import{p as wt,l as Mt,D as rt,R as Ht,U as lt,a as zt,N as Vt,M as Dt,b as ri,L as Rt,P as li,S as di,C as Ct,c as mi,d as ci,W as pi,B as dt,e as $,f as mt,V as z}from"./vendor.da8be286.js";const ui=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const _ of s.addedNodes)_.tagName==="LINK"&&_.rel==="modulepreload"&&a(_)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}};ui();var J=document.getElementById("theCanvas"),Ot=J.getContext("2d"),gi=document.getElementById("plotSelect"),yi=document.getElementById("contrastSlider"),fi=document.getElementById("rafCheck");const Kt=4/9,Z=1/9,tt=1/36;var M=400,Ut=new Array(M+2),vt=new Array(M+2),xt=new Array(M+2),bt=new Array(M+2);for(var k=0;k<=M;k++){var V,R,C;k<M/8?(V=0,R=0,C=Math.round(255*(k+M/8)/(M/4))):k<3*M/8?(V=0,R=Math.round(255*(k-M/8)/(M/4)),C=255):k<5*M/8?(V=Math.round(255*(k-3*M/8)/(M/4)),R=255,C=255-V):k<7*M/8?(V=255,R=Math.round(255*(7*M/8-k)/(M/4)),C=0):(V=Math.round(255*(9*M/8-k)/(M/4)),R=0,C=0),vt[k]=V,xt[k]=R,bt[k]=C,Ut[k]=Yt(V,R,C)}vt[M+1]=0;xt[M+1]=0;bt[M+1]=0;Ut[M+1]=Yt(0,0,0);function It(h){var t=h.toString(16);return t.length==1?"0"+t:t}function Yt(h,t,e){return"#"+It(h)+It(t)+It(e)}class wi{constructor(t,e,a,i,s,_){this.texture=_,this.resolution=a,this.width=t*this.resolution,this.height=e*this.resolution,this.direction=i+180,this.step_ready=!1,this.t_delta=0,J.width=this.width,J.height=this.height,this.speed=s/100,this.viscosity=.02,this._n0_=new Array(this.width*this.height),this._nN_=new Array(this.width*this.height),this._nS_=new Array(this.width*this.height),this._nE_=new Array(this.width*this.height),this._nW_=new Array(this.width*this.height),this._nNE_=new Array(this.width*this.height),this._nSE_=new Array(this.width*this.height),this._nNW_=new Array(this.width*this.height),this._nSW_=new Array(this.width*this.height),this._ux_=new Array(this.width*this.height),this._uy_=new Array(this.width*this.height),this._rho_=new Array(this.width*this.height),this._curl_=new Array(this.width*this.height),this.barrier=new Array(this.width*this.height);for(var r=0;r<this.height;r++)for(var o=0;o<this.width;o++)this.barrier[o+r*this.width]=!1;for(var l=16,r=this.height/2-l;r<=this.height/2+l;r++){var o=Math.round(this.height/3);this.barrier[o+r*this.width]=!0}this.image=Ot.createImageData(J.width,J.height);for(var d=3;d<this.image.data.length;d+=4)this.image.data[d]=255;this.running=!1,this.initFluid(),this.startStop(),this.graphics_model_init()}initFluid(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;console.log(t,e);for(var a=0;a<this.height;a++)for(var i=0;i<this.width;i++)this.setEquil(i,a,t,e,1),this._curl_[i+a*this.width]=0}startStop(){this.running=!this.running,this.running&&this.physics_model_step()}physics_model_step(){let t=new Date;for(let s=0;s<1;s++)this.setBoundaries(),this.collide(),this.stream();this.t_delta=new Date-t,this.step_ready=!0;for(var e=!0,a=0;a<this.width;a++){var i=a+this.height/2*this.width;this._rho_[i]<=0&&(e=!1)}e||(window.alert("The simulation has become unstable due to excessive fluid speeds."),this.startStop(),this.initFluid()),this.graphics_model_init()}graphics_model_init(){this.graphics_model_step()}graphics_model_step(){this.paintCanvas(),this.running&&(fi.checked?requestAnimFrame(this.graphics_model_step_handler.bind(this)):window.setTimeout(this.graphics_model_step_handler.bind(this),10))}graphics_model_step_handler(){this.graphics_model_step()}setBoundaries(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;for(var a=0;a<this.width;a++)this.setEquil(a,0,t,e,1),this.setEquil(a,this.height-1,t,e,1);for(var i=1;i<this.height-1;i++)this.setEquil(0,i,t,e,1),this.setEquil(this.width-1,i,t,e,1)}collide(){for(var t=1/(3*this.viscosity+.5),e=1;e<this.height-1;e++)for(var a=1;a<this.width-1;a++){var i=a+e*this.width,s=this._n0_[i]+this._nN_[i]+this._nS_[i]+this._nE_[i]+this._nW_[i]+this._nNW_[i]+this._nNE_[i]+this._nSW_[i]+this._nSE_[i];this._rho_[i]=s;var _=(this._nE_[i]+this._nNE_[i]+this._nSE_[i]-this._nW_[i]-this._nNW_[i]-this._nSW_[i])/s;this._ux_[i]=_;var r=(this._nN_[i]+this._nNE_[i]+this._nNW_[i]-this._nS_[i]-this._nSE_[i]-this._nSW_[i])/s;this._uy_[i]=r;var o=Z*s,l=tt*s,d=3*_,n=3*r,c=_*_,m=r*r,u=2*_*r,v=c+m,f=1.5*v;this._n0_[i]+=t*(Kt*s*(1-f)-this._n0_[i]),this._nE_[i]+=t*(o*(1+d+4.5*c-f)-this._nE_[i]),this._nW_[i]+=t*(o*(1-d+4.5*c-f)-this._nW_[i]),this._nN_[i]+=t*(o*(1+n+4.5*m-f)-this._nN_[i]),this._nS_[i]+=t*(o*(1-n+4.5*m-f)-this._nS_[i]),this._nNE_[i]+=t*(l*(1+d+n+4.5*(v+u)-f)-this._nNE_[i]),this._nSE_[i]+=t*(l*(1+d-n+4.5*(v-u)-f)-this._nSE_[i]),this._nNW_[i]+=t*(l*(1-d+n+4.5*(v-u)-f)-this._nNW_[i]),this._nSW_[i]+=t*(l*(1-d-n+4.5*(v+u)-f)-this._nSW_[i])}for(var e=1;e<this.height-2;e++)this._nW_[this.width-1+e*this.width]=this._nW_[this.width-2+e*this.width],this._nNW_[this.width-1+e*this.width]=this._nNW_[this.width-2+e*this.width],this._nSW_[this.width-1+e*this.width]=this._nSW_[this.width-2+e*this.width]}stream(){for(var t=this.height-2;t>0;t--)for(var e=1;e<this.width-1;e++)this._nN_[e+t*this.width]=this._nN_[e+(t-1)*this.width],this._nNW_[e+t*this.width]=this._nNW_[e+1+(t-1)*this.width];for(var t=this.height-2;t>0;t--)for(var e=this.width-2;e>0;e--)this._nE_[e+t*this.width]=this._nE_[e-1+t*this.width],this._nNE_[e+t*this.width]=this._nNE_[e-1+(t-1)*this.width];for(var t=1;t<this.height-1;t++)for(var e=this.width-2;e>0;e--)this._nS_[e+t*this.width]=this._nS_[e+(t+1)*this.width],this._nSE_[e+t*this.width]=this._nSE_[e-1+(t+1)*this.width];for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)this._nW_[e+t*this.width]=this._nW_[e+1+t*this.width],this._nSW_[e+t*this.width]=this._nSW_[e+1+(t+1)*this.width];const a=.7,i=1-a;for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)if(this.barrier[e+t*this.width]){var s=e+t*this.width;this._nE_[e+1+t*this.width]=this._nE_[e+1+t*this.width]*i+this._nW_[s]*a,this._nW_[e-1+t*this.width]=this._nW_[e-1+t*this.width]*i+this._nE_[s]*a,this._nN_[e+(t+1)*this.width]=this._nN_[e+(t+1)*this.width]*i+this._nS_[s]*a,this._nS_[e+(t-1)*this.width]=this._nS_[e+(t-1)*this.width]*i+this._nN_[s]*a,this._nNE_[e+1+(t+1)*this.width]=this._nNE_[e+1+(t+1)*this.width]*i+this._nSW_[s]*a,this._nNW_[e-1+(t+1)*this.width]=this._nNW_[e-1+(t+1)*this.width]*i+this._nSE_[s]*a,this._nSE_[e+1+(t-1)*this.width]=this._nSE_[e+1+(t-1)*this.width]*i+this._nNW_[s]*a,this._nSW_[e-1+(t-1)*this.width]=this._nSW_[e-1+(t-1)*this.width]*i+this._nNE_[s]*a}}setEquil(t,e,a,i,s){var _=t+e*this.width;typeof s=="undefined"&&(s=this._rho_[_]);var r=3*a,o=3*i,l=a*a,d=i*i,n=2*a*i,c=l+d,m=1.5*c;this._n0_[_]=Kt*s*(1-m),this._nE_[_]=Z*s*(1+r+4.5*l-m),this._nW_[_]=Z*s*(1-r+4.5*l-m),this._nN_[_]=Z*s*(1+o+4.5*d-m),this._nS_[_]=Z*s*(1-o+4.5*d-m),this._nNE_[_]=tt*s*(1+r+o+4.5*(c+n)-m),this._nSE_[_]=tt*s*(1+r-o+4.5*(c-n)-m),this._nNW_[_]=tt*s*(1-r+o+4.5*(c-n)-m),this._nSW_[_]=tt*s*(1-r-o+4.5*(c+n)-m),this._rho_[_]=s,this._ux_[_]=a,this._uy_[_]=i}apply_energy(t,e,a,i){document.getElementById("wind_info").innerHTML="dir: "+a+"stre : "+i+"<br>";let s=this.width/2+Math.floor(t*this.resolution),_=this.height/2+Math.floor(e*this.resolution),r,o,l,d,n,c,m,u,v,f,I,P;r=Math.floor(s),n=Math.floor(_),o=r+1,c=n,l=r,m=n+1,d=r+1,u=n+1;let b=s-r,W=_-n;v=(1-b)*(1-W),f=b*(1-W),I=(1-b)*W,P=b*W;let B=[r,o,l,d],x=[n,c,m,u],T=[v,f,I,P];for(let E=0;E<1;E++)this.apply_force_to_cell(B[E],x[E],a,T[E]*i)}apply_force_to_cell(t,e,a,i){let s=t+e*this.width,_=this._ux_[s],r=this._uy_[s],o=this._rho_[s],l=Math.cos(a/180*Math.PI)*i/o*-1,d=Math.sin(a/180*Math.PI)*i/o*-1;this.setEquil(t,e,_+l,r+d)}apply_energy_to_cell(t,e,a,i){let s=a+270;s>360&&(s-=360),document.getElementById("wind_info").innerHTML="mirror_angle: "+s+"<br>";const _=[this._nE_,this._nNE_,this._nN_,this._nNW_,this._nW_,this._nSW_,this._nS_,this._nSE_];document.getElementById("wind_info").innerHTML+=JSON.stringify(a)+"<br>";let r=[0,0,0,0,0,0,0,0],o=[0,0,0,0,0,0,0,0],l=[0,0,0,0,0,0,0,0],d=[0,0,0,0,0,0,0,0];for(let n=0;n<8;n++){const c=.1*i,m=(Math.floor(s/45)+1+n)%8;d[n]=m*45,l[n]=s-(d[n]-s),l[n]>360&&(l[n]-=360),l[n]<0&&(l[n]+=360),r[n]=Math.cos(l[n]/180*Math.PI)*_[m][t+e*this.width]*c,o[n]=Math.sin(l[n]/180*Math.PI)*_[m][t+e*this.width]*c,_[m][t+e*this.width]*=1-c}for(let n=0;n<8;n++){const c=(Math.floor(l[n]/45)+1+n)%8;let m,u;c%2==0?Math.abs(r[n])>Math.abs(o[n])?(m=r[n]-o[n],u=o[n]*Math.SQRT2):(m=o[n]-r[n],u=r[n]*Math.SQRT2):Math.abs(r[n])>Math.abs(o[n])?(m=o[n]*Math.SQRT2,u=r[n]-o[n]):(m=r[n]*Math.SQRT2,u=o[n]-r[n]),_[c][t+e*this.width]+=m,_[(c+1)%8][t+e*this.width]+=u;let v=m*1e4,f=u*1e4;document.getElementById("wind_info").innerHTML+="sou: "+d[n]+" mirr: "+Math.floor(l[n])+"<br>",document.getElementById("wind_info").innerHTML+="u: "+Math.floor(v)+" v: "+Math.floor(f)+"<br>"}}get_field_velocity(t,e){t=this.width/2+Math.floor(t*this.resolution),e=this.height/2+Math.floor(e*this.resolution);let a,i,s,_,r,o,l,d,n,c,m,u;a=Math.floor(t),r=Math.floor(e),i=a+1,o=r,s=a,l=r+1,_=a+1,d=r+1;let v=t-a,f=e-r;n=(1-v)*(1-f),c=v*(1-f),m=(1-v)*f,u=v*f;let I=0,P=0;return I=this._ux_[a+r*this.width]*n+this._ux_[i+o*this.width]*c+this._ux_[s+l*this.width]*m+this._ux_[_+d*this.width]*u,P=this._uy_[a+r*this.width]*n+this._uy_[i+o*this.width]*c+this._uy_[s+l*this.width]*m+this._uy_[_+d*this.width]*u,{x:I/4,y:P/4}}paintCanvas(){var t=0,e=Math.pow(1.2,Number(yi.value)),a=gi.selectedIndex;a==4&&this.computeCurl();for(var i=0;i<this.height;i++)for(var s=0;s<this.width;s++){if(this.barrier[s+i*this.width])t=M+1;else{if(a==0)t=Math.round(M*((this._rho_[s+i*this.width]-1)*6*e+.5));else if(a==1)t=Math.round(M*(this._ux_[s+i*this.width]*2*e+.5));else if(a==2)t=Math.round(M*(this._uy_[s+i*this.width]*2*e+.5));else if(a==3){var _=Math.sqrt(this._ux_[s+i*this.width]*this._ux_[s+i*this.width]+this._uy_[s+i*this.width]*this._uy_[s+i*this.width]);t=Math.round(M*(_*4*e))}else t=Math.round(M*(this._curl_[s+i*this.width]*5*e+.5));t<0&&(t=0),t>M&&(t=M)}this.colorSquare(s,i,vt[t],xt[t],bt[t])}Ot.putImageData(this.image,0,0)}colorSquare(t,e,a,i,s){if(this.texture!==void 0){var _=(t+e*this.width)*4;this.texture.image.data[_+0]=a,this.texture.image.data[_+1]=i,this.texture.image.data[_+2]=s,this.texture.image.data[_+3]=255;for(var r=this.height-e-1,o=r;o<r+1;o++)for(var l=t;l<t+1;l++){var d=(l+o*this.width)*4;this.image.data[d+0]=a,this.image.data[d+1]=i,this.image.data[d+2]=s}}}computeCurl(){for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)this._curl_[e+t*this.width]=this._uy_[e+1+t*this.width]-this._uy_[e-1+t*this.width]-this._ux_[e+(t+1)*this.width]+this._ux_[e+(t-1)*this.width]}}window.requestAnimFrame=function(h){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1)}}();let O=1,it;it=.3*O;let Pt=4;Pt=4;let Gt={vectorField:void 0,objCanvas:void 0,ctx:void 0,enableFrameDragging:!0,enableEmitter:!0,loopTimer:void 0,loopTicker:0,emitterX:0,emitterY:0,init:function(h,t){this.initVectorField(h,t)},initVectorField:function(h,t){this.vectorField=new Mi(h,t,h*O,t*O)},start:function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.animateFrame=function(h){Gt.loop(),window.animateTimestamp=h,window.requestAnimationFrame(animateFrame)},window.animateFrame()},get_field_velocity:function(h,t){var e=this.vectorField.areaWidth,a=this.vectorField.areaHeight;h+=this.vectorField.width/2,t+=this.vectorField.height/2,h*=O,t*=O;let i,s,_,r,o,l,d,n,c,m,u,v;i=Math.floor(h),o=Math.floor(t),s=i+1,l=o,_=i,d=o+1,r=i+1,n=o+1;let f=h-i,I=t-o;c=(1-f)*(1-I),m=f*(1-I),u=(1-f)*I,v=f*I;let P=h+.5>>0,b=t-.5>>0,W=0,B=0;if(P<e-1&&P>0+1&&b<a-1&&b>0+1){var x=this.vectorField.field;W=x[i][o].vx*c+x[s][l].vx*m+x[_][d].vx*u+x[r][n].vx*v,B=x[i][o].vy*c+x[s][l].vy*m+x[_][d].vy*u+x[r][n].vy*v}return{x:-W,y:B}},apply_energy:function(h,t,e,a){var i=this.vectorField.areaWidth,s=this.vectorField.areaHeight;h+=this.vectorField.width/2,t+=this.vectorField.height/2,h*=O,t*=O;let _,r,o,l,d,n,c,m,u,v,f,I;_=Math.floor(h),d=Math.floor(t),r=_+1,n=d,o=_,c=d+1,l=_+1,m=d+1;let P=h-_,b=t-d;u=(1-P)*(1-b),v=P*(1-b),f=(1-P)*b,I=P*b;let W=h+.5>>0,B=t+.5>>0;if(W<i-1&&W>0+1&&B<s-1&&B>0+1){var x=this.vectorField.field;let T=0,E=0;T+=-Math.cos(e/180*Math.PI)*a,E+=-Math.sin(e/180*Math.PI)*a,x[_][d].vx+=u*T,x[_][d].vy+=u*E,x[r][n].vx+=v*T,x[r][n].vy+=v*E,x[o][c].vx+=f*T,x[o][c].vy+=f*E,x[l][m].vx+=I*T,x[l][m].vy+=I*E}},loop:function(){this.updateVectorField()},updateVectorField:function(){var h=this.vectorField.field,t=this.vectorField.areaWidth,e=this.vectorField.areaHeight,a,i,s,_,r,o;for(a=t;a--;)for(i=e;i--;)a<t-1&&a>0+1&&i<e-1&&i>0+1?(s=(h[a-1][i].vx+h[a+1][i].vx+h[a][i-1].vx+h[a][i+1].vx)/4,_=(h[a-1][i].vy+h[a+1][i].vy+h[a][i-1].vy+h[a][i+1].vy)/4,r=h[a][i].vx*(1-it)+s*it,o=h[a][i].vy*(1-it)+_*it):(r=h[a][i].vx,o=h[a][i].vy),h[a][i].vx_=r,h[a][i].vy_=o;for(a=t;a--;)for(i=e;i--;);for(a=t;a--;)for(i=e;i--;){let l=h[a][i].vx_,d=h[a][i].vy_,n=Math.abs(l)/60*Pt,c=Math.abs(d)/60*Pt;if(a<t-1&&a>0+1&&i<e-1&&i>0+1){let m,u,v,f,I,P,b,W;m=h[a][i].vx_,u=h[a-Math.sign(l)][i].vx_,v=h[a][i-Math.sign(d)].vx_,f=h[a-Math.sign(l)][i-Math.sign(d)].vx_,I=h[a][i].vy_,P=h[a-Math.sign(l)][i].vy_,b=h[a][i-Math.sign(d)].vy_,W=h[a-Math.sign(l)][i-Math.sign(d)].vy_,h[a][i].vx__=(1-n)*(1-c)*m+n*(1-c)*u+(1-n)*c*v+n*c*f,h[a][i].vy__=(1-n)*(1-c)*I+n*(1-c)*P+(1-n)*c*b+n*c*W,(h[a][i].vx__===void 0||h[a][i].vy__===void 0)&&(console.log("TRAP"),h=void 0)}else h[a][i].vx__=h[a][i].vx_,h[a][i].vy__=h[a][i].vy_;(i==e-2||i==1||a==t-2||a==1)&&(h[a][i].vx__=0,h[a][i].vy__=-2.5)}for(a=t;a--;)for(i=e;i--;)h[a][i].vx=h[a][i].vx__,h[a][i].vy=h[a][i].vy__,h[a][i].velocity=Math.sqrt(h[a][i].vx*h[a][i].vx+h[a][i].vy*h[a][i].vy)}},Mi=function(h,t,e,a){this.field=[],this.width=h,this.height=t,this.areaWidth=e,this.areaHeight=a;var i,s;for(i=e;i--;)for(this.field[i]=[],s=a;s--;)this.field[i][s]=new vi},vi=function(){this.velocity=0,this.vx=0,this.vy=-2,this.vx_=0,this.vy_=-2,this.vx__=0,this.vy__=-2},et=wt,N=et.Vec2;function Qt(h){for(var t=0,e=0;e<h.length;e++)t+=h[e];return t}function Xt(h){return Math.PI/180*h}function xi(h){return 180/Math.PI*Math.atan2(Qt(h.map(Xt).map(Math.sin))/h.length,Qt(h.map(Xt).map(Math.cos))/h.length)}class bi{constructor(t,e,a,i,s){this.bm=s,this.fluid=Gt,this.world=void 0,this.width=t,this.height=e,this.wind_direction=a,this.wind_speed=i,this.show_forces=!0,this.show_fields=!1,this.camera_follow_target=void 0,this.camera_follow=!1,this.camera_zoom=30,this.camera_zoom_max=70,this.camera_zoom_min=10,this.camera_position_x=0,this.camera_position_y=0,this.camera_position_x_max=30,this.camera_position_x_min=-30,this.camera_position_y_max=30,this.camera_position_y_min=-30}physics_model_init(){this.fluid.init(this.width,this.height),this.world=new Mt.World(N(0,0));let t=this.world.createBody(N(0,0)),e={density:0,restitution:.4};t.createFixture(et.Edge(N(-this.width/2+2,-this.height/2+2),N(-this.width/2+2,this.height/2-2)),e),t.createFixture(et.Edge(N(this.width/2-2,-this.height/2+2),N(this.width/2-2,this.height/2-2)),e),t.createFixture(et.Edge(N(-this.width/2+2,this.height/2-2),N(this.width/2-2,this.height/2-2)),e),t.createFixture(et.Edge(N(-this.width/2+2,-this.height/2+2),N(this.width/2-2,-this.height/2+2)),e),this.world.createDynamicBody(N(0,14.5)).createFixture(Mt.Circle(.5),10),this.world.createDynamicBody(N(0,20)).createFixture(Mt.Circle(5),10)}get_wind_speed(t,e){let a=this.bm.get_field_velocity(t,e),i=this.bm.get_field_velocity(t-1,e),s=this.bm.get_field_velocity(t+1,e),_=this.bm.get_field_velocity(t,e-1),r=this.bm.get_field_velocity(t,e+1),o=0;return o+=Math.sqrt(a.x*a.x+a.y*a.y),o+=Math.sqrt(i.x*i.x+i.y*i.y),o+=Math.sqrt(s.x*s.x+s.y*s.y),o+=Math.sqrt(_.x*_.x+_.y*_.y),o+=Math.sqrt(r.x*r.x+r.y*r.y),o/5*100*4}get_wind_direction(t,e){let a=this.bm.get_field_velocity(t,e),i=this.bm.get_field_velocity(t-1,e),s=this.bm.get_field_velocity(t+1,e),_=this.bm.get_field_velocity(t,e-1),r=this.bm.get_field_velocity(t,e+1),o=[Math.atan2(a.y,a.x)/Math.PI*180+180,Math.atan2(i.y,i.x)/Math.PI*180+180,Math.atan2(s.y,s.x)/Math.PI*180+180,Math.atan2(_.y,_.x)/Math.PI*180+180,Math.atan2(r.y,r.x)/Math.PI*180+180];return xi(o)}set_camera_follow_target(t){this.camera_follow_target=t}physics_model_step(){this.camera_follow===!0&&this.camera_follow_target!==void 0&&(this.camera_position_x=this.camera_follow_target.x,this.camera_position_y=this.camera_follow_target.y,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min))}input_show_fields(t){this.show_fields=t}input_show_forces(t){this.show_forces=t}input_camera_follow(t){this.camera_follow=t}input_camera_zoom_relative(t){this.camera_zoom+=t,this.camera_zoom>this.camera_zoom_max&&(this.camera_zoom=this.camera_zoom_max),this.camera_zoom<this.camera_zoom_min&&(this.camera_zoom=this.camera_zoom_min)}input_camera_move_relative(t,e){this.camera_position_x+=t,this.camera_position_y+=e,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min)}}class Ii{constructor(t){this.map=t,this.age=0,this.maxage=4e3,this.parameter=[],this.parameter[0]=[20,0],this.parameter[1]=[0,10],this.parameter[2]=[10,50],this.parameter[3]=[10,5],this.parameter[4]=[0,0],this.parameter[5]=[.1,.5],this.strength=3,this.result=[],this.result[0]=(this.parameter[0][0]*(this.maxage-this.age)+this.parameter[0][1]*this.age)/this.maxage,this.result[1]=(this.parameter[1][0]*(this.maxage-this.age)+this.parameter[1][1]*this.age)/this.maxage,this.result[2]=(this.parameter[2][0]*(this.maxage-this.age)+this.parameter[2][1]*this.age)/this.maxage,this.result[3]=(this.parameter[3][0]*(this.maxage-this.age)+this.parameter[3][1]*this.age)/this.maxage,this.result[4]=(this.parameter[4][0]*(this.maxage-this.age)+this.parameter[4][1]*this.age)/this.maxage,this.result[5]=(this.parameter[5][0]*(this.maxage-this.age)+this.parameter[5][1]*this.age)/this.maxage}physics_model_step(){this.result[0]=(this.parameter[0][0]*(this.maxage-this.age)+this.parameter[0][1]*this.age)/this.maxage,this.result[1]=(this.parameter[1][0]*(this.maxage-this.age)+this.parameter[1][1]*this.age)/this.maxage,this.result[2]=(this.parameter[2][0]*(this.maxage-this.age)+this.parameter[2][1]*this.age)/this.maxage,this.result[3]=(this.parameter[3][0]*(this.maxage-this.age)+this.parameter[3][1]*this.age)/this.maxage,this.result[4]=(this.parameter[4][0]*(this.maxage-this.age)+this.parameter[4][1]*this.age)/this.maxage,this.result[5]=(this.parameter[5][0]*(this.maxage-this.age)+this.parameter[5][1]*this.age)/this.maxage,this.p_beam_x=this.result[0],this.p_beam_y=this.result[1],this.p_beam_width=this.result[2],this.p_beam_height=this.result[3],this.p_beam_direction=this.result[4],this.p_beam_elevation=this.result[5];let t=this.strength*Math.sin(Math.PI*this.age/this.maxage)*(this.p_beam_width+this.p_beam_height)/20,e=Math.PI/4*this.p_beam_width*this.p_beam_height,a=t/e;for(let i=-this.p_beam_width/2;i<=this.p_beam_width/2;i++)for(let s=-this.p_beam_height/2;s<=this.p_beam_height/2;s++){let _=i/(this.p_beam_width/2),r=s/(this.p_beam_height/2);if(Math.sqrt(_*_+r*r)<1){let o=Math.atan2(s-this.p_beam_height/2*(1-this.p_beam_elevation),i)/Math.PI*180,l=Math.cos(this.p_beam_direction/180*Math.PI)*i+-Math.sin(this.p_beam_direction/180*Math.PI)*s,d=Math.sin(this.p_beam_direction/180*Math.PI)*i+Math.cos(this.p_beam_direction/180*Math.PI)*s;this.map.fluid.apply_energy(this.p_beam_x+l,this.p_beam_y+d,o+this.p_beam_direction,-a)}}this.age<this.maxage&&this.age++}}let $t=wt,y=$t.Vec2;class A{constructor(t,e,a,i){this.map=t,this.x=e,this.y=a,i!=null?this.hull_angle=i:this.hull_angle=Math.PI,this.wind_direction=0,this.wind_speed=0,this.hull_mass=6,this.hull_shape=$t.Polygon([y(0,-2.25),y(-.5,-1.25),y(-.75,-.25),y(-.75,.5),y(-.5,1.75),y(.5,1.75),y(.75,.5),y(.75,-.25),y(.5,-1.25),y(0,-2.25)]),this.rudder_input=0,this.motor_input=0,this.rudder_angle=0,this.rudder_angle_last=0,this.rudder_angle_max=60,this.rudder_position=1.8,this.rudder_lenght=.5,this.forces=[],this.mainsail_leading_edge_position=-.8,this.mainsail_boom_length=2.2,this.mainsail_boom_angle_max=80,this.mainsail_boom_angle_factor=.5,this.mainsail_boom_angle=0,this.mainsail_boom_angle_actual=0,this.jib_leading_edge_position=-2,this.jib_boom_length=1.4,this.jib_boom_angle_max=55,this.jib_boom_angle_factor=.65,this.jib_boom_angle=0,this.jib_boom_angle_actual=0,this.center_of_lift=-.05,this.centerboard_position=-.15,this.centerboard_length=.6,this.aero_lookup_resolution=5,this.aero_lift_lookup=[0,.025,.15,.9,1.3,1.46,1.52,1.51,1.45,1.41,1.33,1.16,.95,.82,.73,.6,.43,.34,.28,.28,.28],this.aero_drag_lookup=[.15,.15,.15,.16,.172,.19,.22,.25,.29,.34,.4,.47,.55,.635,.73,.83,.95,1.1,1.28,1.28,1.28],this.physics_model=void 0,this.power=0,this.power_direction=0,this.autopilot_enabled=!1,this.autopilot_heading_target=0,this.autopilot_heading_input=0,this.autopilot_heading_best_vmg_1=50,this.autopilot_heading_best_vmg_2=160,this.autopilot_compensator_p=0,this.autopilot_compensator_i=0,this.autopilot_compensator_d=0,this.autopilot_compensator_last_error=0,this.autopilot_compensator_current_error=0,this.autopilot_compensator_sum_error=0,this.twa=0,this.physics_model_init()}physics_model_init(){let t=wt,e=t.Vec2,a=this.map.world.createBody({type:"dynamic",angularDamping:.5,linearDamping:.1,position:e(this.x,this.y),angle:this.hull_angle,allowSleep:!1});a.createFixture(this.hull_shape,this.hull_mass),this.physics_model=a}physics_model_deinit(){this.map.world.destroyBody(this.physics_model)}physics_model_step(){this.forces=[],document.getElementById("info").innerHTML="Autopilot"+this.autopilot_enabled+"<br>",document.getElementById("info").innerHTML+="Heading Target"+this.autopilot_heading_target+"<br>",this.x=this.physics_model.m_xf.p.x,this.y=this.physics_model.m_xf.p.y,this.wind_speed=this.map.get_wind_speed(this.x,this.y),this.wind_direction=this.map.get_wind_direction(this.x,this.y);var t=this.physics_model.getAngle();for(this.angle=t,this.hull_angle=t;t<-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;let e=this.physics_model.m_linearVelocity.x*Math.cos(t-Math.PI/2)+this.physics_model.m_linearVelocity.y*Math.sin(t-Math.PI/2),a=this.physics_model.m_linearVelocity.x*Math.cos(t)+this.physics_model.m_linearVelocity.y*Math.sin(t),i=Math.atan2(a,Math.abs(e))*180/Math.PI;i>90?i-=180:i<-90&&(i+=180);let s=-i*Math.abs(e)*Math.abs(e)*2;s>150?s=150:s<-150&&(s=-150);var _=this.physics_model.getWorldVector(y(s,0)),r=this.physics_model.getWorldPoint(y(0,this.centerboard_position));this.physics_model.applyForce(_,r,!0),this.forces.push({name:"centerboard",type:"arrow",vector:_,point:r}),document.getElementById("info").innerHTML+="q/d: "+i+"\xB0<br>";let o=this.map.get_wind_direction(this.x,this.y)-t/Math.PI*180+90,l={};l.x=this.physics_model.m_linearVelocity.x+Math.cos(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y),l.y=this.physics_model.m_linearVelocity.y+Math.sin(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y);let d=Math.atan2(l.y,l.x)/Math.PI*180-t/Math.PI*180+90,n=Math.sqrt(l.x*l.x+l.y*l.y);if(d>180&&(d-=360),d<-180&&(d+=360),o>180&&(o-=360),o<-180&&(o+=360),this.awa=d,this.twa=o,this.motor_input===1){var c=this.physics_model.getWorldVector(y(0,-.3)),m=this.physics_model.getWorldPoint(y(0,2));this.physics_model.applyLinearImpulse(c,m,!0)}if(this.motor_input===-1){var c=this.physics_model.getWorldVector(y(0,.3)),m=this.physics_model.getWorldPoint(y(0,2));this.physics_model.applyLinearImpulse(c,m,!0)}this.rudder_angle_last=this.rudder_angle;let u=0;const v=1-Math.abs(e)>0?1-Math.abs(e)+1:1;if(this.rudder_input===-1)this.rudder_angle<this.rudder_angle_max&&(this.rudder_angle+=v),u=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else if(this.rudder_input===1)this.rudder_angle>-this.rudder_angle_max&&(this.rudder_angle-=v),u=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else{let j=e;e>1&&(j=1),e<-1&&(j=-1),this.rudder_angle=this.rudder_angle*(.98-j/80)}if(this.autopilot_enabled){this.autopilot_compensator_p=2,this.autopilot_compensator_i=0,this.autopilot_compensator_d=100;let j=-(this.autopilot_heading_target- -this.twa);this.autopilot_compensator_sum_error*=.85,this.autopilot_compensator_sum_error+=j,j>180&&(j-=360),j<-180&&(j+=360),document.getElementById("info").innerHTML+="error: "+Math.floor(j)+"\xB0<br>";let oi=j*this.autopilot_compensator_p,ni=this.autopilot_compensator_sum_error*this.autopilot_compensator_i,_i=(j-this.autopilot_compensator_last_error)*this.autopilot_compensator_d;this.rudder_angle_target=(oi+ni+_i)*Math.sign(e),this.rudder_angle_target>this.rudder_angle_max/2&&(this.rudder_angle_target=this.rudder_angle_max/2),this.rudder_angle_target<-this.rudder_angle_max/2&&(this.rudder_angle_target=-this.rudder_angle_max/2),this.rudder_angle+=(this.rudder_angle_target-this.rudder_angle)/10,this.autopilot_compensator_last_error=j}else this.autopilot_heading_target=-this.twa,this.autopilot_heading_target>180&&(this.autopilot_heading_target-=360),this.autopilot_heading_target<-180&&(this.autopilot_heading_target+=360);let I=this.physics_model.m_angularVelocity*this.rudder_lenght,P=Math.atan2(-a+I,Math.abs(e))/Math.PI*180,b=0;e>0?b=e*(this.rudder_angle+P)/7:b=e*(this.rudder_angle-P)/7,b+=u*2;let W=this.physics_model.getWorldPoint(y(0,this.rudder_position)),B={};B.x=Math.cos(t+this.rudder_angle/180*Math.PI)*b,B.y=Math.sin(t+this.rudder_angle/180*Math.PI)*b,this.physics_model.applyForce(B,W,!0),this.forces.push({name:"rudder",type:"arrow",vector:B,point:W}),document.getElementById("info").innerHTML+="TWA: "+Math.floor(o)+"<br>",document.getElementById("info").innerHTML+="TWS: "+Math.floor(this.wind_speed*10)/10+"<br>",document.getElementById("info").innerHTML+="AWA: "+Math.floor(d)+"<br>",document.getElementById("info").innerHTML+="AWS: "+Math.floor(n*10)/10+"<br>";let x=Math.sqrt(this.physics_model.m_linearVelocity.x*this.physics_model.m_linearVelocity.x+this.physics_model.m_linearVelocity.y*this.physics_model.m_linearVelocity.y),T=Math.cos(o/180*Math.PI)*x;document.getElementById("info").innerHTML+="BS: "+Math.floor(x*10)/10+"<br>",document.getElementById("info").innerHTML+="VMG: "+Math.floor(T*10)/10+"<br>",this.jib_boom_angle=this.awa*this.jib_boom_angle_factor,this.jib_boom_angle>this.jib_boom_angle_max&&(this.jib_boom_angle=this.jib_boom_angle_max),this.jib_boom_angle<-this.jib_boom_angle_max&&(this.jib_boom_angle=-this.jib_boom_angle_max),this.mainsail_boom_angle=this.awa*this.mainsail_boom_angle_factor,this.mainsail_boom_angle>this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=this.mainsail_boom_angle_max),this.mainsail_boom_angle<-this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=-this.mainsail_boom_angle_max);const E=Math.floor(Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution),ht=Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution-E;let yt=this.aero_drag_lookup[E]*(1-ht)+this.aero_drag_lookup[E+1]*ht,ft=this.aero_lift_lookup[E]*(1-ht)+this.aero_lift_lookup[E+1]*ht,Y={},G={};document.getElementById("info").innerHTML+="Cd: "+Math.floor(yt*10)/10+"<br>",document.getElementById("info").innerHTML+="Cl: "+Math.floor(ft*10)/10+"<br>";const ot=.35;Y.x=Math.cos(t+this.awa/180*Math.PI+Math.PI/2)*n*n*yt*ot,Y.y=Math.sin(t+this.awa/180*Math.PI+Math.PI/2)*n*n*yt*ot,G.x=-Math.sign(this.awa)*Math.cos(t+this.awa/180*Math.PI)*n*n*ft*ot,G.y=-Math.sign(this.awa)*Math.sin(t+this.awa/180*Math.PI)*n*n*ft*ot;let H={};H.x=Y.x+G.x,H.y=Y.y+G.y;var nt=this.physics_model.getWorldPoint(y(0,this.center_of_lift));this.physics_model.applyForce(G,nt,!0),this.physics_model.applyForce(Y,nt,!0),this.forces.push({name:"mainsail",type:"arrow",vector:G,point:nt}),this.forces.push({name:"mainsail",type:"arrow",vector:Y,point:nt}),this.power=Math.sqrt(H.x*H.x+H.y*H.y),this.power_direction=Math.atan2(H.y,H.x)/Math.PI*180,document.getElementById("info").innerHTML+="Power: "+Math.floor(this.power*10)/10+"<br>";var _t={};_t.x=-this.physics_model.m_linearVelocity.x*x,_t.y=-this.physics_model.m_linearVelocity.y*x;var qt=this.physics_model.getWorldPoint(y(0,0));this.physics_model.applyForce(_t,qt,!0),this.forces.push({name:"drag",type:"arrow",vector:_t,point:qt}),this.rudder_input=0,this.motor_input=0}graphics_model_render(){let t=[];this.forces.forEach(n=>{t.push({color:65280,type:"force",x1:n.point.x,y1:n.point.y,x2:n.point.x+n.vector.x/10,y2:n.point.y+n.vector.y/10})});let e={},a=2;this.autopilot_enabled&&(a=10),e.x1=this.physics_model.getWorldPoint(y(0,0)).x,e.y1=this.physics_model.getWorldPoint(y(0,0)).y,e.x2=e.x1+Math.cos((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*a,e.y2=e.y1+Math.sin((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*a,e.color=5596791,e.type="autopilot",t.push(e);let i=this.wind_direction/180*Math.PI;t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),i=this.awa/180*Math.PI+this.hull_angle-Math.PI/2,t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(y(0,this.rudder_position)).x,y1:this.physics_model.getWorldPoint(y(0,this.rudder_position)).y,x2:this.physics_model.getWorldPoint(y(0,this.rudder_position)).x+Math.cos(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght,y2:this.physics_model.getWorldPoint(y(0,this.rudder_position)).y+Math.sin(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(y(0,this.centerboard_position+this.centerboard_length/2)).x,y1:this.physics_model.getWorldPoint(y(0,this.centerboard_position+this.centerboard_length/2)).y,x2:this.physics_model.getWorldPoint(y(0,this.centerboard_position-this.centerboard_length/2)).x,y2:this.physics_model.getWorldPoint(y(0,this.centerboard_position-this.centerboard_length/2)).y});let s=[];s[0]={},s[0].x=this.physics_model.getWorldPoint(y(0,this.mainsail_leading_edge_position)).x,s[0].y=this.physics_model.getWorldPoint(y(0,this.mainsail_leading_edge_position)).y,this.mainsail_boom_angle/this.mainsail_boom_angle_factor,this.mainsail_boom_angle_actual+=(this.mainsail_boom_angle-this.mainsail_boom_angle_actual)/30;let _=this.mainsail_boom_length*.05*Math.abs(this.awa)/30<this.mainsail_boom_length/10?this.mainsail_boom_length*.05*Math.abs(this.awa)/30:this.mainsail_boom_length/10;s[1]={},s[1].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-_*Math.sign(this.mainsail_boom_angle_actual),s[1].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-_*Math.sign(this.mainsail_boom_angle_actual);let r=_;s[2]={},s[2].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.mainsail_boom_angle_actual),s[2].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.mainsail_boom_angle_actual),s[3]={},s[3].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,s[3].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,t.push({color:8939263,type:"sail",x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y}),t.push({color:8939263,type:"sail",x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y}),t.push({color:8939263,type:"sail",x1:s[2].x,y1:s[2].y,x2:s[3].x,y2:s[3].y}),this.jib_boom_angle_actual+=(this.jib_boom_angle-this.jib_boom_angle_actual)/20;let o=[];o[0]={},o[0].x=this.physics_model.getWorldPoint(y(0,this.jib_leading_edge_position)).x,o[0].y=this.physics_model.getWorldPoint(y(0,this.jib_leading_edge_position)).y;let l=this.jib_boom_length*.05*Math.abs(this.awa)/15<this.jib_boom_length/3?this.jib_boom_length*.05*Math.abs(this.awa)/15:this.jib_boom_length/3;o[1]={},o[1].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.jib_boom_angle_actual),o[1].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.jib_boom_angle_actual);let d=l;return o[2]={},o[2].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),o[2].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),o[3]={},o[3].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,o[3].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,t.push({color:8939263,type:"sail",x1:o[0].x,y1:o[0].y,x2:o[1].x,y2:o[1].y}),t.push({color:8939263,type:"sail",x1:o[1].x,y1:o[1].y,x2:o[2].x,y2:o[2].y}),t.push({color:8939263,type:"sail",x1:o[2].x,y1:o[2].y,x2:o[3].x,y2:o[3].y}),t}input_rudder_left(){this.rudder_input=1,this.autopilot_enabled=!1}input_rudder_right(){this.rudder_input=-1,this.autopilot_enabled=!1}input_motor_forward(){this.motor_input=1}input_motor_reverse(){this.motor_input=-1}input_autopilot_enabled_toggle(){this.autopilot_heading_target<0?this.autopilot_heading_target>-90?this.autopilot_heading_target=-this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=-this.autopilot_heading_best_vmg_2:this.autopilot_heading_target<90?this.autopilot_heading_target=this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=this.autopilot_heading_best_vmg_2,this.autopilot_enabled=!0}input_autopilot_tack_toggle(){this.autopilot_heading_target*=-1,this.autopilot_enabled=!0}input_autopilot_heading_increase(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)<175&&(this.autopilot_heading_target>0?this.autopilot_heading_target+=1:this.autopilot_heading_target-=1)}input_autopilot_heading_decrease(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)>5&&(this.autopilot_heading_target>0?this.autopilot_heading_target-=1:this.autopilot_heading_target+=1)}}const Et=100,Wt=100,Jt=90,Zt=7,St=1.5,Q=new wi(Et,Wt,St,Jt,Zt);let p=new bi(Et,Wt,Jt,Zt,Q);p.physics_model_init();var kt=Et*St,Ft=Wt*St,ti=kt*Ft*4,jt=new Uint8Array(ti);for(var K=0;K<ti;K++)jt[K]=Math.random()*256;var ct=new rt(jt,kt,Ft,Ht,lt,zt),ii=new rt(jt,kt,Ft,Ht,lt,zt);ct.magFilter=Vt;ct.needsUpdate=!0;var ei=new Dt({map:ct,transparent:!0});ei.needsUpdate=!0;p.bm.texture=ii;const Pi=function(h,t,e,a,i){return(h-t)*(i-a)/(e-t)+a};let at={},w=[],Bt=[],X=0;const Ei=new ri(p.world,{speed:1,fps:60});var Nt=p.fluid.vectorField.areaWidth,Lt=p.fluid.vectorField.areaHeight,ai=Nt*Lt,Tt=new Uint8Array(ai);for(var K=0;K<ai;K++)Tt[K]=Math.random()*256;var pt=new rt(Tt,Nt,Lt,Rt,lt),si=new rt(Tt,Nt,Lt,Rt,lt);pt.magFilter=Vt;pt.needsUpdate=!0;var Wi=new Dt({color:16777215,alphaMap:pt,transparent:!0});Wi.needsUpdate=!0;let S=[],D=[],F=[],hi=[],ut=[];document.onkeydown=ki;document.onkeyup=Fi;document.getElementById("camera_follow").checked=!1;document.getElementById("show_forces").checked=!0;document.getElementById("show_field").checked=!1;document.getElementById("show_forces").addEventListener("change",h=>{p.input_show_forces(document.getElementById("show_forces").checked)});document.getElementById("scenario_selector").addEventListener("change",h=>{console.log(document.getElementById("scenario_selector").value),At(g[document.getElementById("scenario_selector").value])});document.getElementById("scenario_restart").addEventListener("click",h=>{console.log("restart"),At(g[document.getElementById("scenario_selector").value])});document.getElementById("show_field").addEventListener("change",h=>{p.input_show_fields(document.getElementById("show_field").checked)});document.getElementById("camera_follow").addEventListener("change",h=>{p.input_camera_follow(document.getElementById("camera_follow").checked)});document.getElementById("camera_zoom_in").addEventListener("click",h=>{p.input_camera_zoom_relative(-2)});document.getElementById("camera_zoom_out").addEventListener("click",h=>{p.input_camera_zoom_relative(2)});document.getElementById("camera_move_left").addEventListener("click",h=>{p.input_camera_move_relative(-5,0)});document.getElementById("camera_move_right").addEventListener("click",h=>{p.input_camera_move_relative(5,0)});document.getElementById("camera_move_up").addEventListener("click",h=>{p.input_camera_move_relative(0,5)});document.getElementById("camera_move_down").addEventListener("click",h=>{p.input_camera_move_relative(0,-5)});var Si=function(h){h.pageX,h.pageY;var t=new z,e=new z;t.set(h.clientX/window.innerWidth*2-1,-(h.clientY/window.innerHeight)*2+1,.5),t.unproject(L),t.sub(L.position).normalize();var a=-L.position.z/t.z;e.copy(L.position).add(t.multiplyScalar(a));let i=p.get_wind_direction(e.x,e.y),s=p.get_wind_speed(e.x,e.y),_=Q.get_field_velocity(e.x,e.y).x,r=Q.get_field_velocity(e.x,e.y).y;i=Math.atan2(r,_)/Math.PI*180,s=Math.sqrt(_*_+r*r),document.getElementById("wind_info").innerHTML="Speed: "+Math.floor(s*1e3)/10+"<br>Direction: "+Math.floor(i*10)/10};document.addEventListener("mousemove",Si);function ki(h){h=h||window.event,D[h.keyCode]=!0,S.forEach(t=>{t.type==="KEYDOWN"&&D[t.activation_key]&&(D[t.prohibition_key]===!1||D[t.prohibition_key]===void 0)&&t.object[t.input_handler]()})}function Fi(h){h=h||window.event,D[h.keyCode]=!1}function gt(){at={},S=[],w.forEach(h=>{h.physics_model_deinit()}),w=[],X=0}function At(h){gt(),at=h}function st(h){S=[],h[0]!==void 0&&(S.push({type:"PRESSED",activation_key:37,prohibition_key:39,object:h[0],input_handler:h[0].input_rudder_left.name}),S.push({type:"PRESSED",activation_key:39,prohibition_key:37,object:h[0],input_handler:h[0].input_rudder_right.name}),S.push({type:"PRESSED",activation_key:40,prohibition_key:38,object:h[0],input_handler:h[0].input_autopilot_heading_increase.name}),S.push({type:"PRESSED",activation_key:38,prohibition_key:40,object:h[0],input_handler:h[0].input_autopilot_heading_decrease.name}),S.push({type:"KEYDOWN",activation_key:32,prohibition_key:-1,object:h[0],input_handler:h[0].input_autopilot_enabled_toggle.name}),S.push({type:"KEYDOWN",activation_key:13,prohibition_key:-1,object:h[0],input_handler:h[0].input_autopilot_tack_toggle.name})),h[1]!==void 0&&(S.push({type:"PRESSED",activation_key:65,prohibition_key:68,object:h[1],input_handler:h[1].input_rudder_left.name}),S.push({type:"PRESSED",activation_key:68,prohibition_key:65,object:h[1],input_handler:h[1].input_rudder_right.name}),S.push({type:"PRESSED",activation_key:83,prohibition_key:87,object:h[1],input_handler:h[1].input_autopilot_heading_increase.name}),S.push({type:"PRESSED",activation_key:87,prohibition_key:83,object:h[1],input_handler:h[1].input_autopilot_heading_decrease.name}),S.push({type:"KEYDOWN",activation_key:17,prohibition_key:-1,object:h[1],input_handler:h[0].input_autopilot_enabled_toggle.name}),S.push({type:"KEYDOWN",activation_key:16,prohibition_key:-1,object:h[1],input_handler:h[0].input_autopilot_tack_toggle.name}))}let g=[];g[0]=[];g[0][0]=()=>{w.push(new A(p,10,-9,5*Math.PI/4))};g[0][1]=()=>{console.log(1),w[0].input_autopilot_enabled_toggle()};g[0][2]=()=>{st(w)};g[1]=[];g[1][0]=()=>{w.push(new A(p,12,-6,5*Math.PI/4)),w.push(new A(p,15,-11.5,5*Math.PI/4))};g[1][1]=()=>{console.log(1),w[0].input_autopilot_enabled_toggle(),w[1].input_autopilot_enabled_toggle()};g[1][2]=()=>{st(w)};g[2]=[];g[2][0]=()=>{w.push(new A(p,-10,-6,3*Math.PI/4)),w.push(new A(p,15,-11.5,5*Math.PI/4))};g[2][1]=()=>{console.log(1),w[0].input_autopilot_enabled_toggle(),w[1].input_autopilot_enabled_toggle()};g[2][2]=()=>{st(w)};g[2][2e3]=()=>{gt()};g[3]=[];g[3][0]=()=>{w.push(new A(p,-3,-3,3*Math.PI/4)),w.push(new A(p,18,-11.5,5*Math.PI/4))};g[3][1]=()=>{console.log(1),w[0].input_autopilot_enabled_toggle(),w[1].input_autopilot_enabled_toggle()};g[3][2]=()=>{st(w)};g[3][350]=()=>{w[0].input_autopilot_tack_toggle()};g[3][2e3]=()=>{gt()};g[4]=[];g[4][0]=()=>{w.push(new A(p,-3,-4,3*Math.PI/4)),w.push(new A(p,18,-11.5,5*Math.PI/4))};g[4][1]=()=>{console.log(1),w[0].input_autopilot_enabled_toggle(),w[1].input_autopilot_enabled_toggle()};g[4][2]=()=>{st(w)};g[4][300]=()=>{w[0].input_autopilot_tack_toggle()};g[4][700]=()=>{w[1].input_autopilot_heading_decrease()};g[4][701]=()=>{w[1].input_autopilot_heading_decrease()};g[4][702]=()=>{w[1].input_autopilot_heading_decrease()};g[4][2e3]=()=>{gt()};g[5]=[];g[5][0]=()=>{Bt=[]};g[5][1]=()=>{Bt.push(new Ii(p))};At(g[document.getElementById("scenario_selector").value]);Ei.start(()=>{ut=[],at!==void 0&&at[X]!==void 0&&(console.log("Frame ",X),at[X]()),S.forEach(a=>{a.type==="PRESSED"&&D[a.activation_key]===!0&&(D[a.prohibition_key]===!1||D[a.prohibition_key]===void 0)&&a.object[a.input_handler]()}),p.set_camera_follow_target(w[0]),p.physics_model_step(),Bt.forEach(a=>{a.physics_model_step()}),w.forEach(a=>{a.physics_model_step(),ut=[...ut,...a.graphics_model_render()];let i={},s=a.awa/180*Math.PI+a.hull_angle-Math.PI/2;i.x=a.x+Math.cos(s)*-1.8,i.y=a.y+Math.sin(s)*-1.8,Math.cos(a.power_direction/180*Math.PI)*a.power/1e4,Math.sin(a.power_direction/180*Math.PI)*a.power/1e4,i.x0=a.x+Math.cos(s)*-2,i.y0=a.y+Math.sin(s)*-2,p.bm.apply_energy(i.x0,i.y0,a.power_direction,a.power/1e4),document.getElementById("info").innerHTML+="Phys Time: "+Q.t_delta+"<br>"}),X%1==0&&p.bm.physics_model_step(),X++;var h=p.fluid.vectorField.field;const t=si.image.data;for(let a=0;a<p.fluid.vectorField.areaWidth;a++)for(let i=0;i<p.fluid.vectorField.areaHeight;i++){let s=h[a][i].velocity,_=256-Pi(s,10,15,0,256);t[i*p.fluid.vectorField.areaWidth+a]=_}let e={};e.x=0,e.y=0,U.copyTextureToTexture(e,si,pt),Q.step_ready&&(U.copyTextureToTexture(e,ii,ct),Q.step_ready=!1),p.show_fields},()=>{});let L,q,U;ji();function ji(){L=new li(70,window.innerWidth/window.innerHeight,.01,85),L.position.z=60,L.position.y=20,q=new di,new Ct(6706517),new Ct(5592422);const h=new mi(p.width,p.height);let t=new ci(h,ei);t.position.x=0,t.position.y=0,t.position.z=-.01,q.add(t),U=new pi({antialias:!0}),U.setSize(window.innerWidth,window.innerHeight),U.setAnimationLoop(Bi),document.body.appendChild(U.domElement)}function Bi(h){L.position.x=p.camera_position_x,L.position.y=p.camera_position_y,L.position.z=p.camera_zoom;for(let t of F)q.remove(t),t.geometry.dispose(),t.material.dispose(),t=void 0;for(let t of hi)q.remove(t),t.geometry.dispose!==void 0&&t.geometry.dispose(),t.material.dispose!==void 0&&t.material.dispose(),t=void 0;F=[],hi=[];for(let t=p.world.getBodyList();t;t=t.getNext())for(let e=t.getFixtureList();e;e=e.getNext()){if(t.render&&t.render.hidden)continue;t.render&&t.render.stroke||t.isDynamic()||t.isKinematic()||t.isStatic();const a=e.getType(),i=e.getShape();if(a==="circle"){const s=i.m_radius,_=t.getPosition();let r=[];for(let d=0;d<360;d+=10){let n=d/180*Math.PI,c=s*Math.cos(n)+_.x,m=s*Math.sin(n)+_.y;r.push(new z(c,m,0))}r.push(r[0]);const o=new dt().setFromPoints(r),l=new $({color:65280});F.push(new mt(o,l)),q.add(F[F.length-1])}if(a==="edge"){let s=[];const _=i.m_vertex1,r=i.m_vertex2;let o=_.x+t.m_xf.p.x,l=_.y+t.m_xf.p.y,d=r.x+t.m_xf.p.x,n=r.y+t.m_xf.p.y;s.push(new z(o,l,0)),s.push(new z(d,n,0));const c=new dt().setFromPoints(s),m=new $({color:16711680});F.push(new mt(c,m)),q.add(F[F.length-1])}if(a==="polygon"){let s=i.m_vertices;s.push(s[0]);let _=[];for(const l of s){let d=t.getAngle()+Math.PI,n=t.getLocalCenter(),c=(l.x+n.x)*Math.cos(d)+(l.y-n.y)*Math.sin(d),m=(l.x+n.x)*Math.sin(d)-(l.y-n.y)*Math.cos(d),u=0;c+=e.m_body.c_position.c.x,m+=e.m_body.c_position.c.y,_.push(new z(c,m,u))}const r=new dt().setFromPoints(_),o=new $({color:255});F.push(new mt(r,o)),q.add(F[F.length-1])}}for(const t of ut){if(p.show_forces==!1&&t.type==="force")continue;let e=[];e.push(new z(t.x1,t.y1,0)),e.push(new z(t.x2,t.y2,0));const a=new dt().setFromPoints(e);let i=t.color;i===void 0&&(i=16711680);let s,_,r;t.opacity!==void 0?(_=!0,s=t.opacity,r=new $({color:i,transparent:_,opacity:s})):r=new $({color:i}),F.push(new mt(a,r)),q.add(F[F.length-1])}U.render(q,L)}
