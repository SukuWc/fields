import{p as gt,l as yt,D as Ht,R as Vt,U as Rt,a as Ct,N as Ot,M as Kt,b as Yt,P as Ut,S as Gt,C as It,c as Qt,d as Xt,W as $t,B as _t,L as $,e as at,V as F}from"./vendor.601f039e.js";const Jt=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))h(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&h(n)}).observe(document,{childList:!0,subtree:!0});function i(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerpolicy&&(s.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?s.credentials="include":e.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function h(e){if(e.ep)return;e.ep=!0;const s=i(e);fetch(e.href,s)}};Jt();var Zt=document.getElementById("plotSelect"),ti=document.getElementById("contrastSlider"),ii=document.getElementById("rafCheck");const ot=4/9,B=1/9,j=1/36;var m=400,Pt=new Array(m+2),nt=new Array(m+2),lt=new Array(m+2),rt=new Array(m+2);for(var x=0;x<=m;x++){var z,V,R;x<m/8?(z=0,V=0,R=Math.round(255*(x+m/8)/(m/4))):x<3*m/8?(z=0,V=Math.round(255*(x-m/8)/(m/4)),R=255):x<5*m/8?(z=Math.round(255*(x-3*m/8)/(m/4)),V=255,R=255-z):x<7*m/8?(z=255,V=Math.round(255*(7*m/8-x)/(m/4)),R=0):(z=Math.round(255*(9*m/8-x)/(m/4)),V=0,R=0),nt[x]=z,lt[x]=V,rt[x]=R,Pt[x]=St(z,V,R)}nt[m+1]=0;lt[m+1]=0;rt[m+1]=0;Pt[m+1]=St(0,0,0);function ft(r){var t=r.toString(16);return t.length==1?"0"+t:t}function St(r,t,i){return"#"+ft(r)+ft(t)+ft(i)}class ei{constructor(t,i,h,e){this.x=i,this.y=h,this.parent=t,this.sub_mesh_depth=e,this._n0_=0,this._nN_=0,this._nS_=0,this._nE_=0,this._nW_=0,this._nNE_=0,this._nSE_=0,this._nNW_=0,this._nSW_=0,this._received_nN_=0,this._received_nS_=0,this._received_nE_=0,this._received_nW_=0,this._received_nNE_=0,this._received_nSE_=0,this._received_nNW_=0,this._received_nSW_=0,this._ux_=0,this._uy_=0,this._rho_=0,this._curl_=0,this.barrier=!1,this.child_00=null,this.child_01=null,this.child_10=null,this.child_11=null}setCurl(t){this._curl_=t}setEquil(t,i,h){typeof h=="undefined"&&(h=this._rho_);var e=3*t,s=3*i,n=t*t,o=i*i,_=2*t*i,l=n+o,d=1.5*l;this._n0_=ot*h*(1-d),this._nE_=B*h*(1+e+4.5*n-d),this._nW_=B*h*(1-e+4.5*n-d),this._nN_=B*h*(1+s+4.5*o-d),this._nS_=B*h*(1-s+4.5*o-d),this._nNE_=j*h*(1+e+s+4.5*(l+_)-d),this._nSE_=j*h*(1+e-s+4.5*(l-_)-d),this._nNW_=j*h*(1-e+s+4.5*(l-_)-d),this._nSW_=j*h*(1-e-s+4.5*(l+_)-d),this._rho_=h,this._ux_=t,this._uy_=i}calculate_curl(){let t=this.parent,i=this.x,h=this.y;this._curl_=t.find_cell(i+1,h)._uy_-t.find_cell(i-1,h)._uy_-t.find_cell(i,h+1)._ux_+t.find_cell(i,h-1)._ux_}collide(t){let i=this._n0_+this._nN_+this._nS_+this._nE_+this._nW_+this._nNW_+this._nNE_+this._nSW_+this._nSE_;this._rho_=i;let h=(this._nE_+this._nNE_+this._nSE_-this._nW_-this._nNW_-this._nSW_)/i;this._ux_=h;let e=(this._nN_+this._nNE_+this._nNW_-this._nS_-this._nSE_-this._nSW_)/i;this._uy_=e;let s=B*i,n=j*i,o=3*h,_=3*e,l=h*h,d=e*e,a=2*h*e,u=l+d,c=1.5*u;this._n0_+=t*(ot*i*(1-c)-this._n0_),this._nE_+=t*(s*(1+o+4.5*l-c)-this._nE_),this._nW_+=t*(s*(1-o+4.5*l-c)-this._nW_),this._nN_+=t*(s*(1+_+4.5*d-c)-this._nN_),this._nS_+=t*(s*(1-_+4.5*d-c)-this._nS_),this._nNE_+=t*(n*(1+o+_+4.5*(u+a)-c)-this._nNE_),this._nSE_+=t*(n*(1+o-_+4.5*(u-a)-c)-this._nSE_),this._nNW_+=t*(n*(1-o+_+4.5*(u-a)-c)-this._nNW_),this._nSW_+=t*(n*(1-o-_+4.5*(u+a)-c)-this._nSW_)}stream(){let t=this.parent,i=this.x,h=this.y;this._received_nN_=t.find_cell(i,h-1)._nN_,this._received_nNW_=t.find_cell(i+1,h-1)._nNW_,this._received_nE_=t.find_cell(i-1,h)._nE_,this._received_nNE_=t.find_cell(i-1,h-1)._nNE_,this._received_nS_=t.find_cell(i,h+1)._nS_,this._received_nSE_=t.find_cell(i-1,h+1)._nSE_,this._received_nW_=t.find_cell(i+1,h)._nW_,this._received_nSW_=t.find_cell(i+1,h+1)._nSW_}bounce(){let t=this.parent,i=this.x,h=this.y;this.barrier&&(t.find_cell(i+1,h)._received_nE_=this._received_nW_,t.find_cell(i-1,h)._received_nW_=this._received_nE_,t.find_cell(i,h+1)._received_nN_=this._received_nS_,t.find_cell(i,h-1)._received_nS_=this._received_nN_,t.find_cell(i+1,h+1)._received_nNE_=this._received_nSW_,t.find_cell(i-1,h+1)._received_nNW_=this._received_nSE_,t.find_cell(i+1,h-1)._received_nSE_=this._received_nNW_,t.find_cell(i-1,h-1)._received_nSW_=this._received_nNE_)}consolidate(){this._nN_=this._received_nN_,this._nS_=this._received_nS_,this._nE_=this._received_nE_,this._nW_=this._received_nW_,this._nNE_=this._received_nNE_,this._nSE_=this._received_nSE_,this._nNW_=this._received_nNW_,this._nSW_=this._received_nSW_,this._received_nN_=0,this._received_nS_=0,this._received_nE_=0,this._received_nW_=0,this._received_nNE_=0,this._received_nSE_=0,this._received_nNW_=0,this._received_nSW_=0}}class si{constructor(t,i,h,e,s,n,o){this.oversampling=o,this.texture=n,this.resolution=h,this.width=t*this.resolution,this.height=i*this.resolution,this.direction=e+180,this.step_ready=!1,this.t_delta=0,this.speed=s/100,this.viscosity=.02,this._n0_=new Array(this.width*this.height),this._nN_=new Array(this.width*this.height),this._nS_=new Array(this.width*this.height),this._nE_=new Array(this.width*this.height),this._nW_=new Array(this.width*this.height),this._nNE_=new Array(this.width*this.height),this._nSE_=new Array(this.width*this.height),this._nNW_=new Array(this.width*this.height),this._nSW_=new Array(this.width*this.height),this._received_nN_=new Array(this.width*this.height),this._received_nS_=new Array(this.width*this.height),this._received_nE_=new Array(this.width*this.height),this._received_nW_=new Array(this.width*this.height),this._received_nNE_=new Array(this.width*this.height),this._received_nSE_=new Array(this.width*this.height),this._received_nNW_=new Array(this.width*this.height),this._received_nSW_=new Array(this.width*this.height),this._ux_=new Array(this.width*this.height),this._uy_=new Array(this.width*this.height),this._rho_=new Array(this.width*this.height),this._curl_=new Array(this.width*this.height),this.cells=new Array(this.width*this.height);for(var _=0;_<this.height;_++)for(var l=0;l<this.width;l++)this.cells[l+_*this.width]=new ei(this,l,_,1);this.barrier=new Array(this.width*this.height);for(var _=0;_<this.height;_++)for(var l=0;l<this.width;l++){let u=l+_*this.width;this.barrier[u]=!1,this.cells[u].barrier=!1;let c=5;Math.pow(this.width/2-l,2)+Math.pow(this.height*.75-_,2)<Math.pow(c,2)&&(this.barrier[u]=!0,this.cells[u].barrier=!0)}this.running=!1,this.initFluid(),this.startStop(),this.graphics_model_init()}calculate_index(t,i){return t+i*this.width}find_cell(t,i){return this.cells[t+i*this.width]}initFluid(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,i=Math.sin(this.direction/180*Math.PI)*this.speed;console.log(t,i);for(var h=0;h<this.height;h++)for(var e=0;e<this.width;e++){let s=e+h*this.width;this.setEquil(s,t,i,1),this._curl_[e+h*this.width]=0,this.cells[s].setEquil(t,i,1),this.cells[s].setCurl(0)}}startStop(){this.running=!this.running,this.running&&this.physics_model_step()}physics_model_step(){let t=new Date;for(let i=0;i<1;i++)this.setBoundaries(),this.collide(),this.stream(),this.bounce(),this.consolidate();this.t_delta=new Date-t,this.step_ready=!0,this.graphics_model_init()}graphics_model_init(){this.graphics_model_step()}graphics_model_step(){this.paintTexture(),this.running&&(ii.checked?requestAnimFrame(this.graphics_model_step_handler.bind(this)):window.setTimeout(this.graphics_model_step_handler.bind(this),10))}graphics_model_step_handler(){this.graphics_model_step()}setBoundaries(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,i=Math.sin(this.direction/180*Math.PI)*this.speed;for(var h=0;h<this.width;h++){let s=h+0*this.width;this.setEquil(s,t,i,1),this.cells[s].setEquil(t,i,1),s=h+(this.height-1)*this.width,this.setEquil(s,t,i,1),this.cells[s].setEquil(t,i,1)}for(var e=1;e<this.height-1;e++){let s=0+e*this.width;this.setEquil(s,t,i,1),this.cells[s].setEquil(t,i,1),s=this.width-1+e*this.width,this.setEquil(s,t,i,1),this.cells[s].setEquil(t,i,1)}}collide(){for(var t=1/(3*this.viscosity+.5),i=1;i<this.height-1;i++)for(var h=1;h<this.width-1;h++){let e=h+i*this.width,s=this._n0_[e]+this._nN_[e]+this._nS_[e]+this._nE_[e]+this._nW_[e]+this._nNW_[e]+this._nNE_[e]+this._nSW_[e]+this._nSE_[e];this._rho_[e]=s;let n=(this._nE_[e]+this._nNE_[e]+this._nSE_[e]-this._nW_[e]-this._nNW_[e]-this._nSW_[e])/s;this._ux_[e]=n;let o=(this._nN_[e]+this._nNE_[e]+this._nNW_[e]-this._nS_[e]-this._nSE_[e]-this._nSW_[e])/s;this._uy_[e]=o;let _=B*s,l=j*s,d=3*n,a=3*o,u=n*n,c=o*o,M=2*n*o,v=u+c,w=1.5*v;this._n0_[e]+=t*(ot*s*(1-w)-this._n0_[e]),this._nE_[e]+=t*(_*(1+d+4.5*u-w)-this._nE_[e]),this._nW_[e]+=t*(_*(1-d+4.5*u-w)-this._nW_[e]),this._nN_[e]+=t*(_*(1+a+4.5*c-w)-this._nN_[e]),this._nS_[e]+=t*(_*(1-a+4.5*c-w)-this._nS_[e]),this._nNE_[e]+=t*(l*(1+d+a+4.5*(v+M)-w)-this._nNE_[e]),this._nSE_[e]+=t*(l*(1+d-a+4.5*(v-M)-w)-this._nSE_[e]),this._nNW_[e]+=t*(l*(1-d+a+4.5*(v-M)-w)-this._nNW_[e]),this._nSW_[e]+=t*(l*(1-d-a+4.5*(v+M)-w)-this._nSW_[e]),this.cells[e].collide(t)}}stream(){for(var t=1;t<this.height-1;t++)for(var i=1;i<this.width-1;i++){let h=i+t*this.width;this._received_nN_[h]=this._nN_[i+(t-1)*this.width],this._received_nNW_[h]=this._nNW_[i+1+(t-1)*this.width],this._received_nE_[h]=this._nE_[i-1+t*this.width],this._received_nNE_[h]=this._nNE_[i-1+(t-1)*this.width],this._received_nS_[h]=this._nS_[i+(t+1)*this.width],this._received_nSE_[h]=this._nSE_[i-1+(t+1)*this.width],this._received_nW_[h]=this._nW_[i+1+t*this.width],this._received_nSW_[h]=this._nSW_[i+1+(t+1)*this.width],this.cells[h].stream()}}bounce(){for(var t=1;t<this.height-1;t++)for(var i=1;i<this.width-1;i++){let h=i+t*this.width;this.barrier[h]&&(this._received_nE_[i+1+t*this.width]=this._received_nW_[h],this._received_nW_[i-1+t*this.width]=this._received_nE_[h],this._received_nN_[i+(t+1)*this.width]=this._received_nS_[h],this._received_nS_[i+(t-1)*this.width]=this._received_nN_[h],this._received_nNE_[i+1+(t+1)*this.width]=this._received_nSW_[h],this._received_nNW_[i-1+(t+1)*this.width]=this._received_nSE_[h],this._received_nSE_[i+1+(t-1)*this.width]=this._received_nNW_[h],this._received_nSW_[i-1+(t-1)*this.width]=this._received_nNE_[h]),this.cells[h].bounce()}}consolidate(){for(var t=0;t<this.height;t++)for(var i=0;i<this.width;i++){let h=i+t*this.width;this._nN_[h]=this._received_nN_[h],this._nS_[h]=this._received_nS_[h],this._nE_[h]=this._received_nE_[h],this._nW_[h]=this._received_nW_[h],this._nNE_[h]=this._received_nNE_[h],this._nSE_[h]=this._received_nSE_[h],this._nNW_[h]=this._received_nNW_[h],this._nSW_[h]=this._received_nSW_[h],this._received_nN_[h]=0,this._received_nS_[h]=0,this._received_nE_[h]=0,this._received_nW_[h]=0,this._received_nNE_[h]=0,this._received_nSE_[h]=0,this._received_nNW_[h]=0,this._received_nSW_[h]=0,this.cells[h].consolidate()}}setEquil(t,i,h,e){typeof e=="undefined"&&(e=this._rho_[t]);var s=3*i,n=3*h,o=i*i,_=h*h,l=2*i*h,d=o+_,a=1.5*d;this._n0_[t]=ot*e*(1-a),this._nE_[t]=B*e*(1+s+4.5*o-a),this._nW_[t]=B*e*(1-s+4.5*o-a),this._nN_[t]=B*e*(1+n+4.5*_-a),this._nS_[t]=B*e*(1-n+4.5*_-a),this._nNE_[t]=j*e*(1+s+n+4.5*(d+l)-a),this._nSE_[t]=j*e*(1+s-n+4.5*(d-l)-a),this._nNW_[t]=j*e*(1-s+n+4.5*(d-l)-a),this._nSW_[t]=j*e*(1-s-n+4.5*(d+l)-a),this._rho_[t]=e,this._ux_[t]=i,this._uy_[t]=h}apply_energy(t,i,h,e){document.getElementById("wind_info").innerHTML="dir: "+h+"stre : "+e+"<br>";let s=this.width/2+Math.floor(t*this.resolution),n=this.height/2+Math.floor(i*this.resolution),o,_,l,d,a,u,c,M,v,w,N,T;o=Math.floor(s),a=Math.floor(n),_=o+1,u=a,l=o,c=a+1,d=o+1,M=a+1;let k=s-o,H=n-a;v=(1-k)*(1-H),w=k*(1-H),N=(1-k)*H,T=k*H;let C=[o,_,l,d],O=[a,u,c,M],ut=[v,w,N,T];for(let S=0;S<1;S++)this.apply_force_to_cell(C[S],O[S],h,ut[S]*e)}apply_force_to_cell(t,i,h,e){let s=t+i*this.width,n=this._ux_[s],o=this._uy_[s],_=this._rho_[s],l=Math.cos(h/180*Math.PI)*e/_*-1,d=Math.sin(h/180*Math.PI)*e/_*-1;this.setEquil(s,n+l,o+d),this.cells[s].setEquil(n+l,o+d)}apply_energy_to_cell(t,i,h,e){let s=h+270;s>360&&(s-=360),document.getElementById("wind_info").innerHTML="mirror_angle: "+s+"<br>";const n=[this._nE_,this._nNE_,this._nN_,this._nNW_,this._nW_,this._nSW_,this._nS_,this._nSE_];document.getElementById("wind_info").innerHTML+=JSON.stringify(h)+"<br>";let o=[0,0,0,0,0,0,0,0],_=[0,0,0,0,0,0,0,0],l=[0,0,0,0,0,0,0,0],d=[0,0,0,0,0,0,0,0];for(let a=0;a<8;a++){const u=.1*e,c=(Math.floor(s/45)+1+a)%8;d[a]=c*45,l[a]=s-(d[a]-s),l[a]>360&&(l[a]-=360),l[a]<0&&(l[a]+=360),o[a]=Math.cos(l[a]/180*Math.PI)*n[c][t+i*this.width]*u,_[a]=Math.sin(l[a]/180*Math.PI)*n[c][t+i*this.width]*u,n[c][t+i*this.width]*=1-u}for(let a=0;a<8;a++){const u=(Math.floor(l[a]/45)+1+a)%8;let c,M;u%2==0?Math.abs(o[a])>Math.abs(_[a])?(c=o[a]-_[a],M=_[a]*Math.SQRT2):(c=_[a]-o[a],M=o[a]*Math.SQRT2):Math.abs(o[a])>Math.abs(_[a])?(c=_[a]*Math.SQRT2,M=o[a]-_[a]):(c=o[a]*Math.SQRT2,M=_[a]-o[a]),n[u][t+i*this.width]+=c,n[(u+1)%8][t+i*this.width]+=M;let v=c*1e4,w=M*1e4;document.getElementById("wind_info").innerHTML+="sou: "+d[a]+" mirr: "+Math.floor(l[a])+"<br>",document.getElementById("wind_info").innerHTML+="u: "+Math.floor(v)+" v: "+Math.floor(w)+"<br>"}}get_field_velocity(t,i){t=this.width/2+Math.floor(t*this.resolution),i=this.height/2+Math.floor(i*this.resolution);let h,e,s,n,o,_,l,d,a,u,c,M;h=Math.floor(t),o=Math.floor(i),e=h+1,_=o,s=h,l=o+1,n=h+1,d=o+1;let v=t-h,w=i-o;a=(1-v)*(1-w),u=v*(1-w),c=(1-v)*w,M=v*w;let N=0,T=0;return N=this._ux_[h+o*this.width]*a+this._ux_[e+_*this.width]*u+this._ux_[s+l*this.width]*c+this._ux_[n+d*this.width]*M,T=this._uy_[h+o*this.width]*a+this._uy_[e+_*this.width]*u+this._uy_[s+l*this.width]*c+this._uy_[n+d*this.width]*M,{x:N/4,y:T/4}}paintTexture(){var t=0,i=Math.pow(1.2,Number(ti.value)),h=Zt.selectedIndex;h==4&&this.computeCurl();for(var e=0;e<this.height;e++)for(var s=0;s<this.width;s++){if(this.barrier[s+e*this.width])t=m+1;else{if(h==0)t=Math.round(m*((this._rho_[s+e*this.width]-1)*6*i+.5));else if(h==1)t=Math.round(m*(this._ux_[s+e*this.width]*2*i+.5));else if(h==2)t=Math.round(m*(this._uy_[s+e*this.width]*2*i+.5));else if(h==3){var n=Math.sqrt(this._ux_[s+e*this.width]*this._ux_[s+e*this.width]+this._uy_[s+e*this.width]*this._uy_[s+e*this.width]);t=Math.round(m*(n*4*i))}else t=Math.round(m*(this._curl_[s+e*this.width]*5*i+.5));t<0&&(t=0),t>m&&(t=m)}let o=!1;(this._curl_[s+e*this.width]>.005||this._curl_[s+e*this.width]<-.005)&&(o=!0),this.colorSquare(s,e,nt[t],lt[t],rt[t],o)}h==4&&this.computeCurl();for(var e=0;e<this.height;e++)for(var s=0;s<this.width;s++){if(this.find_cell(s,e).barrier)t=m+1;else{if(h==0)t=Math.round(m*((this.find_cell(s,e)._rho_-1)*6*i+.5));else if(h==1)t=Math.round(m*(this.find_cell(s,e)._ux_*2*i+.5));else if(h==2)t=Math.round(m*(this.find_cell(s,e)._uy_*2*i+.5));else if(h==3){var n=Math.sqrt(this.find_cell(s,e)._ux_*this.find_cell(s,e)._ux_+this.find_cell(s,e)._uy_*this.find_cell(s,e)._uy_);t=Math.round(m*(n*4*i))}else t=Math.round(m*(this.find_cell(s,e)._curl_*5*i+.5));t<0&&(t=0),t>m&&(t=m)}let l=!1;(this.find_cell(s,e)._curl_>.005||this.find_cell(s,e)._curl_<-.005)&&(l=!0),this.colorSquare(s,e,nt[t],lt[t],rt[t],l)}}colorSquare(t,i,h,e,s,n){if(this.texture!==void 0)for(var o=0;o<this.oversampling;o++)for(var _=0;_<this.oversampling;_++){var l=(t*this.oversampling+o+(i*this.oversampling+_)*this.width*this.oversampling)*4;if(this.texture.image.data[l+0]=h,this.texture.image.data[l+1]=e,this.texture.image.data[l+2]=s,this.texture.image.data[l+3]=255,n===!0){var d=(t*this.oversampling+0+(i*this.oversampling+0)*this.width*this.oversampling)*4;this.texture.image.data[d+0]=255,this.texture.image.data[d+1]=0,this.texture.image.data[d+2]=0,this.texture.image.data[d+3]=255}}}computeCurl(){for(var t=1;t<this.height-1;t++)for(var i=1;i<this.width-1;i++)this._curl_[i+t*this.width]=this._uy_[i+1+t*this.width]-this._uy_[i-1+t*this.width]-this._ux_[i+(t+1)*this.width]+this._ux_[i+(t-1)*this.width],this.find_cell(i,t).calculate_curl()}}window.requestAnimFrame=function(r){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1)}}();let J=gt,P=J.Vec2;function Wt(r){for(var t=0,i=0;i<r.length;i++)t+=r[i];return t}function Nt(r){return Math.PI/180*r}function hi(r){return 180/Math.PI*Math.atan2(Wt(r.map(Nt).map(Math.sin))/r.length,Wt(r.map(Nt).map(Math.cos))/r.length)}class _i{constructor(t,i,h,e,s){this.bm=s,this.world=void 0,this.width=t,this.height=i,this.wind_direction=h,this.wind_speed=e,this.show_forces=!0,this.show_fields=!1,this.camera_follow_target=void 0,this.camera_follow=!1,this.camera_zoom=30,this.camera_zoom_max=70,this.camera_zoom_min=10,this.camera_position_x=0,this.camera_position_y=0,this.camera_position_x_max=30,this.camera_position_x_min=-30,this.camera_position_y_max=30,this.camera_position_y_min=-30}physics_model_init(){this.world=new yt.World(P(0,0));let t=this.world.createBody(P(0,0)),i={density:0,restitution:.4};t.createFixture(J.Edge(P(-this.width/2+2,-this.height/2+2),P(-this.width/2+2,this.height/2-2)),i),t.createFixture(J.Edge(P(this.width/2-2,-this.height/2+2),P(this.width/2-2,this.height/2-2)),i),t.createFixture(J.Edge(P(-this.width/2+2,this.height/2-2),P(this.width/2-2,this.height/2-2)),i),t.createFixture(J.Edge(P(-this.width/2+2,-this.height/2+2),P(this.width/2-2,-this.height/2+2)),i),this.world.createDynamicBody(P(0,14.5)).createFixture(yt.Circle(.5),10),this.world.createDynamicBody(P(0,20)).createFixture(yt.Circle(5),10)}get_wind_speed(t,i){let h=this.bm.get_field_velocity(t,i),e=this.bm.get_field_velocity(t-1,i),s=this.bm.get_field_velocity(t+1,i),n=this.bm.get_field_velocity(t,i-1),o=this.bm.get_field_velocity(t,i+1),_=0;return _+=Math.sqrt(h.x*h.x+h.y*h.y),_+=Math.sqrt(e.x*e.x+e.y*e.y),_+=Math.sqrt(s.x*s.x+s.y*s.y),_+=Math.sqrt(n.x*n.x+n.y*n.y),_+=Math.sqrt(o.x*o.x+o.y*o.y),_/5*100*4}get_wind_direction(t,i){let h=this.bm.get_field_velocity(t,i),e=this.bm.get_field_velocity(t-1,i),s=this.bm.get_field_velocity(t+1,i),n=this.bm.get_field_velocity(t,i-1),o=this.bm.get_field_velocity(t,i+1),_=[Math.atan2(h.y,h.x)/Math.PI*180+180,Math.atan2(e.y,e.x)/Math.PI*180+180,Math.atan2(s.y,s.x)/Math.PI*180+180,Math.atan2(n.y,n.x)/Math.PI*180+180,Math.atan2(o.y,o.x)/Math.PI*180+180];return hi(_)}set_camera_follow_target(t){this.camera_follow_target=t}physics_model_step(){this.camera_follow===!0&&this.camera_follow_target!==void 0&&(this.camera_position_x=this.camera_follow_target.x,this.camera_position_y=this.camera_follow_target.y,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min))}input_show_fields(t){this.show_fields=t}input_show_forces(t){this.show_forces=t}input_camera_follow(t){this.camera_follow=t}input_camera_zoom_relative(t){this.camera_zoom+=t,this.camera_zoom>this.camera_zoom_max&&(this.camera_zoom=this.camera_zoom_max),this.camera_zoom<this.camera_zoom_min&&(this.camera_zoom=this.camera_zoom_min)}input_camera_move_relative(t,i){this.camera_position_x+=t,this.camera_position_y+=i,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min)}}let kt=gt,g=kt.Vec2;class A{constructor(t,i,h,e){this.map=t,this.x=i,this.y=h,e!=null?this.hull_angle=e:this.hull_angle=Math.PI,this.wind_direction=0,this.wind_speed=0,this.hull_mass=6,this.hull_shape=kt.Polygon([g(0,-2.25),g(-.5,-1.25),g(-.75,-.25),g(-.75,.5),g(-.5,1.75),g(.5,1.75),g(.75,.5),g(.75,-.25),g(.5,-1.25),g(0,-2.25)]),this.rudder_input=0,this.motor_input=0,this.rudder_angle=0,this.rudder_angle_last=0,this.rudder_angle_max=60,this.rudder_position=1.8,this.rudder_lenght=.5,this.forces=[],this.mainsail_leading_edge_position=-.8,this.mainsail_boom_length=2.2,this.mainsail_boom_angle_max=80,this.mainsail_boom_angle_factor=.5,this.mainsail_boom_angle=0,this.mainsail_boom_angle_actual=0,this.jib_leading_edge_position=-2,this.jib_boom_length=1.4,this.jib_boom_angle_max=55,this.jib_boom_angle_factor=.65,this.jib_boom_angle=0,this.jib_boom_angle_actual=0,this.center_of_lift=-.05,this.centerboard_position=-.15,this.centerboard_length=.6,this.aero_lookup_resolution=5,this.aero_lift_lookup=[0,.025,.15,.9,1.3,1.46,1.52,1.51,1.45,1.41,1.33,1.16,.95,.82,.73,.6,.43,.34,.28,.28,.28],this.aero_drag_lookup=[.15,.15,.15,.16,.172,.19,.22,.25,.29,.34,.4,.47,.55,.635,.73,.83,.95,1.1,1.28,1.28,1.28],this.physics_model=void 0,this.power=0,this.power_direction=0,this.autopilot_enabled=!1,this.autopilot_heading_target=0,this.autopilot_heading_input=0,this.autopilot_heading_best_vmg_1=50,this.autopilot_heading_best_vmg_2=160,this.autopilot_compensator_p=0,this.autopilot_compensator_i=0,this.autopilot_compensator_d=0,this.autopilot_compensator_last_error=0,this.autopilot_compensator_current_error=0,this.autopilot_compensator_sum_error=0,this.twa=0,this.physics_model_init()}physics_model_init(){let t=gt,i=t.Vec2,h=this.map.world.createBody({type:"dynamic",angularDamping:.5,linearDamping:.1,position:i(this.x,this.y),angle:this.hull_angle,allowSleep:!1});h.createFixture(this.hull_shape,this.hull_mass),this.physics_model=h}physics_model_deinit(){this.map.world.destroyBody(this.physics_model)}physics_model_step(){this.forces=[],document.getElementById("info").innerHTML="Autopilot"+this.autopilot_enabled+"<br>",document.getElementById("info").innerHTML+="Heading Target"+this.autopilot_heading_target+"<br>",this.x=this.physics_model.m_xf.p.x,this.y=this.physics_model.m_xf.p.y,this.wind_speed=this.map.get_wind_speed(this.x,this.y),this.wind_direction=this.map.get_wind_direction(this.x,this.y);var t=this.physics_model.getAngle();for(this.angle=t,this.hull_angle=t;t<-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;let i=this.physics_model.m_linearVelocity.x*Math.cos(t-Math.PI/2)+this.physics_model.m_linearVelocity.y*Math.sin(t-Math.PI/2),h=this.physics_model.m_linearVelocity.x*Math.cos(t)+this.physics_model.m_linearVelocity.y*Math.sin(t),e=Math.atan2(h,Math.abs(i))*180/Math.PI;e>90?e-=180:e<-90&&(e+=180);let s=-e*Math.abs(i)*Math.abs(i)*2;s>150?s=150:s<-150&&(s=-150);var n=this.physics_model.getWorldVector(g(s,0)),o=this.physics_model.getWorldPoint(g(0,this.centerboard_position));this.physics_model.applyForce(n,o,!0),this.forces.push({name:"centerboard",type:"arrow",vector:n,point:o}),document.getElementById("info").innerHTML+="q/d: "+e+"\xB0<br>";let _=this.map.get_wind_direction(this.x,this.y)-t/Math.PI*180+90,l={};l.x=this.physics_model.m_linearVelocity.x+Math.cos(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y),l.y=this.physics_model.m_linearVelocity.y+Math.sin(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y);let d=Math.atan2(l.y,l.x)/Math.PI*180-t/Math.PI*180+90,a=Math.sqrt(l.x*l.x+l.y*l.y);if(d>180&&(d-=360),d<-180&&(d+=360),_>180&&(_-=360),_<-180&&(_+=360),this.awa=d,this.twa=_,this.motor_input===1){var u=this.physics_model.getWorldVector(g(0,-.3)),c=this.physics_model.getWorldPoint(g(0,2));this.physics_model.applyLinearImpulse(u,c,!0)}if(this.motor_input===-1){var u=this.physics_model.getWorldVector(g(0,.3)),c=this.physics_model.getWorldPoint(g(0,2));this.physics_model.applyLinearImpulse(u,c,!0)}this.rudder_angle_last=this.rudder_angle;let M=0;const v=1-Math.abs(i)>0?1-Math.abs(i)+1:1;if(this.rudder_input===-1)this.rudder_angle<this.rudder_angle_max&&(this.rudder_angle+=v),M=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else if(this.rudder_input===1)this.rudder_angle>-this.rudder_angle_max&&(this.rudder_angle-=v),M=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else{let I=i;i>1&&(I=1),i<-1&&(I=-1),this.rudder_angle=this.rudder_angle*(.98-I/80)}if(this.autopilot_enabled){this.autopilot_compensator_p=2,this.autopilot_compensator_i=0,this.autopilot_compensator_d=100;let I=-(this.autopilot_heading_target- -this.twa);this.autopilot_compensator_sum_error*=.85,this.autopilot_compensator_sum_error+=I,I>180&&(I-=360),I<-180&&(I+=360),document.getElementById("info").innerHTML+="error: "+Math.floor(I)+"\xB0<br>";let Ft=I*this.autopilot_compensator_p,zt=this.autopilot_compensator_sum_error*this.autopilot_compensator_i,Dt=(I-this.autopilot_compensator_last_error)*this.autopilot_compensator_d;this.rudder_angle_target=(Ft+zt+Dt)*Math.sign(i),this.rudder_angle_target>this.rudder_angle_max/2&&(this.rudder_angle_target=this.rudder_angle_max/2),this.rudder_angle_target<-this.rudder_angle_max/2&&(this.rudder_angle_target=-this.rudder_angle_max/2),this.rudder_angle+=(this.rudder_angle_target-this.rudder_angle)/10,this.autopilot_compensator_last_error=I}else this.autopilot_heading_target=-this.twa,this.autopilot_heading_target>180&&(this.autopilot_heading_target-=360),this.autopilot_heading_target<-180&&(this.autopilot_heading_target+=360);let N=this.physics_model.m_angularVelocity*this.rudder_lenght,T=Math.atan2(-h+N,Math.abs(i))/Math.PI*180,k=0;i>0?k=i*(this.rudder_angle+T)/7:k=i*(this.rudder_angle-T)/7,k+=M*2;let H=this.physics_model.getWorldPoint(g(0,this.rudder_position)),C={};C.x=Math.cos(t+this.rudder_angle/180*Math.PI)*k,C.y=Math.sin(t+this.rudder_angle/180*Math.PI)*k,this.physics_model.applyForce(C,H,!0),this.forces.push({name:"rudder",type:"arrow",vector:C,point:H}),document.getElementById("info").innerHTML+="TWA: "+Math.floor(_)+"<br>",document.getElementById("info").innerHTML+="TWS: "+Math.floor(this.wind_speed*10)/10+"<br>",document.getElementById("info").innerHTML+="AWA: "+Math.floor(d)+"<br>",document.getElementById("info").innerHTML+="AWS: "+Math.floor(a*10)/10+"<br>";let O=Math.sqrt(this.physics_model.m_linearVelocity.x*this.physics_model.m_linearVelocity.x+this.physics_model.m_linearVelocity.y*this.physics_model.m_linearVelocity.y),ut=Math.cos(_/180*Math.PI)*O;document.getElementById("info").innerHTML+="BS: "+Math.floor(O*10)/10+"<br>",document.getElementById("info").innerHTML+="VMG: "+Math.floor(ut*10)/10+"<br>",this.jib_boom_angle=this.awa*this.jib_boom_angle_factor,this.jib_boom_angle>this.jib_boom_angle_max&&(this.jib_boom_angle=this.jib_boom_angle_max),this.jib_boom_angle<-this.jib_boom_angle_max&&(this.jib_boom_angle=-this.jib_boom_angle_max),this.mainsail_boom_angle=this.awa*this.mainsail_boom_angle_factor,this.mainsail_boom_angle>this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=this.mainsail_boom_angle_max),this.mainsail_boom_angle<-this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=-this.mainsail_boom_angle_max);const S=Math.floor(Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution),it=Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution-S;let mt=this.aero_drag_lookup[S]*(1-it)+this.aero_drag_lookup[S+1]*it,pt=this.aero_lift_lookup[S]*(1-it)+this.aero_lift_lookup[S+1]*it,K={},Y={};document.getElementById("info").innerHTML+="Cd: "+Math.floor(mt*10)/10+"<br>",document.getElementById("info").innerHTML+="Cl: "+Math.floor(pt*10)/10+"<br>";const et=.15/3;K.x=Math.cos(t+this.awa/180*Math.PI+Math.PI/2)*a*a*mt*et,K.y=Math.sin(t+this.awa/180*Math.PI+Math.PI/2)*a*a*mt*et,Y.x=-Math.sign(this.awa)*Math.cos(t+this.awa/180*Math.PI)*a*a*pt*et,Y.y=-Math.sign(this.awa)*Math.sin(t+this.awa/180*Math.PI)*a*a*pt*et;let q={};q.x=K.x+Y.x,q.y=K.y+Y.y;var st=this.physics_model.getWorldPoint(g(0,this.center_of_lift));this.physics_model.applyForce(Y,st,!0),this.physics_model.applyForce(K,st,!0),this.forces.push({name:"mainsail",type:"arrow",vector:Y,point:st}),this.forces.push({name:"mainsail",type:"arrow",vector:K,point:st}),this.power=Math.sqrt(q.x*q.x+q.y*q.y),this.power_direction=Math.atan2(q.y,q.x)/Math.PI*180,document.getElementById("info").innerHTML+="Power: "+Math.floor(this.power*10)/10+"<br>";var ht={};ht.x=-this.physics_model.m_linearVelocity.x*O,ht.y=-this.physics_model.m_linearVelocity.y*O;var Et=this.physics_model.getWorldPoint(g(0,0));this.physics_model.applyForce(ht,Et,!0),this.forces.push({name:"drag",type:"arrow",vector:ht,point:Et}),this.rudder_input=0,this.motor_input=0}graphics_model_render(){let t=[];this.forces.forEach(a=>{t.push({color:65280,type:"force",x1:a.point.x,y1:a.point.y,x2:a.point.x+a.vector.x/10,y2:a.point.y+a.vector.y/10})});let i={},h=2;this.autopilot_enabled&&(h=10),i.x1=this.physics_model.getWorldPoint(g(0,0)).x,i.y1=this.physics_model.getWorldPoint(g(0,0)).y,i.x2=i.x1+Math.cos((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*h,i.y2=i.y1+Math.sin((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*h,i.color=5596791,i.type="autopilot",t.push(i);let e=this.wind_direction/180*Math.PI;t.push({color:5588087,type:"guide",x1:this.x+Math.cos(e)*3,y1:this.y+Math.sin(e)*3,x2:this.x+Math.cos(e)*5+Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5+Math.sin(e+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(e)*3,y1:this.y+Math.sin(e)*3,x2:this.x+Math.cos(e)*5-Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5-Math.sin(e+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(e)*4.75,y1:this.y+Math.sin(e)*4.75,x2:this.x+Math.cos(e)*5-Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5-Math.sin(e+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(e)*4.75,y1:this.y+Math.sin(e)*4.75,x2:this.x+Math.cos(e)*5+Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5+Math.sin(e+Math.PI/2)*.5}),e=this.awa/180*Math.PI+this.hull_angle-Math.PI/2,t.push({color:5570679,type:"guide",x1:this.x+Math.cos(e)*3,y1:this.y+Math.sin(e)*3,x2:this.x+Math.cos(e)*5+Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5+Math.sin(e+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(e)*3,y1:this.y+Math.sin(e)*3,x2:this.x+Math.cos(e)*5-Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5-Math.sin(e+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(e)*4.75,y1:this.y+Math.sin(e)*4.75,x2:this.x+Math.cos(e)*5-Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5-Math.sin(e+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(e)*4.75,y1:this.y+Math.sin(e)*4.75,x2:this.x+Math.cos(e)*5+Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5+Math.sin(e+Math.PI/2)*.5}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(g(0,this.rudder_position)).x,y1:this.physics_model.getWorldPoint(g(0,this.rudder_position)).y,x2:this.physics_model.getWorldPoint(g(0,this.rudder_position)).x+Math.cos(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght,y2:this.physics_model.getWorldPoint(g(0,this.rudder_position)).y+Math.sin(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(g(0,this.centerboard_position+this.centerboard_length/2)).x,y1:this.physics_model.getWorldPoint(g(0,this.centerboard_position+this.centerboard_length/2)).y,x2:this.physics_model.getWorldPoint(g(0,this.centerboard_position-this.centerboard_length/2)).x,y2:this.physics_model.getWorldPoint(g(0,this.centerboard_position-this.centerboard_length/2)).y});let s=[];s[0]={},s[0].x=this.physics_model.getWorldPoint(g(0,this.mainsail_leading_edge_position)).x,s[0].y=this.physics_model.getWorldPoint(g(0,this.mainsail_leading_edge_position)).y,this.mainsail_boom_angle/this.mainsail_boom_angle_factor,this.mainsail_boom_angle_actual+=(this.mainsail_boom_angle-this.mainsail_boom_angle_actual)/30;let n=this.mainsail_boom_length*.05*Math.abs(this.awa)/30<this.mainsail_boom_length/10?this.mainsail_boom_length*.05*Math.abs(this.awa)/30:this.mainsail_boom_length/10;s[1]={},s[1].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-n*Math.sign(this.mainsail_boom_angle_actual),s[1].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-n*Math.sign(this.mainsail_boom_angle_actual);let o=n;s[2]={},s[2].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-o*Math.sign(this.mainsail_boom_angle_actual),s[2].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-o*Math.sign(this.mainsail_boom_angle_actual),s[3]={},s[3].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,s[3].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,t.push({color:8939263,type:"sail",x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y}),t.push({color:8939263,type:"sail",x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y}),t.push({color:8939263,type:"sail",x1:s[2].x,y1:s[2].y,x2:s[3].x,y2:s[3].y}),this.jib_boom_angle_actual+=(this.jib_boom_angle-this.jib_boom_angle_actual)/20;let _=[];_[0]={},_[0].x=this.physics_model.getWorldPoint(g(0,this.jib_leading_edge_position)).x,_[0].y=this.physics_model.getWorldPoint(g(0,this.jib_leading_edge_position)).y;let l=this.jib_boom_length*.05*Math.abs(this.awa)/15<this.jib_boom_length/3?this.jib_boom_length*.05*Math.abs(this.awa)/15:this.jib_boom_length/3;_[1]={},_[1].x=_[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.jib_boom_angle_actual),_[1].y=_[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.jib_boom_angle_actual);let d=l;if(_[2]={},_[2].x=_[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),_[2].y=_[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),_[3]={},_[3].x=_[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,_[3].y=_[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,t.push({color:8939263,type:"sail",x1:_[0].x,y1:_[0].y,x2:_[1].x,y2:_[1].y}),t.push({color:8939263,type:"sail",x1:_[1].x,y1:_[1].y,x2:_[2].x,y2:_[2].y}),t.push({color:8939263,type:"sail",x1:_[2].x,y1:_[2].y,x2:_[3].x,y2:_[3].y}),this.map.show_fields){const a=10;for(let u=-a;u<a;u++)for(let c=-a;c<a;c++)if(Math.sqrt(u*u+c*c)<a-1){const M=this.map.bm.resolution;let v=Math.floor(this.x*M)/M+u/M,w=Math.floor(this.y*M)/M+c/M,N=this.map.bm.get_field_velocity(v,w);t.push({color:8939263,type:"sail",x1:v,y1:w,x2:v+N.x*30,y2:w+N.y*30})}}return t}input_rudder_left(){this.rudder_input=1,this.autopilot_enabled=!1}input_rudder_right(){this.rudder_input=-1,this.autopilot_enabled=!1}input_motor_forward(){this.motor_input=1}input_motor_reverse(){this.motor_input=-1}input_autopilot_enabled_toggle(){this.autopilot_heading_target<0?this.autopilot_heading_target>-90?this.autopilot_heading_target=-this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=-this.autopilot_heading_best_vmg_2:this.autopilot_heading_target<90?this.autopilot_heading_target=this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=this.autopilot_heading_best_vmg_2,this.autopilot_enabled=!0}input_autopilot_tack_toggle(){this.autopilot_heading_target*=-1,this.autopilot_enabled=!0}input_autopilot_heading_increase(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)<175&&(this.autopilot_heading_target>0?this.autopilot_heading_target+=1:this.autopilot_heading_target-=1)}input_autopilot_heading_decrease(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)>5&&(this.autopilot_heading_target>0?this.autopilot_heading_target-=1:this.autopilot_heading_target+=1)}}const Mt=50,wt=50,Bt=90,jt=15,vt=2;var bt=2,At=bt*Mt*vt,Lt=bt*wt*vt,ai=At*Lt*4,oi=new Uint8Array(ai),U=new Ht(oi,At,Lt,Vt,Rt,Ct);U.magFilter=Ot;U.needsUpdate=!0;var Tt=new Kt({map:U,transparent:!0});Tt.needsUpdate=!0;const G=new si(Mt,wt,vt,Bt,jt,U,bt);let p=new _i(Mt,wt,Bt,jt,G);p.physics_model_init();let Z={},y=[],Q=0;const ni=new Yt(p.world,{speed:1,fps:30});let b=[],D=[],E=[],qt=[],dt=[];document.onkeydown=ri;document.onkeyup=di;document.getElementById("camera_follow").checked=!1;document.getElementById("show_forces").checked=!0;document.getElementById("show_field").checked=!1;document.getElementById("show_forces").addEventListener("change",r=>{p.input_show_forces(document.getElementById("show_forces").checked)});document.getElementById("scenario_selector").addEventListener("change",r=>{console.log(document.getElementById("scenario_selector").value),xt(f[document.getElementById("scenario_selector").value])});document.getElementById("scenario_restart").addEventListener("click",r=>{console.log("restart"),xt(f[document.getElementById("scenario_selector").value])});document.getElementById("show_field").addEventListener("change",r=>{p.input_show_fields(document.getElementById("show_field").checked)});document.getElementById("windAngle").addEventListener("change",r=>{let t=parseInt(document.getElementById("windAngle").value);p.bm.direction=t+180});document.getElementById("camera_follow").addEventListener("change",r=>{p.input_camera_follow(document.getElementById("camera_follow").checked)});document.getElementById("camera_zoom_in").addEventListener("click",r=>{p.input_camera_zoom_relative(-2)});document.getElementById("camera_zoom_out").addEventListener("click",r=>{p.input_camera_zoom_relative(2)});document.getElementById("camera_move_left").addEventListener("click",r=>{p.input_camera_move_relative(-5,0)});document.getElementById("camera_move_right").addEventListener("click",r=>{p.input_camera_move_relative(5,0)});document.getElementById("camera_move_up").addEventListener("click",r=>{p.input_camera_move_relative(0,5)});document.getElementById("camera_move_down").addEventListener("click",r=>{p.input_camera_move_relative(0,-5)});var li=function(r){r.pageX,r.pageY;var t=new F,i=new F;t.set(r.clientX/window.innerWidth*2-1,-(r.clientY/window.innerHeight)*2+1,.5),t.unproject(W),t.sub(W.position).normalize();var h=-W.position.z/t.z;i.copy(W.position).add(t.multiplyScalar(h));let e=p.get_wind_direction(i.x,i.y),s=p.get_wind_speed(i.x,i.y),n=G.get_field_velocity(i.x,i.y).x,o=G.get_field_velocity(i.x,i.y).y;e=Math.atan2(o,n)/Math.PI*180,s=Math.sqrt(n*n+o*o),document.getElementById("wind_info").innerHTML="Speed: "+Math.floor(s*1e3)/10+"<br>Direction: "+Math.floor(e*10)/10};document.addEventListener("mousemove",li);function ri(r){r=r||window.event,D[r.keyCode]=!0,b.forEach(t=>{t.type==="KEYDOWN"&&D[t.activation_key]&&(D[t.prohibition_key]===!1||D[t.prohibition_key]===void 0)&&t.object[t.input_handler]()})}function di(r){r=r||window.event,D[r.keyCode]=!1}function ct(){Z={},b=[],y.forEach(r=>{r.physics_model_deinit()}),y=[],Q=0}function xt(r){ct(),Z=r}function tt(r){b=[],r[0]!==void 0&&(b.push({type:"PRESSED",activation_key:37,prohibition_key:39,object:r[0],input_handler:r[0].input_rudder_left.name}),b.push({type:"PRESSED",activation_key:39,prohibition_key:37,object:r[0],input_handler:r[0].input_rudder_right.name}),b.push({type:"PRESSED",activation_key:40,prohibition_key:38,object:r[0],input_handler:r[0].input_autopilot_heading_increase.name}),b.push({type:"PRESSED",activation_key:38,prohibition_key:40,object:r[0],input_handler:r[0].input_autopilot_heading_decrease.name}),b.push({type:"KEYDOWN",activation_key:32,prohibition_key:-1,object:r[0],input_handler:r[0].input_autopilot_enabled_toggle.name}),b.push({type:"KEYDOWN",activation_key:13,prohibition_key:-1,object:r[0],input_handler:r[0].input_autopilot_tack_toggle.name})),r[1]!==void 0&&(b.push({type:"PRESSED",activation_key:65,prohibition_key:68,object:r[1],input_handler:r[1].input_rudder_left.name}),b.push({type:"PRESSED",activation_key:68,prohibition_key:65,object:r[1],input_handler:r[1].input_rudder_right.name}),b.push({type:"PRESSED",activation_key:83,prohibition_key:87,object:r[1],input_handler:r[1].input_autopilot_heading_increase.name}),b.push({type:"PRESSED",activation_key:87,prohibition_key:83,object:r[1],input_handler:r[1].input_autopilot_heading_decrease.name}),b.push({type:"KEYDOWN",activation_key:17,prohibition_key:-1,object:r[1],input_handler:r[0].input_autopilot_enabled_toggle.name}),b.push({type:"KEYDOWN",activation_key:16,prohibition_key:-1,object:r[1],input_handler:r[0].input_autopilot_tack_toggle.name}))}let f=[];f[0]=[];f[0][0]=()=>{y.push(new A(p,10,-9,5*Math.PI/4))};f[0][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle()};f[0][2]=()=>{tt(y)};f[1]=[];f[1][0]=()=>{y.push(new A(p,12,-6,5*Math.PI/4)),y.push(new A(p,15,-11.5,5*Math.PI/4))};f[1][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};f[1][2]=()=>{tt(y)};f[2]=[];f[2][0]=()=>{y.push(new A(p,-10,-6,3*Math.PI/4)),y.push(new A(p,15,-11.5,5*Math.PI/4))};f[2][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};f[2][2]=()=>{tt(y)};f[2][2e3]=()=>{ct()};f[3]=[];f[3][0]=()=>{y.push(new A(p,-3,-3,3*Math.PI/4)),y.push(new A(p,18,-11.5,5*Math.PI/4))};f[3][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};f[3][2]=()=>{tt(y)};f[3][350]=()=>{y[0].input_autopilot_tack_toggle()};f[3][2e3]=()=>{ct()};f[4]=[];f[4][0]=()=>{y.push(new A(p,-3,-4,3*Math.PI/4)),y.push(new A(p,18,-11.5,5*Math.PI/4))};f[4][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};f[4][2]=()=>{tt(y)};f[4][300]=()=>{y[0].input_autopilot_tack_toggle()};f[4][700]=()=>{y[1].input_autopilot_heading_decrease()};f[4][701]=()=>{y[1].input_autopilot_heading_decrease()};f[4][702]=()=>{y[1].input_autopilot_heading_decrease()};f[4][2e3]=()=>{ct()};f[5]=[];xt(f[document.getElementById("scenario_selector").value]);ni.start(()=>{dt=[],Z!==void 0&&Z[Q]!==void 0&&(console.log("Frame ",Q),Z[Q]()),b.forEach(i=>{i.type==="PRESSED"&&D[i.activation_key]===!0&&(D[i.prohibition_key]===!1||D[i.prohibition_key]===void 0)&&i.object[i.input_handler]()}),p.set_camera_follow_target(y[0]),p.physics_model_step();let r=0;y.forEach((i,h)=>{y.forEach((o,_)=>{if(_>h){let l=i.x-o.x,d=i.y-o.y;r+=Math.sqrt(l*l+d*d),document.getElementById("dist_info").innerHTML="Dist: "+Math.floor(r*100)/100+"<br>"}}),i.physics_model_step(),dt=[...dt,...i.graphics_model_render()];let e={},s=i.awa/180*Math.PI+i.hull_angle-Math.PI/2;e.x=i.x+Math.cos(s)*-1.8,e.y=i.y+Math.sin(s)*-1.8,Math.cos(i.power_direction/180*Math.PI)*i.power/1e4,Math.sin(i.power_direction/180*Math.PI)*i.power/1e4;const n=1.5;e.x0=i.x+Math.cos(i.hull_angle+90/180*Math.PI)*-n+Math.cos(s)*-2,e.y0=i.y+Math.sin(i.hull_angle+90/180*Math.PI)*-n+Math.sin(s)*-2,e.x1=i.x+Math.cos(i.hull_angle+90/180*Math.PI)*0+Math.cos(s)*-2,e.y1=i.y+Math.sin(i.hull_angle+90/180*Math.PI)*0+Math.sin(s)*-2,e.x2=i.x+Math.cos(i.hull_angle+90/180*Math.PI)*+n+Math.cos(s)*-2,e.y2=i.y+Math.sin(i.hull_angle+90/180*Math.PI)*+n+Math.sin(s)*-2,p.bm.apply_energy(e.x0,e.y0,i.power_direction,i.power/5e3),p.bm.apply_energy(e.x1,e.y1,i.power_direction,i.power/2e3),p.bm.apply_energy(e.x2,e.y2,i.power_direction,i.power/5e3),document.getElementById("info").innerHTML+="Phys Time: "+G.t_delta+"<br>"}),Q%1==0&&p.bm.physics_model_step(),Q++;let t={};t.x=0,t.y=0,G.step_ready&&(X.copyTextureToTexture(t,U,U),G.step_ready=!1),p.show_fields},()=>{});let W,L,X;ci();function ci(){W=new Ut(70,window.innerWidth/window.innerHeight,.01,85),W.position.z=60,W.position.y=20,L=new Gt,new It(6706517),new It(5592422);const r=new Qt(p.width,p.height);let t=new Xt(r,Tt);t.position.x=0,t.position.y=0,t.position.z=-.01,L.add(t),X=new $t({antialias:!0}),X.setSize(window.innerWidth,window.innerHeight),X.setAnimationLoop(ui),document.body.appendChild(X.domElement)}function ui(r){W.position.x=p.camera_position_x,W.position.y=p.camera_position_y,W.position.z=p.camera_zoom;for(let t of E)L.remove(t),t.geometry.dispose(),t.material.dispose(),t=void 0;for(let t of qt)L.remove(t),t.geometry.dispose!==void 0&&t.geometry.dispose(),t.material.dispose!==void 0&&t.material.dispose(),t=void 0;E=[],qt=[];for(let t=p.world.getBodyList();t;t=t.getNext())for(let i=t.getFixtureList();i;i=i.getNext()){if(t.render&&t.render.hidden)continue;t.render&&t.render.stroke||t.isDynamic()||t.isKinematic()||t.isStatic();const h=i.getType(),e=i.getShape();if(h==="circle"){const s=e.m_radius,n=t.getPosition();let o=[];for(let d=0;d<360;d+=10){let a=d/180*Math.PI,u=s*Math.cos(a)+n.x,c=s*Math.sin(a)+n.y;o.push(new F(u,c,0))}o.push(o[0]);const _=new _t().setFromPoints(o),l=new $({color:65280});E.push(new at(_,l)),L.add(E[E.length-1])}if(h==="edge"){let s=[];const n=e.m_vertex1,o=e.m_vertex2;let _=n.x+t.m_xf.p.x,l=n.y+t.m_xf.p.y,d=o.x+t.m_xf.p.x,a=o.y+t.m_xf.p.y;s.push(new F(_,l,0)),s.push(new F(d,a,0));const u=new _t().setFromPoints(s),c=new $({color:16711680});E.push(new at(u,c)),L.add(E[E.length-1])}if(h==="polygon"){let s=e.m_vertices;s.push(s[0]);let n=[];for(const l of s){let d=t.getAngle()+Math.PI,a=t.getLocalCenter(),u=(l.x+a.x)*Math.cos(d)+(l.y-a.y)*Math.sin(d),c=(l.x+a.x)*Math.sin(d)-(l.y-a.y)*Math.cos(d),M=0;u+=i.m_body.c_position.c.x,c+=i.m_body.c_position.c.y,n.push(new F(u,c,M))}const o=new _t().setFromPoints(n),_=new $({color:255});E.push(new at(o,_)),L.add(E[E.length-1])}}for(const t of dt){if(p.show_forces==!1&&t.type==="force")continue;let i=[];i.push(new F(t.x1,t.y1,0)),i.push(new F(t.x2,t.y2,0));const h=new _t().setFromPoints(i);let e=t.color;e===void 0&&(e=16711680);let s,n,o;t.opacity!==void 0?(n=!0,s=t.opacity,o=new $({color:e,transparent:n,opacity:s})):o=new $({color:e}),E.push(new at(h,o)),L.add(E[E.length-1])}X.render(L,W)}
