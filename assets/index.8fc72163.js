import{p as mt,l as ut,D as Vt,R as Rt,U as Ct,a as Ot,N as Kt,M as Yt,b as Ut,P as Gt,S as Qt,C as Pt,c as Xt,d as $t,W as Jt,B as ot,L as Q,e as nt,V as T}from"./vendor.601f039e.js";const Zt=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function i(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerpolicy&&(s.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?s.credentials="include":e.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(e){if(e.ep)return;e.ep=!0;const s=i(e);fetch(e.href,s)}};Zt();var X=document.getElementById("theCanvas"),ti=X.getContext("2d"),ii=document.getElementById("plotSelect"),ei=document.getElementById("contrastSlider"),si=document.getElementById("rafCheck");const Et=4/9,$=1/9,J=1/36;var M=400,St=new Array(M+2),pt=new Array(M+2),gt=new Array(M+2),yt=new Array(M+2);for(var v=0;v<=M;v++){var F,D,H;v<M/8?(F=0,D=0,H=Math.round(255*(v+M/8)/(M/4))):v<3*M/8?(F=0,D=Math.round(255*(v-M/8)/(M/4)),H=255):v<5*M/8?(F=Math.round(255*(v-3*M/8)/(M/4)),D=255,H=255-F):v<7*M/8?(F=255,D=Math.round(255*(7*M/8-v)/(M/4)),H=0):(F=Math.round(255*(9*M/8-v)/(M/4)),D=0,H=0),pt[v]=F,gt[v]=D,yt[v]=H,St[v]=Wt(F,D,H)}pt[M+1]=0;gt[M+1]=0;yt[M+1]=0;St[M+1]=Wt(0,0,0);function ft(_){var t=_.toString(16);return t.length==1?"0"+t:t}function Wt(_,t,i){return"#"+ft(_)+ft(t)+ft(i)}class hi{constructor(t,i,a,e,s,l,n){this.oversampling=n,this.texture=l,this.resolution=a,this.width=t*this.resolution,this.height=i*this.resolution,this.direction=e+180,this.step_ready=!1,this.t_delta=0,X.width=this.width,X.height=this.height,this.speed=s/100,this.viscosity=.02,this._n0_=new Array(this.width*this.height),this._nN_=new Array(this.width*this.height),this._nS_=new Array(this.width*this.height),this._nE_=new Array(this.width*this.height),this._nW_=new Array(this.width*this.height),this._nNE_=new Array(this.width*this.height),this._nSE_=new Array(this.width*this.height),this._nNW_=new Array(this.width*this.height),this._nSW_=new Array(this.width*this.height),this._ux_=new Array(this.width*this.height),this._uy_=new Array(this.width*this.height),this._rho_=new Array(this.width*this.height),this._curl_=new Array(this.width*this.height),this.barrier=new Array(this.width*this.height);for(var h=0;h<this.height;h++)for(var r=0;r<this.width;r++){this.barrier[r+h*this.width]=!1;let o=5;Math.pow(this.width/2-r,2)+Math.pow(this.height*.75-h,2)<Math.pow(o,2)&&(this.barrier[r+h*this.width]=!0)}this.image=ti.createImageData(X.width,X.height);for(var d=3;d<this.image.data.length;d+=4)this.image.data[d]=255;this.running=!1,this.initFluid(),this.startStop(),this.graphics_model_init()}initFluid(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,i=Math.sin(this.direction/180*Math.PI)*this.speed;console.log(t,i);for(var a=0;a<this.height;a++)for(var e=0;e<this.width;e++)this.setEquil(e,a,t,i,1),this._curl_[e+a*this.width]=0}startStop(){this.running=!this.running,this.running&&this.physics_model_step()}physics_model_step(){let t=new Date;for(let s=0;s<1;s++)this.setBoundaries(),this.collide(),this.stream();this.t_delta=new Date-t,this.step_ready=!0;for(var i=!0,a=0;a<this.width;a++){var e=a+this.height/2*this.width;this._rho_[e]<=0&&(i=!1)}i||(window.alert("The simulation has become unstable due to excessive fluid speeds."),this.startStop(),this.initFluid()),this.graphics_model_init()}graphics_model_init(){this.graphics_model_step()}graphics_model_step(){this.paintCanvas(),this.running&&(si.checked?requestAnimFrame(this.graphics_model_step_handler.bind(this)):window.setTimeout(this.graphics_model_step_handler.bind(this),10))}graphics_model_step_handler(){this.graphics_model_step()}setBoundaries(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,i=Math.sin(this.direction/180*Math.PI)*this.speed;for(var a=0;a<this.width;a++)this.setEquil(a,0,t,i,1),this.setEquil(a,this.height-1,t,i,1);for(var e=1;e<this.height-1;e++)this.setEquil(0,e,t,i,1),this.setEquil(this.width-1,e,t,i,1)}collide(){for(var t=1/(3*this.viscosity+.5),i=1;i<this.height-1;i++)for(var a=1;a<this.width-1;a++){var e=a+i*this.width,s=this._n0_[e]+this._nN_[e]+this._nS_[e]+this._nE_[e]+this._nW_[e]+this._nNW_[e]+this._nNE_[e]+this._nSW_[e]+this._nSE_[e];this._rho_[e]=s;var l=(this._nE_[e]+this._nNE_[e]+this._nSE_[e]-this._nW_[e]-this._nNW_[e]-this._nSW_[e])/s;this._ux_[e]=l;var n=(this._nN_[e]+this._nNE_[e]+this._nNW_[e]-this._nS_[e]-this._nSE_[e]-this._nSW_[e])/s;this._uy_[e]=n;var h=$*s,r=J*s,d=3*l,o=3*n,m=l*l,c=n*n,f=2*l*n,b=m+c,w=1.5*b;this._n0_[e]+=t*(Et*s*(1-w)-this._n0_[e]),this._nE_[e]+=t*(h*(1+d+4.5*m-w)-this._nE_[e]),this._nW_[e]+=t*(h*(1-d+4.5*m-w)-this._nW_[e]),this._nN_[e]+=t*(h*(1+o+4.5*c-w)-this._nN_[e]),this._nS_[e]+=t*(h*(1-o+4.5*c-w)-this._nS_[e]),this._nNE_[e]+=t*(r*(1+d+o+4.5*(b+f)-w)-this._nNE_[e]),this._nSE_[e]+=t*(r*(1+d-o+4.5*(b-f)-w)-this._nSE_[e]),this._nNW_[e]+=t*(r*(1-d+o+4.5*(b-f)-w)-this._nNW_[e]),this._nSW_[e]+=t*(r*(1-d-o+4.5*(b+f)-w)-this._nSW_[e])}for(var i=1;i<this.height-2;i++)this._nW_[this.width-1+i*this.width]=this._nW_[this.width-2+i*this.width],this._nNW_[this.width-1+i*this.width]=this._nNW_[this.width-2+i*this.width],this._nSW_[this.width-1+i*this.width]=this._nSW_[this.width-2+i*this.width]}stream(){for(var t=this.height-2;t>0;t--)for(var i=1;i<this.width-1;i++)this._nN_[i+t*this.width]=this._nN_[i+(t-1)*this.width],this._nNW_[i+t*this.width]=this._nNW_[i+1+(t-1)*this.width];for(var t=this.height-2;t>0;t--)for(var i=this.width-2;i>0;i--)this._nE_[i+t*this.width]=this._nE_[i-1+t*this.width],this._nNE_[i+t*this.width]=this._nNE_[i-1+(t-1)*this.width];for(var t=1;t<this.height-1;t++)for(var i=this.width-2;i>0;i--)this._nS_[i+t*this.width]=this._nS_[i+(t+1)*this.width],this._nSE_[i+t*this.width]=this._nSE_[i-1+(t+1)*this.width];for(var t=1;t<this.height-1;t++)for(var i=1;i<this.width-1;i++)this._nW_[i+t*this.width]=this._nW_[i+1+t*this.width],this._nSW_[i+t*this.width]=this._nSW_[i+1+(t+1)*this.width];const a=.7,e=1-a;for(var t=1;t<this.height-1;t++)for(var i=1;i<this.width-1;i++)if(this.barrier[i+t*this.width]){var s=i+t*this.width;this._nE_[i+1+t*this.width]=this._nE_[i+1+t*this.width]*e+this._nW_[s]*a,this._nW_[i-1+t*this.width]=this._nW_[i-1+t*this.width]*e+this._nE_[s]*a,this._nN_[i+(t+1)*this.width]=this._nN_[i+(t+1)*this.width]*e+this._nS_[s]*a,this._nS_[i+(t-1)*this.width]=this._nS_[i+(t-1)*this.width]*e+this._nN_[s]*a,this._nNE_[i+1+(t+1)*this.width]=this._nNE_[i+1+(t+1)*this.width]*e+this._nSW_[s]*a,this._nNW_[i-1+(t+1)*this.width]=this._nNW_[i-1+(t+1)*this.width]*e+this._nSE_[s]*a,this._nSE_[i+1+(t-1)*this.width]=this._nSE_[i+1+(t-1)*this.width]*e+this._nNW_[s]*a,this._nSW_[i-1+(t-1)*this.width]=this._nSW_[i-1+(t-1)*this.width]*e+this._nNE_[s]*a}}setEquil(t,i,a,e,s){var l=t+i*this.width;typeof s=="undefined"&&(s=this._rho_[l]);var n=3*a,h=3*e,r=a*a,d=e*e,o=2*a*e,m=r+d,c=1.5*m;this._n0_[l]=Et*s*(1-c),this._nE_[l]=$*s*(1+n+4.5*r-c),this._nW_[l]=$*s*(1-n+4.5*r-c),this._nN_[l]=$*s*(1+h+4.5*d-c),this._nS_[l]=$*s*(1-h+4.5*d-c),this._nNE_[l]=J*s*(1+n+h+4.5*(m+o)-c),this._nSE_[l]=J*s*(1+n-h+4.5*(m-o)-c),this._nNW_[l]=J*s*(1-n+h+4.5*(m-o)-c),this._nSW_[l]=J*s*(1-n-h+4.5*(m+o)-c),this._rho_[l]=s,this._ux_[l]=a,this._uy_[l]=e}apply_energy(t,i,a,e){document.getElementById("wind_info").innerHTML="dir: "+a+"stre : "+e+"<br>";let s=this.width/2+Math.floor(t*this.resolution),l=this.height/2+Math.floor(i*this.resolution),n,h,r,d,o,m,c,f,b,w,k,L;n=Math.floor(s),o=Math.floor(l),h=n+1,m=o,r=n,c=o+1,d=n+1,f=o+1;let B=s-n,z=l-o;b=(1-B)*(1-z),w=B*(1-z),k=(1-B)*z,L=B*z;let V=[n,h,r,d],R=[o,m,c,f],rt=[b,w,k,L];for(let S=0;S<1;S++)this.apply_force_to_cell(V[S],R[S],a,rt[S]*e)}apply_force_to_cell(t,i,a,e){let s=t+i*this.width,l=this._ux_[s],n=this._uy_[s],h=this._rho_[s],r=Math.cos(a/180*Math.PI)*e/h*-1,d=Math.sin(a/180*Math.PI)*e/h*-1;this.setEquil(t,i,l+r,n+d)}apply_energy_to_cell(t,i,a,e){let s=a+270;s>360&&(s-=360),document.getElementById("wind_info").innerHTML="mirror_angle: "+s+"<br>";const l=[this._nE_,this._nNE_,this._nN_,this._nNW_,this._nW_,this._nSW_,this._nS_,this._nSE_];document.getElementById("wind_info").innerHTML+=JSON.stringify(a)+"<br>";let n=[0,0,0,0,0,0,0,0],h=[0,0,0,0,0,0,0,0],r=[0,0,0,0,0,0,0,0],d=[0,0,0,0,0,0,0,0];for(let o=0;o<8;o++){const m=.1*e,c=(Math.floor(s/45)+1+o)%8;d[o]=c*45,r[o]=s-(d[o]-s),r[o]>360&&(r[o]-=360),r[o]<0&&(r[o]+=360),n[o]=Math.cos(r[o]/180*Math.PI)*l[c][t+i*this.width]*m,h[o]=Math.sin(r[o]/180*Math.PI)*l[c][t+i*this.width]*m,l[c][t+i*this.width]*=1-m}for(let o=0;o<8;o++){const m=(Math.floor(r[o]/45)+1+o)%8;let c,f;m%2==0?Math.abs(n[o])>Math.abs(h[o])?(c=n[o]-h[o],f=h[o]*Math.SQRT2):(c=h[o]-n[o],f=n[o]*Math.SQRT2):Math.abs(n[o])>Math.abs(h[o])?(c=h[o]*Math.SQRT2,f=n[o]-h[o]):(c=n[o]*Math.SQRT2,f=h[o]-n[o]),l[m][t+i*this.width]+=c,l[(m+1)%8][t+i*this.width]+=f;let b=c*1e4,w=f*1e4;document.getElementById("wind_info").innerHTML+="sou: "+d[o]+" mirr: "+Math.floor(r[o])+"<br>",document.getElementById("wind_info").innerHTML+="u: "+Math.floor(b)+" v: "+Math.floor(w)+"<br>"}}get_field_velocity(t,i){t=this.width/2+Math.floor(t*this.resolution),i=this.height/2+Math.floor(i*this.resolution);let a,e,s,l,n,h,r,d,o,m,c,f;a=Math.floor(t),n=Math.floor(i),e=a+1,h=n,s=a,r=n+1,l=a+1,d=n+1;let b=t-a,w=i-n;o=(1-b)*(1-w),m=b*(1-w),c=(1-b)*w,f=b*w;let k=0,L=0;return k=this._ux_[a+n*this.width]*o+this._ux_[e+h*this.width]*m+this._ux_[s+r*this.width]*c+this._ux_[l+d*this.width]*f,L=this._uy_[a+n*this.width]*o+this._uy_[e+h*this.width]*m+this._uy_[s+r*this.width]*c+this._uy_[l+d*this.width]*f,{x:k/4,y:L/4}}paintCanvas(){var t=0,i=Math.pow(1.2,Number(ei.value)),a=ii.selectedIndex;a==4&&this.computeCurl();for(var e=0;e<this.height;e++)for(var s=0;s<this.width;s++){if(this.barrier[s+e*this.width])t=M+1;else{if(a==0)t=Math.round(M*((this._rho_[s+e*this.width]-1)*6*i+.5));else if(a==1)t=Math.round(M*(this._ux_[s+e*this.width]*2*i+.5));else if(a==2)t=Math.round(M*(this._uy_[s+e*this.width]*2*i+.5));else if(a==3){var l=Math.sqrt(this._ux_[s+e*this.width]*this._ux_[s+e*this.width]+this._uy_[s+e*this.width]*this._uy_[s+e*this.width]);t=Math.round(M*(l*4*i))}else t=Math.round(M*(this._curl_[s+e*this.width]*5*i+.5));t<0&&(t=0),t>M&&(t=M)}let n=!1;(this._curl_[s+e*this.width]>.005||this._curl_[s+e*this.width]<-.005)&&(n=!0),this.colorSquare(s,e,pt[t],gt[t],yt[t],n)}}colorSquare(t,i,a,e,s,l){if(this.texture!==void 0)for(var n=0;n<this.oversampling;n++)for(var h=0;h<this.oversampling;h++){var r=(t*this.oversampling+n+(i*this.oversampling+h)*this.width*this.oversampling)*4;if(this.texture.image.data[r+0]=a,this.texture.image.data[r+1]=e,this.texture.image.data[r+2]=s,this.texture.image.data[r+3]=255,l===!0){var d=(t*this.oversampling+0+(i*this.oversampling+0)*this.width*this.oversampling)*4;this.texture.image.data[d+0]=255,this.texture.image.data[d+1]=0,this.texture.image.data[d+2]=0,this.texture.image.data[d+3]=255}}}computeCurl(){for(var t=1;t<this.height-1;t++)for(var i=1;i<this.width-1;i++)this._curl_[i+t*this.width]=this._uy_[i+1+t*this.width]-this._uy_[i-1+t*this.width]-this._ux_[i+(t+1)*this.width]+this._ux_[i+(t-1)*this.width]}}window.requestAnimFrame=function(_){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1)}}();let Z=mt,E=Z.Vec2;function kt(_){for(var t=0,i=0;i<_.length;i++)t+=_[i];return t}function Bt(_){return Math.PI/180*_}function ai(_){return 180/Math.PI*Math.atan2(kt(_.map(Bt).map(Math.sin))/_.length,kt(_.map(Bt).map(Math.cos))/_.length)}class oi{constructor(t,i,a,e,s){this.bm=s,this.world=void 0,this.width=t,this.height=i,this.wind_direction=a,this.wind_speed=e,this.show_forces=!0,this.show_fields=!1,this.camera_follow_target=void 0,this.camera_follow=!1,this.camera_zoom=30,this.camera_zoom_max=70,this.camera_zoom_min=10,this.camera_position_x=0,this.camera_position_y=0,this.camera_position_x_max=30,this.camera_position_x_min=-30,this.camera_position_y_max=30,this.camera_position_y_min=-30}physics_model_init(){this.world=new ut.World(E(0,0));let t=this.world.createBody(E(0,0)),i={density:0,restitution:.4};t.createFixture(Z.Edge(E(-this.width/2+2,-this.height/2+2),E(-this.width/2+2,this.height/2-2)),i),t.createFixture(Z.Edge(E(this.width/2-2,-this.height/2+2),E(this.width/2-2,this.height/2-2)),i),t.createFixture(Z.Edge(E(-this.width/2+2,this.height/2-2),E(this.width/2-2,this.height/2-2)),i),t.createFixture(Z.Edge(E(-this.width/2+2,-this.height/2+2),E(this.width/2-2,-this.height/2+2)),i),this.world.createDynamicBody(E(0,14.5)).createFixture(ut.Circle(.5),10),this.world.createDynamicBody(E(0,20)).createFixture(ut.Circle(5),10)}get_wind_speed(t,i){let a=this.bm.get_field_velocity(t,i),e=this.bm.get_field_velocity(t-1,i),s=this.bm.get_field_velocity(t+1,i),l=this.bm.get_field_velocity(t,i-1),n=this.bm.get_field_velocity(t,i+1),h=0;return h+=Math.sqrt(a.x*a.x+a.y*a.y),h+=Math.sqrt(e.x*e.x+e.y*e.y),h+=Math.sqrt(s.x*s.x+s.y*s.y),h+=Math.sqrt(l.x*l.x+l.y*l.y),h+=Math.sqrt(n.x*n.x+n.y*n.y),h/5*100*4}get_wind_direction(t,i){let a=this.bm.get_field_velocity(t,i),e=this.bm.get_field_velocity(t-1,i),s=this.bm.get_field_velocity(t+1,i),l=this.bm.get_field_velocity(t,i-1),n=this.bm.get_field_velocity(t,i+1),h=[Math.atan2(a.y,a.x)/Math.PI*180+180,Math.atan2(e.y,e.x)/Math.PI*180+180,Math.atan2(s.y,s.x)/Math.PI*180+180,Math.atan2(l.y,l.x)/Math.PI*180+180,Math.atan2(n.y,n.x)/Math.PI*180+180];return ai(h)}set_camera_follow_target(t){this.camera_follow_target=t}physics_model_step(){this.camera_follow===!0&&this.camera_follow_target!==void 0&&(this.camera_position_x=this.camera_follow_target.x,this.camera_position_y=this.camera_follow_target.y,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min))}input_show_fields(t){this.show_fields=t}input_show_forces(t){this.show_forces=t}input_camera_follow(t){this.camera_follow=t}input_camera_zoom_relative(t){this.camera_zoom+=t,this.camera_zoom>this.camera_zoom_max&&(this.camera_zoom=this.camera_zoom_max),this.camera_zoom<this.camera_zoom_min&&(this.camera_zoom=this.camera_zoom_min)}input_camera_move_relative(t,i){this.camera_position_x+=t,this.camera_position_y+=i,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min)}}let jt=mt,p=jt.Vec2;class j{constructor(t,i,a,e){this.map=t,this.x=i,this.y=a,e!=null?this.hull_angle=e:this.hull_angle=Math.PI,this.wind_direction=0,this.wind_speed=0,this.hull_mass=6,this.hull_shape=jt.Polygon([p(0,-2.25),p(-.5,-1.25),p(-.75,-.25),p(-.75,.5),p(-.5,1.75),p(.5,1.75),p(.75,.5),p(.75,-.25),p(.5,-1.25),p(0,-2.25)]),this.rudder_input=0,this.motor_input=0,this.rudder_angle=0,this.rudder_angle_last=0,this.rudder_angle_max=60,this.rudder_position=1.8,this.rudder_lenght=.5,this.forces=[],this.mainsail_leading_edge_position=-.8,this.mainsail_boom_length=2.2,this.mainsail_boom_angle_max=80,this.mainsail_boom_angle_factor=.5,this.mainsail_boom_angle=0,this.mainsail_boom_angle_actual=0,this.jib_leading_edge_position=-2,this.jib_boom_length=1.4,this.jib_boom_angle_max=55,this.jib_boom_angle_factor=.65,this.jib_boom_angle=0,this.jib_boom_angle_actual=0,this.center_of_lift=-.05,this.centerboard_position=-.15,this.centerboard_length=.6,this.aero_lookup_resolution=5,this.aero_lift_lookup=[0,.025,.15,.9,1.3,1.46,1.52,1.51,1.45,1.41,1.33,1.16,.95,.82,.73,.6,.43,.34,.28,.28,.28],this.aero_drag_lookup=[.15,.15,.15,.16,.172,.19,.22,.25,.29,.34,.4,.47,.55,.635,.73,.83,.95,1.1,1.28,1.28,1.28],this.physics_model=void 0,this.power=0,this.power_direction=0,this.autopilot_enabled=!1,this.autopilot_heading_target=0,this.autopilot_heading_input=0,this.autopilot_heading_best_vmg_1=50,this.autopilot_heading_best_vmg_2=160,this.autopilot_compensator_p=0,this.autopilot_compensator_i=0,this.autopilot_compensator_d=0,this.autopilot_compensator_last_error=0,this.autopilot_compensator_current_error=0,this.autopilot_compensator_sum_error=0,this.twa=0,this.physics_model_init()}physics_model_init(){let t=mt,i=t.Vec2,a=this.map.world.createBody({type:"dynamic",angularDamping:.5,linearDamping:.1,position:i(this.x,this.y),angle:this.hull_angle,allowSleep:!1});a.createFixture(this.hull_shape,this.hull_mass),this.physics_model=a}physics_model_deinit(){this.map.world.destroyBody(this.physics_model)}physics_model_step(){this.forces=[],document.getElementById("info").innerHTML="Autopilot"+this.autopilot_enabled+"<br>",document.getElementById("info").innerHTML+="Heading Target"+this.autopilot_heading_target+"<br>",this.x=this.physics_model.m_xf.p.x,this.y=this.physics_model.m_xf.p.y,this.wind_speed=this.map.get_wind_speed(this.x,this.y),this.wind_direction=this.map.get_wind_direction(this.x,this.y);var t=this.physics_model.getAngle();for(this.angle=t,this.hull_angle=t;t<-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;let i=this.physics_model.m_linearVelocity.x*Math.cos(t-Math.PI/2)+this.physics_model.m_linearVelocity.y*Math.sin(t-Math.PI/2),a=this.physics_model.m_linearVelocity.x*Math.cos(t)+this.physics_model.m_linearVelocity.y*Math.sin(t),e=Math.atan2(a,Math.abs(i))*180/Math.PI;e>90?e-=180:e<-90&&(e+=180);let s=-e*Math.abs(i)*Math.abs(i)*2;s>150?s=150:s<-150&&(s=-150);var l=this.physics_model.getWorldVector(p(s,0)),n=this.physics_model.getWorldPoint(p(0,this.centerboard_position));this.physics_model.applyForce(l,n,!0),this.forces.push({name:"centerboard",type:"arrow",vector:l,point:n}),document.getElementById("info").innerHTML+="q/d: "+e+"\xB0<br>";let h=this.map.get_wind_direction(this.x,this.y)-t/Math.PI*180+90,r={};r.x=this.physics_model.m_linearVelocity.x+Math.cos(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y),r.y=this.physics_model.m_linearVelocity.y+Math.sin(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y);let d=Math.atan2(r.y,r.x)/Math.PI*180-t/Math.PI*180+90,o=Math.sqrt(r.x*r.x+r.y*r.y);if(d>180&&(d-=360),d<-180&&(d+=360),h>180&&(h-=360),h<-180&&(h+=360),this.awa=d,this.twa=h,this.motor_input===1){var m=this.physics_model.getWorldVector(p(0,-.3)),c=this.physics_model.getWorldPoint(p(0,2));this.physics_model.applyLinearImpulse(m,c,!0)}if(this.motor_input===-1){var m=this.physics_model.getWorldVector(p(0,.3)),c=this.physics_model.getWorldPoint(p(0,2));this.physics_model.applyLinearImpulse(m,c,!0)}this.rudder_angle_last=this.rudder_angle;let f=0;const b=1-Math.abs(i)>0?1-Math.abs(i)+1:1;if(this.rudder_input===-1)this.rudder_angle<this.rudder_angle_max&&(this.rudder_angle+=b),f=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else if(this.rudder_input===1)this.rudder_angle>-this.rudder_angle_max&&(this.rudder_angle-=b),f=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else{let P=i;i>1&&(P=1),i<-1&&(P=-1),this.rudder_angle=this.rudder_angle*(.98-P/80)}if(this.autopilot_enabled){this.autopilot_compensator_p=2,this.autopilot_compensator_i=0,this.autopilot_compensator_d=100;let P=-(this.autopilot_heading_target- -this.twa);this.autopilot_compensator_sum_error*=.85,this.autopilot_compensator_sum_error+=P,P>180&&(P-=360),P<-180&&(P+=360),document.getElementById("info").innerHTML+="error: "+Math.floor(P)+"\xB0<br>";let zt=P*this.autopilot_compensator_p,Dt=this.autopilot_compensator_sum_error*this.autopilot_compensator_i,Ht=(P-this.autopilot_compensator_last_error)*this.autopilot_compensator_d;this.rudder_angle_target=(zt+Dt+Ht)*Math.sign(i),this.rudder_angle_target>this.rudder_angle_max/2&&(this.rudder_angle_target=this.rudder_angle_max/2),this.rudder_angle_target<-this.rudder_angle_max/2&&(this.rudder_angle_target=-this.rudder_angle_max/2),this.rudder_angle+=(this.rudder_angle_target-this.rudder_angle)/10,this.autopilot_compensator_last_error=P}else this.autopilot_heading_target=-this.twa,this.autopilot_heading_target>180&&(this.autopilot_heading_target-=360),this.autopilot_heading_target<-180&&(this.autopilot_heading_target+=360);let k=this.physics_model.m_angularVelocity*this.rudder_lenght,L=Math.atan2(-a+k,Math.abs(i))/Math.PI*180,B=0;i>0?B=i*(this.rudder_angle+L)/7:B=i*(this.rudder_angle-L)/7,B+=f*2;let z=this.physics_model.getWorldPoint(p(0,this.rudder_position)),V={};V.x=Math.cos(t+this.rudder_angle/180*Math.PI)*B,V.y=Math.sin(t+this.rudder_angle/180*Math.PI)*B,this.physics_model.applyForce(V,z,!0),this.forces.push({name:"rudder",type:"arrow",vector:V,point:z}),document.getElementById("info").innerHTML+="TWA: "+Math.floor(h)+"<br>",document.getElementById("info").innerHTML+="TWS: "+Math.floor(this.wind_speed*10)/10+"<br>",document.getElementById("info").innerHTML+="AWA: "+Math.floor(d)+"<br>",document.getElementById("info").innerHTML+="AWS: "+Math.floor(o*10)/10+"<br>";let R=Math.sqrt(this.physics_model.m_linearVelocity.x*this.physics_model.m_linearVelocity.x+this.physics_model.m_linearVelocity.y*this.physics_model.m_linearVelocity.y),rt=Math.cos(h/180*Math.PI)*R;document.getElementById("info").innerHTML+="BS: "+Math.floor(R*10)/10+"<br>",document.getElementById("info").innerHTML+="VMG: "+Math.floor(rt*10)/10+"<br>",this.jib_boom_angle=this.awa*this.jib_boom_angle_factor,this.jib_boom_angle>this.jib_boom_angle_max&&(this.jib_boom_angle=this.jib_boom_angle_max),this.jib_boom_angle<-this.jib_boom_angle_max&&(this.jib_boom_angle=-this.jib_boom_angle_max),this.mainsail_boom_angle=this.awa*this.mainsail_boom_angle_factor,this.mainsail_boom_angle>this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=this.mainsail_boom_angle_max),this.mainsail_boom_angle<-this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=-this.mainsail_boom_angle_max);const S=Math.floor(Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution),et=Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution-S;let dt=this.aero_drag_lookup[S]*(1-et)+this.aero_drag_lookup[S+1]*et,ct=this.aero_lift_lookup[S]*(1-et)+this.aero_lift_lookup[S+1]*et,C={},O={};document.getElementById("info").innerHTML+="Cd: "+Math.floor(dt*10)/10+"<br>",document.getElementById("info").innerHTML+="Cl: "+Math.floor(ct*10)/10+"<br>";const st=.15;C.x=Math.cos(t+this.awa/180*Math.PI+Math.PI/2)*o*o*dt*st,C.y=Math.sin(t+this.awa/180*Math.PI+Math.PI/2)*o*o*dt*st,O.x=-Math.sign(this.awa)*Math.cos(t+this.awa/180*Math.PI)*o*o*ct*st,O.y=-Math.sign(this.awa)*Math.sin(t+this.awa/180*Math.PI)*o*o*ct*st;let A={};A.x=C.x+O.x,A.y=C.y+O.y;var ht=this.physics_model.getWorldPoint(p(0,this.center_of_lift));this.physics_model.applyForce(O,ht,!0),this.physics_model.applyForce(C,ht,!0),this.forces.push({name:"mainsail",type:"arrow",vector:O,point:ht}),this.forces.push({name:"mainsail",type:"arrow",vector:C,point:ht}),this.power=Math.sqrt(A.x*A.x+A.y*A.y),this.power_direction=Math.atan2(A.y,A.x)/Math.PI*180,document.getElementById("info").innerHTML+="Power: "+Math.floor(this.power*10)/10+"<br>";var at={};at.x=-this.physics_model.m_linearVelocity.x*R,at.y=-this.physics_model.m_linearVelocity.y*R;var It=this.physics_model.getWorldPoint(p(0,0));this.physics_model.applyForce(at,It,!0),this.forces.push({name:"drag",type:"arrow",vector:at,point:It}),this.rudder_input=0,this.motor_input=0}graphics_model_render(){let t=[];this.forces.forEach(o=>{t.push({color:65280,type:"force",x1:o.point.x,y1:o.point.y,x2:o.point.x+o.vector.x/10,y2:o.point.y+o.vector.y/10})});let i={},a=2;this.autopilot_enabled&&(a=10),i.x1=this.physics_model.getWorldPoint(p(0,0)).x,i.y1=this.physics_model.getWorldPoint(p(0,0)).y,i.x2=i.x1+Math.cos((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*a,i.y2=i.y1+Math.sin((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*a,i.color=5596791,i.type="autopilot",t.push(i);let e=this.wind_direction/180*Math.PI;t.push({color:5588087,type:"guide",x1:this.x+Math.cos(e)*3,y1:this.y+Math.sin(e)*3,x2:this.x+Math.cos(e)*5+Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5+Math.sin(e+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(e)*3,y1:this.y+Math.sin(e)*3,x2:this.x+Math.cos(e)*5-Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5-Math.sin(e+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(e)*4.75,y1:this.y+Math.sin(e)*4.75,x2:this.x+Math.cos(e)*5-Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5-Math.sin(e+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(e)*4.75,y1:this.y+Math.sin(e)*4.75,x2:this.x+Math.cos(e)*5+Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5+Math.sin(e+Math.PI/2)*.5}),e=this.awa/180*Math.PI+this.hull_angle-Math.PI/2,t.push({color:5570679,type:"guide",x1:this.x+Math.cos(e)*3,y1:this.y+Math.sin(e)*3,x2:this.x+Math.cos(e)*5+Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5+Math.sin(e+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(e)*3,y1:this.y+Math.sin(e)*3,x2:this.x+Math.cos(e)*5-Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5-Math.sin(e+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(e)*4.75,y1:this.y+Math.sin(e)*4.75,x2:this.x+Math.cos(e)*5-Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5-Math.sin(e+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(e)*4.75,y1:this.y+Math.sin(e)*4.75,x2:this.x+Math.cos(e)*5+Math.cos(e+Math.PI/2)*.5,y2:this.y+Math.sin(e)*5+Math.sin(e+Math.PI/2)*.5}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(p(0,this.rudder_position)).x,y1:this.physics_model.getWorldPoint(p(0,this.rudder_position)).y,x2:this.physics_model.getWorldPoint(p(0,this.rudder_position)).x+Math.cos(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght,y2:this.physics_model.getWorldPoint(p(0,this.rudder_position)).y+Math.sin(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(p(0,this.centerboard_position+this.centerboard_length/2)).x,y1:this.physics_model.getWorldPoint(p(0,this.centerboard_position+this.centerboard_length/2)).y,x2:this.physics_model.getWorldPoint(p(0,this.centerboard_position-this.centerboard_length/2)).x,y2:this.physics_model.getWorldPoint(p(0,this.centerboard_position-this.centerboard_length/2)).y});let s=[];s[0]={},s[0].x=this.physics_model.getWorldPoint(p(0,this.mainsail_leading_edge_position)).x,s[0].y=this.physics_model.getWorldPoint(p(0,this.mainsail_leading_edge_position)).y,this.mainsail_boom_angle/this.mainsail_boom_angle_factor,this.mainsail_boom_angle_actual+=(this.mainsail_boom_angle-this.mainsail_boom_angle_actual)/30;let l=this.mainsail_boom_length*.05*Math.abs(this.awa)/30<this.mainsail_boom_length/10?this.mainsail_boom_length*.05*Math.abs(this.awa)/30:this.mainsail_boom_length/10;s[1]={},s[1].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.mainsail_boom_angle_actual),s[1].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.mainsail_boom_angle_actual);let n=l;s[2]={},s[2].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-n*Math.sign(this.mainsail_boom_angle_actual),s[2].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-n*Math.sign(this.mainsail_boom_angle_actual),s[3]={},s[3].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,s[3].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,t.push({color:8939263,type:"sail",x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y}),t.push({color:8939263,type:"sail",x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y}),t.push({color:8939263,type:"sail",x1:s[2].x,y1:s[2].y,x2:s[3].x,y2:s[3].y}),this.jib_boom_angle_actual+=(this.jib_boom_angle-this.jib_boom_angle_actual)/20;let h=[];h[0]={},h[0].x=this.physics_model.getWorldPoint(p(0,this.jib_leading_edge_position)).x,h[0].y=this.physics_model.getWorldPoint(p(0,this.jib_leading_edge_position)).y;let r=this.jib_boom_length*.05*Math.abs(this.awa)/15<this.jib_boom_length/3?this.jib_boom_length*.05*Math.abs(this.awa)/15:this.jib_boom_length/3;h[1]={},h[1].x=h[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.jib_boom_angle_actual),h[1].y=h[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.jib_boom_angle_actual);let d=r;if(h[2]={},h[2].x=h[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),h[2].y=h[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),h[3]={},h[3].x=h[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,h[3].y=h[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,t.push({color:8939263,type:"sail",x1:h[0].x,y1:h[0].y,x2:h[1].x,y2:h[1].y}),t.push({color:8939263,type:"sail",x1:h[1].x,y1:h[1].y,x2:h[2].x,y2:h[2].y}),t.push({color:8939263,type:"sail",x1:h[2].x,y1:h[2].y,x2:h[3].x,y2:h[3].y}),this.map.show_fields){const o=10;for(let m=-o;m<o;m++)for(let c=-o;c<o;c++)if(Math.sqrt(m*m+c*c)<o-1){const f=this.map.bm.resolution;let b=Math.floor(this.x*f)/f+m/f,w=Math.floor(this.y*f)/f+c/f,k=this.map.bm.get_field_velocity(b,w);t.push({color:8939263,type:"sail",x1:b,y1:w,x2:b+k.x*30,y2:w+k.y*30})}}return t}input_rudder_left(){this.rudder_input=1,this.autopilot_enabled=!1}input_rudder_right(){this.rudder_input=-1,this.autopilot_enabled=!1}input_motor_forward(){this.motor_input=1}input_motor_reverse(){this.motor_input=-1}input_autopilot_enabled_toggle(){this.autopilot_heading_target<0?this.autopilot_heading_target>-90?this.autopilot_heading_target=-this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=-this.autopilot_heading_best_vmg_2:this.autopilot_heading_target<90?this.autopilot_heading_target=this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=this.autopilot_heading_best_vmg_2,this.autopilot_enabled=!0}input_autopilot_tack_toggle(){this.autopilot_heading_target*=-1,this.autopilot_enabled=!0}input_autopilot_heading_increase(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)<175&&(this.autopilot_heading_target>0?this.autopilot_heading_target+=1:this.autopilot_heading_target-=1)}input_autopilot_heading_decrease(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)>5&&(this.autopilot_heading_target>0?this.autopilot_heading_target-=1:this.autopilot_heading_target+=1)}}const Mt=50,wt=50,Nt=90,Lt=7,bt=1.5;var xt=2,At=xt*Mt*bt,Tt=xt*wt*bt,ni=At*Tt*4,_i=new Uint8Array(ni),K=new Vt(_i,At,Tt,Rt,Ct,Ot);K.magFilter=Kt;K.needsUpdate=!0;var Ft=new Yt({map:K,transparent:!0});Ft.needsUpdate=!0;const Y=new hi(Mt,wt,bt,Nt,Lt,K,xt);let u=new oi(Mt,wt,Nt,Lt,Y);u.physics_model_init();let tt={},g=[],U=0;const li=new Ut(u.world,{speed:1,fps:30});let x=[],q=[],I=[],qt=[],_t=[];document.onkeydown=di;document.onkeyup=ci;document.getElementById("camera_follow").checked=!1;document.getElementById("show_forces").checked=!0;document.getElementById("show_field").checked=!1;document.getElementById("show_forces").addEventListener("change",_=>{u.input_show_forces(document.getElementById("show_forces").checked)});document.getElementById("scenario_selector").addEventListener("change",_=>{console.log(document.getElementById("scenario_selector").value),vt(y[document.getElementById("scenario_selector").value])});document.getElementById("scenario_restart").addEventListener("click",_=>{console.log("restart"),vt(y[document.getElementById("scenario_selector").value])});document.getElementById("show_field").addEventListener("change",_=>{u.input_show_fields(document.getElementById("show_field").checked)});document.getElementById("windAngle").addEventListener("change",_=>{let t=parseInt(document.getElementById("windAngle").value);u.bm.direction=t+180});document.getElementById("camera_follow").addEventListener("change",_=>{u.input_camera_follow(document.getElementById("camera_follow").checked)});document.getElementById("camera_zoom_in").addEventListener("click",_=>{u.input_camera_zoom_relative(-2)});document.getElementById("camera_zoom_out").addEventListener("click",_=>{u.input_camera_zoom_relative(2)});document.getElementById("camera_move_left").addEventListener("click",_=>{u.input_camera_move_relative(-5,0)});document.getElementById("camera_move_right").addEventListener("click",_=>{u.input_camera_move_relative(5,0)});document.getElementById("camera_move_up").addEventListener("click",_=>{u.input_camera_move_relative(0,5)});document.getElementById("camera_move_down").addEventListener("click",_=>{u.input_camera_move_relative(0,-5)});var ri=function(_){_.pageX,_.pageY;var t=new T,i=new T;t.set(_.clientX/window.innerWidth*2-1,-(_.clientY/window.innerHeight)*2+1,.5),t.unproject(W),t.sub(W.position).normalize();var a=-W.position.z/t.z;i.copy(W.position).add(t.multiplyScalar(a));let e=u.get_wind_direction(i.x,i.y),s=u.get_wind_speed(i.x,i.y),l=Y.get_field_velocity(i.x,i.y).x,n=Y.get_field_velocity(i.x,i.y).y;e=Math.atan2(n,l)/Math.PI*180,s=Math.sqrt(l*l+n*n),document.getElementById("wind_info").innerHTML="Speed: "+Math.floor(s*1e3)/10+"<br>Direction: "+Math.floor(e*10)/10};document.addEventListener("mousemove",ri);function di(_){_=_||window.event,q[_.keyCode]=!0,x.forEach(t=>{t.type==="KEYDOWN"&&q[t.activation_key]&&(q[t.prohibition_key]===!1||q[t.prohibition_key]===void 0)&&t.object[t.input_handler]()})}function ci(_){_=_||window.event,q[_.keyCode]=!1}function lt(){tt={},x=[],g.forEach(_=>{_.physics_model_deinit()}),g=[],U=0}function vt(_){lt(),tt=_}function it(_){x=[],_[0]!==void 0&&(x.push({type:"PRESSED",activation_key:37,prohibition_key:39,object:_[0],input_handler:_[0].input_rudder_left.name}),x.push({type:"PRESSED",activation_key:39,prohibition_key:37,object:_[0],input_handler:_[0].input_rudder_right.name}),x.push({type:"PRESSED",activation_key:40,prohibition_key:38,object:_[0],input_handler:_[0].input_autopilot_heading_increase.name}),x.push({type:"PRESSED",activation_key:38,prohibition_key:40,object:_[0],input_handler:_[0].input_autopilot_heading_decrease.name}),x.push({type:"KEYDOWN",activation_key:32,prohibition_key:-1,object:_[0],input_handler:_[0].input_autopilot_enabled_toggle.name}),x.push({type:"KEYDOWN",activation_key:13,prohibition_key:-1,object:_[0],input_handler:_[0].input_autopilot_tack_toggle.name})),_[1]!==void 0&&(x.push({type:"PRESSED",activation_key:65,prohibition_key:68,object:_[1],input_handler:_[1].input_rudder_left.name}),x.push({type:"PRESSED",activation_key:68,prohibition_key:65,object:_[1],input_handler:_[1].input_rudder_right.name}),x.push({type:"PRESSED",activation_key:83,prohibition_key:87,object:_[1],input_handler:_[1].input_autopilot_heading_increase.name}),x.push({type:"PRESSED",activation_key:87,prohibition_key:83,object:_[1],input_handler:_[1].input_autopilot_heading_decrease.name}),x.push({type:"KEYDOWN",activation_key:17,prohibition_key:-1,object:_[1],input_handler:_[0].input_autopilot_enabled_toggle.name}),x.push({type:"KEYDOWN",activation_key:16,prohibition_key:-1,object:_[1],input_handler:_[0].input_autopilot_tack_toggle.name}))}let y=[];y[0]=[];y[0][0]=()=>{g.push(new j(u,10,-9,5*Math.PI/4))};y[0][1]=()=>{console.log(1),g[0].input_autopilot_enabled_toggle()};y[0][2]=()=>{it(g)};y[1]=[];y[1][0]=()=>{g.push(new j(u,12,-6,5*Math.PI/4)),g.push(new j(u,15,-11.5,5*Math.PI/4))};y[1][1]=()=>{console.log(1),g[0].input_autopilot_enabled_toggle(),g[1].input_autopilot_enabled_toggle()};y[1][2]=()=>{it(g)};y[2]=[];y[2][0]=()=>{g.push(new j(u,-10,-6,3*Math.PI/4)),g.push(new j(u,15,-11.5,5*Math.PI/4))};y[2][1]=()=>{console.log(1),g[0].input_autopilot_enabled_toggle(),g[1].input_autopilot_enabled_toggle()};y[2][2]=()=>{it(g)};y[2][2e3]=()=>{lt()};y[3]=[];y[3][0]=()=>{g.push(new j(u,-3,-3,3*Math.PI/4)),g.push(new j(u,18,-11.5,5*Math.PI/4))};y[3][1]=()=>{console.log(1),g[0].input_autopilot_enabled_toggle(),g[1].input_autopilot_enabled_toggle()};y[3][2]=()=>{it(g)};y[3][350]=()=>{g[0].input_autopilot_tack_toggle()};y[3][2e3]=()=>{lt()};y[4]=[];y[4][0]=()=>{g.push(new j(u,-3,-4,3*Math.PI/4)),g.push(new j(u,18,-11.5,5*Math.PI/4))};y[4][1]=()=>{console.log(1),g[0].input_autopilot_enabled_toggle(),g[1].input_autopilot_enabled_toggle()};y[4][2]=()=>{it(g)};y[4][300]=()=>{g[0].input_autopilot_tack_toggle()};y[4][700]=()=>{g[1].input_autopilot_heading_decrease()};y[4][701]=()=>{g[1].input_autopilot_heading_decrease()};y[4][702]=()=>{g[1].input_autopilot_heading_decrease()};y[4][2e3]=()=>{lt()};y[5]=[];vt(y[document.getElementById("scenario_selector").value]);li.start(()=>{_t=[],tt!==void 0&&tt[U]!==void 0&&(console.log("Frame ",U),tt[U]()),x.forEach(i=>{i.type==="PRESSED"&&q[i.activation_key]===!0&&(q[i.prohibition_key]===!1||q[i.prohibition_key]===void 0)&&i.object[i.input_handler]()}),u.set_camera_follow_target(g[0]),u.physics_model_step();let _=0;g.forEach((i,a)=>{g.forEach((n,h)=>{if(h>a){let r=i.x-n.x,d=i.y-n.y;_+=Math.sqrt(r*r+d*d),document.getElementById("dist_info").innerHTML="Dist: "+Math.floor(_*100)/100+"<br>"}}),i.physics_model_step(),_t=[..._t,...i.graphics_model_render()];let e={},s=i.awa/180*Math.PI+i.hull_angle-Math.PI/2;e.x=i.x+Math.cos(s)*-1.8,e.y=i.y+Math.sin(s)*-1.8,Math.cos(i.power_direction/180*Math.PI)*i.power/1e4,Math.sin(i.power_direction/180*Math.PI)*i.power/1e4;const l=1.5;e.x0=i.x+Math.cos(i.hull_angle+90/180*Math.PI)*-l+Math.cos(s)*-2,e.y0=i.y+Math.sin(i.hull_angle+90/180*Math.PI)*-l+Math.sin(s)*-2,e.x1=i.x+Math.cos(i.hull_angle+90/180*Math.PI)*0+Math.cos(s)*-2,e.y1=i.y+Math.sin(i.hull_angle+90/180*Math.PI)*0+Math.sin(s)*-2,e.x2=i.x+Math.cos(i.hull_angle+90/180*Math.PI)*+l+Math.cos(s)*-2,e.y2=i.y+Math.sin(i.hull_angle+90/180*Math.PI)*+l+Math.sin(s)*-2,u.bm.apply_energy(e.x0,e.y0,i.power_direction,i.power/5e3),u.bm.apply_energy(e.x1,e.y1,i.power_direction,i.power/2e3),u.bm.apply_energy(e.x2,e.y2,i.power_direction,i.power/5e3),document.getElementById("info").innerHTML+="Phys Time: "+Y.t_delta+"<br>"}),U%1==0&&u.bm.physics_model_step(),U++;let t={};t.x=0,t.y=0,Y.step_ready&&(G.copyTextureToTexture(t,K,K),Y.step_ready=!1),u.show_fields},()=>{});let W,N,G;mi();function mi(){W=new Gt(70,window.innerWidth/window.innerHeight,.01,85),W.position.z=60,W.position.y=20,N=new Qt,new Pt(6706517),new Pt(5592422);const _=new Xt(u.width,u.height);let t=new $t(_,Ft);t.position.x=0,t.position.y=0,t.position.z=-.01,N.add(t),G=new Jt({antialias:!0}),G.setSize(window.innerWidth,window.innerHeight),G.setAnimationLoop(ui),document.body.appendChild(G.domElement)}function ui(_){W.position.x=u.camera_position_x,W.position.y=u.camera_position_y,W.position.z=u.camera_zoom;for(let t of I)N.remove(t),t.geometry.dispose(),t.material.dispose(),t=void 0;for(let t of qt)N.remove(t),t.geometry.dispose!==void 0&&t.geometry.dispose(),t.material.dispose!==void 0&&t.material.dispose(),t=void 0;I=[],qt=[];for(let t=u.world.getBodyList();t;t=t.getNext())for(let i=t.getFixtureList();i;i=i.getNext()){if(t.render&&t.render.hidden)continue;t.render&&t.render.stroke||t.isDynamic()||t.isKinematic()||t.isStatic();const a=i.getType(),e=i.getShape();if(a==="circle"){const s=e.m_radius,l=t.getPosition();let n=[];for(let d=0;d<360;d+=10){let o=d/180*Math.PI,m=s*Math.cos(o)+l.x,c=s*Math.sin(o)+l.y;n.push(new T(m,c,0))}n.push(n[0]);const h=new ot().setFromPoints(n),r=new Q({color:65280});I.push(new nt(h,r)),N.add(I[I.length-1])}if(a==="edge"){let s=[];const l=e.m_vertex1,n=e.m_vertex2;let h=l.x+t.m_xf.p.x,r=l.y+t.m_xf.p.y,d=n.x+t.m_xf.p.x,o=n.y+t.m_xf.p.y;s.push(new T(h,r,0)),s.push(new T(d,o,0));const m=new ot().setFromPoints(s),c=new Q({color:16711680});I.push(new nt(m,c)),N.add(I[I.length-1])}if(a==="polygon"){let s=e.m_vertices;s.push(s[0]);let l=[];for(const r of s){let d=t.getAngle()+Math.PI,o=t.getLocalCenter(),m=(r.x+o.x)*Math.cos(d)+(r.y-o.y)*Math.sin(d),c=(r.x+o.x)*Math.sin(d)-(r.y-o.y)*Math.cos(d),f=0;m+=i.m_body.c_position.c.x,c+=i.m_body.c_position.c.y,l.push(new T(m,c,f))}const n=new ot().setFromPoints(l),h=new Q({color:255});I.push(new nt(n,h)),N.add(I[I.length-1])}}for(const t of _t){if(u.show_forces==!1&&t.type==="force")continue;let i=[];i.push(new T(t.x1,t.y1,0)),i.push(new T(t.x2,t.y2,0));const a=new ot().setFromPoints(i);let e=t.color;e===void 0&&(e=16711680);let s,l,n;t.opacity!==void 0?(l=!0,s=t.opacity,n=new Q({color:e,transparent:l,opacity:s})):n=new Q({color:e}),I.push(new nt(a,n)),N.add(I[I.length-1])}G.render(N,W)}
