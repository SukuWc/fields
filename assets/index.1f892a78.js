import{p as wt,l as Mt,D as rt,R as zt,U as lt,a as Vt,N as Dt,M as Ht,b as ri,L as Rt,P as li,S as di,C as Ct,c as mi,d as ci,W as pi,B as dt,e as $,f as mt,V as z}from"./vendor.da8be286.js";const ui=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}};ui();var J=document.getElementById("theCanvas"),Ut=J.getContext("2d"),gi=document.getElementById("plotSelect"),yi=document.getElementById("contrastSlider"),fi=document.getElementById("rafCheck");const Kt=4/9,Z=1/9,tt=1/36;var v=400,Ot=new Array(v+2),vt=new Array(v+2),xt=new Array(v+2),bt=new Array(v+2);for(var W=0;W<=v;W++){var V,R,C;W<v/8?(V=0,R=0,C=Math.round(255*(W+v/8)/(v/4))):W<3*v/8?(V=0,R=Math.round(255*(W-v/8)/(v/4)),C=255):W<5*v/8?(V=Math.round(255*(W-3*v/8)/(v/4)),R=255,C=255-V):W<7*v/8?(V=255,R=Math.round(255*(7*v/8-W)/(v/4)),C=0):(V=Math.round(255*(9*v/8-W)/(v/4)),R=0,C=0),vt[W]=V,xt[W]=R,bt[W]=C,Ot[W]=Yt(V,R,C)}vt[v+1]=0;xt[v+1]=0;bt[v+1]=0;Ot[v+1]=Yt(0,0,0);function It(h){var t=h.toString(16);return t.length==1?"0"+t:t}function Yt(h,t,e){return"#"+It(h)+It(t)+It(e)}class wi{constructor(t,e,a,i,s,n){this.texture=n,this.resolution=a,this.width=t*this.resolution,this.height=e*this.resolution,this.direction=i+180,this.step_ready=!1,this.t_delta=0,J.width=this.width,J.height=this.height,this.speed=s/100,this.viscosity=.02,this._n0_=new Array(this.width*this.height),this._nN_=new Array(this.width*this.height),this._nS_=new Array(this.width*this.height),this._nE_=new Array(this.width*this.height),this._nW_=new Array(this.width*this.height),this._nNE_=new Array(this.width*this.height),this._nSE_=new Array(this.width*this.height),this._nNW_=new Array(this.width*this.height),this._nSW_=new Array(this.width*this.height),this._ux_=new Array(this.width*this.height),this._uy_=new Array(this.width*this.height),this._rho_=new Array(this.width*this.height),this._curl_=new Array(this.width*this.height),this.barrier=new Array(this.width*this.height);for(var _=0;_<this.height;_++)for(var o=0;o<this.width;o++)this.barrier[o+_*this.width]=!1;for(var m=16,_=this.height/2-m;_<=this.height/2+m;_++){var o=Math.round(this.height/3);this.barrier[o+_*this.width]=!0}this.image=Ut.createImageData(J.width,J.height);for(var l=3;l<this.image.data.length;l+=4)this.image.data[l]=255;this.running=!1,this.initFluid(),this.startStop(),this.graphics_model_init()}initFluid(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;console.log(t,e);for(var a=0;a<this.height;a++)for(var i=0;i<this.width;i++)this.setEquil(i,a,t,e,1),this._curl_[i+a*this.width]=0}startStop(){this.running=!this.running,this.running&&this.physics_model_step()}physics_model_step(){let t=new Date;for(let s=0;s<1;s++)this.setBoundaries(),this.collide(),this.stream();this.t_delta=new Date-t,this.step_ready=!0;for(var e=!0,a=0;a<this.width;a++){var i=a+this.height/2*this.width;this._rho_[i]<=0&&(e=!1)}e||(window.alert("The simulation has become unstable due to excessive fluid speeds."),this.startStop(),this.initFluid()),this.graphics_model_init()}graphics_model_init(){this.graphics_model_step()}graphics_model_step(){this.paintCanvas(),this.running&&(fi.checked?requestAnimFrame(this.graphics_model_step_handler.bind(this)):window.setTimeout(this.graphics_model_step_handler.bind(this),10))}graphics_model_step_handler(){this.graphics_model_step()}setBoundaries(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;for(var a=0;a<this.width;a++)this.setEquil(a,0,t,e,1),this.setEquil(a,this.height-1,t,e,1);for(var i=1;i<this.height-1;i++)this.setEquil(0,i,t,e,1),this.setEquil(this.width-1,i,t,e,1)}collide(){for(var t=1/(3*this.viscosity+.5),e=1;e<this.height-1;e++)for(var a=1;a<this.width-1;a++){var i=a+e*this.width,s=this._n0_[i]+this._nN_[i]+this._nS_[i]+this._nE_[i]+this._nW_[i]+this._nNW_[i]+this._nNE_[i]+this._nSW_[i]+this._nSE_[i];this._rho_[i]=s;var n=(this._nE_[i]+this._nNE_[i]+this._nSE_[i]-this._nW_[i]-this._nNW_[i]-this._nSW_[i])/s;this._ux_[i]=n;var _=(this._nN_[i]+this._nNE_[i]+this._nNW_[i]-this._nS_[i]-this._nSE_[i]-this._nSW_[i])/s;this._uy_[i]=_;var o=Z*s,m=tt*s,l=3*n,d=3*_,c=n*n,r=_*_,y=2*n*_,u=c+r,f=1.5*u;this._n0_[i]+=t*(Kt*s*(1-f)-this._n0_[i]),this._nE_[i]+=t*(o*(1+l+4.5*c-f)-this._nE_[i]),this._nW_[i]+=t*(o*(1-l+4.5*c-f)-this._nW_[i]),this._nN_[i]+=t*(o*(1+d+4.5*r-f)-this._nN_[i]),this._nS_[i]+=t*(o*(1-d+4.5*r-f)-this._nS_[i]),this._nNE_[i]+=t*(m*(1+l+d+4.5*(u+y)-f)-this._nNE_[i]),this._nSE_[i]+=t*(m*(1+l-d+4.5*(u-y)-f)-this._nSE_[i]),this._nNW_[i]+=t*(m*(1-l+d+4.5*(u-y)-f)-this._nNW_[i]),this._nSW_[i]+=t*(m*(1-l-d+4.5*(u+y)-f)-this._nSW_[i])}for(var e=1;e<this.height-2;e++)this._nW_[this.width-1+e*this.width]=this._nW_[this.width-2+e*this.width],this._nNW_[this.width-1+e*this.width]=this._nNW_[this.width-2+e*this.width],this._nSW_[this.width-1+e*this.width]=this._nSW_[this.width-2+e*this.width]}stream(){for(var t=this.height-2;t>0;t--)for(var e=1;e<this.width-1;e++)this._nN_[e+t*this.width]=this._nN_[e+(t-1)*this.width],this._nNW_[e+t*this.width]=this._nNW_[e+1+(t-1)*this.width];for(var t=this.height-2;t>0;t--)for(var e=this.width-2;e>0;e--)this._nE_[e+t*this.width]=this._nE_[e-1+t*this.width],this._nNE_[e+t*this.width]=this._nNE_[e-1+(t-1)*this.width];for(var t=1;t<this.height-1;t++)for(var e=this.width-2;e>0;e--)this._nS_[e+t*this.width]=this._nS_[e+(t+1)*this.width],this._nSE_[e+t*this.width]=this._nSE_[e-1+(t+1)*this.width];for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)this._nW_[e+t*this.width]=this._nW_[e+1+t*this.width],this._nSW_[e+t*this.width]=this._nSW_[e+1+(t+1)*this.width];const a=.7,i=1-a;for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)if(this.barrier[e+t*this.width]){var s=e+t*this.width;this._nE_[e+1+t*this.width]=this._nE_[e+1+t*this.width]*i+this._nW_[s]*a,this._nW_[e-1+t*this.width]=this._nW_[e-1+t*this.width]*i+this._nE_[s]*a,this._nN_[e+(t+1)*this.width]=this._nN_[e+(t+1)*this.width]*i+this._nS_[s]*a,this._nS_[e+(t-1)*this.width]=this._nS_[e+(t-1)*this.width]*i+this._nN_[s]*a,this._nNE_[e+1+(t+1)*this.width]=this._nNE_[e+1+(t+1)*this.width]*i+this._nSW_[s]*a,this._nNW_[e-1+(t+1)*this.width]=this._nNW_[e-1+(t+1)*this.width]*i+this._nSE_[s]*a,this._nSE_[e+1+(t-1)*this.width]=this._nSE_[e+1+(t-1)*this.width]*i+this._nNW_[s]*a,this._nSW_[e-1+(t-1)*this.width]=this._nSW_[e-1+(t-1)*this.width]*i+this._nNE_[s]*a}}setEquil(t,e,a,i,s){var n=t+e*this.width;typeof s=="undefined"&&(s=this._rho_[n]);var _=3*a,o=3*i,m=a*a,l=i*i,d=2*a*i,c=m+l,r=1.5*c;this._n0_[n]=Kt*s*(1-r),this._nE_[n]=Z*s*(1+_+4.5*m-r),this._nW_[n]=Z*s*(1-_+4.5*m-r),this._nN_[n]=Z*s*(1+o+4.5*l-r),this._nS_[n]=Z*s*(1-o+4.5*l-r),this._nNE_[n]=tt*s*(1+_+o+4.5*(c+d)-r),this._nSE_[n]=tt*s*(1+_-o+4.5*(c-d)-r),this._nNW_[n]=tt*s*(1-_+o+4.5*(c-d)-r),this._nSW_[n]=tt*s*(1-_-o+4.5*(c+d)-r),this._rho_[n]=s,this._ux_[n]=a,this._uy_[n]=i}apply_energy(t,e,a,i){let s=this.width/2+Math.floor(t*this.resolution),n=this.height/2+Math.floor(e*this.resolution),_=a+270;_>360&&(_-=360),document.getElementById("wind_info").innerHTML="mirror_angle: "+_+"<br>";const o=[this._nE_,this._nNE_,this._nN_,this._nNW_,this._nW_,this._nSW_,this._nS_,this._nSE_];let m=[0,0,0,0],l=[0,0,0,0],d=[0,0,0,0],c=[0,0,0,0];for(let r=0;r<4;r++){const y=.02,u=(Math.floor(_/45)+1+r)%8;c[r]=u*45,d[r]=_-(c[r]-_),d[r]>360&&(d[r]-=360),d[r]<0&&(d[r]+=360),m[r]=Math.cos(d[r]/180*Math.PI)*o[u][s+n*this.width]*y,l[r]=Math.sin(d[r]/180*Math.PI)*o[u][s+n*this.width]*y,o[u][s+n*this.width]*=1-y}for(let r=0;r<4;r++){const y=(Math.floor(d[r]/45)+1+r)%8;let u,f;y%2==0?Math.abs(m[r])>Math.abs(l[r])?(u=m[r]-l[r],f=l[r]*Math.SQRT2):(u=l[r]-m[r],f=m[r]*Math.SQRT2):Math.abs(m[r])>Math.abs(l[r])?(u=l[r]*Math.SQRT2,f=m[r]-l[r]):(u=m[r]*Math.SQRT2,f=l[r]-m[r]),o[y][s+n*this.width]+=u,o[(y+1)%8][s+n*this.width]+=f,document.getElementById("wind_info").innerHTML+="sou: "+c[r]+" mirr: "+Math.floor(d[r])+"<br>"}}get_field_velocity(t,e){t=this.width/2+Math.floor(t*this.resolution),e=this.height/2+Math.floor(e*this.resolution);let a,i,s,n,_,o,m,l,d,c,r,y;a=Math.floor(t),_=Math.floor(e),i=a+1,o=_,s=a,m=_+1,n=a+1,l=_+1;let u=t-a,f=e-_;d=(1-u)*(1-f),c=u*(1-f),r=(1-u)*f,y=u*f;let b=0,I=0;return b=this._ux_[a+_*this.width]*d+this._ux_[i+o*this.width]*c+this._ux_[s+m*this.width]*r+this._ux_[n+l*this.width]*y,I=this._uy_[a+_*this.width]*d+this._uy_[i+o*this.width]*c+this._uy_[s+m*this.width]*r+this._uy_[n+l*this.width]*y,{x:b/4,y:I/4}}paintCanvas(){var t=0,e=Math.pow(1.2,Number(yi.value)),a=gi.selectedIndex;a==4&&this.computeCurl();for(var i=0;i<this.height;i++)for(var s=0;s<this.width;s++){if(this.barrier[s+i*this.width])t=v+1;else{if(a==0)t=Math.round(v*((this._rho_[s+i*this.width]-1)*6*e+.5));else if(a==1)t=Math.round(v*(this._ux_[s+i*this.width]*2*e+.5));else if(a==2)t=Math.round(v*(this._uy_[s+i*this.width]*2*e+.5));else if(a==3){var n=Math.sqrt(this._ux_[s+i*this.width]*this._ux_[s+i*this.width]+this._uy_[s+i*this.width]*this._uy_[s+i*this.width]);t=Math.round(v*(n*4*e))}else t=Math.round(v*(this._curl_[s+i*this.width]*5*e+.5));t<0&&(t=0),t>v&&(t=v)}this.colorSquare(s,i,vt[t],xt[t],bt[t])}Ut.putImageData(this.image,0,0)}colorSquare(t,e,a,i,s){if(this.texture!==void 0){var n=(t+e*this.width)*4;this.texture.image.data[n+0]=a,this.texture.image.data[n+1]=i,this.texture.image.data[n+2]=s,this.texture.image.data[n+3]=255;for(var _=this.height-e-1,o=_;o<_+1;o++)for(var m=t;m<t+1;m++){var l=(m+o*this.width)*4;this.image.data[l+0]=a,this.image.data[l+1]=i,this.image.data[l+2]=s}}}computeCurl(){for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)this._curl_[e+t*this.width]=this._uy_[e+1+t*this.width]-this._uy_[e-1+t*this.width]-this._ux_[e+(t+1)*this.width]+this._ux_[e+(t-1)*this.width]}}window.requestAnimFrame=function(h){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1)}}();let U=1,it;it=.3*U;let Pt=4;Pt=4;let Gt={vectorField:void 0,objCanvas:void 0,ctx:void 0,enableFrameDragging:!0,enableEmitter:!0,loopTimer:void 0,loopTicker:0,emitterX:0,emitterY:0,init:function(h,t){this.initVectorField(h,t)},initVectorField:function(h,t){this.vectorField=new Mi(h,t,h*U,t*U)},start:function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.animateFrame=function(h){Gt.loop(),window.animateTimestamp=h,window.requestAnimationFrame(animateFrame)},window.animateFrame()},get_field_velocity:function(h,t){var e=this.vectorField.areaWidth,a=this.vectorField.areaHeight;h+=this.vectorField.width/2,t+=this.vectorField.height/2,h*=U,t*=U;let i,s,n,_,o,m,l,d,c,r,y,u;i=Math.floor(h),o=Math.floor(t),s=i+1,m=o,n=i,l=o+1,_=i+1,d=o+1;let f=h-i,b=t-o;c=(1-f)*(1-b),r=f*(1-b),y=(1-f)*b,u=f*b;let I=h+.5>>0,P=t-.5>>0,j=0,A=0;if(I<e-1&&I>0+1&&P<a-1&&P>0+1){var x=this.vectorField.field;j=x[i][o].vx*c+x[s][m].vx*r+x[n][l].vx*y+x[_][d].vx*u,A=x[i][o].vy*c+x[s][m].vy*r+x[n][l].vy*y+x[_][d].vy*u}return{x:-j,y:A}},apply_energy:function(h,t,e,a){var i=this.vectorField.areaWidth,s=this.vectorField.areaHeight;h+=this.vectorField.width/2,t+=this.vectorField.height/2,h*=U,t*=U;let n,_,o,m,l,d,c,r,y,u,f,b;n=Math.floor(h),l=Math.floor(t),_=n+1,d=l,o=n,c=l+1,m=n+1,r=l+1;let I=h-n,P=t-l;y=(1-I)*(1-P),u=I*(1-P),f=(1-I)*P,b=I*P;let j=h+.5>>0,A=t+.5>>0;if(j<i-1&&j>0+1&&A<s-1&&A>0+1){var x=this.vectorField.field;let H=0,B=0;H+=-Math.cos(e/180*Math.PI)*a,B+=-Math.sin(e/180*Math.PI)*a,x[n][l].vx+=y*H,x[n][l].vy+=y*B,x[_][d].vx+=u*H,x[_][d].vy+=u*B,x[o][c].vx+=f*H,x[o][c].vy+=f*B,x[m][r].vx+=b*H,x[m][r].vy+=b*B}},loop:function(){this.updateVectorField()},updateVectorField:function(){var h=this.vectorField.field,t=this.vectorField.areaWidth,e=this.vectorField.areaHeight,a,i,s,n,_,o;for(a=t;a--;)for(i=e;i--;)a<t-1&&a>0+1&&i<e-1&&i>0+1?(s=(h[a-1][i].vx+h[a+1][i].vx+h[a][i-1].vx+h[a][i+1].vx)/4,n=(h[a-1][i].vy+h[a+1][i].vy+h[a][i-1].vy+h[a][i+1].vy)/4,_=h[a][i].vx*(1-it)+s*it,o=h[a][i].vy*(1-it)+n*it):(_=h[a][i].vx,o=h[a][i].vy),h[a][i].vx_=_,h[a][i].vy_=o;for(a=t;a--;)for(i=e;i--;);for(a=t;a--;)for(i=e;i--;){let m=h[a][i].vx_,l=h[a][i].vy_,d=Math.abs(m)/60*Pt,c=Math.abs(l)/60*Pt;if(a<t-1&&a>0+1&&i<e-1&&i>0+1){let r,y,u,f,b,I,P,j;r=h[a][i].vx_,y=h[a-Math.sign(m)][i].vx_,u=h[a][i-Math.sign(l)].vx_,f=h[a-Math.sign(m)][i-Math.sign(l)].vx_,b=h[a][i].vy_,I=h[a-Math.sign(m)][i].vy_,P=h[a][i-Math.sign(l)].vy_,j=h[a-Math.sign(m)][i-Math.sign(l)].vy_,h[a][i].vx__=(1-d)*(1-c)*r+d*(1-c)*y+(1-d)*c*u+d*c*f,h[a][i].vy__=(1-d)*(1-c)*b+d*(1-c)*I+(1-d)*c*P+d*c*j,(h[a][i].vx__===void 0||h[a][i].vy__===void 0)&&(console.log("TRAP"),h=void 0)}else h[a][i].vx__=h[a][i].vx_,h[a][i].vy__=h[a][i].vy_;(i==e-2||i==1||a==t-2||a==1)&&(h[a][i].vx__=0,h[a][i].vy__=-2.5)}for(a=t;a--;)for(i=e;i--;)h[a][i].vx=h[a][i].vx__,h[a][i].vy=h[a][i].vy__,h[a][i].velocity=Math.sqrt(h[a][i].vx*h[a][i].vx+h[a][i].vy*h[a][i].vy)}},Mi=function(h,t,e,a){this.field=[],this.width=h,this.height=t,this.areaWidth=e,this.areaHeight=a;var i,s;for(i=e;i--;)for(this.field[i]=[],s=a;s--;)this.field[i][s]=new vi},vi=function(){this.velocity=0,this.vx=0,this.vy=-2,this.vx_=0,this.vy_=-2,this.vx__=0,this.vy__=-2},et=wt,F=et.Vec2;function Qt(h){for(var t=0,e=0;e<h.length;e++)t+=h[e];return t}function Xt(h){return Math.PI/180*h}function xi(h){return 180/Math.PI*Math.atan2(Qt(h.map(Xt).map(Math.sin))/h.length,Qt(h.map(Xt).map(Math.cos))/h.length)}class bi{constructor(t,e,a,i,s){this.bm=s,this.fluid=Gt,this.world=void 0,this.width=t,this.height=e,this.wind_direction=a,this.wind_speed=i,this.show_forces=!0,this.show_fields=!1,this.camera_follow_target=void 0,this.camera_follow=!1,this.camera_zoom=30,this.camera_zoom_max=70,this.camera_zoom_min=10,this.camera_position_x=0,this.camera_position_y=0,this.camera_position_x_max=30,this.camera_position_x_min=-30,this.camera_position_y_max=30,this.camera_position_y_min=-30}physics_model_init(){this.fluid.init(this.width,this.height),this.world=new Mt.World(F(0,0));let t=this.world.createBody(F(0,0)),e={density:0,restitution:.4};t.createFixture(et.Edge(F(-this.width/2+2,-this.height/2+2),F(-this.width/2+2,this.height/2-2)),e),t.createFixture(et.Edge(F(this.width/2-2,-this.height/2+2),F(this.width/2-2,this.height/2-2)),e),t.createFixture(et.Edge(F(-this.width/2+2,this.height/2-2),F(this.width/2-2,this.height/2-2)),e),t.createFixture(et.Edge(F(-this.width/2+2,-this.height/2+2),F(this.width/2-2,-this.height/2+2)),e),this.world.createDynamicBody(F(0,14.5)).createFixture(Mt.Circle(.5),10),this.world.createDynamicBody(F(0,20)).createFixture(Mt.Circle(5),10)}get_wind_speed(t,e){let a=this.bm.get_field_velocity(t,e),i=this.bm.get_field_velocity(t-1,e),s=this.bm.get_field_velocity(t+1,e),n=this.bm.get_field_velocity(t,e-1),_=this.bm.get_field_velocity(t,e+1),o=0;return o+=Math.sqrt(a.x*a.x+a.y*a.y),o+=Math.sqrt(i.x*i.x+i.y*i.y),o+=Math.sqrt(s.x*s.x+s.y*s.y),o+=Math.sqrt(n.x*n.x+n.y*n.y),o+=Math.sqrt(_.x*_.x+_.y*_.y),o/5*100*4}get_wind_direction(t,e){let a=this.bm.get_field_velocity(t,e),i=this.bm.get_field_velocity(t-1,e),s=this.bm.get_field_velocity(t+1,e),n=this.bm.get_field_velocity(t,e-1),_=this.bm.get_field_velocity(t,e+1),o=[Math.atan2(a.y,a.x)/Math.PI*180+180,Math.atan2(i.y,i.x)/Math.PI*180+180,Math.atan2(s.y,s.x)/Math.PI*180+180,Math.atan2(n.y,n.x)/Math.PI*180+180,Math.atan2(_.y,_.x)/Math.PI*180+180];return xi(o)}set_camera_follow_target(t){this.camera_follow_target=t}physics_model_step(){this.camera_follow===!0&&this.camera_follow_target!==void 0&&(this.camera_position_x=this.camera_follow_target.x,this.camera_position_y=this.camera_follow_target.y,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min))}input_show_fields(t){this.show_fields=t}input_show_forces(t){this.show_forces=t}input_camera_follow(t){this.camera_follow=t}input_camera_zoom_relative(t){this.camera_zoom+=t,this.camera_zoom>this.camera_zoom_max&&(this.camera_zoom=this.camera_zoom_max),this.camera_zoom<this.camera_zoom_min&&(this.camera_zoom=this.camera_zoom_min)}input_camera_move_relative(t,e){this.camera_position_x+=t,this.camera_position_y+=e,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min)}}class Ii{constructor(t){this.map=t,this.age=0,this.maxage=4e3,this.parameter=[],this.parameter[0]=[20,0],this.parameter[1]=[0,10],this.parameter[2]=[10,50],this.parameter[3]=[10,5],this.parameter[4]=[0,0],this.parameter[5]=[.1,.5],this.strength=3,this.result=[],this.result[0]=(this.parameter[0][0]*(this.maxage-this.age)+this.parameter[0][1]*this.age)/this.maxage,this.result[1]=(this.parameter[1][0]*(this.maxage-this.age)+this.parameter[1][1]*this.age)/this.maxage,this.result[2]=(this.parameter[2][0]*(this.maxage-this.age)+this.parameter[2][1]*this.age)/this.maxage,this.result[3]=(this.parameter[3][0]*(this.maxage-this.age)+this.parameter[3][1]*this.age)/this.maxage,this.result[4]=(this.parameter[4][0]*(this.maxage-this.age)+this.parameter[4][1]*this.age)/this.maxage,this.result[5]=(this.parameter[5][0]*(this.maxage-this.age)+this.parameter[5][1]*this.age)/this.maxage}physics_model_step(){this.result[0]=(this.parameter[0][0]*(this.maxage-this.age)+this.parameter[0][1]*this.age)/this.maxage,this.result[1]=(this.parameter[1][0]*(this.maxage-this.age)+this.parameter[1][1]*this.age)/this.maxage,this.result[2]=(this.parameter[2][0]*(this.maxage-this.age)+this.parameter[2][1]*this.age)/this.maxage,this.result[3]=(this.parameter[3][0]*(this.maxage-this.age)+this.parameter[3][1]*this.age)/this.maxage,this.result[4]=(this.parameter[4][0]*(this.maxage-this.age)+this.parameter[4][1]*this.age)/this.maxage,this.result[5]=(this.parameter[5][0]*(this.maxage-this.age)+this.parameter[5][1]*this.age)/this.maxage,this.p_beam_x=this.result[0],this.p_beam_y=this.result[1],this.p_beam_width=this.result[2],this.p_beam_height=this.result[3],this.p_beam_direction=this.result[4],this.p_beam_elevation=this.result[5];let t=this.strength*Math.sin(Math.PI*this.age/this.maxage)*(this.p_beam_width+this.p_beam_height)/20,e=Math.PI/4*this.p_beam_width*this.p_beam_height,a=t/e;for(let i=-this.p_beam_width/2;i<=this.p_beam_width/2;i++)for(let s=-this.p_beam_height/2;s<=this.p_beam_height/2;s++){let n=i/(this.p_beam_width/2),_=s/(this.p_beam_height/2);if(Math.sqrt(n*n+_*_)<1){let o=Math.atan2(s-this.p_beam_height/2*(1-this.p_beam_elevation),i)/Math.PI*180,m=Math.cos(this.p_beam_direction/180*Math.PI)*i+-Math.sin(this.p_beam_direction/180*Math.PI)*s,l=Math.sin(this.p_beam_direction/180*Math.PI)*i+Math.cos(this.p_beam_direction/180*Math.PI)*s;this.map.fluid.apply_energy(this.p_beam_x+m,this.p_beam_y+l,o+this.p_beam_direction,-a)}}this.age<this.maxage&&this.age++}}let $t=wt,w=$t.Vec2;class L{constructor(t,e,a,i){this.map=t,this.x=e,this.y=a,i!=null?this.hull_angle=i:this.hull_angle=Math.PI,this.wind_direction=0,this.wind_speed=0,this.hull_mass=6,this.hull_shape=$t.Polygon([w(0,-2.25),w(-.5,-1.25),w(-.75,-.25),w(-.75,.5),w(-.5,1.75),w(.5,1.75),w(.75,.5),w(.75,-.25),w(.5,-1.25),w(0,-2.25)]),this.rudder_input=0,this.motor_input=0,this.rudder_angle=0,this.rudder_angle_last=0,this.rudder_angle_max=60,this.rudder_position=1.8,this.rudder_lenght=.5,this.forces=[],this.mainsail_leading_edge_position=-.8,this.mainsail_boom_length=2.2,this.mainsail_boom_angle_max=80,this.mainsail_boom_angle_factor=.5,this.mainsail_boom_angle=0,this.mainsail_boom_angle_actual=0,this.jib_leading_edge_position=-2,this.jib_boom_length=1.4,this.jib_boom_angle_max=55,this.jib_boom_angle_factor=.65,this.jib_boom_angle=0,this.jib_boom_angle_actual=0,this.center_of_lift=-.05,this.centerboard_position=-.15,this.centerboard_length=.6,this.aero_lookup_resolution=5,this.aero_lift_lookup=[0,.025,.15,.9,1.3,1.46,1.52,1.51,1.45,1.41,1.33,1.16,.95,.82,.73,.6,.43,.34,.28,.28,.28],this.aero_drag_lookup=[.15,.15,.15,.16,.172,.19,.22,.25,.29,.34,.4,.47,.55,.635,.73,.83,.95,1.1,1.28,1.28,1.28],this.physics_model=void 0,this.power=0,this.power_direction=0,this.autopilot_enabled=!1,this.autopilot_heading_target=0,this.autopilot_heading_input=0,this.autopilot_heading_best_vmg_1=50,this.autopilot_heading_best_vmg_2=160,this.autopilot_compensator_p=0,this.autopilot_compensator_i=0,this.autopilot_compensator_d=0,this.autopilot_compensator_last_error=0,this.autopilot_compensator_current_error=0,this.autopilot_compensator_sum_error=0,this.twa=0,this.physics_model_init()}physics_model_init(){let t=wt,e=t.Vec2,a=this.map.world.createBody({type:"dynamic",angularDamping:.5,linearDamping:.1,position:e(this.x,this.y),angle:this.hull_angle,allowSleep:!1});a.createFixture(this.hull_shape,this.hull_mass),this.physics_model=a}physics_model_deinit(){this.map.world.destroyBody(this.physics_model)}physics_model_step(){this.forces=[],document.getElementById("info").innerHTML="Autopilot"+this.autopilot_enabled+"<br>",document.getElementById("info").innerHTML+="Heading Target"+this.autopilot_heading_target+"<br>",this.x=this.physics_model.m_xf.p.x,this.y=this.physics_model.m_xf.p.y,this.wind_speed=this.map.get_wind_speed(this.x,this.y),this.wind_direction=this.map.get_wind_direction(this.x,this.y);var t=this.physics_model.getAngle();for(this.angle=t,this.hull_angle=t;t<-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;let e=this.physics_model.m_linearVelocity.x*Math.cos(t-Math.PI/2)+this.physics_model.m_linearVelocity.y*Math.sin(t-Math.PI/2),a=this.physics_model.m_linearVelocity.x*Math.cos(t)+this.physics_model.m_linearVelocity.y*Math.sin(t),i=Math.atan2(a,Math.abs(e))*180/Math.PI;i>90?i-=180:i<-90&&(i+=180);let s=-i*Math.abs(e)*Math.abs(e)*2;s>150?s=150:s<-150&&(s=-150);var n=this.physics_model.getWorldVector(w(s,0)),_=this.physics_model.getWorldPoint(w(0,this.centerboard_position));this.physics_model.applyForce(n,_,!0),this.forces.push({name:"centerboard",type:"arrow",vector:n,point:_}),document.getElementById("info").innerHTML+="q/d: "+i+"\xB0<br>";let o=this.map.get_wind_direction(this.x,this.y)-t/Math.PI*180+90,m={};m.x=this.physics_model.m_linearVelocity.x+Math.cos(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y),m.y=this.physics_model.m_linearVelocity.y+Math.sin(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y);let l=Math.atan2(m.y,m.x)/Math.PI*180-t/Math.PI*180+90,d=Math.sqrt(m.x*m.x+m.y*m.y);if(l>180&&(l-=360),l<-180&&(l+=360),o>180&&(o-=360),o<-180&&(o+=360),this.awa=l,this.twa=o,this.motor_input===1){var c=this.physics_model.getWorldVector(w(0,-.3)),r=this.physics_model.getWorldPoint(w(0,2));this.physics_model.applyLinearImpulse(c,r,!0)}if(this.motor_input===-1){var c=this.physics_model.getWorldVector(w(0,.3)),r=this.physics_model.getWorldPoint(w(0,2));this.physics_model.applyLinearImpulse(c,r,!0)}this.rudder_angle_last=this.rudder_angle;let y=0;const u=1-Math.abs(e)>0?1-Math.abs(e)+1:1;if(this.rudder_input===-1)this.rudder_angle<this.rudder_angle_max&&(this.rudder_angle+=u),y=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else if(this.rudder_input===1)this.rudder_angle>-this.rudder_angle_max&&(this.rudder_angle-=u),y=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else{let k=e;e>1&&(k=1),e<-1&&(k=-1),this.rudder_angle=this.rudder_angle*(.98-k/80)}if(this.autopilot_enabled){this.autopilot_compensator_p=2,this.autopilot_compensator_i=0,this.autopilot_compensator_d=100;let k=-(this.autopilot_heading_target- -this.twa);this.autopilot_compensator_sum_error*=.85,this.autopilot_compensator_sum_error+=k,k>180&&(k-=360),k<-180&&(k+=360),document.getElementById("info").innerHTML+="error: "+Math.floor(k)+"\xB0<br>";let oi=k*this.autopilot_compensator_p,ni=this.autopilot_compensator_sum_error*this.autopilot_compensator_i,_i=(k-this.autopilot_compensator_last_error)*this.autopilot_compensator_d;this.rudder_angle_target=(oi+ni+_i)*Math.sign(e),this.rudder_angle_target>this.rudder_angle_max/2&&(this.rudder_angle_target=this.rudder_angle_max/2),this.rudder_angle_target<-this.rudder_angle_max/2&&(this.rudder_angle_target=-this.rudder_angle_max/2),this.rudder_angle+=(this.rudder_angle_target-this.rudder_angle)/10,this.autopilot_compensator_last_error=k}else this.autopilot_heading_target=-this.twa,this.autopilot_heading_target>180&&(this.autopilot_heading_target-=360),this.autopilot_heading_target<-180&&(this.autopilot_heading_target+=360);let b=this.physics_model.m_angularVelocity*this.rudder_lenght,I=Math.atan2(-a+b,Math.abs(e))/Math.PI*180,P=0;e>0?P=e*(this.rudder_angle+I)/7:P=e*(this.rudder_angle-I)/7,P+=y*2;let j=this.physics_model.getWorldPoint(w(0,this.rudder_position)),A={};A.x=Math.cos(t+this.rudder_angle/180*Math.PI)*P,A.y=Math.sin(t+this.rudder_angle/180*Math.PI)*P,this.physics_model.applyForce(A,j,!0),this.forces.push({name:"rudder",type:"arrow",vector:A,point:j}),document.getElementById("info").innerHTML+="TWA: "+Math.floor(o)+"<br>",document.getElementById("info").innerHTML+="TWS: "+Math.floor(this.wind_speed*10)/10+"<br>",document.getElementById("info").innerHTML+="AWA: "+Math.floor(l)+"<br>",document.getElementById("info").innerHTML+="AWS: "+Math.floor(d*10)/10+"<br>";let x=Math.sqrt(this.physics_model.m_linearVelocity.x*this.physics_model.m_linearVelocity.x+this.physics_model.m_linearVelocity.y*this.physics_model.m_linearVelocity.y),H=Math.cos(o/180*Math.PI)*x;document.getElementById("info").innerHTML+="BS: "+Math.floor(x*10)/10+"<br>",document.getElementById("info").innerHTML+="VMG: "+Math.floor(H*10)/10+"<br>",this.jib_boom_angle=this.awa*this.jib_boom_angle_factor,this.jib_boom_angle>this.jib_boom_angle_max&&(this.jib_boom_angle=this.jib_boom_angle_max),this.jib_boom_angle<-this.jib_boom_angle_max&&(this.jib_boom_angle=-this.jib_boom_angle_max),this.mainsail_boom_angle=this.awa*this.mainsail_boom_angle_factor,this.mainsail_boom_angle>this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=this.mainsail_boom_angle_max),this.mainsail_boom_angle<-this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=-this.mainsail_boom_angle_max);const B=Math.floor(Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution),ht=Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution-B;let yt=this.aero_drag_lookup[B]*(1-ht)+this.aero_drag_lookup[B+1]*ht,ft=this.aero_lift_lookup[B]*(1-ht)+this.aero_lift_lookup[B+1]*ht,Y={},G={};document.getElementById("info").innerHTML+="Cd: "+Math.floor(yt*10)/10+"<br>",document.getElementById("info").innerHTML+="Cl: "+Math.floor(ft*10)/10+"<br>";const ot=.35;Y.x=Math.cos(t+this.awa/180*Math.PI+Math.PI/2)*d*d*yt*ot,Y.y=Math.sin(t+this.awa/180*Math.PI+Math.PI/2)*d*d*yt*ot,G.x=-Math.sign(this.awa)*Math.cos(t+this.awa/180*Math.PI)*d*d*ft*ot,G.y=-Math.sign(this.awa)*Math.sin(t+this.awa/180*Math.PI)*d*d*ft*ot;let q={};q.x=Y.x+G.x,q.y=Y.y+G.y;var nt=this.physics_model.getWorldPoint(w(0,this.center_of_lift));this.physics_model.applyForce(G,nt,!0),this.physics_model.applyForce(Y,nt,!0),this.forces.push({name:"mainsail",type:"arrow",vector:G,point:nt}),this.forces.push({name:"mainsail",type:"arrow",vector:Y,point:nt}),this.power=Math.sqrt(q.x*q.x+q.y*q.y),this.power_direction=Math.atan2(q.y,q.x)/Math.PI*180,document.getElementById("info").innerHTML+="Power: "+Math.floor(this.power*10)/10+"<br>";var _t={};_t.x=-this.physics_model.m_linearVelocity.x*x,_t.y=-this.physics_model.m_linearVelocity.y*x;var qt=this.physics_model.getWorldPoint(w(0,0));this.physics_model.applyForce(_t,qt,!0),this.forces.push({name:"drag",type:"arrow",vector:_t,point:qt}),this.rudder_input=0,this.motor_input=0}graphics_model_render(){let t=[];this.forces.forEach(d=>{t.push({color:65280,type:"force",x1:d.point.x,y1:d.point.y,x2:d.point.x+d.vector.x/10,y2:d.point.y+d.vector.y/10})});let e={},a=2;this.autopilot_enabled&&(a=10),e.x1=this.physics_model.getWorldPoint(w(0,0)).x,e.y1=this.physics_model.getWorldPoint(w(0,0)).y,e.x2=e.x1+Math.cos((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*a,e.y2=e.y1+Math.sin((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*a,e.color=5596791,e.type="autopilot",t.push(e);let i=this.wind_direction/180*Math.PI;t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),i=this.awa/180*Math.PI+this.hull_angle-Math.PI/2,t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(w(0,this.rudder_position)).x,y1:this.physics_model.getWorldPoint(w(0,this.rudder_position)).y,x2:this.physics_model.getWorldPoint(w(0,this.rudder_position)).x+Math.cos(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght,y2:this.physics_model.getWorldPoint(w(0,this.rudder_position)).y+Math.sin(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(w(0,this.centerboard_position+this.centerboard_length/2)).x,y1:this.physics_model.getWorldPoint(w(0,this.centerboard_position+this.centerboard_length/2)).y,x2:this.physics_model.getWorldPoint(w(0,this.centerboard_position-this.centerboard_length/2)).x,y2:this.physics_model.getWorldPoint(w(0,this.centerboard_position-this.centerboard_length/2)).y});let s=[];s[0]={},s[0].x=this.physics_model.getWorldPoint(w(0,this.mainsail_leading_edge_position)).x,s[0].y=this.physics_model.getWorldPoint(w(0,this.mainsail_leading_edge_position)).y,this.mainsail_boom_angle/this.mainsail_boom_angle_factor,this.mainsail_boom_angle_actual+=(this.mainsail_boom_angle-this.mainsail_boom_angle_actual)/30;let n=this.mainsail_boom_length*.05*Math.abs(this.awa)/30<this.mainsail_boom_length/10?this.mainsail_boom_length*.05*Math.abs(this.awa)/30:this.mainsail_boom_length/10;s[1]={},s[1].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-n*Math.sign(this.mainsail_boom_angle_actual),s[1].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-n*Math.sign(this.mainsail_boom_angle_actual);let _=n;s[2]={},s[2].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-_*Math.sign(this.mainsail_boom_angle_actual),s[2].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-_*Math.sign(this.mainsail_boom_angle_actual),s[3]={},s[3].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,s[3].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,t.push({color:8939263,type:"sail",x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y}),t.push({color:8939263,type:"sail",x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y}),t.push({color:8939263,type:"sail",x1:s[2].x,y1:s[2].y,x2:s[3].x,y2:s[3].y}),this.jib_boom_angle_actual+=(this.jib_boom_angle-this.jib_boom_angle_actual)/20;let o=[];o[0]={},o[0].x=this.physics_model.getWorldPoint(w(0,this.jib_leading_edge_position)).x,o[0].y=this.physics_model.getWorldPoint(w(0,this.jib_leading_edge_position)).y;let m=this.jib_boom_length*.05*Math.abs(this.awa)/15<this.jib_boom_length/3?this.jib_boom_length*.05*Math.abs(this.awa)/15:this.jib_boom_length/3;o[1]={},o[1].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-m*Math.sign(this.jib_boom_angle_actual),o[1].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-m*Math.sign(this.jib_boom_angle_actual);let l=m;return o[2]={},o[2].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.jib_boom_angle_actual),o[2].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.jib_boom_angle_actual),o[3]={},o[3].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,o[3].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,t.push({color:8939263,type:"sail",x1:o[0].x,y1:o[0].y,x2:o[1].x,y2:o[1].y}),t.push({color:8939263,type:"sail",x1:o[1].x,y1:o[1].y,x2:o[2].x,y2:o[2].y}),t.push({color:8939263,type:"sail",x1:o[2].x,y1:o[2].y,x2:o[3].x,y2:o[3].y}),t}input_rudder_left(){this.rudder_input=1,this.autopilot_enabled=!1}input_rudder_right(){this.rudder_input=-1,this.autopilot_enabled=!1}input_motor_forward(){this.motor_input=1}input_motor_reverse(){this.motor_input=-1}input_autopilot_enabled_toggle(){this.autopilot_heading_target<0?this.autopilot_heading_target>-90?this.autopilot_heading_target=-this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=-this.autopilot_heading_best_vmg_2:this.autopilot_heading_target<90?this.autopilot_heading_target=this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=this.autopilot_heading_best_vmg_2,this.autopilot_enabled=!0}input_autopilot_tack_toggle(){this.autopilot_heading_target*=-1,this.autopilot_enabled=!0}input_autopilot_heading_increase(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)<175&&(this.autopilot_heading_target>0?this.autopilot_heading_target+=1:this.autopilot_heading_target-=1)}input_autopilot_heading_decrease(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)>5&&(this.autopilot_heading_target>0?this.autopilot_heading_target-=1:this.autopilot_heading_target+=1)}}const Et=100,Wt=100,Jt=90,Zt=7,St=1.5,Q=new wi(Et,Wt,St,Jt,Zt);let p=new bi(Et,Wt,Jt,Zt,Q);p.physics_model_init();var kt=Et*St,Ft=Wt*St,ti=kt*Ft*4,jt=new Uint8Array(ti);for(var K=0;K<ti;K++)jt[K]=Math.random()*256;var ct=new rt(jt,kt,Ft,zt,lt,Vt),ii=new rt(jt,kt,Ft,zt,lt,Vt);ct.magFilter=Dt;ct.needsUpdate=!0;var ei=new Ht({map:ct,transparent:!0});ei.needsUpdate=!0;p.bm.texture=ii;const Pi=function(h,t,e,a,i){return(h-t)*(i-a)/(e-t)+a};let at={},M=[],Bt=[],X=0;const Ei=new ri(p.world,{speed:1,fps:60});var Nt=p.fluid.vectorField.areaWidth,At=p.fluid.vectorField.areaHeight,ai=Nt*At,Lt=new Uint8Array(ai);for(var K=0;K<ai;K++)Lt[K]=Math.random()*256;var pt=new rt(Lt,Nt,At,Rt,lt),si=new rt(Lt,Nt,At,Rt,lt);pt.magFilter=Dt;pt.needsUpdate=!0;var Wi=new Ht({color:16777215,alphaMap:pt,transparent:!0});Wi.needsUpdate=!0;let E=[],D=[],S=[],hi=[],ut=[];document.onkeydown=ki;document.onkeyup=Fi;document.getElementById("camera_follow").checked=!1;document.getElementById("show_forces").checked=!0;document.getElementById("show_field").checked=!1;document.getElementById("show_forces").addEventListener("change",h=>{p.input_show_forces(document.getElementById("show_forces").checked)});document.getElementById("scenario_selector").addEventListener("change",h=>{console.log(document.getElementById("scenario_selector").value),Tt(g[document.getElementById("scenario_selector").value])});document.getElementById("scenario_restart").addEventListener("click",h=>{console.log("restart"),Tt(g[document.getElementById("scenario_selector").value])});document.getElementById("show_field").addEventListener("change",h=>{p.input_show_fields(document.getElementById("show_field").checked)});document.getElementById("camera_follow").addEventListener("change",h=>{p.input_camera_follow(document.getElementById("camera_follow").checked)});document.getElementById("camera_zoom_in").addEventListener("click",h=>{p.input_camera_zoom_relative(-2)});document.getElementById("camera_zoom_out").addEventListener("click",h=>{p.input_camera_zoom_relative(2)});document.getElementById("camera_move_left").addEventListener("click",h=>{p.input_camera_move_relative(-5,0)});document.getElementById("camera_move_right").addEventListener("click",h=>{p.input_camera_move_relative(5,0)});document.getElementById("camera_move_up").addEventListener("click",h=>{p.input_camera_move_relative(0,5)});document.getElementById("camera_move_down").addEventListener("click",h=>{p.input_camera_move_relative(0,-5)});var Si=function(h){h.pageX,h.pageY;var t=new z,e=new z;t.set(h.clientX/window.innerWidth*2-1,-(h.clientY/window.innerHeight)*2+1,.5),t.unproject(N),t.sub(N.position).normalize();var a=-N.position.z/t.z;e.copy(N.position).add(t.multiplyScalar(a));let i=p.get_wind_direction(e.x,e.y),s=p.get_wind_speed(e.x,e.y),n=Q.get_field_velocity(e.x,e.y).x,_=Q.get_field_velocity(e.x,e.y).y;i=Math.atan2(_,n)/Math.PI*180,s=Math.sqrt(n*n+_*_),document.getElementById("wind_info").innerHTML="Speed: "+Math.floor(s*1e3)/10+"<br>Direction: "+Math.floor(i*10)/10};document.addEventListener("mousemove",Si);function ki(h){h=h||window.event,D[h.keyCode]=!0,E.forEach(t=>{t.type==="KEYDOWN"&&D[t.activation_key]&&(D[t.prohibition_key]===!1||D[t.prohibition_key]===void 0)&&t.object[t.input_handler]()})}function Fi(h){h=h||window.event,D[h.keyCode]=!1}function gt(){at={},E=[],M.forEach(h=>{h.physics_model_deinit()}),M=[],X=0}function Tt(h){gt(),at=h}function st(h){E=[],h[0]!==void 0&&(E.push({type:"PRESSED",activation_key:37,prohibition_key:39,object:h[0],input_handler:h[0].input_rudder_left.name}),E.push({type:"PRESSED",activation_key:39,prohibition_key:37,object:h[0],input_handler:h[0].input_rudder_right.name}),E.push({type:"PRESSED",activation_key:40,prohibition_key:38,object:h[0],input_handler:h[0].input_autopilot_heading_increase.name}),E.push({type:"PRESSED",activation_key:38,prohibition_key:40,object:h[0],input_handler:h[0].input_autopilot_heading_decrease.name}),E.push({type:"KEYDOWN",activation_key:32,prohibition_key:-1,object:h[0],input_handler:h[0].input_autopilot_enabled_toggle.name}),E.push({type:"KEYDOWN",activation_key:13,prohibition_key:-1,object:h[0],input_handler:h[0].input_autopilot_tack_toggle.name})),h[1]!==void 0&&(E.push({type:"PRESSED",activation_key:65,prohibition_key:68,object:h[1],input_handler:h[1].input_rudder_left.name}),E.push({type:"PRESSED",activation_key:68,prohibition_key:65,object:h[1],input_handler:h[1].input_rudder_right.name}),E.push({type:"PRESSED",activation_key:83,prohibition_key:87,object:h[1],input_handler:h[1].input_autopilot_heading_increase.name}),E.push({type:"PRESSED",activation_key:87,prohibition_key:83,object:h[1],input_handler:h[1].input_autopilot_heading_decrease.name}),E.push({type:"KEYDOWN",activation_key:17,prohibition_key:-1,object:h[1],input_handler:h[0].input_autopilot_enabled_toggle.name}),E.push({type:"KEYDOWN",activation_key:16,prohibition_key:-1,object:h[1],input_handler:h[0].input_autopilot_tack_toggle.name}))}let g=[];g[0]=[];g[0][0]=()=>{M.push(new L(p,10,-9,5*Math.PI/4))};g[0][1]=()=>{console.log(1),M[0].input_autopilot_enabled_toggle()};g[0][2]=()=>{st(M)};g[1]=[];g[1][0]=()=>{M.push(new L(p,10,-8,5*Math.PI/4)),M.push(new L(p,15,-11.5,5*Math.PI/4))};g[1][1]=()=>{console.log(1),M[0].input_autopilot_enabled_toggle(),M[1].input_autopilot_enabled_toggle()};g[1][2]=()=>{st(M)};g[2]=[];g[2][0]=()=>{M.push(new L(p,-10,-6,3*Math.PI/4)),M.push(new L(p,15,-11.5,5*Math.PI/4))};g[2][1]=()=>{console.log(1),M[0].input_autopilot_enabled_toggle(),M[1].input_autopilot_enabled_toggle()};g[2][2]=()=>{st(M)};g[2][2e3]=()=>{gt()};g[3]=[];g[3][0]=()=>{M.push(new L(p,-3,-4,3*Math.PI/4)),M.push(new L(p,18,-11.5,5*Math.PI/4))};g[3][1]=()=>{console.log(1),M[0].input_autopilot_enabled_toggle(),M[1].input_autopilot_enabled_toggle()};g[3][2]=()=>{st(M)};g[3][300]=()=>{M[0].input_autopilot_tack_toggle()};g[3][2e3]=()=>{gt()};g[4]=[];g[4][0]=()=>{M.push(new L(p,-3,-4,3*Math.PI/4)),M.push(new L(p,18,-11.5,5*Math.PI/4))};g[4][1]=()=>{console.log(1),M[0].input_autopilot_enabled_toggle(),M[1].input_autopilot_enabled_toggle()};g[4][2]=()=>{st(M)};g[4][300]=()=>{M[0].input_autopilot_tack_toggle()};g[4][700]=()=>{M[1].input_autopilot_heading_decrease()};g[4][701]=()=>{M[1].input_autopilot_heading_decrease()};g[4][702]=()=>{M[1].input_autopilot_heading_decrease()};g[4][2e3]=()=>{gt()};g[5]=[];g[5][0]=()=>{Bt=[]};g[5][1]=()=>{Bt.push(new Ii(p))};Tt(g[document.getElementById("scenario_selector").value]);Ei.start(()=>{ut=[],at!==void 0&&at[X]!==void 0&&(console.log("Frame ",X),at[X]()),E.forEach(a=>{a.type==="PRESSED"&&D[a.activation_key]===!0&&(D[a.prohibition_key]===!1||D[a.prohibition_key]===void 0)&&a.object[a.input_handler]()}),p.set_camera_follow_target(M[0]),p.physics_model_step(),Bt.forEach(a=>{a.physics_model_step()}),M.forEach(a=>{a.physics_model_step(),ut=[...ut,...a.graphics_model_render()];let i={},s=a.awa/180*Math.PI+a.hull_angle-Math.PI/2;i.x=a.x+Math.cos(s)*-1.8,i.y=a.y+Math.sin(s)*-1.8,Math.cos(a.power_direction/180*Math.PI)*a.power/1e4,Math.sin(a.power_direction/180*Math.PI)*a.power/1e4,i.x0=a.x+Math.cos(s)*-2,i.y0=a.y+Math.sin(s)*-2,p.bm.apply_energy(i.x0,i.y0,a.power_direction),document.getElementById("info").innerHTML+="Phys Time: "+Q.t_delta+"<br>"}),X%1==0&&p.bm.physics_model_step(),X++;var h=p.fluid.vectorField.field;const t=si.image.data;for(let a=0;a<p.fluid.vectorField.areaWidth;a++)for(let i=0;i<p.fluid.vectorField.areaHeight;i++){let s=h[a][i].velocity,n=256-Pi(s,10,15,0,256);t[i*p.fluid.vectorField.areaWidth+a]=n}let e={};e.x=0,e.y=0,O.copyTextureToTexture(e,si,pt),Q.step_ready&&(O.copyTextureToTexture(e,ii,ct),Q.step_ready=!1),p.show_fields},()=>{});let N,T,O;ji();function ji(){N=new li(70,window.innerWidth/window.innerHeight,.01,85),N.position.z=60,N.position.y=20,T=new di,new Ct(6706517),new Ct(5592422);const h=new mi(p.width,p.height);let t=new ci(h,ei);t.position.x=0,t.position.y=0,t.position.z=-.01,T.add(t),O=new pi({antialias:!0}),O.setSize(window.innerWidth,window.innerHeight),O.setAnimationLoop(Bi),document.body.appendChild(O.domElement)}function Bi(h){N.position.x=p.camera_position_x,N.position.y=p.camera_position_y,N.position.z=p.camera_zoom;for(let t of S)T.remove(t),t.geometry.dispose(),t.material.dispose(),t=void 0;for(let t of hi)T.remove(t),t.geometry.dispose!==void 0&&t.geometry.dispose(),t.material.dispose!==void 0&&t.material.dispose(),t=void 0;S=[],hi=[];for(let t=p.world.getBodyList();t;t=t.getNext())for(let e=t.getFixtureList();e;e=e.getNext()){if(t.render&&t.render.hidden)continue;t.render&&t.render.stroke||t.isDynamic()||t.isKinematic()||t.isStatic();const a=e.getType(),i=e.getShape();if(a==="circle"){const s=i.m_radius,n=t.getPosition();let _=[];for(let l=0;l<360;l+=10){let d=l/180*Math.PI,c=s*Math.cos(d)+n.x,r=s*Math.sin(d)+n.y;_.push(new z(c,r,0))}_.push(_[0]);const o=new dt().setFromPoints(_),m=new $({color:65280});S.push(new mt(o,m)),T.add(S[S.length-1])}if(a==="edge"){let s=[];const n=i.m_vertex1,_=i.m_vertex2;let o=n.x+t.m_xf.p.x,m=n.y+t.m_xf.p.y,l=_.x+t.m_xf.p.x,d=_.y+t.m_xf.p.y;s.push(new z(o,m,0)),s.push(new z(l,d,0));const c=new dt().setFromPoints(s),r=new $({color:16711680});S.push(new mt(c,r)),T.add(S[S.length-1])}if(a==="polygon"){let s=i.m_vertices;s.push(s[0]);let n=[];for(const m of s){let l=t.getAngle()+Math.PI,d=t.getLocalCenter(),c=(m.x+d.x)*Math.cos(l)+(m.y-d.y)*Math.sin(l),r=(m.x+d.x)*Math.sin(l)-(m.y-d.y)*Math.cos(l),y=0;c+=e.m_body.c_position.c.x,r+=e.m_body.c_position.c.y,n.push(new z(c,r,y))}const _=new dt().setFromPoints(n),o=new $({color:255});S.push(new mt(_,o)),T.add(S[S.length-1])}}for(const t of ut){if(p.show_forces==!1&&t.type==="force")continue;let e=[];e.push(new z(t.x1,t.y1,0)),e.push(new z(t.x2,t.y2,0));const a=new dt().setFromPoints(e);let i=t.color;i===void 0&&(i=16711680);let s,n,_;t.opacity!==void 0?(n=!0,s=t.opacity,_=new $({color:i,transparent:n,opacity:s})):_=new $({color:i}),S.push(new mt(a,_)),T.add(S[S.length-1])}O.render(T,N)}
