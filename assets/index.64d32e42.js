import{p as mt,l as pt,D as Rt,R as Ct,U as Ot,a as Kt,N as Yt,M as Ut,b as Gt,P as Qt,S as Xt,C as St,c as $t,d as Jt,W as Zt,B as ot,L as J,e as nt,V as H}from"./vendor.601f039e.js";const te=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const h of i)if(h.type==="childList")for(const n of h.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const h={};return i.integrity&&(h.integrity=i.integrity),i.referrerpolicy&&(h.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?h.credentials="include":i.crossorigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(i){if(i.ep)return;i.ep=!0;const h=e(i);fetch(i.href,h)}};te();var ee=document.getElementById("plotSelect"),ie=document.getElementById("contrastSlider"),se=document.getElementById("rafCheck");const gt=4/9,q=1/9,F=1/36;var x=400,Wt=new Array(x+2),ft=new Array(x+2),yt=new Array(x+2),Mt=new Array(x+2);for(var P=0;P<=x;P++){var V,C,O;P<x/8?(V=0,C=0,O=Math.round(255*(P+x/8)/(x/4))):P<3*x/8?(V=0,C=Math.round(255*(P-x/8)/(x/4)),O=255):P<5*x/8?(V=Math.round(255*(P-3*x/8)/(x/4)),C=255,O=255-V):P<7*x/8?(V=255,C=Math.round(255*(7*x/8-P)/(x/4)),O=0):(V=Math.round(255*(9*x/8-P)/(x/4)),C=0,O=0),ft[P]=V,yt[P]=C,Mt[P]=O,Wt[P]=kt(V,C,O)}ft[x+1]=0;yt[x+1]=0;Mt[x+1]=0;Wt[x+1]=kt(0,0,0);function Z(l){return l<0&&(l=0),l>x&&(l=x),{red:ft[l],green:yt[l],blue:Mt[l]}}function bt(l){var t=l.toString(16);return t.length==1?"0"+t:t}function kt(l,t,e){return"#"+bt(l)+bt(t)+bt(e)}class U{constructor(t,e,s,i,h){this.is_temporary=h,this.x=e,this.y=s,this.parent=t,this.sub_mesh_depth=i,this._n0_=0,this._nN_=0,this._nS_=0,this._nE_=0,this._nW_=0,this._nNE_=0,this._nSE_=0,this._nNW_=0,this._nSW_=0,this._received_nN_=0,this._received_nS_=0,this._received_nE_=0,this._received_nW_=0,this._received_nNE_=0,this._received_nSE_=0,this._received_nNW_=0,this._received_nSW_=0,this._ux_=0,this._uy_=0,this._rho_=0,this._curl_=0,this.barrier=!1,this.child_00=null,this.child_01=null,this.child_10=null,this.child_11=null}find_child_cell(t,e){if(this.sub_mesh_depth==2,t*4===Math.round(t*4)){if(t<0&&e<0)return this.child_00;if(t>0&&e<0)return this.child_10;if(t<0&&e>0)return this.child_01;if(t>0&&e>0)return this.child_11}else{let s=Math.round(t*4),i=Math.round(e*4),h=(t*4-s)*1,n=(e*4-i)*1,o=this;if(h!==0){if(o.child_00==null&&(console.log("find_child_cell: convert",h,n),o.convert_to_finer_mesh(!0)),h<0&&n<0)return this.child_00.find_child_cell(h,n);if(h>0&&n<0)return this.child_10.find_child_cell(h,n);if(h<0&&n>0)return this.child_01.find_child_cell(h,n);if(h>0&&n>0)return this.child_11.find_child_cell(h,n)}return o}return this}setCurl(t){this._curl_=t}convert_to_finer_mesh(t){let e=this.x,s=this.y,i=this.parent;for(;i.sub_mesh_depth>0;)i=i.parent;if(this.child_00===null){let m=Math.pow(1/2,this.sub_mesh_depth*2);this.child_00=new U(this,e-m,s-m,this.sub_mesh_depth+1,t),this.child_01=new U(this,e-m,s+m,this.sub_mesh_depth+1,t),this.child_10=new U(this,e+m,s-m,this.sub_mesh_depth+1,t),this.child_11=new U(this,e+m,s+m,this.sub_mesh_depth+1,t)}const h=[[-1/64,1/8,1/64],[1/8,1,-1/8],[1/64,-1/8,-1/64]];let n=0,o=0,_=0,r=0,d=0,a=0,u=0,c=0,b=0,v=0,w=0,S=0;for(let m=0;m<3;m++)for(let p=0;p<3;p++)n+=h[m][p]*i.find_cell(e-1+m,s-1+p)._ux_,o+=h[m][p]*i.find_cell(e-1+m,s-1+p)._uy_,_+=h[m][p]*i.find_cell(e-1+m,s-1+p)._rho_,r+=h[2-p][m]*i.find_cell(e-1+m,s-1+p)._ux_,d+=h[2-p][m]*i.find_cell(e-1+m,s-1+p)._uy_,a+=h[2-p][m]*i.find_cell(e-1+m,s-1+p)._rho_,v+=h[2-m][2-p]*i.find_cell(e-1+m,s-1+p)._ux_,w+=h[2-m][2-p]*i.find_cell(e-1+m,s-1+p)._uy_,S+=h[2-m][2-p]*i.find_cell(e-1+m,s-1+p)._rho_,u+=h[p][2-m]*i.find_cell(e-1+m,s-1+p)._ux_,c+=h[p][2-m]*i.find_cell(e-1+m,s-1+p)._uy_,b+=h[p][2-m]*i.find_cell(e-1+m,s-1+p)._rho_;this.child_00.setEquil(n,o,_),this.child_01.setEquil(r,d,a),this.child_10.setEquil(u,c,b),this.child_11.setEquil(v,w,S)}setEquil(t,e,s){typeof s=="undefined"&&(s=this._rho_);var i=3*t,h=3*e,n=t*t,o=e*e,_=2*t*e,r=n+o,d=1.5*r;this._n0_=gt*s*(1-d),this._nE_=q*s*(1+i+4.5*n-d),this._nW_=q*s*(1-i+4.5*n-d),this._nN_=q*s*(1+h+4.5*o-d),this._nS_=q*s*(1-h+4.5*o-d),this._nNE_=F*s*(1+i+h+4.5*(r+_)-d),this._nSE_=F*s*(1+i-h+4.5*(r-_)-d),this._nNW_=F*s*(1-i+h+4.5*(r-_)-d),this._nSW_=F*s*(1-i-h+4.5*(r+_)-d),this._rho_=s,this._ux_=t,this._uy_=e}calculate_curl(){let t=this.parent;for(;t.sub_mesh_depth>0;)t=t.parent;let e=this.x,s=this.y;const i=Math.pow(1/2,this.sub_mesh_depth-1);let h=t.find_cell(e-i,s),n=t.find_cell(e+i,s),o=t.find_cell(e,s+i),_=t.find_cell(e,s-i);if(h===null||n===null||o===null||_===null){this._curl_=0;return}this._curl_=n._uy_-h._uy_-o._ux_+_._ux_,[h,n,o,_].forEach(r=>{r.is_temporary===!0&&(r.parent.child_00=null,r.parent.child_01=null,r.parent.child_10=null,r.parent.child_11=null)}),this.child_00!==null&&(this.child_00.calculate_curl(),this.child_01.calculate_curl(),this.child_10.calculate_curl(),this.child_11.calculate_curl())}collide(t){let e=this._n0_+this._nN_+this._nS_+this._nE_+this._nW_+this._nNW_+this._nNE_+this._nSW_+this._nSE_;this._rho_=e;let s=(this._nE_+this._nNE_+this._nSE_-this._nW_-this._nNW_-this._nSW_)/e;this._ux_=s;let i=(this._nN_+this._nNE_+this._nNW_-this._nS_-this._nSE_-this._nSW_)/e;this._uy_=i;let h=q*e,n=F*e,o=3*s,_=3*i,r=s*s,d=i*i,a=2*s*i,u=r+d,c=1.5*u;this._n0_+=t*(gt*e*(1-c)-this._n0_),this._nE_+=t*(h*(1+o+4.5*r-c)-this._nE_),this._nW_+=t*(h*(1-o+4.5*r-c)-this._nW_),this._nN_+=t*(h*(1+_+4.5*d-c)-this._nN_),this._nS_+=t*(h*(1-_+4.5*d-c)-this._nS_),this._nNE_+=t*(n*(1+o+_+4.5*(u+a)-c)-this._nNE_),this._nSE_+=t*(n*(1+o-_+4.5*(u-a)-c)-this._nSE_),this._nNW_+=t*(n*(1-o+_+4.5*(u-a)-c)-this._nNW_),this._nSW_+=t*(n*(1-o-_+4.5*(u+a)-c)-this._nSW_)}stream(){let t=this.parent,e=this.x,s=this.y;this._received_nN_=t.find_cell(e,s-1)._nN_,this._received_nNW_=t.find_cell(e+1,s-1)._nNW_,this._received_nE_=t.find_cell(e-1,s)._nE_,this._received_nNE_=t.find_cell(e-1,s-1)._nNE_,this._received_nS_=t.find_cell(e,s+1)._nS_,this._received_nSE_=t.find_cell(e-1,s+1)._nSE_,this._received_nW_=t.find_cell(e+1,s)._nW_,this._received_nSW_=t.find_cell(e+1,s+1)._nSW_}bounce(){let t=this.parent,e=this.x,s=this.y;this.barrier&&(t.find_cell(e+1,s)._received_nE_=this._received_nW_,t.find_cell(e-1,s)._received_nW_=this._received_nE_,t.find_cell(e,s+1)._received_nN_=this._received_nS_,t.find_cell(e,s-1)._received_nS_=this._received_nN_,t.find_cell(e+1,s+1)._received_nNE_=this._received_nSW_,t.find_cell(e-1,s+1)._received_nNW_=this._received_nSE_,t.find_cell(e+1,s-1)._received_nSE_=this._received_nNW_,t.find_cell(e-1,s-1)._received_nSW_=this._received_nNE_)}consolidate(){this._nN_=this._received_nN_,this._nS_=this._received_nS_,this._nE_=this._received_nE_,this._nW_=this._received_nW_,this._nNE_=this._received_nNE_,this._nSE_=this._received_nSE_,this._nNW_=this._received_nNW_,this._nSW_=this._received_nSW_,this._received_nN_=0,this._received_nS_=0,this._received_nE_=0,this._received_nW_=0,this._received_nNE_=0,this._received_nSE_=0,this._received_nNW_=0,this._received_nSW_=0}calculate_color(t,e,s){this.sub_mesh_depth==3;let i;if(this.barrier)i={red:0,green:0,blue:0};else if(e==-1)i={red:255/this.sub_mesh_depth,green:255/this.sub_mesh_depth,blue:255/this.sub_mesh_depth},this.x>this.parent.x?this.y>this.parent.y?i.red=0:i.green=0:i.blue=0;else if(e==0)i=Z(Math.round(x*((this._rho_-1)*6*s+.5)));else if(e==1)i=Z(Math.round(x*(this._ux_*2*s+.5)));else if(e==2)i=Z(Math.round(x*(this._uy_*2*s+.5)));else if(e==3){var h=Math.sqrt(this._ux_*this._ux_+this._uy_*this._uy_);i=Z(Math.round(x*(h*4*s)))}else i=Z(Math.round(x*(this._curl_*this.sub_mesh_depth*5*s+.5)));this.sub_mesh_depth==3&&(this._ux_=2e3,this._uy_=2e3,i={red:i.red/2,green:i.green/2,blue:i.blue/2}),t.colorSquare(this.x,this.y,Math.pow(.5,this.sub_mesh_depth-1),i.red,i.green,i.blue),this.child_00!==null&&(t.colorSquare(this.x,this.y,Math.pow(.5,this.sub_mesh_depth-1),0,0,0),this.child_00.calculate_color(t,e,s),this.child_01.calculate_color(t,e,s),this.child_10.calculate_color(t,e,s),this.child_11.calculate_color(t,e,s))}}class he{constructor(t,e,s,i,h,n,o){this.oversampling=o,this.texture=n,this.resolution=s,this.width=t*this.resolution,this.height=e*this.resolution,this.direction=i+180,this.step_ready=!1,this.t_delta=0,this.speed=h/100,this.viscosity=.02,this.cells=new Array(this.width*this.height);for(var _=0;_<this.height;_++)for(var r=0;r<this.width;r++)this.cells[r+_*this.width]=new U(this,r,_,1);for(var _=0;_<this.height;_++)for(var r=0;r<this.width;r++){this.find_cell(r,_).barrier=!1;let u=5;Math.pow(this.width/2-r,2)+Math.pow(this.height*.75-_,2)<Math.pow(u,2)&&(this.find_cell(r,_).barrier=!0)}this.running=!1,this.initFluid(),this.startStop(),this.graphics_model_init()}calculate_index(t,e){return t+e*this.width}find_cell(t,e){let s=Math.round(t),i=Math.round(e),h=(t-s)*1,n=(e-i)*1,o=this.cells[s+i*this.width];return t!=Math.round(t)?(o.child_00==null&&o.convert_to_finer_mesh(!0),o.find_child_cell(h,n)):o}initFluid(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;console.log(t,e);for(var s=0;s<this.height;s++)for(var i=0;i<this.width;i++)this.find_cell(i,s).setEquil(t,e,1),this.find_cell(i,s).setCurl(0)}startStop(){this.running=!this.running,this.running&&this.physics_model_step()}physics_model_step(){let t=new Date;for(let i=0;i<1;i++){this.setBoundaries(),this.collide(),this.stream(),this.bounce(),this.consolidate();for(var e=40;e<62;e++)for(var s=30;s<52;s++)this.find_cell(s,e).convert_to_finer_mesh();for(var e=45;e<51;e++)for(var s=35;s<41;s++)this.find_cell(s,e).child_00.convert_to_finer_mesh(),this.find_cell(s,e).child_01.convert_to_finer_mesh(),this.find_cell(s,e).child_10.convert_to_finer_mesh(),this.find_cell(s,e).child_11.convert_to_finer_mesh();this.computeCurl()}this.t_delta=new Date-t,this.step_ready=!0,this.graphics_model_init()}graphics_model_init(){this.graphics_model_step()}graphics_model_step(){this.paintTexture(),this.running&&(se.checked?requestAnimFrame(this.graphics_model_step_handler.bind(this)):window.setTimeout(this.graphics_model_step_handler.bind(this),10))}graphics_model_step_handler(){this.graphics_model_step()}setBoundaries(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;for(var s=0;s<this.width;s++)this.find_cell(s,0).setEquil(t,e,1),this.find_cell(s,this.height-1).setEquil(t,e,1);for(var i=1;i<this.height-1;i++)this.find_cell(0,i).setEquil(t,e,1),this.find_cell(this.width-1,i).setEquil(t,e,1)}collide(){for(var t=1/(3*this.viscosity+.5),e=1;e<this.height-1;e++)for(var s=1;s<this.width-1;s++)this.find_cell(s,e).collide(t)}stream(){for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)this.find_cell(e,t).stream()}bounce(){for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)this.find_cell(e,t).bounce()}consolidate(){for(var t=0;t<this.height;t++)for(var e=0;e<this.width;e++)this.find_cell(e,t).consolidate()}setEquil(t,e,s,i){typeof i=="undefined"&&(i=this._rho_[t]);var h=3*e,n=3*s,o=e*e,_=s*s,r=2*e*s,d=o+_,a=1.5*d;this._n0_[t]=gt*i*(1-a),this._nE_[t]=q*i*(1+h+4.5*o-a),this._nW_[t]=q*i*(1-h+4.5*o-a),this._nN_[t]=q*i*(1+n+4.5*_-a),this._nS_[t]=q*i*(1-n+4.5*_-a),this._nNE_[t]=F*i*(1+h+n+4.5*(d+r)-a),this._nSE_[t]=F*i*(1+h-n+4.5*(d-r)-a),this._nNW_[t]=F*i*(1-h+n+4.5*(d-r)-a),this._nSW_[t]=F*i*(1-h-n+4.5*(d+r)-a),this._rho_[t]=i,this._ux_[t]=e,this._uy_[t]=s}apply_energy(t,e,s,i){document.getElementById("wind_info").innerHTML="dir: "+s+"stre : "+i+"<br>";let h=this.width/2+Math.floor(t*this.resolution),n=this.height/2+Math.floor(e*this.resolution),o,_,r,d,a,u,c,b,v,w,S,m;o=Math.floor(h),a=Math.floor(n),_=o+1,u=a,r=o,c=a+1,d=o+1,b=a+1;let p=h-o,N=n-a;v=(1-p)*(1-N),w=p*(1-N),S=(1-p)*N,m=p*N;let L=[o,_,r,d],T=[a,u,c,b],dt=[v,w,S,m];for(let B=0;B<1;B++)this.apply_force_to_cell(L[B],T[B],s,dt[B]*i)}apply_force_to_cell(t,e,s,i){let h=this.find_cell(t,e)._ux_,n=this.find_cell(t,e)._uy_,o=this.find_cell(t,e)._rho_,_=Math.cos(s/180*Math.PI)*i/o*-1,r=Math.sin(s/180*Math.PI)*i/o*-1;this.find_cell(t,e).setEquil(h+_,n+r)}apply_energy_to_cell(t,e,s,i){let h=s+270;h>360&&(h-=360),document.getElementById("wind_info").innerHTML="mirror_angle: "+h+"<br>";const n=[this._nE_,this._nNE_,this._nN_,this._nNW_,this._nW_,this._nSW_,this._nS_,this._nSE_];document.getElementById("wind_info").innerHTML+=JSON.stringify(s)+"<br>";let o=[0,0,0,0,0,0,0,0],_=[0,0,0,0,0,0,0,0],r=[0,0,0,0,0,0,0,0],d=[0,0,0,0,0,0,0,0];for(let a=0;a<8;a++){const u=.1*i,c=(Math.floor(h/45)+1+a)%8;d[a]=c*45,r[a]=h-(d[a]-h),r[a]>360&&(r[a]-=360),r[a]<0&&(r[a]+=360),o[a]=Math.cos(r[a]/180*Math.PI)*n[c][t+e*this.width]*u,_[a]=Math.sin(r[a]/180*Math.PI)*n[c][t+e*this.width]*u,n[c][t+e*this.width]*=1-u}for(let a=0;a<8;a++){const u=(Math.floor(r[a]/45)+1+a)%8;let c,b;u%2==0?Math.abs(o[a])>Math.abs(_[a])?(c=o[a]-_[a],b=_[a]*Math.SQRT2):(c=_[a]-o[a],b=o[a]*Math.SQRT2):Math.abs(o[a])>Math.abs(_[a])?(c=_[a]*Math.SQRT2,b=o[a]-_[a]):(c=o[a]*Math.SQRT2,b=_[a]-o[a]),n[u][t+e*this.width]+=c,n[(u+1)%8][t+e*this.width]+=b;let v=c*1e4,w=b*1e4;document.getElementById("wind_info").innerHTML+="sou: "+d[a]+" mirr: "+Math.floor(r[a])+"<br>",document.getElementById("wind_info").innerHTML+="u: "+Math.floor(v)+" v: "+Math.floor(w)+"<br>"}}get_field_velocity(t,e){t=this.width/2+Math.floor(t*this.resolution),e=this.height/2+Math.floor(e*this.resolution);let s,i,h,n,o,_,r,d,a,u,c,b;s=Math.floor(t),o=Math.floor(e),i=s+1,_=o,h=s,r=o+1,n=s+1,d=o+1;let v=t-s,w=e-o;a=(1-v)*(1-w),u=v*(1-w),c=(1-v)*w,b=v*w;let S=0,m=0,p=this.find_cell(s,o),N=this.find_cell(i,_),L=this.find_cell(h,r),T=this.find_cell(n,d);return S=p._ux_*a+N._ux_*u+L._ux_*c+T._ux_*b,m=p._uy_*a+N._uy_*u+L._uy_*c+T._uy_*b,{x:S/4,y:m/4}}paintTexture(){for(var t=Math.pow(1.2,Number(ie.value)),e=ee.selectedIndex,s=0;s<this.height;s++)for(var i=0;i<this.width;i++)this.find_cell(i,s).calculate_color(this,e,t)}colorSquare(t,e,s,i,h,n){if(this.texture===void 0)return;let o=this.oversampling*s;for(var _=0;_<o;_++)for(var r=0;r<o;r++){let a=(t*this.oversampling-Math.round(t*this.oversampling))/2,u=(e*this.oversampling-Math.round(e*this.oversampling))/2,c=Math.round(t*this.oversampling)+_+Math.ceil(a*this.oversampling)+(s<1?1:0),b=Math.round(e*this.oversampling)+r+Math.ceil(u*this.oversampling)+(s<1?1:0);var d=(c+b*this.width*this.oversampling)*4;this.texture.image.data[d+0]=i,this.texture.image.data[d+1]=h,this.texture.image.data[d+2]=n,this.texture.image.data[d+3]=255}}computeCurl(){for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)this.find_cell(e,t).calculate_curl()}}window.requestAnimFrame=function(l){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1)}}();let tt=mt,k=tt.Vec2;function Bt(l){for(var t=0,e=0;e<l.length;e++)t+=l[e];return t}function jt(l){return Math.PI/180*l}function _e(l){return 180/Math.PI*Math.atan2(Bt(l.map(jt).map(Math.sin))/l.length,Bt(l.map(jt).map(Math.cos))/l.length)}class ae{constructor(t,e,s,i,h){this.bm=h,this.world=void 0,this.width=t,this.height=e,this.wind_direction=s,this.wind_speed=i,this.show_forces=!0,this.show_fields=!1,this.camera_follow_target=void 0,this.camera_follow=!1,this.camera_zoom=30,this.camera_zoom_max=70,this.camera_zoom_min=10,this.camera_position_x=0,this.camera_position_y=0,this.camera_position_x_max=30,this.camera_position_x_min=-30,this.camera_position_y_max=30,this.camera_position_y_min=-30}physics_model_init(){this.world=new pt.World(k(0,0));let t=this.world.createBody(k(0,0)),e={density:0,restitution:.4};t.createFixture(tt.Edge(k(-this.width/2+2,-this.height/2+2),k(-this.width/2+2,this.height/2-2)),e),t.createFixture(tt.Edge(k(this.width/2-2,-this.height/2+2),k(this.width/2-2,this.height/2-2)),e),t.createFixture(tt.Edge(k(-this.width/2+2,this.height/2-2),k(this.width/2-2,this.height/2-2)),e),t.createFixture(tt.Edge(k(-this.width/2+2,-this.height/2+2),k(this.width/2-2,-this.height/2+2)),e),this.world.createDynamicBody(k(0,14.5)).createFixture(pt.Circle(.5),10),this.world.createDynamicBody(k(0,20)).createFixture(pt.Circle(5),10)}get_wind_speed(t,e){let s=this.bm.get_field_velocity(t,e),i=this.bm.get_field_velocity(t-1,e),h=this.bm.get_field_velocity(t+1,e),n=this.bm.get_field_velocity(t,e-1),o=this.bm.get_field_velocity(t,e+1),_=0;return _+=Math.sqrt(s.x*s.x+s.y*s.y),_+=Math.sqrt(i.x*i.x+i.y*i.y),_+=Math.sqrt(h.x*h.x+h.y*h.y),_+=Math.sqrt(n.x*n.x+n.y*n.y),_+=Math.sqrt(o.x*o.x+o.y*o.y),_/5*100*4}get_wind_direction(t,e){let s=this.bm.get_field_velocity(t,e),i=this.bm.get_field_velocity(t-1,e),h=this.bm.get_field_velocity(t+1,e),n=this.bm.get_field_velocity(t,e-1),o=this.bm.get_field_velocity(t,e+1),_=[Math.atan2(s.y,s.x)/Math.PI*180+180,Math.atan2(i.y,i.x)/Math.PI*180+180,Math.atan2(h.y,h.x)/Math.PI*180+180,Math.atan2(n.y,n.x)/Math.PI*180+180,Math.atan2(o.y,o.x)/Math.PI*180+180];return _e(_)}set_camera_follow_target(t){this.camera_follow_target=t}physics_model_step(){this.camera_follow===!0&&this.camera_follow_target!==void 0&&(this.camera_position_x=this.camera_follow_target.x,this.camera_position_y=this.camera_follow_target.y,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min))}input_show_fields(t){this.show_fields=t}input_show_forces(t){this.show_forces=t}input_camera_follow(t){this.camera_follow=t}input_camera_zoom_relative(t){this.camera_zoom+=t,this.camera_zoom>this.camera_zoom_max&&(this.camera_zoom=this.camera_zoom_max),this.camera_zoom<this.camera_zoom_min&&(this.camera_zoom=this.camera_zoom_min)}input_camera_move_relative(t,e){this.camera_position_x+=t,this.camera_position_y+=e,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min)}}let Nt=mt,f=Nt.Vec2;class A{constructor(t,e,s,i){this.map=t,this.x=e,this.y=s,i!=null?this.hull_angle=i:this.hull_angle=Math.PI,this.wind_direction=0,this.wind_speed=0,this.hull_mass=6,this.hull_shape=Nt.Polygon([f(0,-2.25),f(-.5,-1.25),f(-.75,-.25),f(-.75,.5),f(-.5,1.75),f(.5,1.75),f(.75,.5),f(.75,-.25),f(.5,-1.25),f(0,-2.25)]),this.rudder_input=0,this.motor_input=0,this.rudder_angle=0,this.rudder_angle_last=0,this.rudder_angle_max=60,this.rudder_position=1.8,this.rudder_lenght=.5,this.forces=[],this.mainsail_leading_edge_position=-.8,this.mainsail_boom_length=2.2,this.mainsail_boom_angle_max=80,this.mainsail_boom_angle_factor=.5,this.mainsail_boom_angle=0,this.mainsail_boom_angle_actual=0,this.jib_leading_edge_position=-2,this.jib_boom_length=1.4,this.jib_boom_angle_max=55,this.jib_boom_angle_factor=.65,this.jib_boom_angle=0,this.jib_boom_angle_actual=0,this.center_of_lift=-.05,this.centerboard_position=-.15,this.centerboard_length=.6,this.aero_lookup_resolution=5,this.aero_lift_lookup=[0,.025,.15,.9,1.3,1.46,1.52,1.51,1.45,1.41,1.33,1.16,.95,.82,.73,.6,.43,.34,.28,.28,.28],this.aero_drag_lookup=[.15,.15,.15,.16,.172,.19,.22,.25,.29,.34,.4,.47,.55,.635,.73,.83,.95,1.1,1.28,1.28,1.28],this.physics_model=void 0,this.power=0,this.power_direction=0,this.autopilot_enabled=!1,this.autopilot_heading_target=0,this.autopilot_heading_input=0,this.autopilot_heading_best_vmg_1=50,this.autopilot_heading_best_vmg_2=160,this.autopilot_compensator_p=0,this.autopilot_compensator_i=0,this.autopilot_compensator_d=0,this.autopilot_compensator_last_error=0,this.autopilot_compensator_current_error=0,this.autopilot_compensator_sum_error=0,this.twa=0,this.physics_model_init()}physics_model_init(){let t=mt,e=t.Vec2,s=this.map.world.createBody({type:"dynamic",angularDamping:.5,linearDamping:.1,position:e(this.x,this.y),angle:this.hull_angle,allowSleep:!1});s.createFixture(this.hull_shape,this.hull_mass),this.physics_model=s}physics_model_deinit(){this.map.world.destroyBody(this.physics_model)}physics_model_step(){this.forces=[],document.getElementById("info").innerHTML="Autopilot"+this.autopilot_enabled+"<br>",document.getElementById("info").innerHTML+="Heading Target"+this.autopilot_heading_target+"<br>",this.x=this.physics_model.m_xf.p.x,this.y=this.physics_model.m_xf.p.y,this.wind_speed=this.map.get_wind_speed(this.x,this.y),this.wind_direction=this.map.get_wind_direction(this.x,this.y);var t=this.physics_model.getAngle();for(this.angle=t,this.hull_angle=t;t<-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;let e=this.physics_model.m_linearVelocity.x*Math.cos(t-Math.PI/2)+this.physics_model.m_linearVelocity.y*Math.sin(t-Math.PI/2),s=this.physics_model.m_linearVelocity.x*Math.cos(t)+this.physics_model.m_linearVelocity.y*Math.sin(t),i=Math.atan2(s,Math.abs(e))*180/Math.PI;i>90?i-=180:i<-90&&(i+=180);let h=-i*Math.abs(e)*Math.abs(e)*2;h>150?h=150:h<-150&&(h=-150);var n=this.physics_model.getWorldVector(f(h,0)),o=this.physics_model.getWorldPoint(f(0,this.centerboard_position));this.physics_model.applyForce(n,o,!0),this.forces.push({name:"centerboard",type:"arrow",vector:n,point:o}),document.getElementById("info").innerHTML+="q/d: "+i+"\xB0<br>";let _=this.map.get_wind_direction(this.x,this.y)-t/Math.PI*180+90,r={};r.x=this.physics_model.m_linearVelocity.x+Math.cos(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y),r.y=this.physics_model.m_linearVelocity.y+Math.sin(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y);let d=Math.atan2(r.y,r.x)/Math.PI*180-t/Math.PI*180+90,a=Math.sqrt(r.x*r.x+r.y*r.y);if(d>180&&(d-=360),d<-180&&(d+=360),_>180&&(_-=360),_<-180&&(_+=360),this.awa=d,this.twa=_,this.motor_input===1){var u=this.physics_model.getWorldVector(f(0,-.3)),c=this.physics_model.getWorldPoint(f(0,2));this.physics_model.applyLinearImpulse(u,c,!0)}if(this.motor_input===-1){var u=this.physics_model.getWorldVector(f(0,.3)),c=this.physics_model.getWorldPoint(f(0,2));this.physics_model.applyLinearImpulse(u,c,!0)}this.rudder_angle_last=this.rudder_angle;let b=0;const v=1-Math.abs(e)>0?1-Math.abs(e)+1:1;if(this.rudder_input===-1)this.rudder_angle<this.rudder_angle_max&&(this.rudder_angle+=v),b=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else if(this.rudder_input===1)this.rudder_angle>-this.rudder_angle_max&&(this.rudder_angle-=v),b=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else{let W=e;e>1&&(W=1),e<-1&&(W=-1),this.rudder_angle=this.rudder_angle*(.98-W/80)}if(this.autopilot_enabled){this.autopilot_compensator_p=2,this.autopilot_compensator_i=0,this.autopilot_compensator_d=100;let W=-(this.autopilot_heading_target- -this.twa);this.autopilot_compensator_sum_error*=.85,this.autopilot_compensator_sum_error+=W,W>180&&(W-=360),W<-180&&(W+=360),document.getElementById("info").innerHTML+="error: "+Math.floor(W)+"\xB0<br>";let zt=W*this.autopilot_compensator_p,Ht=this.autopilot_compensator_sum_error*this.autopilot_compensator_i,Vt=(W-this.autopilot_compensator_last_error)*this.autopilot_compensator_d;this.rudder_angle_target=(zt+Ht+Vt)*Math.sign(e),this.rudder_angle_target>this.rudder_angle_max/2&&(this.rudder_angle_target=this.rudder_angle_max/2),this.rudder_angle_target<-this.rudder_angle_max/2&&(this.rudder_angle_target=-this.rudder_angle_max/2),this.rudder_angle+=(this.rudder_angle_target-this.rudder_angle)/10,this.autopilot_compensator_last_error=W}else this.autopilot_heading_target=-this.twa,this.autopilot_heading_target>180&&(this.autopilot_heading_target-=360),this.autopilot_heading_target<-180&&(this.autopilot_heading_target+=360);let S=this.physics_model.m_angularVelocity*this.rudder_lenght,m=Math.atan2(-s+S,Math.abs(e))/Math.PI*180,p=0;e>0?p=e*(this.rudder_angle+m)/7:p=e*(this.rudder_angle-m)/7,p+=b*2;let N=this.physics_model.getWorldPoint(f(0,this.rudder_position)),L={};L.x=Math.cos(t+this.rudder_angle/180*Math.PI)*p,L.y=Math.sin(t+this.rudder_angle/180*Math.PI)*p,this.physics_model.applyForce(L,N,!0),this.forces.push({name:"rudder",type:"arrow",vector:L,point:N}),document.getElementById("info").innerHTML+="TWA: "+Math.floor(_)+"<br>",document.getElementById("info").innerHTML+="TWS: "+Math.floor(this.wind_speed*10)/10+"<br>",document.getElementById("info").innerHTML+="AWA: "+Math.floor(d)+"<br>",document.getElementById("info").innerHTML+="AWS: "+Math.floor(a*10)/10+"<br>";let T=Math.sqrt(this.physics_model.m_linearVelocity.x*this.physics_model.m_linearVelocity.x+this.physics_model.m_linearVelocity.y*this.physics_model.m_linearVelocity.y),dt=Math.cos(_/180*Math.PI)*T;document.getElementById("info").innerHTML+="BS: "+Math.floor(T*10)/10+"<br>",document.getElementById("info").innerHTML+="VMG: "+Math.floor(dt*10)/10+"<br>",this.jib_boom_angle=this.awa*this.jib_boom_angle_factor,this.jib_boom_angle>this.jib_boom_angle_max&&(this.jib_boom_angle=this.jib_boom_angle_max),this.jib_boom_angle<-this.jib_boom_angle_max&&(this.jib_boom_angle=-this.jib_boom_angle_max),this.mainsail_boom_angle=this.awa*this.mainsail_boom_angle_factor,this.mainsail_boom_angle>this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=this.mainsail_boom_angle_max),this.mainsail_boom_angle<-this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=-this.mainsail_boom_angle_max);const B=Math.floor(Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution),st=Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution-B;let ct=this.aero_drag_lookup[B]*(1-st)+this.aero_drag_lookup[B+1]*st,ut=this.aero_lift_lookup[B]*(1-st)+this.aero_lift_lookup[B+1]*st,K={},Y={};document.getElementById("info").innerHTML+="Cd: "+Math.floor(ct*10)/10+"<br>",document.getElementById("info").innerHTML+="Cl: "+Math.floor(ut*10)/10+"<br>";const ht=.15/3;K.x=Math.cos(t+this.awa/180*Math.PI+Math.PI/2)*a*a*ct*ht,K.y=Math.sin(t+this.awa/180*Math.PI+Math.PI/2)*a*a*ct*ht,Y.x=-Math.sign(this.awa)*Math.cos(t+this.awa/180*Math.PI)*a*a*ut*ht,Y.y=-Math.sign(this.awa)*Math.sin(t+this.awa/180*Math.PI)*a*a*ut*ht;let z={};z.x=K.x+Y.x,z.y=K.y+Y.y;var _t=this.physics_model.getWorldPoint(f(0,this.center_of_lift));this.physics_model.applyForce(Y,_t,!0),this.physics_model.applyForce(K,_t,!0),this.forces.push({name:"mainsail",type:"arrow",vector:Y,point:_t}),this.forces.push({name:"mainsail",type:"arrow",vector:K,point:_t}),this.power=Math.sqrt(z.x*z.x+z.y*z.y),this.power_direction=Math.atan2(z.y,z.x)/Math.PI*180,document.getElementById("info").innerHTML+="Power: "+Math.floor(this.power*10)/10+"<br>";var at={};at.x=-this.physics_model.m_linearVelocity.x*T,at.y=-this.physics_model.m_linearVelocity.y*T;var Et=this.physics_model.getWorldPoint(f(0,0));this.physics_model.applyForce(at,Et,!0),this.forces.push({name:"drag",type:"arrow",vector:at,point:Et}),this.rudder_input=0,this.motor_input=0}graphics_model_render(){let t=[];this.forces.forEach(a=>{t.push({color:65280,type:"force",x1:a.point.x,y1:a.point.y,x2:a.point.x+a.vector.x/10,y2:a.point.y+a.vector.y/10})});let e={},s=2;this.autopilot_enabled&&(s=10),e.x1=this.physics_model.getWorldPoint(f(0,0)).x,e.y1=this.physics_model.getWorldPoint(f(0,0)).y,e.x2=e.x1+Math.cos((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*s,e.y2=e.y1+Math.sin((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*s,e.color=5596791,e.type="autopilot",t.push(e);let i=this.wind_direction/180*Math.PI;t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),i=this.awa/180*Math.PI+this.hull_angle-Math.PI/2,t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(f(0,this.rudder_position)).x,y1:this.physics_model.getWorldPoint(f(0,this.rudder_position)).y,x2:this.physics_model.getWorldPoint(f(0,this.rudder_position)).x+Math.cos(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght,y2:this.physics_model.getWorldPoint(f(0,this.rudder_position)).y+Math.sin(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(f(0,this.centerboard_position+this.centerboard_length/2)).x,y1:this.physics_model.getWorldPoint(f(0,this.centerboard_position+this.centerboard_length/2)).y,x2:this.physics_model.getWorldPoint(f(0,this.centerboard_position-this.centerboard_length/2)).x,y2:this.physics_model.getWorldPoint(f(0,this.centerboard_position-this.centerboard_length/2)).y});let h=[];h[0]={},h[0].x=this.physics_model.getWorldPoint(f(0,this.mainsail_leading_edge_position)).x,h[0].y=this.physics_model.getWorldPoint(f(0,this.mainsail_leading_edge_position)).y,this.mainsail_boom_angle/this.mainsail_boom_angle_factor,this.mainsail_boom_angle_actual+=(this.mainsail_boom_angle-this.mainsail_boom_angle_actual)/30;let n=this.mainsail_boom_length*.05*Math.abs(this.awa)/30<this.mainsail_boom_length/10?this.mainsail_boom_length*.05*Math.abs(this.awa)/30:this.mainsail_boom_length/10;h[1]={},h[1].x=h[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-n*Math.sign(this.mainsail_boom_angle_actual),h[1].y=h[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-n*Math.sign(this.mainsail_boom_angle_actual);let o=n;h[2]={},h[2].x=h[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-o*Math.sign(this.mainsail_boom_angle_actual),h[2].y=h[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-o*Math.sign(this.mainsail_boom_angle_actual),h[3]={},h[3].x=h[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,h[3].y=h[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,t.push({color:8939263,type:"sail",x1:h[0].x,y1:h[0].y,x2:h[1].x,y2:h[1].y}),t.push({color:8939263,type:"sail",x1:h[1].x,y1:h[1].y,x2:h[2].x,y2:h[2].y}),t.push({color:8939263,type:"sail",x1:h[2].x,y1:h[2].y,x2:h[3].x,y2:h[3].y}),this.jib_boom_angle_actual+=(this.jib_boom_angle-this.jib_boom_angle_actual)/20;let _=[];_[0]={},_[0].x=this.physics_model.getWorldPoint(f(0,this.jib_leading_edge_position)).x,_[0].y=this.physics_model.getWorldPoint(f(0,this.jib_leading_edge_position)).y;let r=this.jib_boom_length*.05*Math.abs(this.awa)/15<this.jib_boom_length/3?this.jib_boom_length*.05*Math.abs(this.awa)/15:this.jib_boom_length/3;_[1]={},_[1].x=_[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.jib_boom_angle_actual),_[1].y=_[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.jib_boom_angle_actual);let d=r;if(_[2]={},_[2].x=_[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),_[2].y=_[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),_[3]={},_[3].x=_[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,_[3].y=_[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,t.push({color:8939263,type:"sail",x1:_[0].x,y1:_[0].y,x2:_[1].x,y2:_[1].y}),t.push({color:8939263,type:"sail",x1:_[1].x,y1:_[1].y,x2:_[2].x,y2:_[2].y}),t.push({color:8939263,type:"sail",x1:_[2].x,y1:_[2].y,x2:_[3].x,y2:_[3].y}),this.map.show_fields){const a=10;for(let u=-a;u<a;u++)for(let c=-a;c<a;c++)if(Math.sqrt(u*u+c*c)<a-1){const b=this.map.bm.resolution;let v=Math.floor(this.x*b)/b+u/b,w=Math.floor(this.y*b)/b+c/b,S=this.map.bm.get_field_velocity(v,w);t.push({color:8939263,type:"sail",x1:v,y1:w,x2:v+S.x*30,y2:w+S.y*30})}}return t}input_rudder_left(){this.rudder_input=1,this.autopilot_enabled=!1}input_rudder_right(){this.rudder_input=-1,this.autopilot_enabled=!1}input_motor_forward(){this.motor_input=1}input_motor_reverse(){this.motor_input=-1}input_autopilot_enabled_toggle(){this.autopilot_heading_target<0?this.autopilot_heading_target>-90?this.autopilot_heading_target=-this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=-this.autopilot_heading_best_vmg_2:this.autopilot_heading_target<90?this.autopilot_heading_target=this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=this.autopilot_heading_best_vmg_2,this.autopilot_enabled=!0}input_autopilot_tack_toggle(){this.autopilot_heading_target*=-1,this.autopilot_enabled=!0}input_autopilot_heading_increase(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)<175&&(this.autopilot_heading_target>0?this.autopilot_heading_target+=1:this.autopilot_heading_target-=1)}input_autopilot_heading_decrease(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)>5&&(this.autopilot_heading_target>0?this.autopilot_heading_target-=1:this.autopilot_heading_target+=1)}}const xt=50,vt=50,Lt=90,Tt=15,wt=2;var It=4,qt=It*xt*wt,Ft=It*vt*wt,oe=qt*Ft*4,ne=new Uint8Array(oe),G=new Rt(ne,qt,Ft,Ct,Ot,Kt);G.magFilter=Yt;G.needsUpdate=!0;var At=new Ut({map:G,transparent:!0});At.needsUpdate=!0;const Q=new he(xt,vt,wt,Lt,Tt,G,It);let g=new ae(xt,vt,Lt,Tt,Q);g.physics_model_init();let et={},y=[],X=0;const le=new Gt(g.world,{speed:1,fps:30});let I=[],R=[],E=[],Dt=[],lt=[];document.onkeydown=de;document.onkeyup=ce;document.getElementById("camera_follow").checked=!1;document.getElementById("show_forces").checked=!0;document.getElementById("show_field").checked=!1;document.getElementById("show_forces").addEventListener("change",l=>{g.input_show_forces(document.getElementById("show_forces").checked)});document.getElementById("scenario_selector").addEventListener("change",l=>{console.log(document.getElementById("scenario_selector").value),Pt(M[document.getElementById("scenario_selector").value])});document.getElementById("scenario_restart").addEventListener("click",l=>{console.log("restart"),Pt(M[document.getElementById("scenario_selector").value])});document.getElementById("show_field").addEventListener("change",l=>{g.input_show_fields(document.getElementById("show_field").checked)});document.getElementById("windAngle").addEventListener("change",l=>{let t=parseInt(document.getElementById("windAngle").value);g.bm.direction=t+180});document.getElementById("camera_follow").addEventListener("change",l=>{g.input_camera_follow(document.getElementById("camera_follow").checked)});document.getElementById("camera_zoom_in").addEventListener("click",l=>{g.input_camera_zoom_relative(-2)});document.getElementById("camera_zoom_out").addEventListener("click",l=>{g.input_camera_zoom_relative(2)});document.getElementById("camera_move_left").addEventListener("click",l=>{g.input_camera_move_relative(-5,0)});document.getElementById("camera_move_right").addEventListener("click",l=>{g.input_camera_move_relative(5,0)});document.getElementById("camera_move_up").addEventListener("click",l=>{g.input_camera_move_relative(0,5)});document.getElementById("camera_move_down").addEventListener("click",l=>{g.input_camera_move_relative(0,-5)});var re=function(l){l.pageX,l.pageY;var t=new H,e=new H;t.set(l.clientX/window.innerWidth*2-1,-(l.clientY/window.innerHeight)*2+1,.5),t.unproject(j),t.sub(j.position).normalize();var s=-j.position.z/t.z;e.copy(j.position).add(t.multiplyScalar(s));let i=g.get_wind_direction(e.x,e.y),h=g.get_wind_speed(e.x,e.y),n=Q.get_field_velocity(e.x,e.y).x,o=Q.get_field_velocity(e.x,e.y).y;i=Math.atan2(o,n)/Math.PI*180,h=Math.sqrt(n*n+o*o),document.getElementById("wind_info").innerHTML="Speed: "+Math.floor(h*1e3)/10+"<br>Direction: "+Math.floor(i*10)/10};document.addEventListener("mousemove",re);function de(l){l=l||window.event,R[l.keyCode]=!0,I.forEach(t=>{t.type==="KEYDOWN"&&R[t.activation_key]&&(R[t.prohibition_key]===!1||R[t.prohibition_key]===void 0)&&t.object[t.input_handler]()})}function ce(l){l=l||window.event,R[l.keyCode]=!1}function rt(){et={},I=[],y.forEach(l=>{l.physics_model_deinit()}),y=[],X=0}function Pt(l){rt(),et=l}function it(l){I=[],l[0]!==void 0&&(I.push({type:"PRESSED",activation_key:37,prohibition_key:39,object:l[0],input_handler:l[0].input_rudder_left.name}),I.push({type:"PRESSED",activation_key:39,prohibition_key:37,object:l[0],input_handler:l[0].input_rudder_right.name}),I.push({type:"PRESSED",activation_key:40,prohibition_key:38,object:l[0],input_handler:l[0].input_autopilot_heading_increase.name}),I.push({type:"PRESSED",activation_key:38,prohibition_key:40,object:l[0],input_handler:l[0].input_autopilot_heading_decrease.name}),I.push({type:"KEYDOWN",activation_key:32,prohibition_key:-1,object:l[0],input_handler:l[0].input_autopilot_enabled_toggle.name}),I.push({type:"KEYDOWN",activation_key:13,prohibition_key:-1,object:l[0],input_handler:l[0].input_autopilot_tack_toggle.name})),l[1]!==void 0&&(I.push({type:"PRESSED",activation_key:65,prohibition_key:68,object:l[1],input_handler:l[1].input_rudder_left.name}),I.push({type:"PRESSED",activation_key:68,prohibition_key:65,object:l[1],input_handler:l[1].input_rudder_right.name}),I.push({type:"PRESSED",activation_key:83,prohibition_key:87,object:l[1],input_handler:l[1].input_autopilot_heading_increase.name}),I.push({type:"PRESSED",activation_key:87,prohibition_key:83,object:l[1],input_handler:l[1].input_autopilot_heading_decrease.name}),I.push({type:"KEYDOWN",activation_key:17,prohibition_key:-1,object:l[1],input_handler:l[0].input_autopilot_enabled_toggle.name}),I.push({type:"KEYDOWN",activation_key:16,prohibition_key:-1,object:l[1],input_handler:l[0].input_autopilot_tack_toggle.name}))}let M=[];M[0]=[];M[0][0]=()=>{y.push(new A(g,10,-9,5*Math.PI/4))};M[0][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle()};M[0][2]=()=>{it(y)};M[1]=[];M[1][0]=()=>{y.push(new A(g,12,-6,5*Math.PI/4)),y.push(new A(g,15,-11.5,5*Math.PI/4))};M[1][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};M[1][2]=()=>{it(y)};M[2]=[];M[2][0]=()=>{y.push(new A(g,-10,-6,3*Math.PI/4)),y.push(new A(g,15,-11.5,5*Math.PI/4))};M[2][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};M[2][2]=()=>{it(y)};M[2][2e3]=()=>{rt()};M[3]=[];M[3][0]=()=>{y.push(new A(g,-3,-3,3*Math.PI/4)),y.push(new A(g,18,-11.5,5*Math.PI/4))};M[3][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};M[3][2]=()=>{it(y)};M[3][350]=()=>{y[0].input_autopilot_tack_toggle()};M[3][2e3]=()=>{rt()};M[4]=[];M[4][0]=()=>{y.push(new A(g,-3,-4,3*Math.PI/4)),y.push(new A(g,18,-11.5,5*Math.PI/4))};M[4][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};M[4][2]=()=>{it(y)};M[4][300]=()=>{y[0].input_autopilot_tack_toggle()};M[4][700]=()=>{y[1].input_autopilot_heading_decrease()};M[4][701]=()=>{y[1].input_autopilot_heading_decrease()};M[4][702]=()=>{y[1].input_autopilot_heading_decrease()};M[4][2e3]=()=>{rt()};M[5]=[];Pt(M[document.getElementById("scenario_selector").value]);le.start(()=>{lt=[],et!==void 0&&et[X]!==void 0&&(console.log("Frame ",X),et[X]()),I.forEach(e=>{e.type==="PRESSED"&&R[e.activation_key]===!0&&(R[e.prohibition_key]===!1||R[e.prohibition_key]===void 0)&&e.object[e.input_handler]()}),g.set_camera_follow_target(y[0]),g.physics_model_step();let l=0;y.forEach((e,s)=>{y.forEach((o,_)=>{if(_>s){let r=e.x-o.x,d=e.y-o.y;l+=Math.sqrt(r*r+d*d),document.getElementById("dist_info").innerHTML="Dist: "+Math.floor(l*100)/100+"<br>"}}),e.physics_model_step(),lt=[...lt,...e.graphics_model_render()];let i={},h=e.awa/180*Math.PI+e.hull_angle-Math.PI/2;i.x=e.x+Math.cos(h)*-1.8,i.y=e.y+Math.sin(h)*-1.8,Math.cos(e.power_direction/180*Math.PI)*e.power/1e4,Math.sin(e.power_direction/180*Math.PI)*e.power/1e4;const n=1.5;i.x0=e.x+Math.cos(e.hull_angle+90/180*Math.PI)*-n+Math.cos(h)*-2,i.y0=e.y+Math.sin(e.hull_angle+90/180*Math.PI)*-n+Math.sin(h)*-2,i.x1=e.x+Math.cos(e.hull_angle+90/180*Math.PI)*0+Math.cos(h)*-2,i.y1=e.y+Math.sin(e.hull_angle+90/180*Math.PI)*0+Math.sin(h)*-2,i.x2=e.x+Math.cos(e.hull_angle+90/180*Math.PI)*+n+Math.cos(h)*-2,i.y2=e.y+Math.sin(e.hull_angle+90/180*Math.PI)*+n+Math.sin(h)*-2,g.bm.apply_energy(i.x0,i.y0,e.power_direction,e.power/5e3),g.bm.apply_energy(i.x1,i.y1,e.power_direction,e.power/2e3),g.bm.apply_energy(i.x2,i.y2,e.power_direction,e.power/5e3),document.getElementById("info").innerHTML+="Phys Time: "+Q.t_delta+"<br>"}),X%1==0&&g.bm.physics_model_step(),X++;let t={};t.x=0,t.y=0,Q.step_ready&&($.copyTextureToTexture(t,G,G),Q.step_ready=!1),g.show_fields},()=>{});let j,D,$;ue();function ue(){j=new Qt(70,window.innerWidth/window.innerHeight,.01,85),j.position.z=60,j.position.y=20,D=new Xt,new St(6706517),new St(5592422);const l=new $t(g.width,g.height);let t=new Jt(l,At);t.position.x=0,t.position.y=0,t.position.z=-.01,D.add(t),$=new Zt({antialias:!0}),$.setSize(window.innerWidth,window.innerHeight),$.setAnimationLoop(me),document.body.appendChild($.domElement)}function me(l){j.position.x=g.camera_position_x,j.position.y=g.camera_position_y,j.position.z=g.camera_zoom;for(let t of E)D.remove(t),t.geometry.dispose(),t.material.dispose(),t=void 0;for(let t of Dt)D.remove(t),t.geometry.dispose!==void 0&&t.geometry.dispose(),t.material.dispose!==void 0&&t.material.dispose(),t=void 0;E=[],Dt=[];for(let t=g.world.getBodyList();t;t=t.getNext())for(let e=t.getFixtureList();e;e=e.getNext()){if(t.render&&t.render.hidden)continue;t.render&&t.render.stroke||t.isDynamic()||t.isKinematic()||t.isStatic();const s=e.getType(),i=e.getShape();if(s==="circle"){const h=i.m_radius,n=t.getPosition();let o=[];for(let d=0;d<360;d+=10){let a=d/180*Math.PI,u=h*Math.cos(a)+n.x,c=h*Math.sin(a)+n.y;o.push(new H(u,c,0))}o.push(o[0]);const _=new ot().setFromPoints(o),r=new J({color:65280});E.push(new nt(_,r)),D.add(E[E.length-1])}if(s==="edge"){let h=[];const n=i.m_vertex1,o=i.m_vertex2;let _=n.x+t.m_xf.p.x,r=n.y+t.m_xf.p.y,d=o.x+t.m_xf.p.x,a=o.y+t.m_xf.p.y;h.push(new H(_,r,0)),h.push(new H(d,a,0));const u=new ot().setFromPoints(h),c=new J({color:16711680});E.push(new nt(u,c)),D.add(E[E.length-1])}if(s==="polygon"){let h=i.m_vertices;h.push(h[0]);let n=[];for(const r of h){let d=t.getAngle()+Math.PI,a=t.getLocalCenter(),u=(r.x+a.x)*Math.cos(d)+(r.y-a.y)*Math.sin(d),c=(r.x+a.x)*Math.sin(d)-(r.y-a.y)*Math.cos(d),b=0;u+=e.m_body.c_position.c.x,c+=e.m_body.c_position.c.y,n.push(new H(u,c,b))}const o=new ot().setFromPoints(n),_=new J({color:255});E.push(new nt(o,_)),D.add(E[E.length-1])}}for(const t of lt){if(g.show_forces==!1&&t.type==="force")continue;let e=[];e.push(new H(t.x1,t.y1,0)),e.push(new H(t.x2,t.y2,0));const s=new ot().setFromPoints(e);let i=t.color;i===void 0&&(i=16711680);let h,n,o;t.opacity!==void 0?(n=!0,h=t.opacity,o=new J({color:i,transparent:n,opacity:h})):o=new J({color:i}),E.push(new nt(s,o)),D.add(E[E.length-1])}$.render(D,j)}
