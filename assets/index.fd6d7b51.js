import{p as wt,l as Mt,D as dt,R as Tt,U as mt,a as qt,N as zt,M as Vt,b as hi,L as Dt,P as oi,S as ni,C as Ht,c as _i,d as ri,W as li,B as ct,e as Z,f as ut,V as D}from"./vendor.da8be286.js";const di=function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function e(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerpolicy&&(s.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?s.credentials="include":t.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(t){if(t.ep)return;t.ep=!0;const s=e(t);fetch(t.href,s)}};di();var tt=document.getElementById("theCanvas"),Rt=tt.getContext("2d"),mi=document.getElementById("plotSelect"),ci=document.getElementById("contrastSlider"),ui=document.getElementById("rafCheck");const Ct=4/9,it=1/9,et=1/36;var w=400,Kt=new Array(w+2),vt=new Array(w+2),xt=new Array(w+2),bt=new Array(w+2);for(var k=0;k<=w;k++){var H,C,K;k<w/8?(H=0,C=0,K=Math.round(255*(k+w/8)/(w/4))):k<3*w/8?(H=0,C=Math.round(255*(k-w/8)/(w/4)),K=255):k<5*w/8?(H=Math.round(255*(k-3*w/8)/(w/4)),C=255,K=255-H):k<7*w/8?(H=255,C=Math.round(255*(7*w/8-k)/(w/4)),K=0):(H=Math.round(255*(9*w/8-k)/(w/4)),C=0,K=0),vt[k]=H,xt[k]=C,bt[k]=K,Kt[k]=Ot(H,C,K)}vt[w+1]=0;xt[w+1]=0;bt[w+1]=0;Kt[w+1]=Ot(0,0,0);function It(h){var i=h.toString(16);return i.length==1?"0"+i:i}function Ot(h,i,e){return"#"+It(h)+It(i)+It(e)}class pi{constructor(i,e,a,t,s,n){this.texture=n,this.resolution=a,this.width=i*this.resolution,this.height=e*this.resolution,this.direction=t+180,this.speed=s,this.step_ready=!1,this.t_delta=0,tt.width=this.width,tt.height=this.height,this.speed=.12,this.speed=.12,this.viscosity=.02,this._n0_=new Array(this.width*this.height),this._nN_=new Array(this.width*this.height),this._nS_=new Array(this.width*this.height),this._nE_=new Array(this.width*this.height),this._nW_=new Array(this.width*this.height),this._nNE_=new Array(this.width*this.height),this._nSE_=new Array(this.width*this.height),this._nNW_=new Array(this.width*this.height),this._nSW_=new Array(this.width*this.height),this._ux_=new Array(this.width*this.height),this._uy_=new Array(this.width*this.height),this._rho_=new Array(this.width*this.height),this._curl_=new Array(this.width*this.height),this.barrier=new Array(this.width*this.height);for(var _=0;_<this.height;_++)for(var o=0;o<this.width;o++)this.barrier[o+_*this.width]=!1;for(var d=16,_=this.height/2-d;_<=this.height/2+d;_++){var o=Math.round(this.height/3);this.barrier[o+_*this.width]=!0}this.image=Rt.createImageData(tt.width,tt.height);for(var r=3;r<this.image.data.length;r+=4)this.image.data[r]=255;this.running=!1,this.initFluid(),this.startStop()}initFluid(){let i=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;console.log(i,e);for(var a=0;a<this.height;a++)for(var t=0;t<this.width;t++)this.setEquil(t,a,i,e,1),this._curl_[t+a*this.width]=0}startStop(){this.running=!this.running,this.running&&this.physics_model_step()}physics_model_step(){let i=new Date;for(let s=0;s<8;s++)this.setBoundaries(),this.collide(),this.stream();this.t_delta=new Date-i,this.step_ready=!0,this.paintCanvas();for(var e=!0,a=0;a<this.width;a++){var t=a+this.height/2*this.width;this._rho_[t]<=0&&(e=!1)}e||(window.alert("The simulation has become unstable due to excessive fluid speeds."),this.startStop(),this.initFluid()),this.running&&(ui.checked?requestAnimFrame(this.physics_model_step_handler.bind(this)):window.setTimeout(this.physics_model_step_handler.bind(this),1))}physics_model_step_handler(){this.physics_model_step()}setBoundaries(){let i=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;for(var a=0;a<this.width;a++)this.setEquil(a,0,i,e,1),this.setEquil(a,this.height-1,i,e,1);for(var t=1;t<this.height-1;t++)this.setEquil(0,t,i,e,1),this.setEquil(this.width-1,t,i,e,1)}collide(){for(var i=1/(3*this.viscosity+.5),e=1;e<this.height-1;e++)for(var a=1;a<this.width-1;a++){var t=a+e*this.width,s=this._n0_[t]+this._nN_[t]+this._nS_[t]+this._nE_[t]+this._nW_[t]+this._nNW_[t]+this._nNE_[t]+this._nSW_[t]+this._nSE_[t];this._rho_[t]=s;var n=(this._nE_[t]+this._nNE_[t]+this._nSE_[t]-this._nW_[t]-this._nNW_[t]-this._nSW_[t])/s;this._ux_[t]=n;var _=(this._nN_[t]+this._nNE_[t]+this._nNW_[t]-this._nS_[t]-this._nSE_[t]-this._nSW_[t])/s;this._uy_[t]=_;var o=it*s,d=et*s,r=3*n,l=3*_,m=n*n,u=_*_,M=2*n*_,v=m+u,f=1.5*v;this._n0_[t]+=i*(Ct*s*(1-f)-this._n0_[t]),this._nE_[t]+=i*(o*(1+r+4.5*m-f)-this._nE_[t]),this._nW_[t]+=i*(o*(1-r+4.5*m-f)-this._nW_[t]),this._nN_[t]+=i*(o*(1+l+4.5*u-f)-this._nN_[t]),this._nS_[t]+=i*(o*(1-l+4.5*u-f)-this._nS_[t]),this._nNE_[t]+=i*(d*(1+r+l+4.5*(v+M)-f)-this._nNE_[t]),this._nSE_[t]+=i*(d*(1+r-l+4.5*(v-M)-f)-this._nSE_[t]),this._nNW_[t]+=i*(d*(1-r+l+4.5*(v-M)-f)-this._nNW_[t]),this._nSW_[t]+=i*(d*(1-r-l+4.5*(v+M)-f)-this._nSW_[t])}for(var e=1;e<this.height-2;e++)this._nW_[this.width-1+e*this.width]=this._nW_[this.width-2+e*this.width],this._nNW_[this.width-1+e*this.width]=this._nNW_[this.width-2+e*this.width],this._nSW_[this.width-1+e*this.width]=this._nSW_[this.width-2+e*this.width]}stream(){for(var i=this.height-2;i>0;i--)for(var e=1;e<this.width-1;e++)this._nN_[e+i*this.width]=this._nN_[e+(i-1)*this.width],this._nNW_[e+i*this.width]=this._nNW_[e+1+(i-1)*this.width];for(var i=this.height-2;i>0;i--)for(var e=this.width-2;e>0;e--)this._nE_[e+i*this.width]=this._nE_[e-1+i*this.width],this._nNE_[e+i*this.width]=this._nNE_[e-1+(i-1)*this.width];for(var i=1;i<this.height-1;i++)for(var e=this.width-2;e>0;e--)this._nS_[e+i*this.width]=this._nS_[e+(i+1)*this.width],this._nSE_[e+i*this.width]=this._nSE_[e-1+(i+1)*this.width];for(var i=1;i<this.height-1;i++)for(var e=1;e<this.width-1;e++)this._nW_[e+i*this.width]=this._nW_[e+1+i*this.width],this._nSW_[e+i*this.width]=this._nSW_[e+1+(i+1)*this.width];for(var i=1;i<this.height-1;i++)for(var e=1;e<this.width-1;e++)if(this.barrier[e+i*this.width]){var a=e+i*this.width;this._nE_[e+1+i*this.width]=this._nW_[a],this._nW_[e-1+i*this.width]=this._nE_[a],this._nN_[e+(i+1)*this.width]=this._nS_[a],this._nS_[e+(i-1)*this.width]=this._nN_[a],this._nNE_[e+1+(i+1)*this.width]=this._nSW_[a],this._nNW_[e-1+(i+1)*this.width]=this._nSE_[a],this._nSE_[e+1+(i-1)*this.width]=this._nNW_[a],this._nSW_[e-1+(i-1)*this.width]=this._nNE_[a]}}setEquil(i,e,a,t,s){var n=i+e*this.width;typeof s=="undefined"&&(s=this._rho_[n]);var _=3*a,o=3*t,d=a*a,r=t*t,l=2*a*t,m=d+r,u=1.5*m;this._n0_[n]=Ct*s*(1-u),this._nE_[n]=it*s*(1+_+4.5*d-u),this._nW_[n]=it*s*(1-_+4.5*d-u),this._nN_[n]=it*s*(1+o+4.5*r-u),this._nS_[n]=it*s*(1-o+4.5*r-u),this._nNE_[n]=et*s*(1+_+o+4.5*(m+l)-u),this._nSE_[n]=et*s*(1+_-o+4.5*(m-l)-u),this._nNW_[n]=et*s*(1-_+o+4.5*(m-l)-u),this._nSW_[n]=et*s*(1-_-o+4.5*(m+l)-u),this._rho_[n]=s,this._ux_[n]=a,this._uy_[n]=t}apply_energy(i,e,a,t){let s=this.width/2+Math.floor(i*this.resolution),n=this.height/2+Math.floor(e*this.resolution),_,o,d,r,l,m,u,M,v,f,I,P;_=Math.floor(s),l=Math.floor(n),o=_+1,m=l,d=_,u=l+1,r=_+1,M=l+1;let b=s-_,E=n-l;v=(1-b)*(1-E),f=b*(1-E),I=(1-b)*E,P=b*E;let B=this._ux_[_+l*this.width],x=this._uy_[_+l*this.width],N=this._ux_[o+m*this.width],S=this._uy_[o+m*this.width],U=this._ux_[d+u*this.width],Q=this._uy_[d+u*this.width],X=this._ux_[r+M*this.width],z=this._uy_[r+M*this.width];this.setEquil(_,l,B+v*a,x+v*t),this.setEquil(o,m,N+f*a,S+f*t),this.setEquil(d,u,U+I*a,Q+I*t),this.setEquil(r,M,X+P*a,z+P*t)}get_field_velocity(i,e){i=this.width/2+Math.floor(i*this.resolution),e=this.height/2+Math.floor(e*this.resolution);let a,t,s,n,_,o,d,r,l,m,u,M;a=Math.floor(i),_=Math.floor(e),t=a+1,o=_,s=a,d=_+1,n=a+1,r=_+1;let v=i-a,f=e-_;l=(1-v)*(1-f),m=v*(1-f),u=(1-v)*f,M=v*f;let I=0,P=0;return I=this._ux_[a+_*this.width]*l+this._ux_[t+o*this.width]*m+this._ux_[s+d*this.width]*u+this._ux_[n+r*this.width]*M,P=this._uy_[a+_*this.width]*l+this._uy_[t+o*this.width]*m+this._uy_[s+d*this.width]*u+this._uy_[n+r*this.width]*M,{x:I/4,y:P/4}}paintCanvas(){var i=0,e=Math.pow(1.2,Number(ci.value)),a=mi.selectedIndex;a==4&&this.computeCurl();for(var t=0;t<this.height;t++)for(var s=0;s<this.width;s++){if(this.barrier[s+t*this.width])i=w+1;else{if(a==0)i=Math.round(w*((this._rho_[s+t*this.width]-1)*6*e+.5));else if(a==1)i=Math.round(w*(this._ux_[s+t*this.width]*2*e+.5));else if(a==2)i=Math.round(w*(this._uy_[s+t*this.width]*2*e+.5));else if(a==3){var n=Math.sqrt(this._ux_[s+t*this.width]*this._ux_[s+t*this.width]+this._uy_[s+t*this.width]*this._uy_[s+t*this.width]);i=Math.round(w*(n*4*e))}else i=Math.round(w*(this._curl_[s+t*this.width]*5*e+.5));i<0&&(i=0),i>w&&(i=w)}this.colorSquare(s,t,vt[i],xt[i],bt[i])}Rt.putImageData(this.image,0,0)}colorSquare(i,e,a,t,s){var n=(i+e*this.width)*4;this.texture.image.data[n+0]=a,this.texture.image.data[n+1]=t,this.texture.image.data[n+2]=s,this.texture.image.data[n+3]=255;for(var _=this.height-e-1,o=_;o<_+1;o++)for(var d=i;d<i+1;d++){var r=(d+o*this.width)*4;this.image.data[r+0]=a,this.image.data[r+1]=t,this.image.data[r+2]=s}}computeCurl(){for(var i=1;i<this.height-1;i++)for(var e=1;e<this.width-1;e++)this._curl_[e+i*this.width]=this._uy_[e+1+i*this.width]-this._uy_[e-1+i*this.width]-this._ux_[e+(i+1)*this.width]+this._ux_[e+(i-1)*this.width]}}window.requestAnimFrame=function(h){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(i){window.setTimeout(i,1)}}();let O=1,at;at=.3*O;let Pt=4;Pt=4;let Gt={vectorField:void 0,objCanvas:void 0,ctx:void 0,enableFrameDragging:!0,enableEmitter:!0,loopTimer:void 0,loopTicker:0,emitterX:0,emitterY:0,init:function(h,i){this.initVectorField(h,i)},initVectorField:function(h,i){this.vectorField=new gi(h,i,h*O,i*O)},start:function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.animateFrame=function(h){Gt.loop(),window.animateTimestamp=h,window.requestAnimationFrame(animateFrame)},window.animateFrame()},get_field_velocity:function(h,i){var e=this.vectorField.areaWidth,a=this.vectorField.areaHeight;h+=this.vectorField.width/2,i+=this.vectorField.height/2,h*=O,i*=O;let t,s,n,_,o,d,r,l,m,u,M,v;t=Math.floor(h),o=Math.floor(i),s=t+1,d=o,n=t,r=o+1,_=t+1,l=o+1;let f=h-t,I=i-o;m=(1-f)*(1-I),u=f*(1-I),M=(1-f)*I,v=f*I;let P=h+.5>>0,b=i-.5>>0,E=0,B=0;if(P<e-1&&P>0+1&&b<a-1&&b>0+1){var x=this.vectorField.field;E=x[t][o].vx*m+x[s][d].vx*u+x[n][r].vx*M+x[_][l].vx*v,B=x[t][o].vy*m+x[s][d].vy*u+x[n][r].vy*M+x[_][l].vy*v}return{x:-E,y:B}},apply_energy:function(h,i,e,a){var t=this.vectorField.areaWidth,s=this.vectorField.areaHeight;h+=this.vectorField.width/2,i+=this.vectorField.height/2,h*=O,i*=O;let n,_,o,d,r,l,m,u,M,v,f,I;n=Math.floor(h),r=Math.floor(i),_=n+1,l=r,o=n,m=r+1,d=n+1,u=r+1;let P=h-n,b=i-r;M=(1-P)*(1-b),v=P*(1-b),f=(1-P)*b,I=P*b;let E=h+.5>>0,B=i+.5>>0;if(E<t-1&&E>0+1&&B<s-1&&B>0+1){var x=this.vectorField.field;let N=0,S=0;N+=-Math.cos(e/180*Math.PI)*a,S+=-Math.sin(e/180*Math.PI)*a,x[n][r].vx+=M*N,x[n][r].vy+=M*S,x[_][l].vx+=v*N,x[_][l].vy+=v*S,x[o][m].vx+=f*N,x[o][m].vy+=f*S,x[d][u].vx+=I*N,x[d][u].vy+=I*S}},loop:function(){this.updateVectorField()},updateVectorField:function(){var h=this.vectorField.field,i=this.vectorField.areaWidth,e=this.vectorField.areaHeight,a,t,s,n,_,o;for(a=i;a--;)for(t=e;t--;)a<i-1&&a>0+1&&t<e-1&&t>0+1?(s=(h[a-1][t].vx+h[a+1][t].vx+h[a][t-1].vx+h[a][t+1].vx)/4,n=(h[a-1][t].vy+h[a+1][t].vy+h[a][t-1].vy+h[a][t+1].vy)/4,_=h[a][t].vx*(1-at)+s*at,o=h[a][t].vy*(1-at)+n*at):(_=h[a][t].vx,o=h[a][t].vy),h[a][t].vx_=_,h[a][t].vy_=o;for(a=i;a--;)for(t=e;t--;);for(a=i;a--;)for(t=e;t--;){let d=h[a][t].vx_,r=h[a][t].vy_,l=Math.abs(d)/60*Pt,m=Math.abs(r)/60*Pt;if(a<i-1&&a>0+1&&t<e-1&&t>0+1){let u,M,v,f,I,P,b,E;u=h[a][t].vx_,M=h[a-Math.sign(d)][t].vx_,v=h[a][t-Math.sign(r)].vx_,f=h[a-Math.sign(d)][t-Math.sign(r)].vx_,I=h[a][t].vy_,P=h[a-Math.sign(d)][t].vy_,b=h[a][t-Math.sign(r)].vy_,E=h[a-Math.sign(d)][t-Math.sign(r)].vy_,h[a][t].vx__=(1-l)*(1-m)*u+l*(1-m)*M+(1-l)*m*v+l*m*f,h[a][t].vy__=(1-l)*(1-m)*I+l*(1-m)*P+(1-l)*m*b+l*m*E,(h[a][t].vx__===void 0||h[a][t].vy__===void 0)&&(console.log("TRAP"),h=void 0)}else h[a][t].vx__=h[a][t].vx_,h[a][t].vy__=h[a][t].vy_;(t==e-2||t==1||a==i-2||a==1)&&(h[a][t].vx__=0,h[a][t].vy__=-2.5)}for(a=i;a--;)for(t=e;t--;)h[a][t].vx=h[a][t].vx__,h[a][t].vy=h[a][t].vy__,h[a][t].velocity=Math.sqrt(h[a][t].vx*h[a][t].vx+h[a][t].vy*h[a][t].vy)}},gi=function(h,i,e,a){this.field=[],this.width=h,this.height=i,this.areaWidth=e,this.areaHeight=a;var t,s;for(t=e;t--;)for(this.field[t]=[],s=a;s--;)this.field[t][s]=new yi},yi=function(){this.velocity=0,this.vx=0,this.vy=-2,this.vx_=0,this.vy_=-2,this.vx__=0,this.vy__=-2},st=wt,A=st.Vec2;function Yt(h){for(var i=0,e=0;e<h.length;e++)i+=h[e];return i}function Ut(h){return Math.PI/180*h}function fi(h){return 180/Math.PI*Math.atan2(Yt(h.map(Ut).map(Math.sin))/h.length,Yt(h.map(Ut).map(Math.cos))/h.length)}class wi{constructor(i,e,a,t){this.fluid=Gt,this.world=void 0,this.width=i,this.height=e,this.wind_direction=a,this.wind_speed=t,this.show_forces=!0,this.show_fields=!1,this.camera_follow_target=void 0,this.camera_follow=!1,this.camera_zoom=30,this.camera_zoom_max=70,this.camera_zoom_min=10,this.camera_position_x=0,this.camera_position_y=0,this.camera_position_x_max=30,this.camera_position_x_min=-30,this.camera_position_y_max=30,this.camera_position_y_min=-30}physics_model_init(){this.fluid.init(this.width,this.height),this.world=new Mt.World(A(0,0));let i=this.world.createBody(A(0,0)),e={density:0,restitution:.4};i.createFixture(st.Edge(A(-this.width/2+2,-this.height/2+2),A(-this.width/2+2,this.height/2-2)),e),i.createFixture(st.Edge(A(this.width/2-2,-this.height/2+2),A(this.width/2-2,this.height/2-2)),e),i.createFixture(st.Edge(A(-this.width/2+2,this.height/2-2),A(this.width/2-2,this.height/2-2)),e),i.createFixture(st.Edge(A(-this.width/2+2,-this.height/2+2),A(this.width/2-2,-this.height/2+2)),e),this.world.createDynamicBody(A(0,14.5)).createFixture(Mt.Circle(.5),10),this.world.createDynamicBody(A(0,20)).createFixture(Mt.Circle(5),10)}get_wind_speed(i,e){let a=this.fluid.get_field_velocity(i,e),t=this.fluid.get_field_velocity(i-1,e),s=this.fluid.get_field_velocity(i+1,e),n=this.fluid.get_field_velocity(i,e-1),_=this.fluid.get_field_velocity(i,e+1),o=0;return o+=Math.sqrt(a.x*a.x+a.y*a.y),o+=Math.sqrt(t.x*t.x+t.y*t.y),o+=Math.sqrt(s.x*s.x+s.y*s.y),o+=Math.sqrt(n.x*n.x+n.y*n.y),o+=Math.sqrt(_.x*_.x+_.y*_.y),o/5*5}get_wind_direction(i,e){let a=this.fluid.get_field_velocity(i,e),t=this.fluid.get_field_velocity(i-1,e),s=this.fluid.get_field_velocity(i+1,e),n=this.fluid.get_field_velocity(i,e-1),_=this.fluid.get_field_velocity(i,e+1),o=[Math.atan2(a.x,a.y)/Math.PI*180+270,Math.atan2(t.x,t.y)/Math.PI*180+270,Math.atan2(s.x,s.y)/Math.PI*180+270,Math.atan2(n.x,n.y)/Math.PI*180+270,Math.atan2(_.x,_.y)/Math.PI*180+270];return fi(o)}set_camera_follow_target(i){this.camera_follow_target=i}physics_model_step(){this.camera_follow===!0&&this.camera_follow_target!==void 0&&(this.camera_position_x=this.camera_follow_target.x,this.camera_position_y=this.camera_follow_target.y,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min))}input_show_fields(i){this.show_fields=i}input_show_forces(i){this.show_forces=i}input_camera_follow(i){this.camera_follow=i}input_camera_zoom_relative(i){this.camera_zoom+=i,this.camera_zoom>this.camera_zoom_max&&(this.camera_zoom=this.camera_zoom_max),this.camera_zoom<this.camera_zoom_min&&(this.camera_zoom=this.camera_zoom_min)}input_camera_move_relative(i,e){this.camera_position_x+=i,this.camera_position_y+=e,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min)}}class Mi{constructor(i){this.map=i,this.age=0,this.maxage=4e3,this.parameter=[],this.parameter[0]=[20,0],this.parameter[1]=[0,10],this.parameter[2]=[10,50],this.parameter[3]=[10,5],this.parameter[4]=[0,0],this.parameter[5]=[.1,.5],this.strength=3,this.result=[],this.result[0]=(this.parameter[0][0]*(this.maxage-this.age)+this.parameter[0][1]*this.age)/this.maxage,this.result[1]=(this.parameter[1][0]*(this.maxage-this.age)+this.parameter[1][1]*this.age)/this.maxage,this.result[2]=(this.parameter[2][0]*(this.maxage-this.age)+this.parameter[2][1]*this.age)/this.maxage,this.result[3]=(this.parameter[3][0]*(this.maxage-this.age)+this.parameter[3][1]*this.age)/this.maxage,this.result[4]=(this.parameter[4][0]*(this.maxage-this.age)+this.parameter[4][1]*this.age)/this.maxage,this.result[5]=(this.parameter[5][0]*(this.maxage-this.age)+this.parameter[5][1]*this.age)/this.maxage}physics_model_step(){this.result[0]=(this.parameter[0][0]*(this.maxage-this.age)+this.parameter[0][1]*this.age)/this.maxage,this.result[1]=(this.parameter[1][0]*(this.maxage-this.age)+this.parameter[1][1]*this.age)/this.maxage,this.result[2]=(this.parameter[2][0]*(this.maxage-this.age)+this.parameter[2][1]*this.age)/this.maxage,this.result[3]=(this.parameter[3][0]*(this.maxage-this.age)+this.parameter[3][1]*this.age)/this.maxage,this.result[4]=(this.parameter[4][0]*(this.maxage-this.age)+this.parameter[4][1]*this.age)/this.maxage,this.result[5]=(this.parameter[5][0]*(this.maxage-this.age)+this.parameter[5][1]*this.age)/this.maxage,this.p_beam_x=this.result[0],this.p_beam_y=this.result[1],this.p_beam_width=this.result[2],this.p_beam_height=this.result[3],this.p_beam_direction=this.result[4],this.p_beam_elevation=this.result[5];let i=this.strength*Math.sin(Math.PI*this.age/this.maxage)*(this.p_beam_width+this.p_beam_height)/20,e=Math.PI/4*this.p_beam_width*this.p_beam_height,a=i/e;for(let t=-this.p_beam_width/2;t<=this.p_beam_width/2;t++)for(let s=-this.p_beam_height/2;s<=this.p_beam_height/2;s++){let n=t/(this.p_beam_width/2),_=s/(this.p_beam_height/2);if(Math.sqrt(n*n+_*_)<1){let o=Math.atan2(s-this.p_beam_height/2*(1-this.p_beam_elevation),t)/Math.PI*180,d=Math.cos(this.p_beam_direction/180*Math.PI)*t+-Math.sin(this.p_beam_direction/180*Math.PI)*s,r=Math.sin(this.p_beam_direction/180*Math.PI)*t+Math.cos(this.p_beam_direction/180*Math.PI)*s;this.map.fluid.apply_energy(this.p_beam_x+d,this.p_beam_y+r,o+this.p_beam_direction,-a)}}this.age<this.maxage&&this.age++}}let $t=wt,g=$t.Vec2;class T{constructor(i,e,a,t){this.map=i,this.x=e,this.y=a,t!=null?this.hull_angle=t:this.hull_angle=Math.PI,this.wind_direction=0,this.wind_speed=0,this.hull_mass=8,this.hull_shape=$t.Polygon([g(0,-2.25),g(-.5,-1.25),g(-.75,-.25),g(-.75,.5),g(-.5,1.75),g(.5,1.75),g(.75,.5),g(.75,-.25),g(.5,-1.25),g(0,-2.25)]),this.rudder_input=0,this.motor_input=0,this.rudder_angle=0,this.rudder_angle_last=0,this.rudder_angle_max=60,this.rudder_position=1.8,this.rudder_lenght=.5,this.forces=[],this.mainsail_leading_edge_position=-.8,this.mainsail_boom_length=2.2,this.mainsail_boom_angle_max=80,this.mainsail_boom_angle_factor=.5,this.mainsail_boom_angle=0,this.mainsail_boom_angle_actual=0,this.jib_leading_edge_position=-2,this.jib_boom_length=1.4,this.jib_boom_angle_max=55,this.jib_boom_angle_factor=.65,this.jib_boom_angle=0,this.jib_boom_angle_actual=0,this.center_of_lift=-.05,this.centerboard_position=-.15,this.centerboard_length=.6,this.aero_lookup_resolution=5,this.aero_lift_lookup=[0,.025,.15,.9,1.3,1.46,1.52,1.51,1.45,1.41,1.33,1.16,.95,.82,.73,.6,.43,.34,.28,.28,.28],this.aero_drag_lookup=[.15,.15,.15,.16,.172,.19,.22,.25,.29,.34,.4,.47,.55,.635,.73,.83,.95,1.1,1.28,1.28,1.28],this.physics_model=void 0,this.power=0,this.power_direction=0,this.autopilot_enabled=!1,this.autopilot_heading_target=0,this.autopilot_heading_input=0,this.autopilot_heading_best_vmg_1=50,this.autopilot_heading_best_vmg_2=160,this.autopilot_compensator_p=0,this.autopilot_compensator_i=0,this.autopilot_compensator_d=0,this.autopilot_compensator_last_error=0,this.autopilot_compensator_current_error=0,this.autopilot_compensator_sum_error=0,this.twa=0,this.physics_model_init()}physics_model_init(){let i=wt,e=i.Vec2,a=this.map.world.createBody({type:"dynamic",angularDamping:.5,linearDamping:.1,position:e(this.x,this.y),angle:this.hull_angle,allowSleep:!1});a.createFixture(this.hull_shape,this.hull_mass),this.physics_model=a}physics_model_deinit(){this.map.world.destroyBody(this.physics_model)}physics_model_step(){this.forces=[],document.getElementById("info").innerHTML="Autopilot"+this.autopilot_enabled+"<br>",document.getElementById("info").innerHTML+="Heading Target"+this.autopilot_heading_target+"<br>",this.x=this.physics_model.m_xf.p.x,this.y=this.physics_model.m_xf.p.y,this.wind_speed=this.map.get_wind_speed(this.x,this.y),this.wind_direction=this.map.get_wind_direction(this.x,this.y);var i=this.physics_model.getAngle();for(this.hull_angle=i;i<-Math.PI;)i+=2*Math.PI;for(;i>Math.PI;)i-=2*Math.PI;let e=this.physics_model.m_linearVelocity.x*Math.cos(i-Math.PI/2)+this.physics_model.m_linearVelocity.y*Math.sin(i-Math.PI/2),a=this.physics_model.m_linearVelocity.x*Math.cos(i)+this.physics_model.m_linearVelocity.y*Math.sin(i),t=Math.atan2(a,Math.abs(e))*180/Math.PI;t>90?t-=180:t<-90&&(t+=180);let s=-t*Math.abs(e)*Math.abs(e)*2;s>150?s=150:s<-150&&(s=-150);var n=this.physics_model.getWorldVector(g(s,0)),_=this.physics_model.getWorldPoint(g(0,this.centerboard_position));this.physics_model.applyForce(n,_,!0),this.forces.push({name:"centerboard",type:"arrow",vector:n,point:_}),document.getElementById("info").innerHTML+="q/d: "+t+"\xB0<br>";let o=this.map.get_wind_direction(this.x,this.y)-i/Math.PI*180+90,d={};d.x=this.physics_model.m_linearVelocity.x+Math.cos(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y),d.y=this.physics_model.m_linearVelocity.y+Math.sin(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y);let r=Math.atan2(d.y,d.x)/Math.PI*180-i/Math.PI*180+90,l=Math.sqrt(d.x*d.x+d.y*d.y);if(r>180&&(r-=360),r<-180&&(r+=360),o>180&&(o-=360),o<-180&&(o+=360),this.awa=r,this.twa=o,this.motor_input===1){var m=this.physics_model.getWorldVector(g(0,-.3)),u=this.physics_model.getWorldPoint(g(0,2));this.physics_model.applyLinearImpulse(m,u,!0)}if(this.motor_input===-1){var m=this.physics_model.getWorldVector(g(0,.3)),u=this.physics_model.getWorldPoint(g(0,2));this.physics_model.applyLinearImpulse(m,u,!0)}this.rudder_angle_last=this.rudder_angle;let M=0;const v=1-Math.abs(e)>0?1-Math.abs(e)+1:1;if(this.rudder_input===-1)this.rudder_angle<this.rudder_angle_max&&(this.rudder_angle+=v),M=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else if(this.rudder_input===1)this.rudder_angle>-this.rudder_angle_max&&(this.rudder_angle-=v),M=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else{let j=e;e>1&&(j=1),e<-1&&(j=-1),this.rudder_angle=this.rudder_angle*(.98-j/80)}if(this.autopilot_enabled){this.autopilot_compensator_p=2,this.autopilot_compensator_i=0,this.autopilot_compensator_d=100;let j=-(this.autopilot_heading_target- -this.twa);this.autopilot_compensator_sum_error*=.85,this.autopilot_compensator_sum_error+=j,j>180&&(j-=360),j<-180&&(j+=360),document.getElementById("info").innerHTML+="error: "+Math.floor(j)+"\xB0<br>";let ei=j*this.autopilot_compensator_p,ai=this.autopilot_compensator_sum_error*this.autopilot_compensator_i,si=(j-this.autopilot_compensator_last_error)*this.autopilot_compensator_d;this.rudder_angle_target=(ei+ai+si)*Math.sign(e),this.rudder_angle_target>this.rudder_angle_max/2&&(this.rudder_angle_target=this.rudder_angle_max/2),this.rudder_angle_target<-this.rudder_angle_max/2&&(this.rudder_angle_target=-this.rudder_angle_max/2),this.rudder_angle+=(this.rudder_angle_target-this.rudder_angle)/10,this.autopilot_compensator_last_error=j}else this.autopilot_heading_target=-this.twa,this.autopilot_heading_target>180&&(this.autopilot_heading_target-=360),this.autopilot_heading_target<-180&&(this.autopilot_heading_target+=360);let I=this.physics_model.m_angularVelocity*this.rudder_lenght,P=Math.atan2(-a+I,Math.abs(e))/Math.PI*180,b=0;e>0?b=e*(this.rudder_angle+P)/7:b=e*(this.rudder_angle-P)/7,b+=M*2;let E=this.physics_model.getWorldPoint(g(0,this.rudder_position)),B={};B.x=Math.cos(i+this.rudder_angle/180*Math.PI)*b,B.y=Math.sin(i+this.rudder_angle/180*Math.PI)*b,this.physics_model.applyForce(B,E,!0),this.forces.push({name:"rudder",type:"arrow",vector:B,point:E}),document.getElementById("info").innerHTML+="TWA: "+Math.floor(o)+"<br>",document.getElementById("info").innerHTML+="TWS: "+Math.floor(this.map.get_wind_speed(this.x,this.y))+"<br>",document.getElementById("info").innerHTML+="AWA: "+Math.floor(r)+"<br>",document.getElementById("info").innerHTML+="AWS: "+Math.floor(l*10)/10+"<br>";let x=Math.sqrt(this.physics_model.m_linearVelocity.x*this.physics_model.m_linearVelocity.x+this.physics_model.m_linearVelocity.y*this.physics_model.m_linearVelocity.y),N=Math.cos(o/180*Math.PI)*x;document.getElementById("info").innerHTML+="BS: "+Math.floor(x*10)/10+"<br>",document.getElementById("info").innerHTML+="VMG: "+Math.floor(N*10)/10+"<br>",this.jib_boom_angle=this.awa*this.jib_boom_angle_factor,this.jib_boom_angle>this.jib_boom_angle_max&&(this.jib_boom_angle=this.jib_boom_angle_max),this.jib_boom_angle<-this.jib_boom_angle_max&&(this.jib_boom_angle=-this.jib_boom_angle_max),this.mainsail_boom_angle=this.awa*this.mainsail_boom_angle_factor,this.mainsail_boom_angle>this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=this.mainsail_boom_angle_max),this.mainsail_boom_angle<-this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=-this.mainsail_boom_angle_max);const S=Math.floor(Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution),U=Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution-S;let Q=this.aero_drag_lookup[S]*(1-U)+this.aero_drag_lookup[S+1]*U,X=this.aero_lift_lookup[S]*(1-U)+this.aero_lift_lookup[S+1]*U,z={},$={};document.getElementById("info").innerHTML+="Cd: "+Math.floor(Q*10)/10+"<br>",document.getElementById("info").innerHTML+="Cl: "+Math.floor(X*10)/10+"<br>";const _t=.15;z.x=Math.cos(i+this.awa/180*Math.PI+Math.PI/2)*l*l*Q*_t,z.y=Math.sin(i+this.awa/180*Math.PI+Math.PI/2)*l*l*Q*_t,$.x=-Math.sign(this.awa)*Math.cos(i+this.awa/180*Math.PI)*l*l*X*_t,$.y=-Math.sign(this.awa)*Math.sin(i+this.awa/180*Math.PI)*l*l*X*_t;let V={};V.x=z.x+$.x,V.y=z.y+$.y;var rt=this.physics_model.getWorldPoint(g(0,this.center_of_lift));this.physics_model.applyForce($,rt,!0),this.physics_model.applyForce(z,rt,!0),this.forces.push({name:"mainsail",type:"arrow",vector:$,point:rt}),this.forces.push({name:"mainsail",type:"arrow",vector:z,point:rt}),this.power=Math.sqrt(V.x*V.x+V.y*V.y),this.power_direction=Math.atan2(V.y,V.x)/Math.PI*180,document.getElementById("info").innerHTML+="Power: "+Math.floor(this.power*10)/10+"<br>";var lt={};lt.x=-this.physics_model.m_linearVelocity.x*x,lt.y=-this.physics_model.m_linearVelocity.y*x;var Nt=this.physics_model.getWorldPoint(g(0,0));this.physics_model.applyForce(lt,Nt,!0),this.forces.push({name:"drag",type:"arrow",vector:lt,point:Nt}),this.rudder_input=0,this.motor_input=0}graphics_model_render(){let i=[];this.forces.forEach(l=>{i.push({color:65280,type:"force",x1:l.point.x,y1:l.point.y,x2:l.point.x+l.vector.x/10,y2:l.point.y+l.vector.y/10})});let e={},a=2;this.autopilot_enabled&&(a=10),e.x1=this.physics_model.getWorldPoint(g(0,0)).x,e.y1=this.physics_model.getWorldPoint(g(0,0)).y,e.x2=e.x1+Math.cos((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*a,e.y2=e.y1+Math.sin((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*a,e.color=5596791,e.type="autopilot",i.push(e);let t=this.wind_direction/180*Math.PI;i.push({color:5588087,type:"guide",x1:this.x+Math.cos(t)*3,y1:this.y+Math.sin(t)*3,x2:this.x+Math.cos(t)*5+Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5+Math.sin(t+Math.PI/2)*.5}),i.push({color:5588087,type:"guide",x1:this.x+Math.cos(t)*3,y1:this.y+Math.sin(t)*3,x2:this.x+Math.cos(t)*5-Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5-Math.sin(t+Math.PI/2)*.5}),i.push({color:5588087,type:"guide",x1:this.x+Math.cos(t)*4.75,y1:this.y+Math.sin(t)*4.75,x2:this.x+Math.cos(t)*5-Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5-Math.sin(t+Math.PI/2)*.5}),i.push({color:5588087,type:"guide",x1:this.x+Math.cos(t)*4.75,y1:this.y+Math.sin(t)*4.75,x2:this.x+Math.cos(t)*5+Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5+Math.sin(t+Math.PI/2)*.5}),t=this.awa/180*Math.PI+this.hull_angle-Math.PI/2,i.push({color:5570679,type:"guide",x1:this.x+Math.cos(t)*3,y1:this.y+Math.sin(t)*3,x2:this.x+Math.cos(t)*5+Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5+Math.sin(t+Math.PI/2)*.5}),i.push({color:5570679,type:"guide",x1:this.x+Math.cos(t)*3,y1:this.y+Math.sin(t)*3,x2:this.x+Math.cos(t)*5-Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5-Math.sin(t+Math.PI/2)*.5}),i.push({color:5570679,type:"guide",x1:this.x+Math.cos(t)*4.75,y1:this.y+Math.sin(t)*4.75,x2:this.x+Math.cos(t)*5-Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5-Math.sin(t+Math.PI/2)*.5}),i.push({color:5570679,type:"guide",x1:this.x+Math.cos(t)*4.75,y1:this.y+Math.sin(t)*4.75,x2:this.x+Math.cos(t)*5+Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5+Math.sin(t+Math.PI/2)*.5}),i.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(g(0,this.rudder_position)).x,y1:this.physics_model.getWorldPoint(g(0,this.rudder_position)).y,x2:this.physics_model.getWorldPoint(g(0,this.rudder_position)).x+Math.cos(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght,y2:this.physics_model.getWorldPoint(g(0,this.rudder_position)).y+Math.sin(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght}),i.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(g(0,this.centerboard_position+this.centerboard_length/2)).x,y1:this.physics_model.getWorldPoint(g(0,this.centerboard_position+this.centerboard_length/2)).y,x2:this.physics_model.getWorldPoint(g(0,this.centerboard_position-this.centerboard_length/2)).x,y2:this.physics_model.getWorldPoint(g(0,this.centerboard_position-this.centerboard_length/2)).y});let s=[];s[0]={},s[0].x=this.physics_model.getWorldPoint(g(0,this.mainsail_leading_edge_position)).x,s[0].y=this.physics_model.getWorldPoint(g(0,this.mainsail_leading_edge_position)).y,this.mainsail_boom_angle/this.mainsail_boom_angle_factor,this.mainsail_boom_angle_actual+=(this.mainsail_boom_angle-this.mainsail_boom_angle_actual)/30;let n=this.mainsail_boom_length*.05*Math.abs(this.awa)/30<this.mainsail_boom_length/10?this.mainsail_boom_length*.05*Math.abs(this.awa)/30:this.mainsail_boom_length/10;s[1]={},s[1].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-n*Math.sign(this.mainsail_boom_angle_actual),s[1].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-n*Math.sign(this.mainsail_boom_angle_actual);let _=n;s[2]={},s[2].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-_*Math.sign(this.mainsail_boom_angle_actual),s[2].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-_*Math.sign(this.mainsail_boom_angle_actual),s[3]={},s[3].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,s[3].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,i.push({color:8939263,type:"sail",x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y}),i.push({color:8939263,type:"sail",x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y}),i.push({color:8939263,type:"sail",x1:s[2].x,y1:s[2].y,x2:s[3].x,y2:s[3].y}),this.jib_boom_angle_actual+=(this.jib_boom_angle-this.jib_boom_angle_actual)/20;let o=[];o[0]={},o[0].x=this.physics_model.getWorldPoint(g(0,this.jib_leading_edge_position)).x,o[0].y=this.physics_model.getWorldPoint(g(0,this.jib_leading_edge_position)).y;let d=this.jib_boom_length*.05*Math.abs(this.awa)/15<this.jib_boom_length/3?this.jib_boom_length*.05*Math.abs(this.awa)/15:this.jib_boom_length/3;o[1]={},o[1].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),o[1].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual);let r=d;return o[2]={},o[2].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.jib_boom_angle_actual),o[2].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.jib_boom_angle_actual),o[3]={},o[3].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,o[3].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,i.push({color:8939263,type:"sail",x1:o[0].x,y1:o[0].y,x2:o[1].x,y2:o[1].y}),i.push({color:8939263,type:"sail",x1:o[1].x,y1:o[1].y,x2:o[2].x,y2:o[2].y}),i.push({color:8939263,type:"sail",x1:o[2].x,y1:o[2].y,x2:o[3].x,y2:o[3].y}),i}input_rudder_left(){this.rudder_input=1,this.autopilot_enabled=!1}input_rudder_right(){this.rudder_input=-1,this.autopilot_enabled=!1}input_motor_forward(){this.motor_input=1}input_motor_reverse(){this.motor_input=-1}input_autopilot_enabled_toggle(){this.autopilot_heading_target<0?this.autopilot_heading_target>-90?this.autopilot_heading_target=-this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=-this.autopilot_heading_best_vmg_2:this.autopilot_heading_target<90?this.autopilot_heading_target=this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=this.autopilot_heading_best_vmg_2,this.autopilot_enabled=!0}input_autopilot_tack_toggle(){this.autopilot_heading_target*=-1,this.autopilot_enabled=!0}input_autopilot_heading_increase(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)<175&&(this.autopilot_heading_target>0?this.autopilot_heading_target+=1:this.autopilot_heading_target-=1)}input_autopilot_heading_decrease(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)>5&&(this.autopilot_heading_target>0?this.autopilot_heading_target-=1:this.autopilot_heading_target+=1)}}let c=new wi(100,100,90,5);c.physics_model_init();const Et=1.5;var Wt=c.fluid.vectorField.areaWidth*Et,kt=c.fluid.vectorField.areaHeight*Et,Jt=Wt*kt*4,Ft=new Uint8Array(Jt);for(var G=0;G<Jt;G++)Ft[G]=Math.random()*256;var pt=new dt(Ft,Wt,kt,Tt,mt,qt),Qt=new dt(Ft,Wt,kt,Tt,mt,qt);pt.magFilter=zt;pt.needsUpdate=!0;var Xt=new Vt({map:pt,transparent:!0});Xt.needsUpdate=!0;const vi=function(h,i,e,a,t){return(h-i)*(t-a)/(e-i)+a},J=new pi(c.fluid.vectorField.areaWidth,c.fluid.vectorField.areaHeight,Et,90,5,Qt);let ht={},y=[],St=[],ot=0;const xi=new hi(c.world,{speed:1,fps:60});var jt=c.fluid.vectorField.areaWidth,Bt=c.fluid.vectorField.areaHeight,Zt=jt*Bt,At=new Uint8Array(Zt);for(var G=0;G<Zt;G++)At[G]=Math.random()*256;var gt=new dt(At,jt,Bt,Dt,mt),ti=new dt(At,jt,Bt,Dt,mt);gt.magFilter=zt;gt.needsUpdate=!0;var bi=new Vt({color:16777215,alphaMap:gt,transparent:!0});bi.needsUpdate=!0;let W=[],R=[],F=[],ii=[],yt=[];document.onkeydown=Pi;document.onkeyup=Ei;document.getElementById("camera_follow").checked=!1;document.getElementById("show_forces").checked=!0;document.getElementById("show_field").checked=!1;document.getElementById("show_forces").addEventListener("change",h=>{c.input_show_forces(document.getElementById("show_forces").checked)});document.getElementById("scenario_selector").addEventListener("change",h=>{console.log(document.getElementById("scenario_selector").value),Lt(p[document.getElementById("scenario_selector").value])});document.getElementById("scenario_restart").addEventListener("click",h=>{console.log("restart"),Lt(p[document.getElementById("scenario_selector").value])});document.getElementById("show_field").addEventListener("change",h=>{c.input_show_fields(document.getElementById("show_field").checked)});document.getElementById("camera_follow").addEventListener("change",h=>{c.input_camera_follow(document.getElementById("camera_follow").checked)});document.getElementById("camera_zoom_in").addEventListener("click",h=>{c.input_camera_zoom_relative(-2)});document.getElementById("camera_zoom_out").addEventListener("click",h=>{c.input_camera_zoom_relative(2)});document.getElementById("camera_move_left").addEventListener("click",h=>{c.input_camera_move_relative(-5,0)});document.getElementById("camera_move_right").addEventListener("click",h=>{c.input_camera_move_relative(5,0)});document.getElementById("camera_move_up").addEventListener("click",h=>{c.input_camera_move_relative(0,5)});document.getElementById("camera_move_down").addEventListener("click",h=>{c.input_camera_move_relative(0,-5)});var Ii=function(h){h.pageX,h.pageY;var i=new D,e=new D;i.set(h.clientX/window.innerWidth*2-1,-(h.clientY/window.innerHeight)*2+1,.5),i.unproject(L),i.sub(L.position).normalize();var a=-L.position.z/i.z;e.copy(L.position).add(i.multiplyScalar(a));let t=c.get_wind_direction(e.x,e.y),s=c.get_wind_speed(e.x,e.y),n=J.get_field_velocity(e.x,e.y).x,_=J.get_field_velocity(e.x,e.y).y;t=Math.atan2(_,n)/Math.PI*180,s=Math.sqrt(n*n+_*_),document.getElementById("wind_info").innerHTML="Speed: "+Math.floor(s*1e3)/10+"<br>Direction: "+Math.floor(t*10)/10};document.addEventListener("mousemove",Ii);function Pi(h){h=h||window.event,R[h.keyCode]=!0,W.forEach(i=>{i.type==="KEYDOWN"&&R[i.activation_key]&&(R[i.prohibition_key]===!1||R[i.prohibition_key]===void 0)&&i.object[i.input_handler]()})}function Ei(h){h=h||window.event,R[h.keyCode]=!1}function ft(){ht={},W=[],y.forEach(h=>{h.physics_model_deinit()}),y=[],ot=0}function Lt(h){ft(),ht=h}function nt(h){W=[],h[0]!==void 0&&(W.push({type:"PRESSED",activation_key:37,prohibition_key:39,object:h[0],input_handler:h[0].input_rudder_left.name}),W.push({type:"PRESSED",activation_key:39,prohibition_key:37,object:h[0],input_handler:h[0].input_rudder_right.name}),W.push({type:"PRESSED",activation_key:40,prohibition_key:38,object:h[0],input_handler:h[0].input_autopilot_heading_increase.name}),W.push({type:"PRESSED",activation_key:38,prohibition_key:40,object:h[0],input_handler:h[0].input_autopilot_heading_decrease.name}),W.push({type:"KEYDOWN",activation_key:32,prohibition_key:-1,object:h[0],input_handler:h[0].input_autopilot_enabled_toggle.name}),W.push({type:"KEYDOWN",activation_key:13,prohibition_key:-1,object:h[0],input_handler:h[0].input_autopilot_tack_toggle.name})),h[1]!==void 0&&(W.push({type:"PRESSED",activation_key:65,prohibition_key:68,object:h[1],input_handler:h[1].input_rudder_left.name}),W.push({type:"PRESSED",activation_key:68,prohibition_key:65,object:h[1],input_handler:h[1].input_rudder_right.name}),W.push({type:"PRESSED",activation_key:83,prohibition_key:87,object:h[1],input_handler:h[1].input_autopilot_heading_increase.name}),W.push({type:"PRESSED",activation_key:87,prohibition_key:83,object:h[1],input_handler:h[1].input_autopilot_heading_decrease.name}),W.push({type:"KEYDOWN",activation_key:17,prohibition_key:-1,object:h[1],input_handler:h[0].input_autopilot_enabled_toggle.name}),W.push({type:"KEYDOWN",activation_key:16,prohibition_key:-1,object:h[1],input_handler:h[0].input_autopilot_tack_toggle.name}))}let p=[];p[0]=[];p[0][0]=()=>{y.push(new T(c,10,-9,5*Math.PI/4))};p[0][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle()};p[0][2]=()=>{nt(y)};p[1]=[];p[1][0]=()=>{y.push(new T(c,10,-8,5*Math.PI/4)),y.push(new T(c,15,-11.5,5*Math.PI/4))};p[1][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};p[1][2]=()=>{nt(y)};p[2]=[];p[2][0]=()=>{y.push(new T(c,-10,-6,3*Math.PI/4)),y.push(new T(c,15,-11.5,5*Math.PI/4))};p[2][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};p[2][2]=()=>{nt(y)};p[2][2e3]=()=>{ft()};p[3]=[];p[3][0]=()=>{y.push(new T(c,-3,-4,3*Math.PI/4)),y.push(new T(c,18,-11.5,5*Math.PI/4))};p[3][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};p[3][2]=()=>{nt(y)};p[3][300]=()=>{y[0].input_autopilot_tack_toggle()};p[3][2e3]=()=>{ft()};p[4]=[];p[4][0]=()=>{y.push(new T(c,-3,-4,3*Math.PI/4)),y.push(new T(c,18,-11.5,5*Math.PI/4))};p[4][1]=()=>{console.log(1),y[0].input_autopilot_enabled_toggle(),y[1].input_autopilot_enabled_toggle()};p[4][2]=()=>{nt(y)};p[4][300]=()=>{y[0].input_autopilot_tack_toggle()};p[4][700]=()=>{y[1].input_autopilot_heading_decrease()};p[4][701]=()=>{y[1].input_autopilot_heading_decrease()};p[4][702]=()=>{y[1].input_autopilot_heading_decrease()};p[4][2e3]=()=>{ft()};p[5]=[];p[5][0]=()=>{St=[]};p[5][1]=()=>{St.push(new Mi(c))};Lt(p[document.getElementById("scenario_selector").value]);xi.start(()=>{yt=[],ht!==void 0&&ht[ot]!==void 0&&(console.log("Frame ",ot),ht[ot]()),W.forEach(a=>{a.type==="PRESSED"&&R[a.activation_key]===!0&&(R[a.prohibition_key]===!1||R[a.prohibition_key]===void 0)&&a.object[a.input_handler]()}),c.set_camera_follow_target(y[0]),c.physics_model_step(),St.forEach(a=>{a.physics_model_step()}),y.forEach(a=>{a.physics_model_step(),yt=[...yt,...a.graphics_model_render()];let t={},s=a.awa/180*Math.PI+a.hull_angle-Math.PI/2;t.x=a.x+Math.cos(s)*-1.8,t.y=a.y+Math.sin(s)*-1.8,c.fluid.apply_energy(t.x,t.y,a.power_direction,a.power/50);let n=Math.cos(a.power_direction/180*Math.PI)*a.power/7e3,_=Math.sin(a.power_direction/180*Math.PI)*a.power/7e3;t.x0=a.x+Math.cos(s)*-1.8,t.y0=a.y+Math.sin(s)*-1.8,t.x1=a.x+Math.cos(s+Math.PI/8)*-1.8,t.y1=a.y+Math.sin(s+Math.PI/8)*-1.8,t.x2=a.x+Math.cos(s-Math.PI/8)*-1.8,t.y2=a.y+Math.sin(s-Math.PI/8)*-1.8,J.apply_energy(t.x0,t.y0,-n,-_),document.getElementById("info").innerHTML+="Phys Time: "+J.t_delta+"<br>"}),ot++,c.fluid.loop();var h=c.fluid.vectorField.field;const i=ti.image.data;for(let a=0;a<c.fluid.vectorField.areaWidth;a++)for(let t=0;t<c.fluid.vectorField.areaHeight;t++){let s=h[a][t].velocity,n=256-vi(s,10,15,0,256);i[t*c.fluid.vectorField.areaWidth+a]=n}let e={};e.x=0,e.y=0,Y.copyTextureToTexture(e,ti,gt),J.step_ready&&(Y.copyTextureToTexture(e,Qt,pt),J.step_ready=!1),c.show_fields},()=>{});let L,q,Y;Wi();function Wi(){L=new oi(70,window.innerWidth/window.innerHeight,.01,85),L.position.z=60,L.position.y=20,q=new ni,new Ht(6706517),new Ht(5592422);const h=new _i(c.width,c.height);let i=new ri(h,Xt);i.position.x=0,i.position.y=0,i.position.z=-.01,q.add(i),Y=new li({antialias:!0}),Y.setSize(window.innerWidth,window.innerHeight),Y.setAnimationLoop(ki),document.body.appendChild(Y.domElement)}function ki(h){L.position.x=c.camera_position_x,L.position.y=c.camera_position_y,L.position.z=c.camera_zoom;for(let i of F)q.remove(i),i.geometry.dispose(),i.material.dispose(),i=void 0;for(let i of ii)q.remove(i),i.geometry.dispose!==void 0&&i.geometry.dispose(),i.material.dispose!==void 0&&i.material.dispose(),i=void 0;F=[],ii=[];for(let i=c.world.getBodyList();i;i=i.getNext())for(let e=i.getFixtureList();e;e=e.getNext()){if(i.render&&i.render.hidden)continue;i.render&&i.render.stroke||i.isDynamic()||i.isKinematic()||i.isStatic();const a=e.getType(),t=e.getShape();if(a==="circle"){const s=t.m_radius,n=i.getPosition();let _=[];for(let r=0;r<360;r+=10){let l=r/180*Math.PI,m=s*Math.cos(l)+n.x,u=s*Math.sin(l)+n.y;_.push(new D(m,u,0))}_.push(_[0]);const o=new ct().setFromPoints(_),d=new Z({color:65280});F.push(new ut(o,d)),q.add(F[F.length-1])}if(a==="edge"){let s=[];const n=t.m_vertex1,_=t.m_vertex2;let o=n.x+i.m_xf.p.x,d=n.y+i.m_xf.p.y,r=_.x+i.m_xf.p.x,l=_.y+i.m_xf.p.y;s.push(new D(o,d,0)),s.push(new D(r,l,0));const m=new ct().setFromPoints(s),u=new Z({color:16711680});F.push(new ut(m,u)),q.add(F[F.length-1])}if(a==="polygon"){let s=t.m_vertices;s.push(s[0]);let n=[];for(const d of s){let r=i.getAngle()+Math.PI,l=i.getLocalCenter(),m=(d.x+l.x)*Math.cos(r)+(d.y-l.y)*Math.sin(r),u=(d.x+l.x)*Math.sin(r)-(d.y-l.y)*Math.cos(r),M=0;m+=e.m_body.c_position.c.x,u+=e.m_body.c_position.c.y,n.push(new D(m,u,M))}const _=new ct().setFromPoints(n),o=new Z({color:255});F.push(new ut(_,o)),q.add(F[F.length-1])}}for(const i of yt){if(c.show_forces==!1&&i.type==="force")continue;let e=[];e.push(new D(i.x1,i.y1,0)),e.push(new D(i.x2,i.y2,0));const a=new ct().setFromPoints(e);let t=i.color;t===void 0&&(t=16711680);let s,n,_;i.opacity!==void 0?(n=!0,s=i.opacity,_=new Z({color:t,transparent:n,opacity:s})):_=new Z({color:t}),F.push(new ut(a,_)),q.add(F[F.length-1])}Y.render(q,L)}
