import{p as gt,l as yt,D as ft,R as ai,U as Mt,a as si,N as Tt,M as qt,b as hi,L as Ht,P as oi,S as ni,C as zt,c as _i,d as ri,W as li,B as lt,e as J,f as dt,V as z}from"./vendor.da8be286.js";const di=function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const _ of a.addedNodes)_.tagName==="LINK"&&_.rel==="modulepreload"&&s(_)}).observe(document,{childList:!0,subtree:!0});function e(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerpolicy&&(a.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?a.credentials="include":t.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(t){if(t.ep)return;t.ep=!0;const a=e(t);fetch(t.href,a)}};di();var Z=document.getElementById("theCanvas"),mi=Z.getContext("2d"),ci=document.getElementById("plotSelect"),ui=document.getElementById("contrastSlider"),pi=document.getElementById("rafCheck");const Dt=4/9,tt=1/9,it=1/36;var v=400,Vt=new Array(v+2),wt=new Array(v+2),vt=new Array(v+2),xt=new Array(v+2);for(var k=0;k<=v;k++){var D,R,C;k<v/8?(D=0,R=0,C=Math.round(255*(k+v/8)/(v/4))):k<3*v/8?(D=0,R=Math.round(255*(k-v/8)/(v/4)),C=255):k<5*v/8?(D=Math.round(255*(k-3*v/8)/(v/4)),R=255,C=255-D):k<7*v/8?(D=255,R=Math.round(255*(7*v/8-k)/(v/4)),C=0):(D=Math.round(255*(9*v/8-k)/(v/4)),R=0,C=0),wt[k]=D,vt[k]=R,xt[k]=C,Vt[k]=Rt(D,R,C)}wt[v+1]=0;vt[v+1]=0;xt[v+1]=0;Vt[v+1]=Rt(0,0,0);function bt(h){var i=h.toString(16);return i.length==1?"0"+i:i}function Rt(h,i,e){return"#"+bt(h)+bt(i)+bt(e)}class gi{constructor(i,e,s,t,a,_,r){this.oversampling=r,this.texture=_,this.resolution=s,this.width=i*this.resolution,this.height=e*this.resolution,this.direction=t+180,this.step_ready=!1,this.t_delta=0,Z.width=this.width,Z.height=this.height,this.speed=a/100,this.viscosity=.02,this._n0_=new Array(this.width*this.height),this._nN_=new Array(this.width*this.height),this._nS_=new Array(this.width*this.height),this._nE_=new Array(this.width*this.height),this._nW_=new Array(this.width*this.height),this._nNE_=new Array(this.width*this.height),this._nSE_=new Array(this.width*this.height),this._nNW_=new Array(this.width*this.height),this._nSW_=new Array(this.width*this.height),this._ux_=new Array(this.width*this.height),this._uy_=new Array(this.width*this.height),this._rho_=new Array(this.width*this.height),this._curl_=new Array(this.width*this.height),this.barrier=new Array(this.width*this.height);for(var o=0;o<this.height;o++)for(var l=0;l<this.width;l++){this.barrier[l+o*this.width]=!1;let n=5;Math.pow(this.width/2-l,2)+Math.pow(this.height*.75-o,2)<Math.pow(n,2)&&(this.barrier[l+o*this.width]=!0)}this.image=mi.createImageData(Z.width,Z.height);for(var d=3;d<this.image.data.length;d+=4)this.image.data[d]=255;this.running=!1,this.initFluid(),this.startStop(),this.graphics_model_init()}initFluid(){let i=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;console.log(i,e);for(var s=0;s<this.height;s++)for(var t=0;t<this.width;t++)this.setEquil(t,s,i,e,1),this._curl_[t+s*this.width]=0}startStop(){this.running=!this.running,this.running&&this.physics_model_step()}physics_model_step(){let i=new Date;for(let a=0;a<1;a++)this.setBoundaries(),this.collide(),this.stream();this.t_delta=new Date-i,this.step_ready=!0;for(var e=!0,s=0;s<this.width;s++){var t=s+this.height/2*this.width;this._rho_[t]<=0&&(e=!1)}e||(window.alert("The simulation has become unstable due to excessive fluid speeds."),this.startStop(),this.initFluid()),this.graphics_model_init()}graphics_model_init(){this.graphics_model_step()}graphics_model_step(){this.paintCanvas(),this.running&&(pi.checked?requestAnimFrame(this.graphics_model_step_handler.bind(this)):window.setTimeout(this.graphics_model_step_handler.bind(this),10))}graphics_model_step_handler(){this.graphics_model_step()}setBoundaries(){let i=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;for(var s=0;s<this.width;s++)this.setEquil(s,0,i,e,1),this.setEquil(s,this.height-1,i,e,1);for(var t=1;t<this.height-1;t++)this.setEquil(0,t,i,e,1),this.setEquil(this.width-1,t,i,e,1)}collide(){for(var i=1/(3*this.viscosity+.5),e=1;e<this.height-1;e++)for(var s=1;s<this.width-1;s++){var t=s+e*this.width,a=this._n0_[t]+this._nN_[t]+this._nS_[t]+this._nE_[t]+this._nW_[t]+this._nNW_[t]+this._nNE_[t]+this._nSW_[t]+this._nSE_[t];this._rho_[t]=a;var _=(this._nE_[t]+this._nNE_[t]+this._nSE_[t]-this._nW_[t]-this._nNW_[t]-this._nSW_[t])/a;this._ux_[t]=_;var r=(this._nN_[t]+this._nNE_[t]+this._nNW_[t]-this._nS_[t]-this._nSE_[t]-this._nSW_[t])/a;this._uy_[t]=r;var o=tt*a,l=it*a,d=3*_,n=3*r,m=_*_,c=r*r,p=2*_*r,f=m+c,g=1.5*f;this._n0_[t]+=i*(Dt*a*(1-g)-this._n0_[t]),this._nE_[t]+=i*(o*(1+d+4.5*m-g)-this._nE_[t]),this._nW_[t]+=i*(o*(1-d+4.5*m-g)-this._nW_[t]),this._nN_[t]+=i*(o*(1+n+4.5*c-g)-this._nN_[t]),this._nS_[t]+=i*(o*(1-n+4.5*c-g)-this._nS_[t]),this._nNE_[t]+=i*(l*(1+d+n+4.5*(f+p)-g)-this._nNE_[t]),this._nSE_[t]+=i*(l*(1+d-n+4.5*(f-p)-g)-this._nSE_[t]),this._nNW_[t]+=i*(l*(1-d+n+4.5*(f-p)-g)-this._nNW_[t]),this._nSW_[t]+=i*(l*(1-d-n+4.5*(f+p)-g)-this._nSW_[t])}for(var e=1;e<this.height-2;e++)this._nW_[this.width-1+e*this.width]=this._nW_[this.width-2+e*this.width],this._nNW_[this.width-1+e*this.width]=this._nNW_[this.width-2+e*this.width],this._nSW_[this.width-1+e*this.width]=this._nSW_[this.width-2+e*this.width]}stream(){for(var i=this.height-2;i>0;i--)for(var e=1;e<this.width-1;e++)this._nN_[e+i*this.width]=this._nN_[e+(i-1)*this.width],this._nNW_[e+i*this.width]=this._nNW_[e+1+(i-1)*this.width];for(var i=this.height-2;i>0;i--)for(var e=this.width-2;e>0;e--)this._nE_[e+i*this.width]=this._nE_[e-1+i*this.width],this._nNE_[e+i*this.width]=this._nNE_[e-1+(i-1)*this.width];for(var i=1;i<this.height-1;i++)for(var e=this.width-2;e>0;e--)this._nS_[e+i*this.width]=this._nS_[e+(i+1)*this.width],this._nSE_[e+i*this.width]=this._nSE_[e-1+(i+1)*this.width];for(var i=1;i<this.height-1;i++)for(var e=1;e<this.width-1;e++)this._nW_[e+i*this.width]=this._nW_[e+1+i*this.width],this._nSW_[e+i*this.width]=this._nSW_[e+1+(i+1)*this.width];const s=.7,t=1-s;for(var i=1;i<this.height-1;i++)for(var e=1;e<this.width-1;e++)if(this.barrier[e+i*this.width]){var a=e+i*this.width;this._nE_[e+1+i*this.width]=this._nE_[e+1+i*this.width]*t+this._nW_[a]*s,this._nW_[e-1+i*this.width]=this._nW_[e-1+i*this.width]*t+this._nE_[a]*s,this._nN_[e+(i+1)*this.width]=this._nN_[e+(i+1)*this.width]*t+this._nS_[a]*s,this._nS_[e+(i-1)*this.width]=this._nS_[e+(i-1)*this.width]*t+this._nN_[a]*s,this._nNE_[e+1+(i+1)*this.width]=this._nNE_[e+1+(i+1)*this.width]*t+this._nSW_[a]*s,this._nNW_[e-1+(i+1)*this.width]=this._nNW_[e-1+(i+1)*this.width]*t+this._nSE_[a]*s,this._nSE_[e+1+(i-1)*this.width]=this._nSE_[e+1+(i-1)*this.width]*t+this._nNW_[a]*s,this._nSW_[e-1+(i-1)*this.width]=this._nSW_[e-1+(i-1)*this.width]*t+this._nNE_[a]*s}}setEquil(i,e,s,t,a){var _=i+e*this.width;typeof a=="undefined"&&(a=this._rho_[_]);var r=3*s,o=3*t,l=s*s,d=t*t,n=2*s*t,m=l+d,c=1.5*m;this._n0_[_]=Dt*a*(1-c),this._nE_[_]=tt*a*(1+r+4.5*l-c),this._nW_[_]=tt*a*(1-r+4.5*l-c),this._nN_[_]=tt*a*(1+o+4.5*d-c),this._nS_[_]=tt*a*(1-o+4.5*d-c),this._nNE_[_]=it*a*(1+r+o+4.5*(m+n)-c),this._nSE_[_]=it*a*(1+r-o+4.5*(m-n)-c),this._nNW_[_]=it*a*(1-r+o+4.5*(m-n)-c),this._nSW_[_]=it*a*(1-r-o+4.5*(m+n)-c),this._rho_[_]=a,this._ux_[_]=s,this._uy_[_]=t}apply_energy(i,e,s,t){document.getElementById("wind_info").innerHTML="dir: "+s+"stre : "+t+"<br>";let a=this.width/2+Math.floor(i*this.resolution),_=this.height/2+Math.floor(e*this.resolution),r,o,l,d,n,m,c,p,f,g,b,P;r=Math.floor(a),n=Math.floor(_),o=r+1,m=n,l=r,c=n+1,d=r+1,p=n+1;let I=a-r,W=_-n;f=(1-I)*(1-W),g=I*(1-W),b=(1-I)*W,P=I*W;let j=[r,o,l,d],x=[n,m,c,p],A=[f,g,b,P];for(let E=0;E<1;E++)this.apply_force_to_cell(j[E],x[E],s,A[E]*t)}apply_force_to_cell(i,e,s,t){let a=i+e*this.width,_=this._ux_[a],r=this._uy_[a],o=this._rho_[a],l=Math.cos(s/180*Math.PI)*t/o*-1,d=Math.sin(s/180*Math.PI)*t/o*-1;this.setEquil(i,e,_+l,r+d)}apply_energy_to_cell(i,e,s,t){let a=s+270;a>360&&(a-=360),document.getElementById("wind_info").innerHTML="mirror_angle: "+a+"<br>";const _=[this._nE_,this._nNE_,this._nN_,this._nNW_,this._nW_,this._nSW_,this._nS_,this._nSE_];document.getElementById("wind_info").innerHTML+=JSON.stringify(s)+"<br>";let r=[0,0,0,0,0,0,0,0],o=[0,0,0,0,0,0,0,0],l=[0,0,0,0,0,0,0,0],d=[0,0,0,0,0,0,0,0];for(let n=0;n<8;n++){const m=.1*t,c=(Math.floor(a/45)+1+n)%8;d[n]=c*45,l[n]=a-(d[n]-a),l[n]>360&&(l[n]-=360),l[n]<0&&(l[n]+=360),r[n]=Math.cos(l[n]/180*Math.PI)*_[c][i+e*this.width]*m,o[n]=Math.sin(l[n]/180*Math.PI)*_[c][i+e*this.width]*m,_[c][i+e*this.width]*=1-m}for(let n=0;n<8;n++){const m=(Math.floor(l[n]/45)+1+n)%8;let c,p;m%2==0?Math.abs(r[n])>Math.abs(o[n])?(c=r[n]-o[n],p=o[n]*Math.SQRT2):(c=o[n]-r[n],p=r[n]*Math.SQRT2):Math.abs(r[n])>Math.abs(o[n])?(c=o[n]*Math.SQRT2,p=r[n]-o[n]):(c=r[n]*Math.SQRT2,p=o[n]-r[n]),_[m][i+e*this.width]+=c,_[(m+1)%8][i+e*this.width]+=p;let f=c*1e4,g=p*1e4;document.getElementById("wind_info").innerHTML+="sou: "+d[n]+" mirr: "+Math.floor(l[n])+"<br>",document.getElementById("wind_info").innerHTML+="u: "+Math.floor(f)+" v: "+Math.floor(g)+"<br>"}}get_field_velocity(i,e){i=this.width/2+Math.floor(i*this.resolution),e=this.height/2+Math.floor(e*this.resolution);let s,t,a,_,r,o,l,d,n,m,c,p;s=Math.floor(i),r=Math.floor(e),t=s+1,o=r,a=s,l=r+1,_=s+1,d=r+1;let f=i-s,g=e-r;n=(1-f)*(1-g),m=f*(1-g),c=(1-f)*g,p=f*g;let b=0,P=0;return b=this._ux_[s+r*this.width]*n+this._ux_[t+o*this.width]*m+this._ux_[a+l*this.width]*c+this._ux_[_+d*this.width]*p,P=this._uy_[s+r*this.width]*n+this._uy_[t+o*this.width]*m+this._uy_[a+l*this.width]*c+this._uy_[_+d*this.width]*p,{x:b/4,y:P/4}}paintCanvas(){var i=0,e=Math.pow(1.2,Number(ui.value)),s=ci.selectedIndex;s==4&&this.computeCurl();for(var t=0;t<this.height;t++)for(var a=0;a<this.width;a++){if(this.barrier[a+t*this.width])i=v+1;else{if(s==0)i=Math.round(v*((this._rho_[a+t*this.width]-1)*6*e+.5));else if(s==1)i=Math.round(v*(this._ux_[a+t*this.width]*2*e+.5));else if(s==2)i=Math.round(v*(this._uy_[a+t*this.width]*2*e+.5));else if(s==3){var _=Math.sqrt(this._ux_[a+t*this.width]*this._ux_[a+t*this.width]+this._uy_[a+t*this.width]*this._uy_[a+t*this.width]);i=Math.round(v*(_*4*e))}else i=Math.round(v*(this._curl_[a+t*this.width]*5*e+.5));i<0&&(i=0),i>v&&(i=v)}let r=!1;(this._curl_[a+t*this.width]>.005||this._curl_[a+t*this.width]<-.005)&&(r=!0),this.colorSquare(a,t,wt[i],vt[i],xt[i],r)}}colorSquare(i,e,s,t,a,_){if(this.texture!==void 0)for(var r=0;r<this.oversampling;r++)for(var o=0;o<this.oversampling;o++){var l=(i*this.oversampling+r+(e*this.oversampling+o)*this.width*this.oversampling)*4;if(this.texture.image.data[l+0]=s,this.texture.image.data[l+1]=t,this.texture.image.data[l+2]=a,this.texture.image.data[l+3]=255,_===!0){var d=(i*this.oversampling+0+(e*this.oversampling+0)*this.width*this.oversampling)*4;this.texture.image.data[d+0]=255,this.texture.image.data[d+1]=0,this.texture.image.data[d+2]=0,this.texture.image.data[d+3]=255}}}computeCurl(){for(var i=1;i<this.height-1;i++)for(var e=1;e<this.width-1;e++)this._curl_[e+i*this.width]=this._uy_[e+1+i*this.width]-this._uy_[e-1+i*this.width]-this._ux_[e+(i+1)*this.width]+this._ux_[e+(i-1)*this.width]}}window.requestAnimFrame=function(h){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(i){window.setTimeout(i,1)}}();let O=1,et;et=.3*O;let It=4;It=4;let Ct={vectorField:void 0,objCanvas:void 0,ctx:void 0,enableFrameDragging:!0,enableEmitter:!0,loopTimer:void 0,loopTicker:0,emitterX:0,emitterY:0,init:function(h,i){this.initVectorField(h,i)},initVectorField:function(h,i){this.vectorField=new yi(h,i,h*O,i*O)},start:function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.animateFrame=function(h){Ct.loop(),window.animateTimestamp=h,window.requestAnimationFrame(animateFrame)},window.animateFrame()},get_field_velocity:function(h,i){var e=this.vectorField.areaWidth,s=this.vectorField.areaHeight;h+=this.vectorField.width/2,i+=this.vectorField.height/2,h*=O,i*=O;let t,a,_,r,o,l,d,n,m,c,p,f;t=Math.floor(h),o=Math.floor(i),a=t+1,l=o,_=t,d=o+1,r=t+1,n=o+1;let g=h-t,b=i-o;m=(1-g)*(1-b),c=g*(1-b),p=(1-g)*b,f=g*b;let P=h+.5>>0,I=i-.5>>0,W=0,j=0;if(P<e-1&&P>0+1&&I<s-1&&I>0+1){var x=this.vectorField.field;W=x[t][o].vx*m+x[a][l].vx*c+x[_][d].vx*p+x[r][n].vx*f,j=x[t][o].vy*m+x[a][l].vy*c+x[_][d].vy*p+x[r][n].vy*f}return{x:-W,y:j}},apply_energy:function(h,i,e,s){var t=this.vectorField.areaWidth,a=this.vectorField.areaHeight;h+=this.vectorField.width/2,i+=this.vectorField.height/2,h*=O,i*=O;let _,r,o,l,d,n,m,c,p,f,g,b;_=Math.floor(h),d=Math.floor(i),r=_+1,n=d,o=_,m=d+1,l=_+1,c=d+1;let P=h-_,I=i-d;p=(1-P)*(1-I),f=P*(1-I),g=(1-P)*I,b=P*I;let W=h+.5>>0,j=i+.5>>0;if(W<t-1&&W>0+1&&j<a-1&&j>0+1){var x=this.vectorField.field;let A=0,E=0;A+=-Math.cos(e/180*Math.PI)*s,E+=-Math.sin(e/180*Math.PI)*s,x[_][d].vx+=p*A,x[_][d].vy+=p*E,x[r][n].vx+=f*A,x[r][n].vy+=f*E,x[o][m].vx+=g*A,x[o][m].vy+=g*E,x[l][c].vx+=b*A,x[l][c].vy+=b*E}},loop:function(){this.updateVectorField()},updateVectorField:function(){var h=this.vectorField.field,i=this.vectorField.areaWidth,e=this.vectorField.areaHeight,s,t,a,_,r,o;for(s=i;s--;)for(t=e;t--;)s<i-1&&s>0+1&&t<e-1&&t>0+1?(a=(h[s-1][t].vx+h[s+1][t].vx+h[s][t-1].vx+h[s][t+1].vx)/4,_=(h[s-1][t].vy+h[s+1][t].vy+h[s][t-1].vy+h[s][t+1].vy)/4,r=h[s][t].vx*(1-et)+a*et,o=h[s][t].vy*(1-et)+_*et):(r=h[s][t].vx,o=h[s][t].vy),h[s][t].vx_=r,h[s][t].vy_=o;for(s=i;s--;)for(t=e;t--;);for(s=i;s--;)for(t=e;t--;){let l=h[s][t].vx_,d=h[s][t].vy_,n=Math.abs(l)/60*It,m=Math.abs(d)/60*It;if(s<i-1&&s>0+1&&t<e-1&&t>0+1){let c,p,f,g,b,P,I,W;c=h[s][t].vx_,p=h[s-Math.sign(l)][t].vx_,f=h[s][t-Math.sign(d)].vx_,g=h[s-Math.sign(l)][t-Math.sign(d)].vx_,b=h[s][t].vy_,P=h[s-Math.sign(l)][t].vy_,I=h[s][t-Math.sign(d)].vy_,W=h[s-Math.sign(l)][t-Math.sign(d)].vy_,h[s][t].vx__=(1-n)*(1-m)*c+n*(1-m)*p+(1-n)*m*f+n*m*g,h[s][t].vy__=(1-n)*(1-m)*b+n*(1-m)*P+(1-n)*m*I+n*m*W,(h[s][t].vx__===void 0||h[s][t].vy__===void 0)&&(console.log("TRAP"),h=void 0)}else h[s][t].vx__=h[s][t].vx_,h[s][t].vy__=h[s][t].vy_;(t==e-2||t==1||s==i-2||s==1)&&(h[s][t].vx__=0,h[s][t].vy__=-2.5)}for(s=i;s--;)for(t=e;t--;)h[s][t].vx=h[s][t].vx__,h[s][t].vy=h[s][t].vy__,h[s][t].velocity=Math.sqrt(h[s][t].vx*h[s][t].vx+h[s][t].vy*h[s][t].vy)}},yi=function(h,i,e,s){this.field=[],this.width=h,this.height=i,this.areaWidth=e,this.areaHeight=s;var t,a;for(t=e;t--;)for(this.field[t]=[],a=s;a--;)this.field[t][a]=new fi},fi=function(){this.velocity=0,this.vx=0,this.vy=-2,this.vx_=0,this.vy_=-2,this.vx__=0,this.vy__=-2},at=gt,L=at.Vec2;function Ot(h){for(var i=0,e=0;e<h.length;e++)i+=h[e];return i}function Kt(h){return Math.PI/180*h}function Mi(h){return 180/Math.PI*Math.atan2(Ot(h.map(Kt).map(Math.sin))/h.length,Ot(h.map(Kt).map(Math.cos))/h.length)}class wi{constructor(i,e,s,t,a){this.bm=a,this.fluid=Ct,this.world=void 0,this.width=i,this.height=e,this.wind_direction=s,this.wind_speed=t,this.show_forces=!0,this.show_fields=!1,this.camera_follow_target=void 0,this.camera_follow=!1,this.camera_zoom=30,this.camera_zoom_max=70,this.camera_zoom_min=10,this.camera_position_x=0,this.camera_position_y=0,this.camera_position_x_max=30,this.camera_position_x_min=-30,this.camera_position_y_max=30,this.camera_position_y_min=-30}physics_model_init(){this.fluid.init(this.width,this.height),this.world=new yt.World(L(0,0));let i=this.world.createBody(L(0,0)),e={density:0,restitution:.4};i.createFixture(at.Edge(L(-this.width/2+2,-this.height/2+2),L(-this.width/2+2,this.height/2-2)),e),i.createFixture(at.Edge(L(this.width/2-2,-this.height/2+2),L(this.width/2-2,this.height/2-2)),e),i.createFixture(at.Edge(L(-this.width/2+2,this.height/2-2),L(this.width/2-2,this.height/2-2)),e),i.createFixture(at.Edge(L(-this.width/2+2,-this.height/2+2),L(this.width/2-2,-this.height/2+2)),e),this.world.createDynamicBody(L(0,14.5)).createFixture(yt.Circle(.5),10),this.world.createDynamicBody(L(0,20)).createFixture(yt.Circle(5),10)}get_wind_speed(i,e){let s=this.bm.get_field_velocity(i,e),t=this.bm.get_field_velocity(i-1,e),a=this.bm.get_field_velocity(i+1,e),_=this.bm.get_field_velocity(i,e-1),r=this.bm.get_field_velocity(i,e+1),o=0;return o+=Math.sqrt(s.x*s.x+s.y*s.y),o+=Math.sqrt(t.x*t.x+t.y*t.y),o+=Math.sqrt(a.x*a.x+a.y*a.y),o+=Math.sqrt(_.x*_.x+_.y*_.y),o+=Math.sqrt(r.x*r.x+r.y*r.y),o/5*100*4}get_wind_direction(i,e){let s=this.bm.get_field_velocity(i,e),t=this.bm.get_field_velocity(i-1,e),a=this.bm.get_field_velocity(i+1,e),_=this.bm.get_field_velocity(i,e-1),r=this.bm.get_field_velocity(i,e+1),o=[Math.atan2(s.y,s.x)/Math.PI*180+180,Math.atan2(t.y,t.x)/Math.PI*180+180,Math.atan2(a.y,a.x)/Math.PI*180+180,Math.atan2(_.y,_.x)/Math.PI*180+180,Math.atan2(r.y,r.x)/Math.PI*180+180];return Mi(o)}set_camera_follow_target(i){this.camera_follow_target=i}physics_model_step(){this.camera_follow===!0&&this.camera_follow_target!==void 0&&(this.camera_position_x=this.camera_follow_target.x,this.camera_position_y=this.camera_follow_target.y,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min))}input_show_fields(i){this.show_fields=i}input_show_forces(i){this.show_forces=i}input_camera_follow(i){this.camera_follow=i}input_camera_zoom_relative(i){this.camera_zoom+=i,this.camera_zoom>this.camera_zoom_max&&(this.camera_zoom=this.camera_zoom_max),this.camera_zoom<this.camera_zoom_min&&(this.camera_zoom=this.camera_zoom_min)}input_camera_move_relative(i,e){this.camera_position_x+=i,this.camera_position_y+=e,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min)}}class vi{constructor(i){this.map=i,this.age=0,this.maxage=4e3,this.parameter=[],this.parameter[0]=[20,0],this.parameter[1]=[0,10],this.parameter[2]=[10,50],this.parameter[3]=[10,5],this.parameter[4]=[0,0],this.parameter[5]=[.1,.5],this.strength=3,this.result=[],this.result[0]=(this.parameter[0][0]*(this.maxage-this.age)+this.parameter[0][1]*this.age)/this.maxage,this.result[1]=(this.parameter[1][0]*(this.maxage-this.age)+this.parameter[1][1]*this.age)/this.maxage,this.result[2]=(this.parameter[2][0]*(this.maxage-this.age)+this.parameter[2][1]*this.age)/this.maxage,this.result[3]=(this.parameter[3][0]*(this.maxage-this.age)+this.parameter[3][1]*this.age)/this.maxage,this.result[4]=(this.parameter[4][0]*(this.maxage-this.age)+this.parameter[4][1]*this.age)/this.maxage,this.result[5]=(this.parameter[5][0]*(this.maxage-this.age)+this.parameter[5][1]*this.age)/this.maxage}physics_model_step(){this.result[0]=(this.parameter[0][0]*(this.maxage-this.age)+this.parameter[0][1]*this.age)/this.maxage,this.result[1]=(this.parameter[1][0]*(this.maxage-this.age)+this.parameter[1][1]*this.age)/this.maxage,this.result[2]=(this.parameter[2][0]*(this.maxage-this.age)+this.parameter[2][1]*this.age)/this.maxage,this.result[3]=(this.parameter[3][0]*(this.maxage-this.age)+this.parameter[3][1]*this.age)/this.maxage,this.result[4]=(this.parameter[4][0]*(this.maxage-this.age)+this.parameter[4][1]*this.age)/this.maxage,this.result[5]=(this.parameter[5][0]*(this.maxage-this.age)+this.parameter[5][1]*this.age)/this.maxage,this.p_beam_x=this.result[0],this.p_beam_y=this.result[1],this.p_beam_width=this.result[2],this.p_beam_height=this.result[3],this.p_beam_direction=this.result[4],this.p_beam_elevation=this.result[5];let i=this.strength*Math.sin(Math.PI*this.age/this.maxage)*(this.p_beam_width+this.p_beam_height)/20,e=Math.PI/4*this.p_beam_width*this.p_beam_height,s=i/e;for(let t=-this.p_beam_width/2;t<=this.p_beam_width/2;t++)for(let a=-this.p_beam_height/2;a<=this.p_beam_height/2;a++){let _=t/(this.p_beam_width/2),r=a/(this.p_beam_height/2);if(Math.sqrt(_*_+r*r)<1){let o=Math.atan2(a-this.p_beam_height/2*(1-this.p_beam_elevation),t)/Math.PI*180,l=Math.cos(this.p_beam_direction/180*Math.PI)*t+-Math.sin(this.p_beam_direction/180*Math.PI)*a,d=Math.sin(this.p_beam_direction/180*Math.PI)*t+Math.cos(this.p_beam_direction/180*Math.PI)*a;this.map.fluid.apply_energy(this.p_beam_x+l,this.p_beam_y+d,o+this.p_beam_direction,-s)}}this.age<this.maxage&&this.age++}}let Ut=gt,M=Ut.Vec2;class T{constructor(i,e,s,t){this.map=i,this.x=e,this.y=s,t!=null?this.hull_angle=t:this.hull_angle=Math.PI,this.wind_direction=0,this.wind_speed=0,this.hull_mass=6,this.hull_shape=Ut.Polygon([M(0,-2.25),M(-.5,-1.25),M(-.75,-.25),M(-.75,.5),M(-.5,1.75),M(.5,1.75),M(.75,.5),M(.75,-.25),M(.5,-1.25),M(0,-2.25)]),this.rudder_input=0,this.motor_input=0,this.rudder_angle=0,this.rudder_angle_last=0,this.rudder_angle_max=60,this.rudder_position=1.8,this.rudder_lenght=.5,this.forces=[],this.mainsail_leading_edge_position=-.8,this.mainsail_boom_length=2.2,this.mainsail_boom_angle_max=80,this.mainsail_boom_angle_factor=.5,this.mainsail_boom_angle=0,this.mainsail_boom_angle_actual=0,this.jib_leading_edge_position=-2,this.jib_boom_length=1.4,this.jib_boom_angle_max=55,this.jib_boom_angle_factor=.65,this.jib_boom_angle=0,this.jib_boom_angle_actual=0,this.center_of_lift=-.05,this.centerboard_position=-.15,this.centerboard_length=.6,this.aero_lookup_resolution=5,this.aero_lift_lookup=[0,.025,.15,.9,1.3,1.46,1.52,1.51,1.45,1.41,1.33,1.16,.95,.82,.73,.6,.43,.34,.28,.28,.28],this.aero_drag_lookup=[.15,.15,.15,.16,.172,.19,.22,.25,.29,.34,.4,.47,.55,.635,.73,.83,.95,1.1,1.28,1.28,1.28],this.physics_model=void 0,this.power=0,this.power_direction=0,this.autopilot_enabled=!1,this.autopilot_heading_target=0,this.autopilot_heading_input=0,this.autopilot_heading_best_vmg_1=50,this.autopilot_heading_best_vmg_2=160,this.autopilot_compensator_p=0,this.autopilot_compensator_i=0,this.autopilot_compensator_d=0,this.autopilot_compensator_last_error=0,this.autopilot_compensator_current_error=0,this.autopilot_compensator_sum_error=0,this.twa=0,this.physics_model_init()}physics_model_init(){let i=gt,e=i.Vec2,s=this.map.world.createBody({type:"dynamic",angularDamping:.5,linearDamping:.1,position:e(this.x,this.y),angle:this.hull_angle,allowSleep:!1});s.createFixture(this.hull_shape,this.hull_mass),this.physics_model=s}physics_model_deinit(){this.map.world.destroyBody(this.physics_model)}physics_model_step(){this.forces=[],document.getElementById("info").innerHTML="Autopilot"+this.autopilot_enabled+"<br>",document.getElementById("info").innerHTML+="Heading Target"+this.autopilot_heading_target+"<br>",this.x=this.physics_model.m_xf.p.x,this.y=this.physics_model.m_xf.p.y,this.wind_speed=this.map.get_wind_speed(this.x,this.y),this.wind_direction=this.map.get_wind_direction(this.x,this.y);var i=this.physics_model.getAngle();for(this.angle=i,this.hull_angle=i;i<-Math.PI;)i+=2*Math.PI;for(;i>Math.PI;)i-=2*Math.PI;let e=this.physics_model.m_linearVelocity.x*Math.cos(i-Math.PI/2)+this.physics_model.m_linearVelocity.y*Math.sin(i-Math.PI/2),s=this.physics_model.m_linearVelocity.x*Math.cos(i)+this.physics_model.m_linearVelocity.y*Math.sin(i),t=Math.atan2(s,Math.abs(e))*180/Math.PI;t>90?t-=180:t<-90&&(t+=180);let a=-t*Math.abs(e)*Math.abs(e)*2;a>150?a=150:a<-150&&(a=-150);var _=this.physics_model.getWorldVector(M(a,0)),r=this.physics_model.getWorldPoint(M(0,this.centerboard_position));this.physics_model.applyForce(_,r,!0),this.forces.push({name:"centerboard",type:"arrow",vector:_,point:r}),document.getElementById("info").innerHTML+="q/d: "+t+"\xB0<br>";let o=this.map.get_wind_direction(this.x,this.y)-i/Math.PI*180+90,l={};l.x=this.physics_model.m_linearVelocity.x+Math.cos(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y),l.y=this.physics_model.m_linearVelocity.y+Math.sin(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y);let d=Math.atan2(l.y,l.x)/Math.PI*180-i/Math.PI*180+90,n=Math.sqrt(l.x*l.x+l.y*l.y);if(d>180&&(d-=360),d<-180&&(d+=360),o>180&&(o-=360),o<-180&&(o+=360),this.awa=d,this.twa=o,this.motor_input===1){var m=this.physics_model.getWorldVector(M(0,-.3)),c=this.physics_model.getWorldPoint(M(0,2));this.physics_model.applyLinearImpulse(m,c,!0)}if(this.motor_input===-1){var m=this.physics_model.getWorldVector(M(0,.3)),c=this.physics_model.getWorldPoint(M(0,2));this.physics_model.applyLinearImpulse(m,c,!0)}this.rudder_angle_last=this.rudder_angle;let p=0;const f=1-Math.abs(e)>0?1-Math.abs(e)+1:1;if(this.rudder_input===-1)this.rudder_angle<this.rudder_angle_max&&(this.rudder_angle+=f),p=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else if(this.rudder_input===1)this.rudder_angle>-this.rudder_angle_max&&(this.rudder_angle-=f),p=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else{let B=e;e>1&&(B=1),e<-1&&(B=-1),this.rudder_angle=this.rudder_angle*(.98-B/80)}if(this.autopilot_enabled){this.autopilot_compensator_p=2,this.autopilot_compensator_i=0,this.autopilot_compensator_d=100;let B=-(this.autopilot_heading_target- -this.twa);this.autopilot_compensator_sum_error*=.85,this.autopilot_compensator_sum_error+=B,B>180&&(B-=360),B<-180&&(B+=360),document.getElementById("info").innerHTML+="error: "+Math.floor(B)+"\xB0<br>";let ti=B*this.autopilot_compensator_p,ii=this.autopilot_compensator_sum_error*this.autopilot_compensator_i,ei=(B-this.autopilot_compensator_last_error)*this.autopilot_compensator_d;this.rudder_angle_target=(ti+ii+ei)*Math.sign(e),this.rudder_angle_target>this.rudder_angle_max/2&&(this.rudder_angle_target=this.rudder_angle_max/2),this.rudder_angle_target<-this.rudder_angle_max/2&&(this.rudder_angle_target=-this.rudder_angle_max/2),this.rudder_angle+=(this.rudder_angle_target-this.rudder_angle)/10,this.autopilot_compensator_last_error=B}else this.autopilot_heading_target=-this.twa,this.autopilot_heading_target>180&&(this.autopilot_heading_target-=360),this.autopilot_heading_target<-180&&(this.autopilot_heading_target+=360);let b=this.physics_model.m_angularVelocity*this.rudder_lenght,P=Math.atan2(-s+b,Math.abs(e))/Math.PI*180,I=0;e>0?I=e*(this.rudder_angle+P)/7:I=e*(this.rudder_angle-P)/7,I+=p*2;let W=this.physics_model.getWorldPoint(M(0,this.rudder_position)),j={};j.x=Math.cos(i+this.rudder_angle/180*Math.PI)*I,j.y=Math.sin(i+this.rudder_angle/180*Math.PI)*I,this.physics_model.applyForce(j,W,!0),this.forces.push({name:"rudder",type:"arrow",vector:j,point:W}),document.getElementById("info").innerHTML+="TWA: "+Math.floor(o)+"<br>",document.getElementById("info").innerHTML+="TWS: "+Math.floor(this.wind_speed*10)/10+"<br>",document.getElementById("info").innerHTML+="AWA: "+Math.floor(d)+"<br>",document.getElementById("info").innerHTML+="AWS: "+Math.floor(n*10)/10+"<br>";let x=Math.sqrt(this.physics_model.m_linearVelocity.x*this.physics_model.m_linearVelocity.x+this.physics_model.m_linearVelocity.y*this.physics_model.m_linearVelocity.y),A=Math.cos(o/180*Math.PI)*x;document.getElementById("info").innerHTML+="BS: "+Math.floor(x*10)/10+"<br>",document.getElementById("info").innerHTML+="VMG: "+Math.floor(A*10)/10+"<br>",this.jib_boom_angle=this.awa*this.jib_boom_angle_factor,this.jib_boom_angle>this.jib_boom_angle_max&&(this.jib_boom_angle=this.jib_boom_angle_max),this.jib_boom_angle<-this.jib_boom_angle_max&&(this.jib_boom_angle=-this.jib_boom_angle_max),this.mainsail_boom_angle=this.awa*this.mainsail_boom_angle_factor,this.mainsail_boom_angle>this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=this.mainsail_boom_angle_max),this.mainsail_boom_angle<-this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=-this.mainsail_boom_angle_max);const E=Math.floor(Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution),ot=Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution-E;let ut=this.aero_drag_lookup[E]*(1-ot)+this.aero_drag_lookup[E+1]*ot,pt=this.aero_lift_lookup[E]*(1-ot)+this.aero_lift_lookup[E+1]*ot,U={},Y={};document.getElementById("info").innerHTML+="Cd: "+Math.floor(ut*10)/10+"<br>",document.getElementById("info").innerHTML+="Cl: "+Math.floor(pt*10)/10+"<br>";const nt=.15;U.x=Math.cos(i+this.awa/180*Math.PI+Math.PI/2)*n*n*ut*nt,U.y=Math.sin(i+this.awa/180*Math.PI+Math.PI/2)*n*n*ut*nt,Y.x=-Math.sign(this.awa)*Math.cos(i+this.awa/180*Math.PI)*n*n*pt*nt,Y.y=-Math.sign(this.awa)*Math.sin(i+this.awa/180*Math.PI)*n*n*pt*nt;let H={};H.x=U.x+Y.x,H.y=U.y+Y.y;var _t=this.physics_model.getWorldPoint(M(0,this.center_of_lift));this.physics_model.applyForce(Y,_t,!0),this.physics_model.applyForce(U,_t,!0),this.forces.push({name:"mainsail",type:"arrow",vector:Y,point:_t}),this.forces.push({name:"mainsail",type:"arrow",vector:U,point:_t}),this.power=Math.sqrt(H.x*H.x+H.y*H.y),this.power_direction=Math.atan2(H.y,H.x)/Math.PI*180,document.getElementById("info").innerHTML+="Power: "+Math.floor(this.power*10)/10+"<br>";var rt={};rt.x=-this.physics_model.m_linearVelocity.x*x,rt.y=-this.physics_model.m_linearVelocity.y*x;var At=this.physics_model.getWorldPoint(M(0,0));this.physics_model.applyForce(rt,At,!0),this.forces.push({name:"drag",type:"arrow",vector:rt,point:At}),this.rudder_input=0,this.motor_input=0}graphics_model_render(){let i=[];this.forces.forEach(n=>{i.push({color:65280,type:"force",x1:n.point.x,y1:n.point.y,x2:n.point.x+n.vector.x/10,y2:n.point.y+n.vector.y/10})});let e={},s=2;this.autopilot_enabled&&(s=10),e.x1=this.physics_model.getWorldPoint(M(0,0)).x,e.y1=this.physics_model.getWorldPoint(M(0,0)).y,e.x2=e.x1+Math.cos((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*s,e.y2=e.y1+Math.sin((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*s,e.color=5596791,e.type="autopilot",i.push(e);let t=this.wind_direction/180*Math.PI;i.push({color:5588087,type:"guide",x1:this.x+Math.cos(t)*3,y1:this.y+Math.sin(t)*3,x2:this.x+Math.cos(t)*5+Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5+Math.sin(t+Math.PI/2)*.5}),i.push({color:5588087,type:"guide",x1:this.x+Math.cos(t)*3,y1:this.y+Math.sin(t)*3,x2:this.x+Math.cos(t)*5-Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5-Math.sin(t+Math.PI/2)*.5}),i.push({color:5588087,type:"guide",x1:this.x+Math.cos(t)*4.75,y1:this.y+Math.sin(t)*4.75,x2:this.x+Math.cos(t)*5-Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5-Math.sin(t+Math.PI/2)*.5}),i.push({color:5588087,type:"guide",x1:this.x+Math.cos(t)*4.75,y1:this.y+Math.sin(t)*4.75,x2:this.x+Math.cos(t)*5+Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5+Math.sin(t+Math.PI/2)*.5}),t=this.awa/180*Math.PI+this.hull_angle-Math.PI/2,i.push({color:5570679,type:"guide",x1:this.x+Math.cos(t)*3,y1:this.y+Math.sin(t)*3,x2:this.x+Math.cos(t)*5+Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5+Math.sin(t+Math.PI/2)*.5}),i.push({color:5570679,type:"guide",x1:this.x+Math.cos(t)*3,y1:this.y+Math.sin(t)*3,x2:this.x+Math.cos(t)*5-Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5-Math.sin(t+Math.PI/2)*.5}),i.push({color:5570679,type:"guide",x1:this.x+Math.cos(t)*4.75,y1:this.y+Math.sin(t)*4.75,x2:this.x+Math.cos(t)*5-Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5-Math.sin(t+Math.PI/2)*.5}),i.push({color:5570679,type:"guide",x1:this.x+Math.cos(t)*4.75,y1:this.y+Math.sin(t)*4.75,x2:this.x+Math.cos(t)*5+Math.cos(t+Math.PI/2)*.5,y2:this.y+Math.sin(t)*5+Math.sin(t+Math.PI/2)*.5}),i.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(M(0,this.rudder_position)).x,y1:this.physics_model.getWorldPoint(M(0,this.rudder_position)).y,x2:this.physics_model.getWorldPoint(M(0,this.rudder_position)).x+Math.cos(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght,y2:this.physics_model.getWorldPoint(M(0,this.rudder_position)).y+Math.sin(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght}),i.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(M(0,this.centerboard_position+this.centerboard_length/2)).x,y1:this.physics_model.getWorldPoint(M(0,this.centerboard_position+this.centerboard_length/2)).y,x2:this.physics_model.getWorldPoint(M(0,this.centerboard_position-this.centerboard_length/2)).x,y2:this.physics_model.getWorldPoint(M(0,this.centerboard_position-this.centerboard_length/2)).y});let a=[];a[0]={},a[0].x=this.physics_model.getWorldPoint(M(0,this.mainsail_leading_edge_position)).x,a[0].y=this.physics_model.getWorldPoint(M(0,this.mainsail_leading_edge_position)).y,this.mainsail_boom_angle/this.mainsail_boom_angle_factor,this.mainsail_boom_angle_actual+=(this.mainsail_boom_angle-this.mainsail_boom_angle_actual)/30;let _=this.mainsail_boom_length*.05*Math.abs(this.awa)/30<this.mainsail_boom_length/10?this.mainsail_boom_length*.05*Math.abs(this.awa)/30:this.mainsail_boom_length/10;a[1]={},a[1].x=a[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-_*Math.sign(this.mainsail_boom_angle_actual),a[1].y=a[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-_*Math.sign(this.mainsail_boom_angle_actual);let r=_;a[2]={},a[2].x=a[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.mainsail_boom_angle_actual),a[2].y=a[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.mainsail_boom_angle_actual),a[3]={},a[3].x=a[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,a[3].y=a[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,i.push({color:8939263,type:"sail",x1:a[0].x,y1:a[0].y,x2:a[1].x,y2:a[1].y}),i.push({color:8939263,type:"sail",x1:a[1].x,y1:a[1].y,x2:a[2].x,y2:a[2].y}),i.push({color:8939263,type:"sail",x1:a[2].x,y1:a[2].y,x2:a[3].x,y2:a[3].y}),this.jib_boom_angle_actual+=(this.jib_boom_angle-this.jib_boom_angle_actual)/20;let o=[];o[0]={},o[0].x=this.physics_model.getWorldPoint(M(0,this.jib_leading_edge_position)).x,o[0].y=this.physics_model.getWorldPoint(M(0,this.jib_leading_edge_position)).y;let l=this.jib_boom_length*.05*Math.abs(this.awa)/15<this.jib_boom_length/3?this.jib_boom_length*.05*Math.abs(this.awa)/15:this.jib_boom_length/3;o[1]={},o[1].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.jib_boom_angle_actual),o[1].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.jib_boom_angle_actual);let d=l;if(o[2]={},o[2].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),o[2].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),o[3]={},o[3].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,o[3].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,i.push({color:8939263,type:"sail",x1:o[0].x,y1:o[0].y,x2:o[1].x,y2:o[1].y}),i.push({color:8939263,type:"sail",x1:o[1].x,y1:o[1].y,x2:o[2].x,y2:o[2].y}),i.push({color:8939263,type:"sail",x1:o[2].x,y1:o[2].y,x2:o[3].x,y2:o[3].y}),this.map.show_fields){const n=10;for(let m=-n;m<n;m++)for(let c=-n;c<n;c++)if(Math.sqrt(m*m+c*c)<n-1){const p=this.map.bm.resolution;let f=Math.floor(this.x*p)/p+m/p,g=Math.floor(this.y*p)/p+c/p,b=this.map.bm.get_field_velocity(f,g);i.push({color:8939263,type:"sail",x1:f,y1:g,x2:f+b.x*30,y2:g+b.y*30})}}return i}input_rudder_left(){this.rudder_input=1,this.autopilot_enabled=!1}input_rudder_right(){this.rudder_input=-1,this.autopilot_enabled=!1}input_motor_forward(){this.motor_input=1}input_motor_reverse(){this.motor_input=-1}input_autopilot_enabled_toggle(){this.autopilot_heading_target<0?this.autopilot_heading_target>-90?this.autopilot_heading_target=-this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=-this.autopilot_heading_best_vmg_2:this.autopilot_heading_target<90?this.autopilot_heading_target=this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=this.autopilot_heading_best_vmg_2,this.autopilot_enabled=!0}input_autopilot_tack_toggle(){this.autopilot_heading_target*=-1,this.autopilot_enabled=!0}input_autopilot_heading_increase(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)<175&&(this.autopilot_heading_target>0?this.autopilot_heading_target+=1:this.autopilot_heading_target-=1)}input_autopilot_heading_decrease(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)>5&&(this.autopilot_heading_target>0?this.autopilot_heading_target-=1:this.autopilot_heading_target+=1)}}const Pt=50,Et=50,Yt=90,Gt=7,Wt=1.5;var K=2,Qt=K*Pt*Wt,Xt=K*Et*Wt,xi=Qt*Xt*4,bi=new Uint8Array(xi),G=new ft(bi,Qt,Xt,ai,Mt,si);G.magFilter=Tt;G.needsUpdate=!0;var $t=new qt({map:G,transparent:!0});$t.needsUpdate=!0;const Q=new gi(Pt,Et,Wt,Yt,Gt,G,K);let u=new wi(Pt,Et,Yt,Gt,Q);u.physics_model_init();const Ii=function(h,i,e,s,t){return(h-i)*(t-s)/(e-i)+s};let st={},w=[],St=[],X=0;const Pi=new hi(u.world,{speed:1,fps:30});var kt=u.fluid.vectorField.areaWidth,Ft=u.fluid.vectorField.areaHeight,Jt=kt*Ft,Bt=new Uint8Array(Jt);for(var jt=0;jt<Jt;jt++)Bt[jt]=Math.random()*256;var Lt=new ft(Bt,kt,Ft,Ht,Mt),Ei=new ft(Bt,kt,Ft,Ht,Mt);Lt.magFilter=Tt;Lt.needsUpdate=!0;var Wi=new qt({color:16777215,alphaMap:Lt,transparent:!0});Wi.needsUpdate=!0;let S=[],V=[],F=[],Zt=[],mt=[];document.onkeydown=ki;document.onkeyup=Fi;document.getElementById("camera_follow").checked=!1;document.getElementById("show_forces").checked=!0;document.getElementById("show_field").checked=!1;document.getElementById("show_forces").addEventListener("change",h=>{u.input_show_forces(document.getElementById("show_forces").checked)});document.getElementById("scenario_selector").addEventListener("change",h=>{console.log(document.getElementById("scenario_selector").value),Nt(y[document.getElementById("scenario_selector").value])});document.getElementById("scenario_restart").addEventListener("click",h=>{console.log("restart"),Nt(y[document.getElementById("scenario_selector").value])});document.getElementById("show_field").addEventListener("change",h=>{u.input_show_fields(document.getElementById("show_field").checked)});document.getElementById("windAngle").addEventListener("change",h=>{let i=parseInt(document.getElementById("windAngle").value);u.bm.direction=i+180});document.getElementById("camera_follow").addEventListener("change",h=>{u.input_camera_follow(document.getElementById("camera_follow").checked)});document.getElementById("camera_zoom_in").addEventListener("click",h=>{u.input_camera_zoom_relative(-2)});document.getElementById("camera_zoom_out").addEventListener("click",h=>{u.input_camera_zoom_relative(2)});document.getElementById("camera_move_left").addEventListener("click",h=>{u.input_camera_move_relative(-5,0)});document.getElementById("camera_move_right").addEventListener("click",h=>{u.input_camera_move_relative(5,0)});document.getElementById("camera_move_up").addEventListener("click",h=>{u.input_camera_move_relative(0,5)});document.getElementById("camera_move_down").addEventListener("click",h=>{u.input_camera_move_relative(0,-5)});var Si=function(h){h.pageX,h.pageY;var i=new z,e=new z;i.set(h.clientX/window.innerWidth*2-1,-(h.clientY/window.innerHeight)*2+1,.5),i.unproject(N),i.sub(N.position).normalize();var s=-N.position.z/i.z;e.copy(N.position).add(i.multiplyScalar(s));let t=u.get_wind_direction(e.x,e.y),a=u.get_wind_speed(e.x,e.y),_=Q.get_field_velocity(e.x,e.y).x,r=Q.get_field_velocity(e.x,e.y).y;t=Math.atan2(r,_)/Math.PI*180,a=Math.sqrt(_*_+r*r),document.getElementById("wind_info").innerHTML="Speed: "+Math.floor(a*1e3)/10+"<br>Direction: "+Math.floor(t*10)/10};document.addEventListener("mousemove",Si);function ki(h){h=h||window.event,V[h.keyCode]=!0,S.forEach(i=>{i.type==="KEYDOWN"&&V[i.activation_key]&&(V[i.prohibition_key]===!1||V[i.prohibition_key]===void 0)&&i.object[i.input_handler]()})}function Fi(h){h=h||window.event,V[h.keyCode]=!1}function ct(){st={},S=[],w.forEach(h=>{h.physics_model_deinit()}),w=[],X=0}function Nt(h){ct(),st=h}function ht(h){S=[],h[0]!==void 0&&(S.push({type:"PRESSED",activation_key:37,prohibition_key:39,object:h[0],input_handler:h[0].input_rudder_left.name}),S.push({type:"PRESSED",activation_key:39,prohibition_key:37,object:h[0],input_handler:h[0].input_rudder_right.name}),S.push({type:"PRESSED",activation_key:40,prohibition_key:38,object:h[0],input_handler:h[0].input_autopilot_heading_increase.name}),S.push({type:"PRESSED",activation_key:38,prohibition_key:40,object:h[0],input_handler:h[0].input_autopilot_heading_decrease.name}),S.push({type:"KEYDOWN",activation_key:32,prohibition_key:-1,object:h[0],input_handler:h[0].input_autopilot_enabled_toggle.name}),S.push({type:"KEYDOWN",activation_key:13,prohibition_key:-1,object:h[0],input_handler:h[0].input_autopilot_tack_toggle.name})),h[1]!==void 0&&(S.push({type:"PRESSED",activation_key:65,prohibition_key:68,object:h[1],input_handler:h[1].input_rudder_left.name}),S.push({type:"PRESSED",activation_key:68,prohibition_key:65,object:h[1],input_handler:h[1].input_rudder_right.name}),S.push({type:"PRESSED",activation_key:83,prohibition_key:87,object:h[1],input_handler:h[1].input_autopilot_heading_increase.name}),S.push({type:"PRESSED",activation_key:87,prohibition_key:83,object:h[1],input_handler:h[1].input_autopilot_heading_decrease.name}),S.push({type:"KEYDOWN",activation_key:17,prohibition_key:-1,object:h[1],input_handler:h[0].input_autopilot_enabled_toggle.name}),S.push({type:"KEYDOWN",activation_key:16,prohibition_key:-1,object:h[1],input_handler:h[0].input_autopilot_tack_toggle.name}))}let y=[];y[0]=[];y[0][0]=()=>{w.push(new T(u,10,-9,5*Math.PI/4))};y[0][1]=()=>{console.log(1),w[0].input_autopilot_enabled_toggle()};y[0][2]=()=>{ht(w)};y[1]=[];y[1][0]=()=>{w.push(new T(u,12,-6,5*Math.PI/4)),w.push(new T(u,15,-11.5,5*Math.PI/4))};y[1][1]=()=>{console.log(1),w[0].input_autopilot_enabled_toggle(),w[1].input_autopilot_enabled_toggle()};y[1][2]=()=>{ht(w)};y[2]=[];y[2][0]=()=>{w.push(new T(u,-10,-6,3*Math.PI/4)),w.push(new T(u,15,-11.5,5*Math.PI/4))};y[2][1]=()=>{console.log(1),w[0].input_autopilot_enabled_toggle(),w[1].input_autopilot_enabled_toggle()};y[2][2]=()=>{ht(w)};y[2][2e3]=()=>{ct()};y[3]=[];y[3][0]=()=>{w.push(new T(u,-3,-3,3*Math.PI/4)),w.push(new T(u,18,-11.5,5*Math.PI/4))};y[3][1]=()=>{console.log(1),w[0].input_autopilot_enabled_toggle(),w[1].input_autopilot_enabled_toggle()};y[3][2]=()=>{ht(w)};y[3][350]=()=>{w[0].input_autopilot_tack_toggle()};y[3][2e3]=()=>{ct()};y[4]=[];y[4][0]=()=>{w.push(new T(u,-3,-4,3*Math.PI/4)),w.push(new T(u,18,-11.5,5*Math.PI/4))};y[4][1]=()=>{console.log(1),w[0].input_autopilot_enabled_toggle(),w[1].input_autopilot_enabled_toggle()};y[4][2]=()=>{ht(w)};y[4][300]=()=>{w[0].input_autopilot_tack_toggle()};y[4][700]=()=>{w[1].input_autopilot_heading_decrease()};y[4][701]=()=>{w[1].input_autopilot_heading_decrease()};y[4][702]=()=>{w[1].input_autopilot_heading_decrease()};y[4][2e3]=()=>{ct()};y[5]=[];y[5][0]=()=>{St=[]};y[5][1]=()=>{St.push(new vi(u))};Nt(y[document.getElementById("scenario_selector").value]);Pi.start(()=>{mt=[],st!==void 0&&st[X]!==void 0&&(console.log("Frame ",X),st[X]()),S.forEach(t=>{t.type==="PRESSED"&&V[t.activation_key]===!0&&(V[t.prohibition_key]===!1||V[t.prohibition_key]===void 0)&&t.object[t.input_handler]()}),u.set_camera_follow_target(w[0]),u.physics_model_step(),St.forEach(t=>{t.physics_model_step()});let h=0;w.forEach((t,a)=>{w.forEach((l,d)=>{if(d>a){let n=t.x-l.x,m=t.y-l.y;h+=Math.sqrt(n*n+m*m),document.getElementById("dist_info").innerHTML="Dist: "+Math.floor(h*100)/100+"<br>"}}),t.physics_model_step(),mt=[...mt,...t.graphics_model_render()];let _={},r=t.awa/180*Math.PI+t.hull_angle-Math.PI/2;_.x=t.x+Math.cos(r)*-1.8,_.y=t.y+Math.sin(r)*-1.8,Math.cos(t.power_direction/180*Math.PI)*t.power/1e4,Math.sin(t.power_direction/180*Math.PI)*t.power/1e4;const o=1.5;_.x0=t.x+Math.cos(t.hull_angle+90/180*Math.PI)*-o+Math.cos(r)*-2,_.y0=t.y+Math.sin(t.hull_angle+90/180*Math.PI)*-o+Math.sin(r)*-2,_.x1=t.x+Math.cos(t.hull_angle+90/180*Math.PI)*0+Math.cos(r)*-2,_.y1=t.y+Math.sin(t.hull_angle+90/180*Math.PI)*0+Math.sin(r)*-2,_.x2=t.x+Math.cos(t.hull_angle+90/180*Math.PI)*+o+Math.cos(r)*-2,_.y2=t.y+Math.sin(t.hull_angle+90/180*Math.PI)*+o+Math.sin(r)*-2,u.bm.apply_energy(_.x0,_.y0,t.power_direction,t.power/5e3),u.bm.apply_energy(_.x1,_.y1,t.power_direction,t.power/2e3),u.bm.apply_energy(_.x2,_.y2,t.power_direction,t.power/5e3),document.getElementById("info").innerHTML+="Phys Time: "+Q.t_delta+"<br>"}),X%1==0&&u.bm.physics_model_step(),X++;var i=u.fluid.vectorField.field;const e=Ei.image.data;for(let t=0;t<u.fluid.vectorField.areaWidth*K;t++)for(let a=0;a<u.fluid.vectorField.areaHeight*K;a++){let _=Math.floor(t/K),r=Math.floor(a/K),o=i[_][r].velocity,l=256-Ii(o,10,15,0,256);e[r*u.fluid.vectorField.areaWidth+_]=l}let s={};s.x=0,s.y=0,Q.step_ready&&($.copyTextureToTexture(s,G,G),Q.step_ready=!1),u.show_fields},()=>{});let N,q,$;Bi();function Bi(){N=new oi(70,window.innerWidth/window.innerHeight,.01,85),N.position.z=60,N.position.y=20,q=new ni,new zt(6706517),new zt(5592422);const h=new _i(u.width,u.height);let i=new ri(h,$t);i.position.x=0,i.position.y=0,i.position.z=-.01,q.add(i),$=new li({antialias:!0}),$.setSize(window.innerWidth,window.innerHeight),$.setAnimationLoop(ji),document.body.appendChild($.domElement)}function ji(h){N.position.x=u.camera_position_x,N.position.y=u.camera_position_y,N.position.z=u.camera_zoom;for(let i of F)q.remove(i),i.geometry.dispose(),i.material.dispose(),i=void 0;for(let i of Zt)q.remove(i),i.geometry.dispose!==void 0&&i.geometry.dispose(),i.material.dispose!==void 0&&i.material.dispose(),i=void 0;F=[],Zt=[];for(let i=u.world.getBodyList();i;i=i.getNext())for(let e=i.getFixtureList();e;e=e.getNext()){if(i.render&&i.render.hidden)continue;i.render&&i.render.stroke||i.isDynamic()||i.isKinematic()||i.isStatic();const s=e.getType(),t=e.getShape();if(s==="circle"){const a=t.m_radius,_=i.getPosition();let r=[];for(let d=0;d<360;d+=10){let n=d/180*Math.PI,m=a*Math.cos(n)+_.x,c=a*Math.sin(n)+_.y;r.push(new z(m,c,0))}r.push(r[0]);const o=new lt().setFromPoints(r),l=new J({color:65280});F.push(new dt(o,l)),q.add(F[F.length-1])}if(s==="edge"){let a=[];const _=t.m_vertex1,r=t.m_vertex2;let o=_.x+i.m_xf.p.x,l=_.y+i.m_xf.p.y,d=r.x+i.m_xf.p.x,n=r.y+i.m_xf.p.y;a.push(new z(o,l,0)),a.push(new z(d,n,0));const m=new lt().setFromPoints(a),c=new J({color:16711680});F.push(new dt(m,c)),q.add(F[F.length-1])}if(s==="polygon"){let a=t.m_vertices;a.push(a[0]);let _=[];for(const l of a){let d=i.getAngle()+Math.PI,n=i.getLocalCenter(),m=(l.x+n.x)*Math.cos(d)+(l.y-n.y)*Math.sin(d),c=(l.x+n.x)*Math.sin(d)-(l.y-n.y)*Math.cos(d),p=0;m+=e.m_body.c_position.c.x,c+=e.m_body.c_position.c.y,_.push(new z(m,c,p))}const r=new lt().setFromPoints(_),o=new J({color:255});F.push(new dt(r,o)),q.add(F[F.length-1])}}for(const i of mt){if(u.show_forces==!1&&i.type==="force")continue;let e=[];e.push(new z(i.x1,i.y1,0)),e.push(new z(i.x2,i.y2,0));const s=new lt().setFromPoints(e);let t=i.color;t===void 0&&(t=16711680);let a,_,r;i.opacity!==void 0?(_=!0,a=i.opacity,r=new J({color:t,transparent:_,opacity:a})):r=new J({color:t}),F.push(new dt(s,r)),q.add(F[F.length-1])}$.render(q,N)}
