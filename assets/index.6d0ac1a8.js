import{p as ct,l as ut,D as Ht,R as Vt,U as Rt,a as Ct,N as Ot,M as Kt,b as Yt,P as Ut,S as Gt,C as Pt,c as Qt,d as Xt,W as $t,B as ot,L as $,e as _t,V as H}from"./vendor.601f039e.js";const Jt=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}};Jt();var Zt=document.getElementById("plotSelect"),te=document.getElementById("contrastSlider"),ee=document.getElementById("rafCheck");const mt=4/9,T=1/9,q=1/36;var y=400,Et=new Array(y+2),pt=new Array(y+2),gt=new Array(y+2),ft=new Array(y+2);for(var v=0;v<=y;v++){var V,C,O;v<y/8?(V=0,C=0,O=Math.round(255*(v+y/8)/(y/4))):v<3*y/8?(V=0,C=Math.round(255*(v-y/8)/(y/4)),O=255):v<5*y/8?(V=Math.round(255*(v-3*y/8)/(y/4)),C=255,O=255-V):v<7*y/8?(V=255,C=Math.round(255*(7*y/8-v)/(y/4)),O=0):(V=Math.round(255*(9*y/8-v)/(y/4)),C=0,O=0),pt[v]=V,gt[v]=C,ft[v]=O,Et[v]=St(V,C,O)}pt[y+1]=0;gt[y+1]=0;ft[y+1]=0;Et[y+1]=St(0,0,0);function yt(n){var t=n.toString(16);return t.length==1?"0"+t:t}function St(n,t,e){return"#"+yt(n)+yt(t)+yt(e)}class ie{constructor(t,e,a,i){this.x=e,this.y=a,this.parent=t,this.sub_mesh_depth=i,this._n0_=0,this._nN_=0,this._nS_=0,this._nE_=0,this._nW_=0,this._nNE_=0,this._nSE_=0,this._nNW_=0,this._nSW_=0,this._received_nN_=0,this._received_nS_=0,this._received_nE_=0,this._received_nW_=0,this._received_nNE_=0,this._received_nSE_=0,this._received_nNW_=0,this._received_nSW_=0,this._ux_=0,this._uy_=0,this._rho_=0,this._curl_=0,this.barrier=!1,this.child_00=null,this.child_01=null,this.child_10=null,this.child_11=null}setCurl(t){this._curl_=t}setEquil(t,e,a){typeof a=="undefined"&&(a=this._rho_);var i=3*t,s=3*e,l=t*t,h=e*e,o=2*t*e,r=l+h,d=1.5*r;this._n0_=mt*a*(1-d),this._nE_=T*a*(1+i+4.5*l-d),this._nW_=T*a*(1-i+4.5*l-d),this._nN_=T*a*(1+s+4.5*h-d),this._nS_=T*a*(1-s+4.5*h-d),this._nNE_=q*a*(1+i+s+4.5*(r+o)-d),this._nSE_=q*a*(1+i-s+4.5*(r-o)-d),this._nNW_=q*a*(1-i+s+4.5*(r-o)-d),this._nSW_=q*a*(1-i-s+4.5*(r+o)-d),this._rho_=a,this._ux_=t,this._uy_=e}calculate_curl(){let t=this.parent,e=this.x,a=this.y;this._curl_=t.find_cell(e+1,a)._uy_-t.find_cell(e-1,a)._uy_-t.find_cell(e,a+1)._ux_+t.find_cell(e,a-1)._ux_}collide(t){let e=this._n0_+this._nN_+this._nS_+this._nE_+this._nW_+this._nNW_+this._nNE_+this._nSW_+this._nSE_;this._rho_=e;let a=(this._nE_+this._nNE_+this._nSE_-this._nW_-this._nNW_-this._nSW_)/e;this._ux_=a;let i=(this._nN_+this._nNE_+this._nNW_-this._nS_-this._nSE_-this._nSW_)/e;this._uy_=i;let s=T*e,l=q*e,h=3*a,o=3*i,r=a*a,d=i*i,_=2*a*i,u=r+d,c=1.5*u;this._n0_+=t*(mt*e*(1-c)-this._n0_),this._nE_+=t*(s*(1+h+4.5*r-c)-this._nE_),this._nW_+=t*(s*(1-h+4.5*r-c)-this._nW_),this._nN_+=t*(s*(1+o+4.5*d-c)-this._nN_),this._nS_+=t*(s*(1-o+4.5*d-c)-this._nS_),this._nNE_+=t*(l*(1+h+o+4.5*(u+_)-c)-this._nNE_),this._nSE_+=t*(l*(1+h-o+4.5*(u-_)-c)-this._nSE_),this._nNW_+=t*(l*(1-h+o+4.5*(u-_)-c)-this._nNW_),this._nSW_+=t*(l*(1-h-o+4.5*(u+_)-c)-this._nSW_)}stream(){let t=this.parent,e=this.x,a=this.y;this._received_nN_=t.find_cell(e,a-1)._nN_,this._received_nNW_=t.find_cell(e+1,a-1)._nNW_,this._received_nE_=t.find_cell(e-1,a)._nE_,this._received_nNE_=t.find_cell(e-1,a-1)._nNE_,this._received_nS_=t.find_cell(e,a+1)._nS_,this._received_nSE_=t.find_cell(e-1,a+1)._nSE_,this._received_nW_=t.find_cell(e+1,a)._nW_,this._received_nSW_=t.find_cell(e+1,a+1)._nSW_}bounce(){let t=this.parent,e=this.x,a=this.y;this.barrier&&(t.find_cell(e+1,a)._received_nE_=this._received_nW_,t.find_cell(e-1,a)._received_nW_=this._received_nE_,t.find_cell(e,a+1)._received_nN_=this._received_nS_,t.find_cell(e,a-1)._received_nS_=this._received_nN_,t.find_cell(e+1,a+1)._received_nNE_=this._received_nSW_,t.find_cell(e-1,a+1)._received_nNW_=this._received_nSE_,t.find_cell(e+1,a-1)._received_nSE_=this._received_nNW_,t.find_cell(e-1,a-1)._received_nSW_=this._received_nNE_)}consolidate(){this._nN_=this._received_nN_,this._nS_=this._received_nS_,this._nE_=this._received_nE_,this._nW_=this._received_nW_,this._nNE_=this._received_nNE_,this._nSE_=this._received_nSE_,this._nNW_=this._received_nNW_,this._nSW_=this._received_nSW_,this._received_nN_=0,this._received_nS_=0,this._received_nE_=0,this._received_nW_=0,this._received_nNE_=0,this._received_nSE_=0,this._received_nNW_=0,this._received_nSW_=0}}class se{constructor(t,e,a,i,s,l,h){this.oversampling=h,this.texture=l,this.resolution=a,this.width=t*this.resolution,this.height=e*this.resolution,this.direction=i+180,this.step_ready=!1,this.t_delta=0,this.speed=s/100,this.viscosity=.02,this.cells=new Array(this.width*this.height);for(var o=0;o<this.height;o++)for(var r=0;r<this.width;r++)this.cells[r+o*this.width]=new ie(this,r,o,1);for(var o=0;o<this.height;o++)for(var r=0;r<this.width;r++){this.find_cell(r,o).barrier=!1;let u=5;Math.pow(this.width/2-r,2)+Math.pow(this.height*.75-o,2)<Math.pow(u,2)&&(this.find_cell(r,o).barrier=!0)}this.running=!1,this.initFluid(),this.startStop(),this.graphics_model_init()}calculate_index(t,e){return t+e*this.width}find_cell(t,e){return this.cells[t+e*this.width]}initFluid(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;console.log(t,e);for(var a=0;a<this.height;a++)for(var i=0;i<this.width;i++)this.find_cell(i,a).setEquil(t,e,1),this.find_cell(i,a).setCurl(0)}startStop(){this.running=!this.running,this.running&&this.physics_model_step()}physics_model_step(){let t=new Date;for(let e=0;e<1;e++)this.setBoundaries(),this.collide(),this.stream(),this.bounce(),this.consolidate();this.t_delta=new Date-t,this.step_ready=!0,this.graphics_model_init()}graphics_model_init(){this.graphics_model_step()}graphics_model_step(){this.paintTexture(),this.running&&(ee.checked?requestAnimFrame(this.graphics_model_step_handler.bind(this)):window.setTimeout(this.graphics_model_step_handler.bind(this),10))}graphics_model_step_handler(){this.graphics_model_step()}setBoundaries(){let t=Math.cos(this.direction/180*Math.PI)*this.speed,e=Math.sin(this.direction/180*Math.PI)*this.speed;for(var a=0;a<this.width;a++)this.find_cell(a,0).setEquil(t,e,1),this.find_cell(a,this.height-1).setEquil(t,e,1);for(var i=1;i<this.height-1;i++)this.find_cell(0,i).setEquil(t,e,1),this.find_cell(this.width-1,i).setEquil(t,e,1)}collide(){for(var t=1/(3*this.viscosity+.5),e=1;e<this.height-1;e++)for(var a=1;a<this.width-1;a++)this.find_cell(a,e).collide(t)}stream(){for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)this.find_cell(e,t).stream()}bounce(){for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)this.find_cell(e,t).bounce()}consolidate(){for(var t=0;t<this.height;t++)for(var e=0;e<this.width;e++)this.find_cell(e,t).consolidate()}setEquil(t,e,a,i){typeof i=="undefined"&&(i=this._rho_[t]);var s=3*e,l=3*a,h=e*e,o=a*a,r=2*e*a,d=h+o,_=1.5*d;this._n0_[t]=mt*i*(1-_),this._nE_[t]=T*i*(1+s+4.5*h-_),this._nW_[t]=T*i*(1-s+4.5*h-_),this._nN_[t]=T*i*(1+l+4.5*o-_),this._nS_[t]=T*i*(1-l+4.5*o-_),this._nNE_[t]=q*i*(1+s+l+4.5*(d+r)-_),this._nSE_[t]=q*i*(1+s-l+4.5*(d-r)-_),this._nNW_[t]=q*i*(1-s+l+4.5*(d-r)-_),this._nSW_[t]=q*i*(1-s-l+4.5*(d+r)-_),this._rho_[t]=i,this._ux_[t]=e,this._uy_[t]=a}apply_energy(t,e,a,i){document.getElementById("wind_info").innerHTML="dir: "+a+"stre : "+i+"<br>";let s=this.width/2+Math.floor(t*this.resolution),l=this.height/2+Math.floor(e*this.resolution),h,o,r,d,_,u,c,M,b,w,B,z;h=Math.floor(s),_=Math.floor(l),o=h+1,u=_,r=h,c=_+1,d=h+1,M=_+1;let P=s-h,N=l-_;b=(1-P)*(1-N),w=P*(1-N),B=(1-P)*N,z=P*N;let j=[h,o,r,d],L=[_,u,c,M],lt=[b,w,B,z];for(let W=0;W<1;W++)this.apply_force_to_cell(j[W],L[W],a,lt[W]*i)}apply_force_to_cell(t,e,a,i){let s=this.find_cell(t,e)._ux_,l=this.find_cell(t,e)._uy_,h=this.find_cell(t,e)._rho_,o=Math.cos(a/180*Math.PI)*i/h*-1,r=Math.sin(a/180*Math.PI)*i/h*-1;this.find_cell(t,e).setEquil(s+o,l+r)}apply_energy_to_cell(t,e,a,i){let s=a+270;s>360&&(s-=360),document.getElementById("wind_info").innerHTML="mirror_angle: "+s+"<br>";const l=[this._nE_,this._nNE_,this._nN_,this._nNW_,this._nW_,this._nSW_,this._nS_,this._nSE_];document.getElementById("wind_info").innerHTML+=JSON.stringify(a)+"<br>";let h=[0,0,0,0,0,0,0,0],o=[0,0,0,0,0,0,0,0],r=[0,0,0,0,0,0,0,0],d=[0,0,0,0,0,0,0,0];for(let _=0;_<8;_++){const u=.1*i,c=(Math.floor(s/45)+1+_)%8;d[_]=c*45,r[_]=s-(d[_]-s),r[_]>360&&(r[_]-=360),r[_]<0&&(r[_]+=360),h[_]=Math.cos(r[_]/180*Math.PI)*l[c][t+e*this.width]*u,o[_]=Math.sin(r[_]/180*Math.PI)*l[c][t+e*this.width]*u,l[c][t+e*this.width]*=1-u}for(let _=0;_<8;_++){const u=(Math.floor(r[_]/45)+1+_)%8;let c,M;u%2==0?Math.abs(h[_])>Math.abs(o[_])?(c=h[_]-o[_],M=o[_]*Math.SQRT2):(c=o[_]-h[_],M=h[_]*Math.SQRT2):Math.abs(h[_])>Math.abs(o[_])?(c=o[_]*Math.SQRT2,M=h[_]-o[_]):(c=h[_]*Math.SQRT2,M=o[_]-h[_]),l[u][t+e*this.width]+=c,l[(u+1)%8][t+e*this.width]+=M;let b=c*1e4,w=M*1e4;document.getElementById("wind_info").innerHTML+="sou: "+d[_]+" mirr: "+Math.floor(r[_])+"<br>",document.getElementById("wind_info").innerHTML+="u: "+Math.floor(b)+" v: "+Math.floor(w)+"<br>"}}get_field_velocity(t,e){t=this.width/2+Math.floor(t*this.resolution),e=this.height/2+Math.floor(e*this.resolution);let a,i,s,l,h,o,r,d,_,u,c,M;a=Math.floor(t),h=Math.floor(e),i=a+1,o=h,s=a,r=h+1,l=a+1,d=h+1;let b=t-a,w=e-h;_=(1-b)*(1-w),u=b*(1-w),c=(1-b)*w,M=b*w;let B=0,z=0,P=this.find_cell(a,h),N=this.find_cell(i,o),j=this.find_cell(s,r),L=this.find_cell(l,d);return B=P._ux_*_+N._ux_*u+j._ux_*c+L._ux_*M,z=P._uy_*_+N._uy_*u+j._uy_*c+L._uy_*M,{x:B/4,y:z/4}}paintTexture(){var t=0,e=Math.pow(1.2,Number(te.value)),a=Zt.selectedIndex;a==4&&this.computeCurl();for(var i=0;i<this.height;i++)for(var s=0;s<this.width;s++){if(this.find_cell(s,i).barrier)t=y+1;else{if(a==0)t=Math.round(y*((this.find_cell(s,i)._rho_-1)*6*e+.5));else if(a==1)t=Math.round(y*(this.find_cell(s,i)._ux_*2*e+.5));else if(a==2)t=Math.round(y*(this.find_cell(s,i)._uy_*2*e+.5));else if(a==3){var l=Math.sqrt(this.find_cell(s,i)._ux_*this.find_cell(s,i)._ux_+this.find_cell(s,i)._uy_*this.find_cell(s,i)._uy_);t=Math.round(y*(l*4*e))}else t=Math.round(y*(this.find_cell(s,i)._curl_*5*e+.5));t<0&&(t=0),t>y&&(t=y)}let h=!1;(this.find_cell(s,i)._curl_>.005||this.find_cell(s,i)._curl_<-.005)&&(h=!0),this.colorSquare(s,i,pt[t],gt[t],ft[t],h)}}colorSquare(t,e,a,i,s,l){if(this.texture!==void 0)for(var h=0;h<this.oversampling;h++)for(var o=0;o<this.oversampling;o++){var r=(t*this.oversampling+h+(e*this.oversampling+o)*this.width*this.oversampling)*4;if(this.texture.image.data[r+0]=a,this.texture.image.data[r+1]=i,this.texture.image.data[r+2]=s,this.texture.image.data[r+3]=255,l===!0){var d=(t*this.oversampling+0+(e*this.oversampling+0)*this.width*this.oversampling)*4;this.texture.image.data[d+0]=255,this.texture.image.data[d+1]=0,this.texture.image.data[d+2]=0,this.texture.image.data[d+3]=255}}}computeCurl(){for(var t=1;t<this.height-1;t++)for(var e=1;e<this.width-1;e++)this.find_cell(e,t).calculate_curl()}}window.requestAnimFrame=function(n){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1)}}();let J=ct,S=J.Vec2;function Wt(n){for(var t=0,e=0;e<n.length;e++)t+=n[e];return t}function kt(n){return Math.PI/180*n}function ae(n){return 180/Math.PI*Math.atan2(Wt(n.map(kt).map(Math.sin))/n.length,Wt(n.map(kt).map(Math.cos))/n.length)}class oe{constructor(t,e,a,i,s){this.bm=s,this.world=void 0,this.width=t,this.height=e,this.wind_direction=a,this.wind_speed=i,this.show_forces=!0,this.show_fields=!1,this.camera_follow_target=void 0,this.camera_follow=!1,this.camera_zoom=30,this.camera_zoom_max=70,this.camera_zoom_min=10,this.camera_position_x=0,this.camera_position_y=0,this.camera_position_x_max=30,this.camera_position_x_min=-30,this.camera_position_y_max=30,this.camera_position_y_min=-30}physics_model_init(){this.world=new ut.World(S(0,0));let t=this.world.createBody(S(0,0)),e={density:0,restitution:.4};t.createFixture(J.Edge(S(-this.width/2+2,-this.height/2+2),S(-this.width/2+2,this.height/2-2)),e),t.createFixture(J.Edge(S(this.width/2-2,-this.height/2+2),S(this.width/2-2,this.height/2-2)),e),t.createFixture(J.Edge(S(-this.width/2+2,this.height/2-2),S(this.width/2-2,this.height/2-2)),e),t.createFixture(J.Edge(S(-this.width/2+2,-this.height/2+2),S(this.width/2-2,-this.height/2+2)),e),this.world.createDynamicBody(S(0,14.5)).createFixture(ut.Circle(.5),10),this.world.createDynamicBody(S(0,20)).createFixture(ut.Circle(5),10)}get_wind_speed(t,e){let a=this.bm.get_field_velocity(t,e),i=this.bm.get_field_velocity(t-1,e),s=this.bm.get_field_velocity(t+1,e),l=this.bm.get_field_velocity(t,e-1),h=this.bm.get_field_velocity(t,e+1),o=0;return o+=Math.sqrt(a.x*a.x+a.y*a.y),o+=Math.sqrt(i.x*i.x+i.y*i.y),o+=Math.sqrt(s.x*s.x+s.y*s.y),o+=Math.sqrt(l.x*l.x+l.y*l.y),o+=Math.sqrt(h.x*h.x+h.y*h.y),o/5*100*4}get_wind_direction(t,e){let a=this.bm.get_field_velocity(t,e),i=this.bm.get_field_velocity(t-1,e),s=this.bm.get_field_velocity(t+1,e),l=this.bm.get_field_velocity(t,e-1),h=this.bm.get_field_velocity(t,e+1),o=[Math.atan2(a.y,a.x)/Math.PI*180+180,Math.atan2(i.y,i.x)/Math.PI*180+180,Math.atan2(s.y,s.x)/Math.PI*180+180,Math.atan2(l.y,l.x)/Math.PI*180+180,Math.atan2(h.y,h.x)/Math.PI*180+180];return ae(o)}set_camera_follow_target(t){this.camera_follow_target=t}physics_model_step(){this.camera_follow===!0&&this.camera_follow_target!==void 0&&(this.camera_position_x=this.camera_follow_target.x,this.camera_position_y=this.camera_follow_target.y,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min))}input_show_fields(t){this.show_fields=t}input_show_forces(t){this.show_forces=t}input_camera_follow(t){this.camera_follow=t}input_camera_zoom_relative(t){this.camera_zoom+=t,this.camera_zoom>this.camera_zoom_max&&(this.camera_zoom=this.camera_zoom_max),this.camera_zoom<this.camera_zoom_min&&(this.camera_zoom=this.camera_zoom_min)}input_camera_move_relative(t,e){this.camera_position_x+=t,this.camera_position_y+=e,this.camera_position_x>this.camera_position_x_max&&(this.camera_position_x=this.camera_position_x_max),this.camera_position_y>this.camera_position_y_max&&(this.camera_position_y=this.camera_position_y_max),this.camera_position_x<this.camera_position_x_min&&(this.camera_position_x=this.camera_position_x_min),this.camera_position_y<this.camera_position_y_min&&(this.camera_position_y=this.camera_position_y_min)}}let Bt=ct,p=Bt.Vec2;class F{constructor(t,e,a,i){this.map=t,this.x=e,this.y=a,i!=null?this.hull_angle=i:this.hull_angle=Math.PI,this.wind_direction=0,this.wind_speed=0,this.hull_mass=6,this.hull_shape=Bt.Polygon([p(0,-2.25),p(-.5,-1.25),p(-.75,-.25),p(-.75,.5),p(-.5,1.75),p(.5,1.75),p(.75,.5),p(.75,-.25),p(.5,-1.25),p(0,-2.25)]),this.rudder_input=0,this.motor_input=0,this.rudder_angle=0,this.rudder_angle_last=0,this.rudder_angle_max=60,this.rudder_position=1.8,this.rudder_lenght=.5,this.forces=[],this.mainsail_leading_edge_position=-.8,this.mainsail_boom_length=2.2,this.mainsail_boom_angle_max=80,this.mainsail_boom_angle_factor=.5,this.mainsail_boom_angle=0,this.mainsail_boom_angle_actual=0,this.jib_leading_edge_position=-2,this.jib_boom_length=1.4,this.jib_boom_angle_max=55,this.jib_boom_angle_factor=.65,this.jib_boom_angle=0,this.jib_boom_angle_actual=0,this.center_of_lift=-.05,this.centerboard_position=-.15,this.centerboard_length=.6,this.aero_lookup_resolution=5,this.aero_lift_lookup=[0,.025,.15,.9,1.3,1.46,1.52,1.51,1.45,1.41,1.33,1.16,.95,.82,.73,.6,.43,.34,.28,.28,.28],this.aero_drag_lookup=[.15,.15,.15,.16,.172,.19,.22,.25,.29,.34,.4,.47,.55,.635,.73,.83,.95,1.1,1.28,1.28,1.28],this.physics_model=void 0,this.power=0,this.power_direction=0,this.autopilot_enabled=!1,this.autopilot_heading_target=0,this.autopilot_heading_input=0,this.autopilot_heading_best_vmg_1=50,this.autopilot_heading_best_vmg_2=160,this.autopilot_compensator_p=0,this.autopilot_compensator_i=0,this.autopilot_compensator_d=0,this.autopilot_compensator_last_error=0,this.autopilot_compensator_current_error=0,this.autopilot_compensator_sum_error=0,this.twa=0,this.physics_model_init()}physics_model_init(){let t=ct,e=t.Vec2,a=this.map.world.createBody({type:"dynamic",angularDamping:.5,linearDamping:.1,position:e(this.x,this.y),angle:this.hull_angle,allowSleep:!1});a.createFixture(this.hull_shape,this.hull_mass),this.physics_model=a}physics_model_deinit(){this.map.world.destroyBody(this.physics_model)}physics_model_step(){this.forces=[],document.getElementById("info").innerHTML="Autopilot"+this.autopilot_enabled+"<br>",document.getElementById("info").innerHTML+="Heading Target"+this.autopilot_heading_target+"<br>",this.x=this.physics_model.m_xf.p.x,this.y=this.physics_model.m_xf.p.y,this.wind_speed=this.map.get_wind_speed(this.x,this.y),this.wind_direction=this.map.get_wind_direction(this.x,this.y);var t=this.physics_model.getAngle();for(this.angle=t,this.hull_angle=t;t<-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;let e=this.physics_model.m_linearVelocity.x*Math.cos(t-Math.PI/2)+this.physics_model.m_linearVelocity.y*Math.sin(t-Math.PI/2),a=this.physics_model.m_linearVelocity.x*Math.cos(t)+this.physics_model.m_linearVelocity.y*Math.sin(t),i=Math.atan2(a,Math.abs(e))*180/Math.PI;i>90?i-=180:i<-90&&(i+=180);let s=-i*Math.abs(e)*Math.abs(e)*2;s>150?s=150:s<-150&&(s=-150);var l=this.physics_model.getWorldVector(p(s,0)),h=this.physics_model.getWorldPoint(p(0,this.centerboard_position));this.physics_model.applyForce(l,h,!0),this.forces.push({name:"centerboard",type:"arrow",vector:l,point:h}),document.getElementById("info").innerHTML+="q/d: "+i+"\xB0<br>";let o=this.map.get_wind_direction(this.x,this.y)-t/Math.PI*180+90,r={};r.x=this.physics_model.m_linearVelocity.x+Math.cos(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y),r.y=this.physics_model.m_linearVelocity.y+Math.sin(this.map.get_wind_direction(this.x,this.y)/180*Math.PI)*this.map.get_wind_speed(this.x,this.y);let d=Math.atan2(r.y,r.x)/Math.PI*180-t/Math.PI*180+90,_=Math.sqrt(r.x*r.x+r.y*r.y);if(d>180&&(d-=360),d<-180&&(d+=360),o>180&&(o-=360),o<-180&&(o+=360),this.awa=d,this.twa=o,this.motor_input===1){var u=this.physics_model.getWorldVector(p(0,-.3)),c=this.physics_model.getWorldPoint(p(0,2));this.physics_model.applyLinearImpulse(u,c,!0)}if(this.motor_input===-1){var u=this.physics_model.getWorldVector(p(0,.3)),c=this.physics_model.getWorldPoint(p(0,2));this.physics_model.applyLinearImpulse(u,c,!0)}this.rudder_angle_last=this.rudder_angle;let M=0;const b=1-Math.abs(e)>0?1-Math.abs(e)+1:1;if(this.rudder_input===-1)this.rudder_angle<this.rudder_angle_max&&(this.rudder_angle+=b),M=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else if(this.rudder_input===1)this.rudder_angle>-this.rudder_angle_max&&(this.rudder_angle-=b),M=1.5*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last)*(this.rudder_angle-this.rudder_angle_last);else{let E=e;e>1&&(E=1),e<-1&&(E=-1),this.rudder_angle=this.rudder_angle*(.98-E/80)}if(this.autopilot_enabled){this.autopilot_compensator_p=2,this.autopilot_compensator_i=0,this.autopilot_compensator_d=100;let E=-(this.autopilot_heading_target- -this.twa);this.autopilot_compensator_sum_error*=.85,this.autopilot_compensator_sum_error+=E,E>180&&(E-=360),E<-180&&(E+=360),document.getElementById("info").innerHTML+="error: "+Math.floor(E)+"\xB0<br>";let At=E*this.autopilot_compensator_p,zt=this.autopilot_compensator_sum_error*this.autopilot_compensator_i,Dt=(E-this.autopilot_compensator_last_error)*this.autopilot_compensator_d;this.rudder_angle_target=(At+zt+Dt)*Math.sign(e),this.rudder_angle_target>this.rudder_angle_max/2&&(this.rudder_angle_target=this.rudder_angle_max/2),this.rudder_angle_target<-this.rudder_angle_max/2&&(this.rudder_angle_target=-this.rudder_angle_max/2),this.rudder_angle+=(this.rudder_angle_target-this.rudder_angle)/10,this.autopilot_compensator_last_error=E}else this.autopilot_heading_target=-this.twa,this.autopilot_heading_target>180&&(this.autopilot_heading_target-=360),this.autopilot_heading_target<-180&&(this.autopilot_heading_target+=360);let B=this.physics_model.m_angularVelocity*this.rudder_lenght,z=Math.atan2(-a+B,Math.abs(e))/Math.PI*180,P=0;e>0?P=e*(this.rudder_angle+z)/7:P=e*(this.rudder_angle-z)/7,P+=M*2;let N=this.physics_model.getWorldPoint(p(0,this.rudder_position)),j={};j.x=Math.cos(t+this.rudder_angle/180*Math.PI)*P,j.y=Math.sin(t+this.rudder_angle/180*Math.PI)*P,this.physics_model.applyForce(j,N,!0),this.forces.push({name:"rudder",type:"arrow",vector:j,point:N}),document.getElementById("info").innerHTML+="TWA: "+Math.floor(o)+"<br>",document.getElementById("info").innerHTML+="TWS: "+Math.floor(this.wind_speed*10)/10+"<br>",document.getElementById("info").innerHTML+="AWA: "+Math.floor(d)+"<br>",document.getElementById("info").innerHTML+="AWS: "+Math.floor(_*10)/10+"<br>";let L=Math.sqrt(this.physics_model.m_linearVelocity.x*this.physics_model.m_linearVelocity.x+this.physics_model.m_linearVelocity.y*this.physics_model.m_linearVelocity.y),lt=Math.cos(o/180*Math.PI)*L;document.getElementById("info").innerHTML+="BS: "+Math.floor(L*10)/10+"<br>",document.getElementById("info").innerHTML+="VMG: "+Math.floor(lt*10)/10+"<br>",this.jib_boom_angle=this.awa*this.jib_boom_angle_factor,this.jib_boom_angle>this.jib_boom_angle_max&&(this.jib_boom_angle=this.jib_boom_angle_max),this.jib_boom_angle<-this.jib_boom_angle_max&&(this.jib_boom_angle=-this.jib_boom_angle_max),this.mainsail_boom_angle=this.awa*this.mainsail_boom_angle_factor,this.mainsail_boom_angle>this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=this.mainsail_boom_angle_max),this.mainsail_boom_angle<-this.mainsail_boom_angle_max&&(this.mainsail_boom_angle=-this.mainsail_boom_angle_max);const W=Math.floor(Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution),et=Math.abs(this.mainsail_boom_angle-this.awa)/this.aero_lookup_resolution-W;let rt=this.aero_drag_lookup[W]*(1-et)+this.aero_drag_lookup[W+1]*et,dt=this.aero_lift_lookup[W]*(1-et)+this.aero_lift_lookup[W+1]*et,K={},Y={};document.getElementById("info").innerHTML+="Cd: "+Math.floor(rt*10)/10+"<br>",document.getElementById("info").innerHTML+="Cl: "+Math.floor(dt*10)/10+"<br>";const it=.15/3;K.x=Math.cos(t+this.awa/180*Math.PI+Math.PI/2)*_*_*rt*it,K.y=Math.sin(t+this.awa/180*Math.PI+Math.PI/2)*_*_*rt*it,Y.x=-Math.sign(this.awa)*Math.cos(t+this.awa/180*Math.PI)*_*_*dt*it,Y.y=-Math.sign(this.awa)*Math.sin(t+this.awa/180*Math.PI)*_*_*dt*it;let D={};D.x=K.x+Y.x,D.y=K.y+Y.y;var st=this.physics_model.getWorldPoint(p(0,this.center_of_lift));this.physics_model.applyForce(Y,st,!0),this.physics_model.applyForce(K,st,!0),this.forces.push({name:"mainsail",type:"arrow",vector:Y,point:st}),this.forces.push({name:"mainsail",type:"arrow",vector:K,point:st}),this.power=Math.sqrt(D.x*D.x+D.y*D.y),this.power_direction=Math.atan2(D.y,D.x)/Math.PI*180,document.getElementById("info").innerHTML+="Power: "+Math.floor(this.power*10)/10+"<br>";var at={};at.x=-this.physics_model.m_linearVelocity.x*L,at.y=-this.physics_model.m_linearVelocity.y*L;var It=this.physics_model.getWorldPoint(p(0,0));this.physics_model.applyForce(at,It,!0),this.forces.push({name:"drag",type:"arrow",vector:at,point:It}),this.rudder_input=0,this.motor_input=0}graphics_model_render(){let t=[];this.forces.forEach(_=>{t.push({color:65280,type:"force",x1:_.point.x,y1:_.point.y,x2:_.point.x+_.vector.x/10,y2:_.point.y+_.vector.y/10})});let e={},a=2;this.autopilot_enabled&&(a=10),e.x1=this.physics_model.getWorldPoint(p(0,0)).x,e.y1=this.physics_model.getWorldPoint(p(0,0)).y,e.x2=e.x1+Math.cos((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*a,e.y2=e.y1+Math.sin((this.wind_direction+this.autopilot_heading_target)/180*Math.PI)*a,e.color=5596791,e.type="autopilot",t.push(e);let i=this.wind_direction/180*Math.PI;t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5588087,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),i=this.awa/180*Math.PI+this.hull_angle-Math.PI/2,t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*3,y1:this.y+Math.sin(i)*3,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5-Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5-Math.sin(i+Math.PI/2)*.5}),t.push({color:5570679,type:"guide",x1:this.x+Math.cos(i)*4.75,y1:this.y+Math.sin(i)*4.75,x2:this.x+Math.cos(i)*5+Math.cos(i+Math.PI/2)*.5,y2:this.y+Math.sin(i)*5+Math.sin(i+Math.PI/2)*.5}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(p(0,this.rudder_position)).x,y1:this.physics_model.getWorldPoint(p(0,this.rudder_position)).y,x2:this.physics_model.getWorldPoint(p(0,this.rudder_position)).x+Math.cos(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght,y2:this.physics_model.getWorldPoint(p(0,this.rudder_position)).y+Math.sin(this.physics_model.getAngle()+Math.PI/2+this.rudder_angle/180*Math.PI)*this.rudder_lenght}),t.push({color:5570560,type:"hydro",x1:this.physics_model.getWorldPoint(p(0,this.centerboard_position+this.centerboard_length/2)).x,y1:this.physics_model.getWorldPoint(p(0,this.centerboard_position+this.centerboard_length/2)).y,x2:this.physics_model.getWorldPoint(p(0,this.centerboard_position-this.centerboard_length/2)).x,y2:this.physics_model.getWorldPoint(p(0,this.centerboard_position-this.centerboard_length/2)).y});let s=[];s[0]={},s[0].x=this.physics_model.getWorldPoint(p(0,this.mainsail_leading_edge_position)).x,s[0].y=this.physics_model.getWorldPoint(p(0,this.mainsail_leading_edge_position)).y,this.mainsail_boom_angle/this.mainsail_boom_angle_factor,this.mainsail_boom_angle_actual+=(this.mainsail_boom_angle-this.mainsail_boom_angle_actual)/30;let l=this.mainsail_boom_length*.05*Math.abs(this.awa)/30<this.mainsail_boom_length/10?this.mainsail_boom_length*.05*Math.abs(this.awa)/30:this.mainsail_boom_length/10;s[1]={},s[1].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.mainsail_boom_angle_actual),s[1].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.25+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-l*Math.sign(this.mainsail_boom_angle_actual);let h=l;s[2]={},s[2].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.cos(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-h*Math.sign(this.mainsail_boom_angle_actual),s[2].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length*.5+Math.sin(this.hull_angle+this.mainsail_boom_angle_actual/180*Math.PI)*-h*Math.sign(this.mainsail_boom_angle_actual),s[3]={},s[3].x=s[0].x+Math.cos(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,s[3].y=s[0].y+Math.sin(this.hull_angle+Math.PI/2+this.mainsail_boom_angle_actual/180*Math.PI)*this.mainsail_boom_length,t.push({color:8939263,type:"sail",x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y}),t.push({color:8939263,type:"sail",x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y}),t.push({color:8939263,type:"sail",x1:s[2].x,y1:s[2].y,x2:s[3].x,y2:s[3].y}),this.jib_boom_angle_actual+=(this.jib_boom_angle-this.jib_boom_angle_actual)/20;let o=[];o[0]={},o[0].x=this.physics_model.getWorldPoint(p(0,this.jib_leading_edge_position)).x,o[0].y=this.physics_model.getWorldPoint(p(0,this.jib_leading_edge_position)).y;let r=this.jib_boom_length*.05*Math.abs(this.awa)/15<this.jib_boom_length/3?this.jib_boom_length*.05*Math.abs(this.awa)/15:this.jib_boom_length/3;o[1]={},o[1].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.jib_boom_angle_actual),o[1].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.25+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-r*Math.sign(this.jib_boom_angle_actual);let d=r;if(o[2]={},o[2].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.cos(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),o[2].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length*.5+Math.sin(this.hull_angle+this.jib_boom_angle_actual/180*Math.PI)*-d*Math.sign(this.jib_boom_angle_actual),o[3]={},o[3].x=o[0].x+Math.cos(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,o[3].y=o[0].y+Math.sin(this.hull_angle+Math.PI/2+this.jib_boom_angle_actual/180*Math.PI)*this.jib_boom_length,t.push({color:8939263,type:"sail",x1:o[0].x,y1:o[0].y,x2:o[1].x,y2:o[1].y}),t.push({color:8939263,type:"sail",x1:o[1].x,y1:o[1].y,x2:o[2].x,y2:o[2].y}),t.push({color:8939263,type:"sail",x1:o[2].x,y1:o[2].y,x2:o[3].x,y2:o[3].y}),this.map.show_fields){const _=10;for(let u=-_;u<_;u++)for(let c=-_;c<_;c++)if(Math.sqrt(u*u+c*c)<_-1){const M=this.map.bm.resolution;let b=Math.floor(this.x*M)/M+u/M,w=Math.floor(this.y*M)/M+c/M,B=this.map.bm.get_field_velocity(b,w);t.push({color:8939263,type:"sail",x1:b,y1:w,x2:b+B.x*30,y2:w+B.y*30})}}return t}input_rudder_left(){this.rudder_input=1,this.autopilot_enabled=!1}input_rudder_right(){this.rudder_input=-1,this.autopilot_enabled=!1}input_motor_forward(){this.motor_input=1}input_motor_reverse(){this.motor_input=-1}input_autopilot_enabled_toggle(){this.autopilot_heading_target<0?this.autopilot_heading_target>-90?this.autopilot_heading_target=-this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=-this.autopilot_heading_best_vmg_2:this.autopilot_heading_target<90?this.autopilot_heading_target=this.autopilot_heading_best_vmg_1:this.autopilot_heading_target=this.autopilot_heading_best_vmg_2,this.autopilot_enabled=!0}input_autopilot_tack_toggle(){this.autopilot_heading_target*=-1,this.autopilot_enabled=!0}input_autopilot_heading_increase(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)<175&&(this.autopilot_heading_target>0?this.autopilot_heading_target+=1:this.autopilot_heading_target-=1)}input_autopilot_heading_decrease(){this.autopilot_enabled=!0,Math.abs(this.autopilot_heading_target)>5&&(this.autopilot_heading_target>0?this.autopilot_heading_target-=1:this.autopilot_heading_target+=1)}}const Mt=50,bt=50,Nt=90,jt=15,xt=2;var vt=2,Lt=vt*Mt*xt,Tt=vt*bt*xt,_e=Lt*Tt*4,he=new Uint8Array(_e),U=new Ht(he,Lt,Tt,Vt,Rt,Ct);U.magFilter=Ot;U.needsUpdate=!0;var qt=new Kt({map:U,transparent:!0});qt.needsUpdate=!0;const G=new se(Mt,bt,xt,Nt,jt,U,vt);let m=new oe(Mt,bt,Nt,jt,G);m.physics_model_init();let Z={},g=[],Q=0;const ne=new Yt(m.world,{speed:1,fps:30});let x=[],R=[],I=[],Ft=[],ht=[];document.onkeydown=re;document.onkeyup=de;document.getElementById("camera_follow").checked=!1;document.getElementById("show_forces").checked=!0;document.getElementById("show_field").checked=!1;document.getElementById("show_forces").addEventListener("change",n=>{m.input_show_forces(document.getElementById("show_forces").checked)});document.getElementById("scenario_selector").addEventListener("change",n=>{console.log(document.getElementById("scenario_selector").value),wt(f[document.getElementById("scenario_selector").value])});document.getElementById("scenario_restart").addEventListener("click",n=>{console.log("restart"),wt(f[document.getElementById("scenario_selector").value])});document.getElementById("show_field").addEventListener("change",n=>{m.input_show_fields(document.getElementById("show_field").checked)});document.getElementById("windAngle").addEventListener("change",n=>{let t=parseInt(document.getElementById("windAngle").value);m.bm.direction=t+180});document.getElementById("camera_follow").addEventListener("change",n=>{m.input_camera_follow(document.getElementById("camera_follow").checked)});document.getElementById("camera_zoom_in").addEventListener("click",n=>{m.input_camera_zoom_relative(-2)});document.getElementById("camera_zoom_out").addEventListener("click",n=>{m.input_camera_zoom_relative(2)});document.getElementById("camera_move_left").addEventListener("click",n=>{m.input_camera_move_relative(-5,0)});document.getElementById("camera_move_right").addEventListener("click",n=>{m.input_camera_move_relative(5,0)});document.getElementById("camera_move_up").addEventListener("click",n=>{m.input_camera_move_relative(0,5)});document.getElementById("camera_move_down").addEventListener("click",n=>{m.input_camera_move_relative(0,-5)});var le=function(n){n.pageX,n.pageY;var t=new H,e=new H;t.set(n.clientX/window.innerWidth*2-1,-(n.clientY/window.innerHeight)*2+1,.5),t.unproject(k),t.sub(k.position).normalize();var a=-k.position.z/t.z;e.copy(k.position).add(t.multiplyScalar(a));let i=m.get_wind_direction(e.x,e.y),s=m.get_wind_speed(e.x,e.y),l=G.get_field_velocity(e.x,e.y).x,h=G.get_field_velocity(e.x,e.y).y;i=Math.atan2(h,l)/Math.PI*180,s=Math.sqrt(l*l+h*h),document.getElementById("wind_info").innerHTML="Speed: "+Math.floor(s*1e3)/10+"<br>Direction: "+Math.floor(i*10)/10};document.addEventListener("mousemove",le);function re(n){n=n||window.event,R[n.keyCode]=!0,x.forEach(t=>{t.type==="KEYDOWN"&&R[t.activation_key]&&(R[t.prohibition_key]===!1||R[t.prohibition_key]===void 0)&&t.object[t.input_handler]()})}function de(n){n=n||window.event,R[n.keyCode]=!1}function nt(){Z={},x=[],g.forEach(n=>{n.physics_model_deinit()}),g=[],Q=0}function wt(n){nt(),Z=n}function tt(n){x=[],n[0]!==void 0&&(x.push({type:"PRESSED",activation_key:37,prohibition_key:39,object:n[0],input_handler:n[0].input_rudder_left.name}),x.push({type:"PRESSED",activation_key:39,prohibition_key:37,object:n[0],input_handler:n[0].input_rudder_right.name}),x.push({type:"PRESSED",activation_key:40,prohibition_key:38,object:n[0],input_handler:n[0].input_autopilot_heading_increase.name}),x.push({type:"PRESSED",activation_key:38,prohibition_key:40,object:n[0],input_handler:n[0].input_autopilot_heading_decrease.name}),x.push({type:"KEYDOWN",activation_key:32,prohibition_key:-1,object:n[0],input_handler:n[0].input_autopilot_enabled_toggle.name}),x.push({type:"KEYDOWN",activation_key:13,prohibition_key:-1,object:n[0],input_handler:n[0].input_autopilot_tack_toggle.name})),n[1]!==void 0&&(x.push({type:"PRESSED",activation_key:65,prohibition_key:68,object:n[1],input_handler:n[1].input_rudder_left.name}),x.push({type:"PRESSED",activation_key:68,prohibition_key:65,object:n[1],input_handler:n[1].input_rudder_right.name}),x.push({type:"PRESSED",activation_key:83,prohibition_key:87,object:n[1],input_handler:n[1].input_autopilot_heading_increase.name}),x.push({type:"PRESSED",activation_key:87,prohibition_key:83,object:n[1],input_handler:n[1].input_autopilot_heading_decrease.name}),x.push({type:"KEYDOWN",activation_key:17,prohibition_key:-1,object:n[1],input_handler:n[0].input_autopilot_enabled_toggle.name}),x.push({type:"KEYDOWN",activation_key:16,prohibition_key:-1,object:n[1],input_handler:n[0].input_autopilot_tack_toggle.name}))}let f=[];f[0]=[];f[0][0]=()=>{g.push(new F(m,10,-9,5*Math.PI/4))};f[0][1]=()=>{console.log(1),g[0].input_autopilot_enabled_toggle()};f[0][2]=()=>{tt(g)};f[1]=[];f[1][0]=()=>{g.push(new F(m,12,-6,5*Math.PI/4)),g.push(new F(m,15,-11.5,5*Math.PI/4))};f[1][1]=()=>{console.log(1),g[0].input_autopilot_enabled_toggle(),g[1].input_autopilot_enabled_toggle()};f[1][2]=()=>{tt(g)};f[2]=[];f[2][0]=()=>{g.push(new F(m,-10,-6,3*Math.PI/4)),g.push(new F(m,15,-11.5,5*Math.PI/4))};f[2][1]=()=>{console.log(1),g[0].input_autopilot_enabled_toggle(),g[1].input_autopilot_enabled_toggle()};f[2][2]=()=>{tt(g)};f[2][2e3]=()=>{nt()};f[3]=[];f[3][0]=()=>{g.push(new F(m,-3,-3,3*Math.PI/4)),g.push(new F(m,18,-11.5,5*Math.PI/4))};f[3][1]=()=>{console.log(1),g[0].input_autopilot_enabled_toggle(),g[1].input_autopilot_enabled_toggle()};f[3][2]=()=>{tt(g)};f[3][350]=()=>{g[0].input_autopilot_tack_toggle()};f[3][2e3]=()=>{nt()};f[4]=[];f[4][0]=()=>{g.push(new F(m,-3,-4,3*Math.PI/4)),g.push(new F(m,18,-11.5,5*Math.PI/4))};f[4][1]=()=>{console.log(1),g[0].input_autopilot_enabled_toggle(),g[1].input_autopilot_enabled_toggle()};f[4][2]=()=>{tt(g)};f[4][300]=()=>{g[0].input_autopilot_tack_toggle()};f[4][700]=()=>{g[1].input_autopilot_heading_decrease()};f[4][701]=()=>{g[1].input_autopilot_heading_decrease()};f[4][702]=()=>{g[1].input_autopilot_heading_decrease()};f[4][2e3]=()=>{nt()};f[5]=[];wt(f[document.getElementById("scenario_selector").value]);ne.start(()=>{ht=[],Z!==void 0&&Z[Q]!==void 0&&(console.log("Frame ",Q),Z[Q]()),x.forEach(e=>{e.type==="PRESSED"&&R[e.activation_key]===!0&&(R[e.prohibition_key]===!1||R[e.prohibition_key]===void 0)&&e.object[e.input_handler]()}),m.set_camera_follow_target(g[0]),m.physics_model_step();let n=0;g.forEach((e,a)=>{g.forEach((h,o)=>{if(o>a){let r=e.x-h.x,d=e.y-h.y;n+=Math.sqrt(r*r+d*d),document.getElementById("dist_info").innerHTML="Dist: "+Math.floor(n*100)/100+"<br>"}}),e.physics_model_step(),ht=[...ht,...e.graphics_model_render()];let i={},s=e.awa/180*Math.PI+e.hull_angle-Math.PI/2;i.x=e.x+Math.cos(s)*-1.8,i.y=e.y+Math.sin(s)*-1.8,Math.cos(e.power_direction/180*Math.PI)*e.power/1e4,Math.sin(e.power_direction/180*Math.PI)*e.power/1e4;const l=1.5;i.x0=e.x+Math.cos(e.hull_angle+90/180*Math.PI)*-l+Math.cos(s)*-2,i.y0=e.y+Math.sin(e.hull_angle+90/180*Math.PI)*-l+Math.sin(s)*-2,i.x1=e.x+Math.cos(e.hull_angle+90/180*Math.PI)*0+Math.cos(s)*-2,i.y1=e.y+Math.sin(e.hull_angle+90/180*Math.PI)*0+Math.sin(s)*-2,i.x2=e.x+Math.cos(e.hull_angle+90/180*Math.PI)*+l+Math.cos(s)*-2,i.y2=e.y+Math.sin(e.hull_angle+90/180*Math.PI)*+l+Math.sin(s)*-2,m.bm.apply_energy(i.x0,i.y0,e.power_direction,e.power/5e3),m.bm.apply_energy(i.x1,i.y1,e.power_direction,e.power/2e3),m.bm.apply_energy(i.x2,i.y2,e.power_direction,e.power/5e3),document.getElementById("info").innerHTML+="Phys Time: "+G.t_delta+"<br>"}),Q%1==0&&m.bm.physics_model_step(),Q++;let t={};t.x=0,t.y=0,G.step_ready&&(X.copyTextureToTexture(t,U,U),G.step_ready=!1),m.show_fields},()=>{});let k,A,X;ce();function ce(){k=new Ut(70,window.innerWidth/window.innerHeight,.01,85),k.position.z=60,k.position.y=20,A=new Gt,new Pt(6706517),new Pt(5592422);const n=new Qt(m.width,m.height);let t=new Xt(n,qt);t.position.x=0,t.position.y=0,t.position.z=-.01,A.add(t),X=new $t({antialias:!0}),X.setSize(window.innerWidth,window.innerHeight),X.setAnimationLoop(ue),document.body.appendChild(X.domElement)}function ue(n){k.position.x=m.camera_position_x,k.position.y=m.camera_position_y,k.position.z=m.camera_zoom;for(let t of I)A.remove(t),t.geometry.dispose(),t.material.dispose(),t=void 0;for(let t of Ft)A.remove(t),t.geometry.dispose!==void 0&&t.geometry.dispose(),t.material.dispose!==void 0&&t.material.dispose(),t=void 0;I=[],Ft=[];for(let t=m.world.getBodyList();t;t=t.getNext())for(let e=t.getFixtureList();e;e=e.getNext()){if(t.render&&t.render.hidden)continue;t.render&&t.render.stroke||t.isDynamic()||t.isKinematic()||t.isStatic();const a=e.getType(),i=e.getShape();if(a==="circle"){const s=i.m_radius,l=t.getPosition();let h=[];for(let d=0;d<360;d+=10){let _=d/180*Math.PI,u=s*Math.cos(_)+l.x,c=s*Math.sin(_)+l.y;h.push(new H(u,c,0))}h.push(h[0]);const o=new ot().setFromPoints(h),r=new $({color:65280});I.push(new _t(o,r)),A.add(I[I.length-1])}if(a==="edge"){let s=[];const l=i.m_vertex1,h=i.m_vertex2;let o=l.x+t.m_xf.p.x,r=l.y+t.m_xf.p.y,d=h.x+t.m_xf.p.x,_=h.y+t.m_xf.p.y;s.push(new H(o,r,0)),s.push(new H(d,_,0));const u=new ot().setFromPoints(s),c=new $({color:16711680});I.push(new _t(u,c)),A.add(I[I.length-1])}if(a==="polygon"){let s=i.m_vertices;s.push(s[0]);let l=[];for(const r of s){let d=t.getAngle()+Math.PI,_=t.getLocalCenter(),u=(r.x+_.x)*Math.cos(d)+(r.y-_.y)*Math.sin(d),c=(r.x+_.x)*Math.sin(d)-(r.y-_.y)*Math.cos(d),M=0;u+=e.m_body.c_position.c.x,c+=e.m_body.c_position.c.y,l.push(new H(u,c,M))}const h=new ot().setFromPoints(l),o=new $({color:255});I.push(new _t(h,o)),A.add(I[I.length-1])}}for(const t of ht){if(m.show_forces==!1&&t.type==="force")continue;let e=[];e.push(new H(t.x1,t.y1,0)),e.push(new H(t.x2,t.y2,0));const a=new ot().setFromPoints(e);let i=t.color;i===void 0&&(i=16711680);let s,l,h;t.opacity!==void 0?(l=!0,s=t.opacity,h=new $({color:i,transparent:l,opacity:s})):h=new $({color:i}),I.push(new _t(a,h)),A.add(I[I.length-1])}X.render(A,k)}
